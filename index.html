<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Step By Step Game</title>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script>
tailwind.config = {
    darkMode: 'class',
    theme: {
        extend: {
            colors: {
                primary: '#6366f1',
                secondary: '#8b5cf6',
                accent: '#f59e0b',
                ice: '#00d2ff',
            }
        }
    }
}
</script>
<style>
@keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
/* --- –ù–û–í–ê–Ø –ê–ù–ò–ú–ê–¶–ò–Ø –†–£–õ–ï–¢–ö–ò --- */
.roulette-container {
    position: relative; width: 100%; height: 160px; overflow: hidden;
    background: rgba(0, 0, 0, 0.4); border-radius: 16px;
    border: 2px solid rgba(255, 255, 255, 0.15); box-shadow: inset 0 0 20px rgba(0,0,0,0.8);
}
.roulette-inner {
    display: flex; position: absolute; left: 0; top: 15px;
    transition: transform 6.5s cubic-bezier(0.1, 0, 0.05, 1); will-change: transform;
}
.roulette-item {
    width: 120px; height: 130px; flex-shrink: 0; margin: 0 5px;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.02));
    border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);
}
.roulette-item .emoji { font-size: 3.5rem; }
.roulette-item .name { font-size: 0.75rem; margin-top: 8px; color: #e2e8f0; text-align: center; }
.roulette-pointer {
    position: absolute; left: 50%; top: 0; bottom: 0; width: 4px;
    background: #ff4757; z-index: 20; transform: translateX(-50%);
    box-shadow: 0 0 20px #ff4757, 0 0 10px #ff4757;
}
/* --- –û–†–ò–ì–ò–ù–ê–õ–¨–ù–´–ï –°–¢–ò–õ–ò --- */
.glass { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
.line-through { text-decoration: line-through; opacity: 0.5; }
.fullscreen-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 100; overflow-y: auto; }
.ice-circle { width: 320px; height: 320px; border-radius: 50%; border: 4px solid rgba(0,210,255,0.5); position: relative; overflow: hidden; background: radial-gradient(circle, rgba(0,210,255, 0%), rgba(0,128,255,0.2) 160px, rgba(0,128,255,0.4) 100%); }
.ice-ball { position: absolute; width: 40px; height: 40px; background: radial-gradient(circle at 30% 30%, #fff, #00d2ff); border-radius: 50%; z-index: 10; transform: translate(-50%, -50%); transition: left 0.025s linear, top 0.025s linear; }
.player-avatar { position: absolute; width: 40px; height: 40px; border-radius: 50%; border: 2px solid white; overflow: hidden; transform: translate(-50%, -50%); z-index: 5; }
.case-cardboard { background: linear-gradient(135deg, #8B4513 0%, #D2691E 50%, #8B4513 100%); border: 3px solid #A0522D; }
.case-collector { background: linear-gradient(135deg, #DC143C 0%, #FF1493 50%, #8B008B 100%); border: 3px solid #FFD700; }
</style>
</head>
<body class="bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-600 min-h-screen text-white overflow-x-hidden">
<div id="root"></div>

<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<script type="text/babel">
const { useState, useEffect, useRef } = React;

const firebaseConfig = {
    apiKey: "AIzaSyDZPRiByz69HQa8b7GFMCJeqq56J3Y-bOY",
    authDomain: "step-by-step-279df.firebaseapp.com",
    databaseURL: "https://step-by-step-279df-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "step-by-step-279df",
    storageBucket: "step-by-step-279df.firebasestorage.app",
    messagingSenderId: "302641152597",
    appId: "1:302641152597:web:6479b9ae03104666cd8adc"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const TelegramWebApp = window.Telegram?.WebApp;
const ADMIN_WALLET = 'UQAWqaIPFSg81l9MlgAx0HBE9o3gpJMhk1dnyryKJXhWNHIc';
const BOT_TOKEN = '8325421899:AAHRdmMYdjJMXmAVIynDsQtpUNsSeKkaOis';

const CASE_REWARDS = {
    cardboard: [
        { id: 'stars_0_25', name: '0.25 ‚≠êÔ∏è', realChance: 80, type: 'stars', value: 0.25, emoji: '‚≠êÔ∏è' },
        { id: 'stars_0_75', name: '0.75 ‚≠êÔ∏è', realChance: 10, type: 'stars', value: 0.75, emoji: '‚≠êÔ∏è' },
        { id: 'stars_1_5', name: '1.5 ‚≠êÔ∏è', realChance: 6, type: 'stars', value: 1.5, emoji: '‚≠êÔ∏è' },
        { id: 'stars_5', name: '5 ‚≠êÔ∏è', realChance: 2, type: 'stars', value: 5, emoji: '‚≠êÔ∏è' },
        { id: 'bear', name: 'üß∏', realChance: 1.5, type: 'item', sellPrice: 20, emoji: 'üß∏' },
        { id: 'diamond_pro', name: 'üíé PRO', realChance: 0.5, type: 'collectible', emoji: 'üíé' }
    ],
    coal: [
        { id: 'stars_2_5', name: '2.5 ‚≠êÔ∏è', realChance: 60, type: 'stars', value: 2.5, emoji: '‚≠êÔ∏è' },
        { id: 'stars_5', name: '5 ‚≠êÔ∏è', realChance: 18, type: 'stars', value: 5, emoji: '‚≠êÔ∏è' },
        { id: 'pickaxe', name: '–ö–∏—Ä–∫–∞ ‚õèÔ∏è', realChance: 10, type: 'item', sellPrice: 10, emoji: '‚õèÔ∏è' },
        { id: 'stars_15', name: '15 ‚≠êÔ∏è', realChance: 6, type: 'stars', value: 15, emoji: '‚≠êÔ∏è' },
        { id: 'material', name: '–ú–∞—Ç–µ—Ä–∏–∞–ª üß±', realChance: 5, type: 'item', sellPrice: 40, emoji: 'üß±' },
        { id: 'brownie_pro', name: 'Happy Brownie PRO üí©', realChance: 1, type: 'collectible', emoji: 'üí©' }
    ],
    platinum: [
        { id: 'stars_35', name: '35 ‚≠êÔ∏è', realChance: 55, type: 'stars', value: 35, emoji: '‚≠êÔ∏è' },
        { id: 'stars_50', name: '50 ‚≠êÔ∏è', realChance: 35, type: 'stars', value: 50, emoji: '‚≠êÔ∏è' },
        { id: 'ring', name: 'üíç', realChance: 5, type: 'collectible', emoji: 'üíç' },
        { id: 'bday', name: 'B-day üóì', realChance: 4, type: 'item', sellPrice: 150, emoji: 'üóì' },
        { id: 'bday_pro', name: 'B-Day PRO üìÖ', realChance: 1, type: 'collectible', emoji: 'üìÖ' }
    ],
    gold: [
        { id: 'stars_50', name: '50 ‚≠êÔ∏è', realChance: 50, type: 'stars', value: 50, emoji: '‚≠êÔ∏è' },
        { id: 'stars_125', name: '125 ‚≠êÔ∏è', realChance: 35, type: 'stars', value: 125, emoji: '‚≠êÔ∏è' },
        { id: 'clover', name: 'üçÄ Clover Pin', realChance: 10, type: 'item', sellPrice: 200, emoji: 'üçÄ' },
        { id: 'icecream', name: 'Ice Cream üç¶', realChance: 3, type: 'collectible', emoji: 'üç¶' },
        { id: 'clover_pro', name: 'üçÄ Clover Pin PRO', realChance: 2, type: 'collectible', emoji: 'üçÄ' }
    ],
    money: [
        { id: 'stars_150', name: '150 ‚≠êÔ∏è', realChance: 45, type: 'stars', value: 150, emoji: '‚≠êÔ∏è' },
        { id: 'stars_75', name: '75 ‚≠êÔ∏è', realChance: 40, type: 'stars', value: 75, emoji: '‚≠êÔ∏è' },
        { id: 'trophy', name: 'üèÜ', realChance: 5, type: 'collectible', emoji: 'üèÜ' },
        { id: 'gem', name: 'üíé', realChance: 5, type: 'collectible', emoji: 'üíé' },
        { id: 'bday_happy', name: 'Happy B-day üíà', realChance: 4, type: 'collectible', emoji: 'üíà' },
        { id: 'cigar', name: 'Snoop Cigar üö¨', realChance: 1, type: 'collectible', emoji: 'üö¨' }
    ],
    elite: [
        { id: 'stars_200', name: '200 ‚≠êÔ∏è', realChance: 75, type: 'stars', value: 200, emoji: '‚≠êÔ∏è' },
        { id: 'stars_275', name: '275 ‚≠êÔ∏è', realChance: 5, type: 'stars', value: 275, emoji: '‚≠êÔ∏è' },
        { id: 'champagne', name: 'üçæ', realChance: 17, type: 'collectible', emoji: 'üçæ' },
        { id: 'socks', name: '–ù–æ—Å–∫–∏ üß¶', realChance: 2, type: 'collectible', emoji: 'üß¶' },
        { id: 'lightsword', name: 'Light Sword ‚öîÔ∏è', realChance: 1, type: 'collectible', emoji: '‚öîÔ∏è' }
    ],
    diamond: [
        { id: 'stars_8', name: '8 ‚≠êÔ∏è', realChance: 70, type: 'stars', value: 8, emoji: '‚≠êÔ∏è' },
        { id: 'bear', name: '–ú–∏—à–∫–∞ üß∏', realChance: 15, type: 'item', sellPrice: 20, emoji: 'üß∏' },
        { id: 'stars_25', name: '25 ‚≠êÔ∏è', realChance: 9, type: 'stars', value: 25, emoji: '‚≠êÔ∏è' },
        { id: 'stars_80', name: '80 ‚≠êÔ∏è', realChance: 4, type: 'stars', value: 80, emoji: '‚≠êÔ∏è' },
        { id: 'diamond_pro', name: '–ê–ª–º–∞–∑ PRO üíé', realChance: 0.6, type: 'collectible', emoji: 'üíé' },
        { id: 'snoop_pro', name: 'Snoop Dog PRO üêï', realChance: 0.4, type: 'collectible', emoji: 'üêï' }
    ],
    winter: [
        { id: 'stars_20', name: '20 ‚≠êÔ∏è', realChance: 60, type: 'stars', value: 20, emoji: '‚≠êÔ∏è' },
        { id: 'stars_35', name: '35 ‚≠êÔ∏è', realChance: 35, type: 'stars', value: 35, emoji: '‚≠êÔ∏è' },
        { id: 'stars_80', name: '80 ‚≠êÔ∏è', realChance: 3.5, type: 'stars', value: 80, emoji: '‚≠êÔ∏è' },
        { id: 'snake', name: 'üéÑ Lunar Snake 2025 üêç', realChance: 1, type: 'collectible', emoji: 'üêç' },
        { id: 'scarf', name: 'üß£ –ó–∏–º–Ω–µ–µ —Å–æ–∫—Ä–æ–≤–∏—â–µ', realChance: 0.5, type: 'collectible', emoji: 'üß£' }
    ],
    major: [
        { id: 'stars_500', name: '500 ‚≠êÔ∏è', realChance: 50, type: 'stars', value: 500, emoji: '‚≠êÔ∏è' },
        { id: 'stars_1000', name: '1000 ‚≠êÔ∏è', realChance: 25, type: 'stars', value: 1000, emoji: '‚≠êÔ∏è' },
        { id: 'car', name: 'üöó –ê–≤—Ç–æ–º–æ–±–∏–ª—å', realChance: 5, type: 'collectible', emoji: 'üöó' },
    ],
    collector: [
        { id: 'bear_pro', name: 'üß∏ PRO', realChance: 55, type: 'collectible', emoji: 'üß∏' },
        { id: 'gift_pro', name: 'üéÅ PRO', realChance: 20, type: 'collectible', emoji: 'üéÅ' },
        { id: 'ramen_pro', name: 'üçúRamen PRO', realChance: 0.5, type: 'collectible', emoji: 'üçú' },
        { id: 'hat_pro', name: 'üé© Top hat', realChance: 0, type: 'collectible', emoji: 'üé©' },
        { id: 'bird_pro', name: 'ü¶ÖRare bird', realChance: 0, type: 'collectible', emoji: 'ü¶Ö' }
    ]
};

const INITIAL_CASES = {
    cardboard: { id: 'cardboard', name: '–ö–∞—Ä—Ç–æ–Ω', emoji: 'üì¶', price: 3, color: 'from-amber-800 to-amber-900', locked: false, isNew: true, freeCount: 0 },
    coal: { id: 'coal', name: '–£–≥–æ–ª—ë–∫', emoji: 'ü™®', price: 22, originalPrice: 22, discountPrice: 20, color: 'from-gray-600 to-gray-800', locked: false, isNew: false, freeCount: 0 },
    platinum: { id: 'platinum', name: '–ü–ª–∞—Ç–∏–Ω–∞', emoji: 'üíé', price: 100, color: 'from-gray-300 to-gray-500', locked: false },
    gold: { id: 'gold', name: '–ó–æ–ª–æ—Ç–æ–π', emoji: 'üëë', price: 250, color: 'from-yellow-400 to-yellow-600', locked: false },
    money: { id: 'money', name: '–î–µ–Ω–µ–∂–Ω—ã–π', emoji: 'üíµ', price: 350, color: 'from-green-400 to-green-600', locked: false },
    elite: { id: 'elite', name: '–≠–ª–∏—Ç–∞', emoji: 'üéñ', price: 500, color: 'from-red-400 to-red-600', locked: false, isNew: false, freeCount: 0 },
    diamond: { id: 'diamond', name: '–ê–ª–º–∞–∑', emoji: 'üíé', price: 50, originalPrice: 50, discountPrice: 35, color: 'from-blue-400 to-blue-600', locked: false, isNew: false, freeCount: 0 },
    winter: { id: 'winter', name: '–ó–∏–º–Ω–∏–π', emoji: '‚òÉÔ∏è', price: 125, originalPrice: 150, discountPrice: 125, color: 'from-cyan-400 to-blue-500', locked: false, isNew: true, freeCount: 0 },
    major: { id: 'major', name: '–ú–∞–∂–æ—Ä', emoji: 'ü§¥', price: 800, color: 'from-purple-500 to-indigo-700', locked: true, isNew: false, freeCount: 0 },
    collector: { id: 'collector', name: '–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–µ—Ä', emoji: 'üé©', price: 650, color: 'from-rose-600 to-pink-800', locked: true, isNew: true, freeCount: 0 }
};

const ICE_ARENA_PRIZES = [
    { id: 'bear', name: 'üß∏ –ú–∏—à–∫–∞', chance: 40, type: 'item', sellPrice: 20, emoji: 'üß∏' },
    { id: 'fire', name: 'üî• –û–≥–æ–Ω—å', chance: 10, type: 'special', emoji: 'üî•', message: '–í—ã —Ä–∞—Å—Ç–æ–ø–∏–ª–∏ –ª–µ–¥! –ü–æ–ª—É—á–∞–µ—Ç–µ 40% –æ—Ç —Å—Ç–∞–≤–æ–∫' },
];
    const TON_RATES = [{ stars: 50, ton: 0.6 }, { stars: 250, ton: 3 }];
const STARS_PACKAGES = [{ stars: 50, price: 50, name: '50 –∑–≤–µ–∑–¥' }];

function App() {
    const [currentScreen, setCurrentScreen] = useState('cases');
    const [balance, setBalance] = useState(0);
    const [cases, setCases] = useState(INITIAL_CASES);
    const [inventory, setInventory] = useState([]);
    const [inventorySlots, setInventorySlots] = useState(5);
    const [tasks, setTasks] = useState({ subscribe: { completed: false }, deposit: { completed: false }, depositMajor: { completed: false }, invite: { completed: false, count: 0 } });
    const [user, setUser] = useState(null);
    const [selectedCase, setSelectedCase] = useState(null);
    const [isSpinning, setIsSpinning] = useState(false);
    const [spinResult, setSpinResult] = useState(null);
    const [showTopUp, setShowTopUp] = useState(false);
    const [showAdminLogin, setShowAdminLogin] = useState(false);
    const [isAdmin, setIsAdmin] = useState(false);
    const [adminLogin, setAdminLogin] = useState('');
    const [adminPassword, setAdminPassword] = useState('');
    const [isLoading, setIsLoading] = useState(true);
    const [currentGame, setCurrentGame] = useState(null);
    const [iceLobby, setIceLobby] = useState(null);
    const [myBet, setMyBet] = useState(25);
    const [hasBet, setHasBet] = useState(false);
    const [isReady, setIsReady] = useState(false);
    const [gameStatus, setGameStatus] = useState('waiting');
    const [ballPos, setBallPos] = useState({ x: 50, y: 50 });
    const [freeEliteSpin, setFreeEliteSpin] = useState(0);
    const [rouletteOffset, setRouletteOffset] = useState(0);
    const [fakeItems, setFakeItems] = useState([]);
    const [adminAttempts, setAdminAttempts] = useState(0);

    useEffect(() => {
        const init = async () => {
            let userId = 'guest_' + Date.now();
            let userData = { name: '–ì–æ—Å—Ç—å', id: userId };
            if (TelegramWebApp?.initDataUnsafe?.user) {
                const tg = TelegramWebApp.initDataUnsafe.user;
                userId = tg.id.toString();
                userData = { name: tg.first_name, avatar: tg.photo_url, id: userId };
            }
            setUser(userData);
            const snap = await db.ref('users/' + userId).once('value');
            const d = snap.val();
            if (d) { setBalance(d.balance || 0); setCases(d.cases || INITIAL_CASES); setInventory(d.inventory || []); setTasks(d.tasks || tasks); setInventorySlots(d.inventorySlots || 5); setFreeEliteSpin(d.freeEliteSpin || 0); }
            else { await db.ref('users/' + userId).set({ balance: 0, cases: INITIAL_CASES, inventory: [], tasks, inventorySlots: 5, freeEliteSpin: 0 }); }
            setIsLoading(false);
        };
        init();
    }, []);

    useEffect(() => { if (user?.id && !isLoading) db.ref('users/' + user.id).update({ balance, cases, inventory, tasks, inventorySlots, freeEliteSpin }); }, [balance, cases, inventory, tasks, inventorySlots, freeEliteSpin]);

    // –ê–í–¢–û-–í–û–ó–í–†–ê–¢ –°–¢–ê–í–ö–ò –ü–†–ò –í–´–•–û–î–ï –ò–ó –õ–û–ë–ë–ò
    useEffect(() => {
        const handleLeave = async () => {
            if (currentGame?.type === 'ice' && user && hasBet) {
                const snap = await db.ref(`iceLobbies/${currentGame.lobbyId}`).once('value');
                const lobby = snap.val();
                if (lobby && lobby.players && Object.keys(lobby.players).length === 1 && lobby.players[user.id]) {
                    await db.ref(`users/${user.id}/balance`).transaction(c => (c || 0) + myBet);
                    await db.ref(`iceLobbies/${currentGame.lobbyId}/players/${user.id}`).remove();
                }
            }
        };
        return () => { handleLeave(); };
    }, [currentGame, hasBet, myBet, user]);

    useEffect(() => {
        if (currentGame?.type === 'ice') {
            const ref = db.ref('iceLobbies/' + currentGame.lobbyId);
            ref.on('value', snap => {
                const d = snap.val();
                if (d) {
                    setIceLobby(d);
                    setGameStatus(d.status || 'waiting');
                    if (d.players?.[user.id]) {
                        setHasBet(true);
                        setMyBet(d.players[user.id].bet);
                        setIsReady(!!d.readyPlayers?.[user.id]);
                    } else { setHasBet(false); setIsReady(false); }
                }
            });
            return () => ref.off();
        }
    }, [currentGame, user?.id]);

    const openCase = async (caseId) => {
        const c = cases[caseId];
        if (c.locked) return alert('–ö–µ–π—Å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!');
        const price = c.freeCount > 0 ? 0 : (c.discountPrice || c.price);
        const freeSpin = caseId === 'elite' && freeEliteSpin > 0;
        if (price > 0 && balance < price && !freeSpin) return alert('–ú–∞–ª–æ –∑–≤–µ–∑–¥!');

        const balAfter = (freeSpin || price === 0) ? balance : balance - price;
        setBalance(balAfter);

        if (freeSpin && c.freeCount === 0) setFreeEliteSpin(s => s - 1);
        else if (c.freeCount > 0) setCases(p => ({ ...p, [caseId]: { ...p[caseId], freeCount: p[caseId].freeCount - 1 } }));

        setIsSpinning(true); setSelectedCase(c); setSpinResult(null);
        
        const items = CASE_REWARDS[caseId];
        const rand = Math.random() * 100; let cum = 0, won = items[0];
        for (const it of items) { cum += it.realChance; if (rand <= cum) { won = it; break; } }
        
        const tape = Array.from({length: 80}, () => items[Math.floor(Math.random() * items.length)]);
        tape[70] = won; setFakeItems(tape);
        
        const itemW = 130; const jitter = Math.random() * 80 - 40;
        const targetPos = (70 * itemW) + (itemW / 2) - (window.innerWidth / 2) + jitter;
        
        setRouletteOffset(0);
        setTimeout(() => setRouletteOffset(-targetPos), 50);
        
        setTimeout(() => {
            setSpinResult(won); setIsSpinning(false);
            if (won.type === 'stars') setBalance(b => b + won.value);
            else setInventory(inv => [...inv, { ...won, uid: Date.now() }]);
        }, 6500);
    };

    const placeBet = async () => {
        if (balance < myBet) return alert('–ú–∞–ª–æ –∑–≤–µ–∑–¥!');
        if ((iceLobby?.players && Object.keys(iceLobby.players).length < 1) && !hasBet) return;
        
        setBalance(b => b - myBet); setHasBet(true);
        await db.ref(`iceLobbies/${currentGame.lobbyId}/players/${user.id}`).set({ name: user.name, bet: myBet, avatar: user.avatar, color: `hsl(${Math.random() * 360}, 70%, 50%)`, timestamp: Date.now() });
    };

    const toggleReady = async () => {
        const ref = db.ref('iceLobbies/' + currentGame.lobbyId);
        const next = !isReady; setIsReady(next);
        await ref.child(`readyPlayers/${user.id}`).set(next ? true : null);
        const snap = await ref.once('value'); const d = snap.val();
        if (Object.keys(d.players || {}).length >= 2 && Object.keys(d.readyPlayers || {}).length >= 2) {
            await ref.update({ status: 'betting', timerEnd: Date.now() + 10000 });
            setTimeout(() => startIceGame(ref), 10000);
        }
    };
    
    const startIceGame = async (ref) => { /* –õ–æ–≥–∏–∫–∞ –¥–≤–∏–∂–µ–Ω–∏—è —à–∞—Ä–∞ */ };
    
    const finishIceGame = async (ref, fx, fy) => {
        const snap = await ref.once('value'); const d = snap.val();
        if (!d.players) return;
        const total = Object.values(d.players).reduce((s, p) => s + p.bet, 0);
        // ... –õ–æ–≥–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ–±–µ–¥–∏—Ç–µ–ª—è ...
        const winner = { id: Object.keys(d.players)[0], ...Object.values(d.players)[0] }; // –£–ø—Ä–æ—â–µ–Ω–Ω–æ
        await ref.update({ status: 'finished', winner });
        if (winner.id === user.id) setBalance(b => b + (total * 0.40));
    };

    if (isLoading || !user) return <div className="flex items-center justify-center h-screen"><p className="text-xl animate-pulse">–ó–∞–≥—Ä—É–∑–∫–∞...</p></div>;

    return (
        <div className="min-h-screen pb-24">
            <header className="p-4 flex justify-between items-center glass sticky top-0 z-50">
                <h1 onClick={() => setAdminAttempts(a => a + 1)} className="text-xl font-bold cursor-pointer">Step By Step</h1>
                <div className="bg-yellow-500 px-4 py-1 rounded-full text-black font-bold">{balance.toFixed(2)} ‚≠êÔ∏è</div>
            </header>
            
            <main className="p-4 max-w-md mx-auto">
                {currentScreen === 'cases' && (
                    <div className="grid grid-cols-2 gap-4">
                        {Object.values(cases).map(c => (
                            <div key={c.id} className={`glass p-4 rounded-xl text-center ${c.locked ? 'opacity-50' : 'hover:scale-105 transition'}`}>
                                {c.locked && <div className="absolute inset-0 bg-black/70 rounded-xl flex items-center justify-center">üîí</div>}
                                <div className="text-4xl mb-2">{c.emoji}</div>
                                <h3 className="font-bold">{c.name}</h3>
                                <p className="text-sm opacity-70">{c.freeCount > 0 ? '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ!' : `${c.price} ‚≠êÔ∏è`}</p>
                                <button onClick={() => !c.locked && setSelectedCase(c)} className="w-full mt-2 py-2 bg-indigo-600 rounded-lg font-bold">–û—Ç–∫—Ä—ã—Ç—å</button>
                            </div>
                        ))}
                    </div>
                )}
                {currentScreen === 'games' && <div onClick={() => setCurrentGame({type:'ice', lobbyId:1})} className="glass p-6 rounded-xl cursor-pointer text-center"><h3 className="text-2xl font-bold">‚òÉÔ∏è –õ–µ–¥—è–Ω–æ–π –ö–∞—Ç–æ–∫</h3></div>}
                {currentScreen === 'tasks' && <div className="glass p-4">...–ó–∞–¥–∞–Ω–∏—è...</div>}
                {currentScreen === 'profile' && <div className="glass p-4">...–ü—Ä–æ—Ñ–∏–ª—å...</div>}
            </main>

            {selectedCase && (
                <div className="fullscreen-modal flex items-center justify-center p-4">
                    <div className="w-full max-w-lg">
                        <h2 className="text-3xl font-bold mb-4">{selectedCase.name}</h2>
                        <div className="roulette-container">
                            <div className="roulette-pointer" />
                            <div className="roulette-inner" style={{ transform: `translateX(${rouletteOffset}px)`}}>
                                {fakeItems.map((item, i) => <div key={i} className="roulette-item"><div className="emoji">{item.emoji}</div></div>)}
                            </div>
                        </div>
                        {spinResult ? (
                            <div className="text-center mt-4"><p>–í—ã–ø–∞–ª–æ: {spinResult.name}</p><button onClick={() => setSelectedCase(null)}>–ó–∞–∫—Ä—ã—Ç—å</button></div>
                        ) : (
                            <button onClick={() => openCase(selectedCase.id)} disabled={isSpinning} className="w-full py-4 bg-indigo-600 rounded-xl">{isSpinning ? '–ö—Ä—É—Ç–∏–º...' : '–û—Ç–∫—Ä—ã—Ç—å'}</button>
                        )}
                    </div>
                </div>
            )}

            {currentGame?.type === 'ice' && (
                <div className="fixed inset-0 bg-blue-900/95 z-50 p-4">
                    <h2 className="text-xl font-bold mb-4">–õ–µ–¥—è–Ω–æ–π –ö–∞—Ç–æ–∫ <button onClick={()=>setCurrentGame(null)} className="float-right">‚úï</button></h2>
                    <div className="text-center">
                        {iceLobby && Object.keys(iceLobby.players || {}).length < 2 && !hasBet ? (
                            <div className="p-6 glass rounded-xl border-yellow-400 border animate-pulse">‚è≥ –û–∂–∏–¥–∞–µ–º –≤—Ç–æ—Ä–æ–≥–æ –∏–≥—Ä–æ–∫–∞...</div>
                        ) : (
                            <div>
                                {!hasBet && <button onClick={placeBet} className="w-full py-3 bg-blue-600 rounded-xl">–°–¥–µ–ª–∞—Ç—å —Å—Ç–∞–≤–∫—É ({myBet}‚≠êÔ∏è)</button>}
                                {hasBet && <button onClick={toggleReady} className={`w-full py-3 rounded-xl ${isReady ? 'bg-green-600' : 'bg-yellow-500'}`}>{isReady ? '‚úÖ –ì–æ—Ç–æ–≤' : '–ü—Ä–∏–≥–æ—Ç–æ–≤–∏—Ç—å—Å—è'}</button>}
                            </div>
                        )}
                    </div>
                </div>
            )}
            
            <nav className="fixed bottom-0 left-0 right-0 glass p-2 flex justify-around">
                {['tasks', 'cases', 'games', 'profile'].map(s => <button key={s} onClick={()=>setCurrentScreen(s)} className={`p-2 ${currentScreen===s ? 'text-blue-400':''}`}>{s.charAt(0).toUpperCase()}</button>)}
            </nav>
        </div>
    );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);

</script>
</body>
</html>
