<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Step By Step Game</title>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script>
tailwind.config = {
darkMode: 'class',
theme: {
extend: {
colors: { primary: '#6366f1', secondary: '#8b5cf6', accent: '#f59e0b', ice: '#00d2ff', }
}
}
}
</script>
<style>
@keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
.roulette-container { position: relative; width: 100%; height: 160px; overflow: hidden; background: rgba(0,0,0,0.4); border-radius: 16px; border: 2px solid rgba(255,255,255,0.1); margin: 20px 0; }
.roulette-inner { display: flex; position: absolute; left: 0; top: 20px; transition: transform 6.5s cubic-bezier(0.15, 0, 0.15, 1); will-change: transform; }
.roulette-item { width: 120px; height: 120px; flex-shrink: 0; margin: 0 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05)); border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); }
.roulette-item .emoji { font-size: 3.5rem; }
.roulette-item .name { font-size: 11px; opacity: 0.8; text-align: center; margin-top: 4px; }
.roulette-pointer { position: absolute; left: 50%; top: 0; bottom: 0; width: 4px; background: #ff4757; z-index: 20; transform: translateX(-50%); box-shadow: 0 0 20px #ff4757; }
.glass { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
.line-through { text-decoration: line-through; opacity: 0.5; }
.fullscreen-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 100; overflow-y: auto; }
.ice-circle { width: 320px; height: 320px; border-radius: 50%; border: 4px solid rgba(0,210,255,0.5); position: relative; overflow: hidden; background: radial-gradient(circle, rgba(0,210,255, 0%), rgba(0,128,255,0.2) 160px, rgba(0,128,255,0.4) 100%); box-shadow: 0 0 30px rgba(0,210,255,0.3); }
.ice-ball { position: absolute; width: 40px; height: 40px; background: radial-gradient(circle at 30% 30%, #fff, #00d2ff); border-radius: 50%; box-shadow: 0 0 20px rgba(0,210,255,0.8); z-index: 10; transform: translate(-50%, -50%); border: 2px solid rgba(255,255,255,0.5); transition: left 0.025s linear, top 0.025s linear; }
.player-avatar { position: absolute; width: 40px; height: 40px; border-radius: 50%; border: 2px solid white; overflow: hidden; transform: translate(-50%, -50%); z-index: 5; }
.case-cardboard { background: linear-gradient(135deg, #8B4513 0%, #D2691E 50%, #8B4513 100%); border: 3px solid #A0522D; }
.case-collector { background: linear-gradient(135deg, #DC143C 0%, #FF1493 50%, #8B008B 100%); border: 3px solid #FFD700; }
</style>
</head>
<body class="bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-600 min-h-screen text-white overflow-x-hidden">
<div id="root"></div>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script type="text/babel">
const { useState, useEffect, useRef } = React;
const firebaseConfig = {
apiKey: "AIzaSyDZPRiByz69HQa8b7GFMCJeqq56J3Y-bOY",
authDomain: "step-by-step-279df.firebaseapp.com",
databaseURL: "https://step-by-step-279df-default-rtdb.europe-west1.firebasedatabase.app",
projectId: "step-by-step-279df",
storageBucket: "step-by-step-279df.firebasestorage.app",
messagingSenderId: "302641152597",
appId: "1:302641152597:web:6479b9ae03104666cd8adc"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const TelegramWebApp = window.Telegram?.WebApp;
const ADMIN_WALLET = 'UQAWqaIPFSg81l9MlgAx0HBE9o3gpJMhk1dnyryKJXhWNHIc';
const TONCENTER_API = 'https://toncenter.com/api/v2';
const BOT_TOKEN = '8325421899:AAHRdmMYdjJMXmAVIynDsQtpUNsSeKkaOis';

const CASE_REWARDS = {
cardboard: [
{ id: 'stars_0_25', name: '0.25 ‚≠êÔ∏è', displayChance: '80%', realChance: 80, type: 'stars', value: 0.25, emoji: '‚≠êÔ∏è' },
{ id: 'stars_0_75', name: '0.75 ‚≠êÔ∏è', displayChance: '10%', realChance: 10, type: 'stars', value: 0.75, emoji: '‚≠êÔ∏è' },
{ id: 'stars_1_5', name: '1.5 ‚≠êÔ∏è', displayChance: '6%', realChance: 6, type: 'stars', value: 1.5, emoji: '‚≠êÔ∏è' },
{ id: 'stars_5', name: '5 ‚≠êÔ∏è', displayChance: '2%', realChance: 2, type: 'stars', value: 5, emoji: '‚≠êÔ∏è' },
{ id: 'bear', name: 'üß∏', displayChance: '1.5%', realChance: 1.5, type: 'item', sellPrice: 20, emoji: 'üß∏' },
{ id: 'diamond_pro', name: 'üíé PRO', displayChance: '0.5%', realChance: 0.5, type: 'collectible', emoji: 'üíé' }
],
coal: [
{ id: 'stars_2_5', name: '2.5 ‚≠êÔ∏è', displayChance: '60%', realChance: 60, type: 'stars', value: 2.5, emoji: '‚≠êÔ∏è' },
{ id: 'stars_5', name: '5 ‚≠êÔ∏è', displayChance: '18%', realChance: 18, type: 'stars', value: 5, emoji: '‚≠êÔ∏è' },
{ id: 'pickaxe', name: '–ö–∏—Ä–∫–∞ ‚õèÔ∏è', displayChance: '10%', realChance: 10, type: 'item', sellPrice: 10, emoji: '‚õèÔ∏è' },
{ id: 'stars_15', name: '15 ‚≠êÔ∏è', displayChance: '6%', realChance: 6, type: 'stars', value: 15, emoji: '‚≠êÔ∏è' },
{ id: 'material', name: '–ú–∞—Ç–µ—Ä–∏–∞–ª üß±', displayChance: '5%', realChance: 5, type: 'item', sellPrice: 40, emoji: 'üß±' },
{ id: 'brownie_pro', name: 'Happy Brownie PRO üí©', displayChance: '1%', realChance: 1, type: 'collectible', emoji: 'üí©' }
],
platinum: [
{ id: 'stars_35', name: '35 ‚≠êÔ∏è', displayChance: '55%', realChance: 55, type: 'stars', value: 35, emoji: '‚≠êÔ∏è' },
{ id: 'stars_50', name: '50 ‚≠êÔ∏è', displayChance: '35%', realChance: 35, type: 'stars', value: 50, emoji: '‚≠êÔ∏è' },
{ id: 'ring', name: 'üíç', displayChance: '5%', realChance: 5, type: 'collectible', emoji: 'üíç' },
{ id: 'bday', name: 'B-day üóì', displayChance: '4%', realChance: 4, type: 'item', sellPrice: 150, emoji: 'üóì' },
{ id: 'bday_pro', name: 'B-Day PRO üìÖ', displayChance: '1%', realChance: 1, type: 'collectible', emoji: 'üìÖ' }
],
gold: [
{ id: 'stars_50', name: '50 ‚≠êÔ∏è', displayChance: '50%', realChance: 50, type: 'stars', value: 50, emoji: '‚≠êÔ∏è' },
{ id: 'stars_125', name: '125 ‚≠êÔ∏è', displayChance: '35%', realChance: 35, type: 'stars', value: 125, emoji: '‚≠êÔ∏è' },
{ id: 'clover', name: 'üçÄ Clover Pin', displayChance: '10%', realChance: 10, type: 'item', sellPrice: 200, emoji: 'üçÄ' },
{ id: 'icecream', name: 'Ice Cream üç¶', displayChance: '3%', realChance: 3, type: 'collectible', emoji: 'üç¶' },
{ id: 'clover_pro', name: 'üçÄ Clover Pin PRO', displayChance: '2%', realChance: 2, type: 'collectible', emoji: 'üçÄ' }
],
money: [
{ id: 'stars_150', name: '150 ‚≠êÔ∏è', displayChance: '45%', realChance: 45, type: 'stars', value: 150, emoji: '‚≠êÔ∏è' },
{ id: 'stars_75', name: '75 ‚≠êÔ∏è', displayChance: '40%', realChance: 40, type: 'stars', value: 75, emoji: '‚≠êÔ∏è' },
{ id: 'trophy', name: 'üèÜ', displayChance: '5%', realChance: 5, type: 'collectible', emoji: 'üèÜ' },
{ id: 'gem', name: 'üíé', displayChance: '5%', realChance: 5, type: 'collectible', emoji: 'üíé' },
{ id: 'bday_happy', name: 'Happy B-day üíà', displayChance: '4%', realChance: 4, type: 'collectible', emoji: 'üíà' },
{ id: 'cigar', name: 'Snoop Cigar üö¨', displayChance: '1%', realChance: 1, type: 'collectible', emoji: 'üö¨' }
],
elite: [
{ id: 'stars_200', name: '200 ‚≠êÔ∏è', displayChance: '75%', realChance: 75, type: 'stars', value: 200, emoji: '‚≠êÔ∏è' },
{ id: 'stars_275', name: '275 ‚≠êÔ∏è', displayChance: '5%', realChance: 5, type: 'stars', value: 275, emoji: '‚≠êÔ∏è' },
{ id: 'champagne', name: 'üçæ', displayChance: '17%', realChance: 17, type: 'collectible', emoji: 'üçæ' },
{ id: 'socks', name: '–ù–æ—Å–∫–∏ üß¶', displayChance: '2%', realChance: 2, type: 'collectible', emoji: 'üß¶' },
{ id: 'lightsword', name: 'Light Sword ‚öîÔ∏è', displayChance: '1%', realChance: 1, type: 'collectible', emoji: '‚öîÔ∏è' }
],
diamond: [
{ id: 'stars_8', name: '8 ‚≠êÔ∏è', displayChance: '70%', realChance: 70, type: 'stars', value: 8, emoji: '‚≠êÔ∏è' },
{ id: 'bear', name: '–ú–∏—à–∫–∞ üß∏', displayChance: '15%', realChance: 15, type: 'item', sellPrice: 20, emoji: 'üß∏' },
{ id: 'stars_25', name: '25 ‚≠êÔ∏è', displayChance: '9%', realChance: 9, type: 'stars', value: 25, emoji: '‚≠êÔ∏è' },
{ id: 'stars_80', name: '80 ‚≠êÔ∏è', displayChance: '4%', realChance: 4, type: 'stars', value: 80, emoji: '‚≠êÔ∏è' },
{ id: 'diamond_pro', name: '–ê–ª–º–∞–∑ PRO üíé', displayChance: '0.6%', realChance: 0.6, type: 'collectible', emoji: 'üíé' },
{ id: 'snoop_pro', name: 'Snoop Dog PRO üêï', displayChance: '0.4%', realChance: 0.4, type: 'collectible', emoji: 'üêï' }
],
winter: [
{ id: 'stars_20', name: '20 ‚≠êÔ∏è', displayChance: '60%', realChance: 60, type: 'stars', value: 20, emoji: '‚≠êÔ∏è' },
{ id: 'stars_35', name: '35 ‚≠êÔ∏è', displayChance: '35%', realChance: 35, type: 'stars', value: 35, emoji: '‚≠êÔ∏è' },
{ id: 'stars_80', name: '80 ‚≠êÔ∏è', displayChance: '3.5%', realChance: 3.5, type: 'stars', value: 80, emoji: '‚≠êÔ∏è' },
{ id: 'snake', name: 'üéÑ Lunar Snake 2025 üêç', displayChance: '1%', realChance: 1, type: 'collectible', emoji: 'üêç' },
{ id: 'scarf', name: 'üß£ –ó–∏–º–Ω–µ–µ —Å–æ–∫—Ä–æ–≤–∏—â–µ', displayChance: '0.5%', realChance: 0.5, type: 'collectible', emoji: 'üß£' }
],
major: [
{ id: 'stars_500', name: '500 ‚≠êÔ∏è', displayChance: '50%', realChance: 50, type: 'stars', value: 500, emoji: '‚≠êÔ∏è' },
{ id: 'stars_1000', name: '1000 ‚≠êÔ∏è', displayChance: '25%', realChance: 25, type: 'stars', value: 1000, emoji: '‚≠êÔ∏è' },
{ id: 'stars_2500', name: '2500 ‚≠êÔ∏è', displayChance: '10%', realChance: 10, type: 'stars', value: 2500, emoji: '‚≠êÔ∏è' },
{ id: 'stars_5000', name: '5000 ‚≠êÔ∏è', displayChance: '5%', realChance: 5, type: 'stars', value: 5000, emoji: '‚≠êÔ∏è' },
{ id: 'car', name: 'üöó –ê–≤—Ç–æ–º–æ–±–∏–ª—å', displayChance: '5%', realChance: 5, type: 'collectible', emoji: 'üöó' },
{ id: 'diamond_ring', name: 'üíç –ë—Ä–∏–ª–ª–∏–∞–Ω—Ç–æ–≤–æ–µ –∫–æ–ª—å—Ü–æ', displayChance: '3%', realChance: 3, type: 'collectible', emoji: 'üíç' },
{ id: 'gold_bar', name: 'ü•á –ó–æ–ª–æ—Ç–æ–π —Å–ª–∏—Ç–æ–∫', displayChance: '2%', realChance: 2, type: 'collectible', emoji: 'ü•á' }
],
collector: [
{ id: 'bear_pro', name: 'üß∏ PRO', displayChance: '55%', realChance: 55, type: 'collectible', emoji: 'üß∏' },
{ id: 'gift_pro', name: 'üéÅ PRO', displayChance: '20%', realChance: 20, type: 'collectible', emoji: 'üéÅ' },
{ id: 'rocket_pro', name: 'üöÄ PRO', displayChance: '15%', realChance: 15, type: 'collectible', emoji: 'üöÄ' },
{ id: 'cup_pro', name: 'üèÜ PRO', displayChance: '5%', realChance: 5, type: 'collectible', emoji: 'üèÜ' },
{ id: 'cake_candle', name: 'üç∞B-day Candle', displayChance: '2%', realChance: 2, type: 'collectible', emoji: 'üç∞' },
{ id: 'ramen_pro', name: 'üçúRamen PRO', displayChance: '1.5%', realChance: 0.5, type: 'collectible', emoji: 'üçú' },
{ id: 'hat_pro', name: 'üé© Top hat', displayChance: '1%', realChance: 0, type: 'collectible', emoji: 'üé©' },
{ id: 'bird_pro', name: 'ü¶ÖRare bird', displayChance: '0.5%', realChance: 0, type: 'collectible', emoji: 'ü¶Ö' }
]
};

const INITIAL_CASES = {
cardboard: { id: 'cardboard', name: '–ö–∞—Ä—Ç–æ–Ω', emoji: 'üì¶', price: 3, color: 'from-amber-800 to-amber-900', locked: false, isNew: true, freeCount: 0 },
coal: { id: 'coal', name: '–£–≥–æ–ª—ë–∫', emoji: 'ü™®', price: 22, originalPrice: 22, discountPrice: 20, color: 'from-gray-600 to-gray-800', locked: false, isNew: false, freeCount: 0 },
platinum: { id: 'platinum', name: '–ü–ª–∞—Ç–∏–Ω–∞', emoji: 'üíé', price: 100, color: 'from-gray-300 to-gray-500', locked: false },
gold: { id: 'gold', name: '–ó–æ–ª–æ—Ç–æ–π', emoji: 'üëë', price: 250, color: 'from-yellow-400 to-yellow-600', locked: false },
money: { id: 'money', name: '–î–µ–Ω–µ–∂–Ω—ã–π', emoji: 'üíµ', price: 350, color: 'from-green-400 to-green-600', locked: false },
elite: { id: 'elite', name: '–≠–ª–∏—Ç–∞', emoji: 'üéñ', price: 500, color: 'from-red-400 to-red-600', locked: false, isNew: false, freeCount: 0 },
diamond: { id: 'diamond', name: '–ê–ª–º–∞–∑', emoji: 'üíé', price: 50, originalPrice: 50, discountPrice: 35, color: 'from-blue-400 to-blue-600', locked: false, isNew: false, freeCount: 0 },
winter: { id: 'winter', name: '–ó–∏–º–Ω–∏–π', emoji: '‚òÉÔ∏è', price: 125, originalPrice: 150, discountPrice: 125, color: 'from-cyan-400 to-blue-500', locked: false, isNew: true, freeCount: 0 },
major: { id: 'major', name: '–ú–∞–∂–æ—Ä', emoji: 'ü§¥', price: 800, color: 'from-purple-500 to-indigo-700', locked: true, isNew: false, freeCount: 0 },
collector: { id: 'collector', name: '–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–µ—Ä', emoji: 'üé©', price: 650, color: 'from-rose-600 to-pink-800', locked: true, isNew: true, freeCount: 0 }
};

const ICE_ARENA_PRIZES = [
{ id: 'bear', name: 'üß∏ –ú–∏—à–∫–∞', chance: 40, type: 'item', sellPrice: 20, emoji: 'üß∏' },
{ id: 'gloves', name: 'üß§ –í–∞—Ä–µ–∂–∫–∏', chance: 30, type: 'item', sellPrice: 50, emoji: 'üß§' },
{ id: 'fire', name: 'üî• –û–≥–æ–Ω—å', chance: 10, type: 'special', emoji: 'üî•', message: '–í—ã —Ä–∞—Å—Ç–æ–ø–∏–ª–∏ –ª–µ–¥! –ü–æ–ª—É—á–∞–µ—Ç–µ 40% –æ—Ç —Å—Ç–∞–≤–æ–∫' },
{ id: 'snow', name: '‚ùÑÔ∏è –°–Ω–µ–∂–∏–Ω–∫–∞', chance: 5, type: 'item', sellPrice: 125, emoji: '‚ùÑÔ∏è' },
{ id: 'snoop', name: 'üêï Snoop Dog', chance: 5, type: 'item', sellPrice: 130, emoji: 'üêï' },
{ id: 'winter_case', name: '‚òÉÔ∏è –ö–µ–π—Å –ó–∏–º–Ω–∏–π', chance: 4, type: 'case_free', caseType: 'winter', emoji: '‚òÉÔ∏è' },
{ id: 'elite_case', name: 'üéñ –ö–µ–π—Å –≠–ª–∏—Ç–Ω—ã–π', chance: 3, type: 'case_free', caseType: 'elite', emoji: 'üéñ' },
{ id: 'stars_350', name: '350 ‚≠êÔ∏è', chance: 2, type: 'stars', value: 350, emoji: '350‚≠êÔ∏è' },
{ id: 'scarf', name: 'üß£ –ó–∏–º–Ω–µ–µ —Å–æ–∫—Ä–æ–≤–∏—â–µ', chance: 0.5, type: 'collectible', emoji: 'üß£' },
{ id: 'dellko', name: 'üîë Promocode DELLKO', chance: 0.5, type: 'promo', code: 'DELLKO', emoji: 'üîë' }
];

const TON_RATES = [ { stars: 50, ton: 0.6 }, { stars: 250, ton: 3 }, { stars: 500, ton: 6 }, { stars: 1000, ton: 12 } ];
const STARS_PACKAGES = [ { stars: 50, price: 50, name: '50 –∑–≤–µ–∑–¥' }, { stars: 100, price: 100, name: '100 –∑–≤–µ–∑–¥' }, { stars: 250, price: 250, name: '250 –∑–≤–µ–∑–¥' }, { stars: 500, price: 500, name: '500 –∑–≤–µ–∑–¥' }, { stars: 1000, price: 1000, name: '1000 –∑–≤–µ–∑–¥' } ];
    function App() {
const [currentScreen, setCurrentScreen] = useState('cases');
const [balance, setBalance] = useState(0);
const [cases, setCases] = useState(INITIAL_CASES);
const [inventory, setInventory] = useState([]);
const [inventorySlots, setInventorySlots] = useState(5);
const [tasks, setTasks] = useState({ subscribe: { completed: false }, depositMajor: { completed: false } });
const [user, setUser] = useState(null);

const [selectedCase, setSelectedCase] = useState(null);
const [isSpinning, setIsSpinning] = useState(false);
const [spinResult, setSpinResult] = useState(null);
const [rouletteOffset, setRouletteOffset] = useState(0);
const [fakeItems, setFakeItems] = useState([]);
const [rouletteKey, setRouletteKey] = useState(0);
const rouletteContainerRef = useRef(null);
const [determinedWinner, setDeterminedWinner] = useState(null);

const [showTopUp, setShowTopUp] = useState(false);
const [promoCode, setPromoCode] = useState('');
const [usedPromos, setUsedPromos] = useState([]);
const [wonPromos, setWonPromos] = useState([]);

const [adminAttempts, setAdminAttempts] = useState(0);
const [showAdminLogin, setShowAdminLogin] = useState(false);
const [isAdmin, setIsAdmin] = useState(false);
const [adminLogin, setAdminLogin] = useState('');
const [adminPassword, setAdminPassword] = useState('');
const [adminScreen, setAdminScreen] = useState('stats');
const [allUsers, setAllUsers] = useState([]);
const [selectedUser, setSelectedUser] = useState(null);

const [showCollectibleModal, setShowCollectibleModal] = useState(false);
const [selectedCollectible, setSelectedCollectible] = useState(null);
const [isLoading, setIsLoading] = useState(true);

const [currentGame, setCurrentGame] = useState(null);
const [iceLobby, setIceLobby] = useState(null);
const [myBet, setMyBet] = useState(25);
const [hasBet, setHasBet] = useState(false);
const [gameStatus, setGameStatus] = useState('waiting');
const [ballPos, setBallPos] = useState({ x: 50, y: 50 });
const [showPrizeChest, setShowPrizeChest] = useState(false);
const [chestPrizes, setChestPrizes] = useState([]);
const [openedChestCount, setOpenedChestCount] = useState(0);
const [showNewGamePrompt, setShowNewGamePrompt] = useState(false);
const [timerRemaining, setTimerRemaining] = useState(0);
const [showIceGiftModal, setShowIceGiftModal] = useState(false);
const [selectedIceGift, setSelectedIceGift] = useState(null);
const [withdrawAmount, setWithdrawAmount] = useState('');
const [showWithdrawModal, setShowWithdrawModal] = useState(false);
const [totalDeposits, setTotalDeposits] = useState(0);
const [freeEliteSpin, setFreeEliteSpin] = useState(0);
const [icePlayerCount, setIcePlayerCount] = useState(0);

useEffect(() => {
const initApp = async () => {
let userId = localStorage.getItem('sbs_user_id');
let userData = { name: '–ì–æ—Å—Ç—å', username: null, avatar: null };
const tgUser = TelegramWebApp?.initDataUnsafe?.user;

if (tgUser) {
  userId = tgUser.id.toString();
  localStorage.setItem('sbs_user_id', userId);
  userData = { name: tgUser.first_name + (tgUser.last_name ? ' ' + tgUser.last_name : ''), username: tgUser.username ? '@' + tgUser.username : null, avatar: tgUser.photo_url || null };
} else if (!userId) {
  userId = 'guest_' + Date.now();
  localStorage.setItem('sbs_user_id', userId);
}

const userRef = db.ref('users/' + userId);
userRef.on('value', snap => {
  const data = snap.val();
  if (data) {
    setUser({ id: userId, ...data });
    setBalance(data.balance || 0);
    setCases(data.cases || INITIAL_CASES);
    setInventory(data.inventory || []);
    setTasks(data.tasks || { subscribe: { completed: false } });
    setInventorySlots(data.inventorySlots || 5);
    setUsedPromos(data.usedPromos || []);
    setTotalDeposits(data.totalDeposits || 0);
    setFreeEliteSpin(data.freeEliteSpin || 0);
    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∏–º—è –≤ –±–∞–∑–µ
    userRef.update({ name: userData.name, username: userData.username });
  } else {
    const newUser = { ...userData, balance: 15, cases: INITIAL_CASES, inventory: [], inventorySlots: 5, usedPromos: [], totalDeposits: 0, freeEliteSpin: 0 };
    setUser({ id: userId, ...newUser });
    userRef.set(newUser);
  }
  setIsLoading(false);
});
};
initApp();
}, []);

useEffect(() => {
if (currentGame?.type === 'ice' && currentGame.lobbyId) {
const lobbyRef = db.ref('iceLobbies/' + currentGame.lobbyId);
lobbyRef.on('value', snap => {
const data = snap.val();
if (data) {
setIceLobby(data);
setGameStatus(data.status || 'waiting');
const pCount = data.players ? Object.keys(data.players).length : 0;
setIcePlayerCount(pCount);
if (data.players?.[user?.id]) {
setHasBet(data.players[user.id].bet > 0);
} else {
setHasBet(false);
}
if (data.ballPosition) setBallPos(data.ballPosition);
if (data.timerEnd && data.status === 'betting') {
const remaining = Math.max(0, Math.ceil((data.timerEnd - Date.now()) / 1000));
setTimerRemaining(remaining);
}
if (data.status === 'finished' && data.winner?.id === user.id && !data.prizeClaimed?.[user.id]) {
const winAmount = Math.floor(data.totalPot * 0.4);
alert(`–ü–û–ë–ï–î–ê! –í—ã–∏–≥—Ä—ã—à: ${winAmount} ‚≠êÔ∏è`);
db.ref('users/'+user.id+'/balance').transaction(b => (b || 0) + winAmount);
lobbyRef.child('prizeClaimed/'+user.id).set(true);
}
}
});
return () => lobbyRef.off();
}
}, [currentGame, user?.id]);

const handleTitleClick = () => {
const newAttempts = adminAttempts + 1;
setAdminAttempts(newAttempts);
if (newAttempts >= 11) {
setShowAdminLogin(true);
setAdminAttempts(0);
}
};

const checkAdminLogin = () => {
if (adminLogin === '_*\\^BAGUETTE_642819_6281' && adminPassword === '3628874910ZTWMI_') {
setIsAdmin(true);
setShowAdminLogin(false);
db.ref('users').once('value').then(snap => {
const users = [];
snap.forEach(child => users.push({ id: child.key, ...child.val() }));
setAllUsers(users);
});
} else {
alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω!');
}
};

const adminGiveReward = async (targetUserId, reward) => {
if (reward.type === 'stars') {
await db.ref('users/' + targetUserId + '/balance').transaction(b => (b || 0) + reward.amount);
} else if (reward.type === 'case') {
await db.ref('users/' + targetUserId + `/cases/${reward.caseType}/freeCount`).transaction(c => (c || 0) + reward.count);
} else if (reward.type === 'item') {
const snapshot = await db.ref('users/' + targetUserId).once('value');
const userData = snapshot.val() || {};
const newItem = { ...reward.item, uniqueId: Date.now() };
await db.ref('users/' + targetUserId + '/inventory').set([...(userData.inventory || []), newItem]);
} else if (reward.type === 'unlock_collector') {
await db.ref('users/' + targetUserId + '/totalDeposits').set(350);
}
alert('–ù–∞–≥—Ä–∞–¥–∞ –≤—ã–¥–∞–Ω–∞!');
};

const joinIceLobby = async (lobbyId) => {
const lobbyRef = db.ref('iceLobbies/' + lobbyId);
const snap = await lobbyRef.once('value');
const data = snap.val() || { status: 'waiting', players: {} };

if (data.status === 'playing') {
alert('–ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å! –í—ã –º–æ–∂–µ—Ç–µ —Ç–æ–ª—å–∫–æ –Ω–∞–±–ª—é–¥–∞—Ç—å.');
setCurrentGame({ type: 'ice', lobbyId, spectator: true });
return;
}

await lobbyRef.child('players/' + user.id).set({
id: user.id,
name: user.name,
avatar: user.avatar,
bet: 0,
color: `hsl(${Math.random() * 360}, 70%, 50%)`
});

setCurrentGame({ type: 'ice', lobbyId, spectator: false });
};

const placeBet = async () => {
if (balance < myBet) { alert("–ú–∞–ª–æ –∑–≤–µ–∑–¥!"); return; }
if (myBet < 25) { alert("–ú–∏–Ω–∏–º—É–º 25‚≠êÔ∏è!"); return; }

const lobbyRef = db.ref('iceLobbies/' + currentGame.lobbyId);
await db.ref('users/'+user.id+'/balance').transaction(b => b - myBet);
await lobbyRef.child('players/' + user.id).update({ bet: myBet });

setHasBet(true);

const snap = await lobbyRef.once('value');
const d = snap.val();
const players = Object.values(d.players || {});
const allBetted = players.length >= 2 && players.every(p => p.bet > 0);

if (allBetted && d.status === 'waiting') {
const tEnd = Date.now() + 10000;
await lobbyRef.update({ status: 'betting', timerEnd: tEnd, totalPot: players.reduce((s,p)=>s+p.bet, 0) });
setTimeout(() => startIceGame(lobbyRef), 10000);
}
};

const startIceGame = async (lobbyRef) => {
// ...
};

const finishIceGame = async (ref, fx, fy) => {
// ...
};

const leaveLobby = async () => {
const lobbyRef = db.ref('iceLobbies/' + currentGame.lobbyId);
const myData = iceLobby?.players?.[user.id];
if (myData?.bet > 0 && iceLobby.status !== 'playing') {
await db.ref('users/'+user.id+'/balance').transaction(b => (b||0) + myData.bet);
}
await lobbyRef.child('players/' + user.id).remove();
const remain = iceLobby?.players ? Object.keys(iceLobby.players).length - 1 : 0;
if (remain <= 0) {
await lobbyRef.set({status:'waiting', players:{}, ready:{}});
}
lobbyRef.off();
setCurrentGame(null);
setIceLobby(null);
};

const openCase = async (caseType) => {
const c = cases[caseType];
if(c.locked) { return alert("–≠—Ç–æ—Ç –∫–µ–π—Å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω"); }
const price = c.freeCount > 0 ? 0 : c.price;
if (balance < price) return alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–≤–µ–∑–¥!");

const balAfter = balance - price;
if(c.freeCount > 0) { await db.ref(`users/${user.id}/cases/${caseType}/freeCount`).transaction(c => (c || 0) - 1); }
else { await db.ref('users/'+user.id+'/balance').set(balAfter); }

setIsSpinning(true);
setSelectedCase({...c, id: caseType});
setSpinResult(null);
setRouletteOffset(0);
setFakeItems([]);
setRouletteKey(k => k + 1);

const pool = CASE_REWARDS[caseType];
const rand = Math.random() * 100;
let cum=0, won=pool[0];
for(const i of pool){ cum+=i.realChance; if(rand<=cum){ won=i; break; } }
setDeterminedWinner(won);

const tape = [];
for(let i=0; i<80; i++) tape.push(pool[Math.floor(Math.random()*pool.length)]);
tape[70] = won;

setTimeout(() => {
setFakeItems(tape);
setTimeout(() => {
const containerWidth = rouletteContainerRef.current?.offsetWidth || window.innerWidth;
const itemFullWidth = 136;
const targetPos = (70 * itemFullWidth) + (itemFullWidth / 2) - (containerWidth / 2);
setRouletteOffset(-targetPos);
}, 100);
}, 100);

setTimeout(async () => {
setSpinResult(determinedWinner);
setIsSpinning(false);
if (determinedWinner.type === 'stars') {
await db.ref('users/'+user.id+'/balance').set(balAfter + determinedWinner.value);
} else {
const inv = [...(inventory || []), { ...determinedWinner, uniqueId: Date.now() }];
await db.ref('users/'+user.id+'/inventory').set(inv.slice(0, inventorySlots));
}
}, 6600);
};

const sellItem = async (item) => {
if (item.type === 'collectible') {
setSelectedCollectible(item);
setShowCollectibleModal(true);
return;
}
if (confirm(`–ü—Ä–æ–¥–∞—Ç—å ${item.name} –∑–∞ ${item.sellPrice}‚≠êÔ∏è?`)) {
const newInventory = inventory.filter(i => i.uniqueId !== item.uniqueId);
db.ref('users/'+user.id).update({
balance: balance + item.sellPrice,
inventory: newInventory
});
}
};

const buySlot = async () => {
if (balance < 50) return alert("–ù—É–∂–Ω–æ 50 ‚≠êÔ∏è");
await db.ref('users/'+user.id).update({
balance: balance - 50,
inventorySlots: (inventorySlots || 5) + 1
});
};

const checkPromo = async () => {
const code = promoCode.toUpperCase();
if (usedPromos.includes(code)) { alert("–£–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω!"); return; }
if(code === 'DIAMOND') {
await db.ref(`users/${user.id}/cases/diamond/freeCount`).transaction(c => (c || 0) + 2);
await db.ref(`users/${user.id}/usedPromos`).set([...(usedPromos||[]), code]);
alert("–ü–æ–ª—É—á–µ–Ω–æ 2 –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –∫–µ–π—Å–∞ –ê–ª–º–∞–∑!");
setPromoCode('');
} else {
alert("–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥");
}
};

const completeTask = async (taskId) => {
if(taskId === 'subscribe') {
window.open('https://t.me/stepbystepdelision');
await db.ref(`users/${user.id}/freeEliteSpin`).transaction(c => (c || 0) + 1);
alert("–í—ã–¥–∞–Ω 1 –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ø—Ä–æ–∫—Ä—É—Ç –≠–ª–∏—Ç—ã!");
}
};

if(isLoading) return <div className="h-screen flex items-center justify-center font-bold">–ó–ê–ì–†–£–ó–ö–ê...</div>;
if(isAdmin) return (
<div className="p-4">
<div className="flex justify-between items-center mb-4">
<h2 className="text-2xl font-bold">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h2>
<button onClick={() => setIsAdmin(false)} className="bg-red-500 px-3 py-1 rounded">–í—ã—Ö–æ–¥</button>
</div>
<div className="mb-4">
<h3 className="font-bold mb-2">–ù–∞–≥—Ä–∞–¥–∏—Ç—å —Å–µ–±—è</h3>
<div className="grid grid-cols-2 gap-2">
<button onClick={() => adminGiveReward(user.id, {type:'stars', amount: 5000})} className="bg-green-600 p-2 rounded">+5000‚≠êÔ∏è</button>
<button onClick={() => adminGiveReward(user.id, {type:'unlock_collector'})} className="bg-purple-600 p-2 rounded">üîì –ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–µ—Ä</button>
</div>
</div>
<div>
<h3 className="font-bold mb-2">–í—Å–µ –∏–≥—Ä–æ–∫–∏</h3>
{allUsers.map(u => (
<div key={u.id} className="bg-gray-800 p-2 mb-2 flex justify-between">
<span>{u.name} ({u.balance})</span>
<button onClick={() => adminGiveReward(u.id, {type:'stars', amount: 500})} className="bg-green-600 px-2 rounded">+500</button>
</div>
))}
</div>
</div>
);

return (
<div className="min-h-screen pb-24">
<header className="p-4 flex justify-between items-center glass sticky top-0 z-50">
<h1 onClick={handleTitleClick} className="text-xl font-bold cursor-pointer">Step By Step</h1>
<div className="bg-yellow-400 text-black px-4 py-1 rounded-full font-bold">{balance.toFixed(2)}‚≠êÔ∏è</div>
</header>
<main className="p-4">
{currentScreen === 'cases' && (
<div className="grid grid-cols-2 gap-4">
{Object.values(cases).map(c => {
const locked = c.locked && (c.id !== 'collector' || totalDeposits < 350);
return (
<div key={c.id} onClick={() => !locked && openCase(c.id)} className={`glass p-4 rounded-2xl flex flex-col items-center ${locked ? 'opacity-50' : ''} ${c.cls}`}>
<div className="text-5xl mb-2">{c.emoji}</div>
<h3 className="font-bold">{c.name}</h3>
<p className="text-sm opacity-70">{c.freeCount > 0 ? `–ë–µ—Å–ø–ª–∞—Ç–Ω–æ: ${c.freeCount}` : `${c.price}‚≠êÔ∏è`}</p>
</div>
);
})}
</div>
)}
{currentScreen === 'games' && (
<div onClick={() => joinIceLobby(1)} className="p-8 rounded-3xl glass border-2 border-ice/30 text-center cursor-pointer">
<div className="text-7xl mb-4">‚òÉÔ∏è</div>
<h2 className="text-2xl font-bold text-ice">–õ–µ–¥—è–Ω–æ–π –ö–∞—Ç–æ–∫</h2>
</div>
)}
{currentScreen === 'tasks' && (
<div className="space-y-4">
<div className="glass p-4 rounded-2xl flex justify-between items-center">
<div>
<div className="font-bold">–ü–æ–¥–ø–∏—Å–∫–∞</div>
<div className="text-xs opacity-50">+1 –ø—Ä–æ–∫—Ä—É—Ç –≠–ª–∏—Ç—ã</div>
</div>
<button onClick={() => completeTask('subscribe')} className="bg-blue-600 px-4 py-1 rounded-lg text-sm">OK</button>
</div>
<div className="glass p-4 rounded-2xl">
<div className="font-bold">–î–µ–ø–æ–∑–∏—Ç 350‚≠êÔ∏è</div>
<p className="text-xs opacity-50">–†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ—Ç –ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–µ—Ä–∞</p>
<div className="w-full bg-gray-700 h-2 rounded mt-2"><div className="bg-yellow-400 h-2 rounded" style={{width: `${Math.min(totalDeposits / 350 * 100, 100)}%`}}></div></div>
</div>
</div>
)}
{currentScreen === 'profile' && (
<div className="space-y-4">
<div className="glass p-4 rounded-2xl">
<div className="flex justify-between items-center mb-2"><h3 className="font-bold">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</h3><span>{inventory.length}/{inventorySlots}</span></div>
<div className="grid grid-cols-4 gap-2 mb-4">
{[...Array(inventorySlots)].map((_,i) => (
<div key={i} onClick={() => inventory[i] && sellItem(inventory[i])} className="aspect-square bg-white/10 rounded-lg flex items-center justify-center text-2xl">
{inventory[i]?.emoji}
</div>
))}
</div>
<button onClick={buySlot} className="w-full bg-gray-700 py-2 rounded-lg text-xs">+1 –°–ª–æ—Ç (50‚≠êÔ∏è)</button>
</div>
<div className="glass p-4 rounded-2xl">
<h3 className="font-bold mb-2">–ü—Ä–æ–º–æ–∫–æ–¥</h3>
<div className="flex gap-2">
<input value={promoCode} onChange={e=>setPromoCode(e.target.value)} className="bg-black/30 p-2 rounded flex-1 outline-none" />
<button onClick={checkPromo} className="bg-blue-600 px-4 rounded">OK</button>
</div>
</div>
</div>
)}
</main>
{selectedCase && (
<div className="fullscreen-modal" key={rouletteKey}>
<div className="w-full max-w-lg p-4" ref={rouletteContainerRef}>
<h3 className="text-2xl font-bold text-center mb-4">{isSpinning ? "–£–¥–∞—á–∏!" : spinResult?.name}</h3>
<div className="roulette-container">
<div className="roulette-pointer"></div>
<div className="roulette-inner" style={{ transform: `translateX(${rouletteOffset}px)` }}>
{fakeItems.map((item,i) => <div key={i} className="roulette-item"><div className="emoji">{item.emoji}</div><div className="name">{item.name}</div></div>)}
</div>
</div>
{!isSpinning && spinResult && <button onClick={() => setSelectedCase(null)} className="w-full py-3 bg-green-500 rounded-xl font-bold">–ó–∞–±—Ä–∞—Ç—å</button>}
</div>
</div>
)}
{showCollectibleModal && (
<div className="fullscreen-modal">
<div className="glass p-6 rounded-2xl text-center max-w-xs">
<div className="text-6xl mb-4">{selectedCollectible?.emoji}</div>
<h3 className="text-xl font-bold mb-2">–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω—ã–π –ø—Ä–µ–¥–º–µ—Ç!</h3>
<p className="mb-4">–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞–≥—Ä–∞–¥—ã –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ <a href="https://t.me/stepbystepdelision" target="_blank" className="text-blue-400 underline">–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏</a>.</p>
<button onClick={() => setShowCollectibleModal(false)} className="w-full bg-indigo-600 py-3 rounded-xl">OK</button>
</div>
</div>
)}
<nav className="fixed bottom-0 left-0 right-0 glass p-2 flex justify-around rounded-t-3xl border-t border-white/10">
{['tasks', 'cases', 'games', 'profile'].map(s => <button key={s} onClick={() => setCurrentScreen(s)} className={`nav-btn ${currentScreen === s ? 'active' : ''}`}><span>{s[0].toUpperCase()}</span><span>{s}</span></button>)}
</nav>
</div>
);
}
ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
