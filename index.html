<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Step By Step Game</title>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script>
tailwind.config = {
    darkMode: 'class',
    theme: {
        extend: {
            colors: { primary: '#6366f1', secondary: '#8b5cf6', accent: '#f59e0b', ice: '#00d2ff' }
        }
    }
}
</script>
<style>
@keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
/* –ù–û–í–ê–Ø –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –ê–ù–ò–ú–ê–¶–ò–Ø */
.roulette-container {
    position: relative; width: 100%; height: 160px; overflow: hidden;
    background: rgba(0, 0, 0, 0.5); border-radius: 16px;
    border: 2px solid rgba(255, 255, 255, 0.15); box-shadow: inset 0 0 30px rgba(0,0,0,0.9);
}
.roulette-inner {
    display: flex; position: absolute; left: 0; top: 15px;
    will-change: transform;
}
.roulette-item {
    width: 120px; height: 130px; flex-shrink: 0; margin: 0 8px;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.02));
    border-radius: 14px; border: 1px solid rgba(255,255,255,0.1);
}
.roulette-item .emoji { font-size: 3.5rem; }
.roulette-item .name { font-size: 0.7rem; margin-top: 6px; color: #cbd5e1; text-align: center; }
.roulette-pointer {
    position: absolute; left: 50%; top: 0; bottom: 0; width: 4px;
    background: #ff4757; z-index: 30; transform: translateX(-50%);
    box-shadow: 0 0 25px #ff4757;
}
.glass { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
.ice-circle { width: 320px; height: 320px; border-radius: 50%; border: 4px solid rgba(0,210,255,0.5); position: relative; overflow: hidden; background: radial-gradient(circle, rgba(0,210,255, 0%), rgba(0,128,255,0.2) 160px, rgba(0,128,255,0.4) 100%); box-shadow: 0 0 30px rgba(0,210,255,0.3); }
.ice-ball { position: absolute; width: 40px; height: 40px; background: radial-gradient(circle at 30% 30%, #fff, #00d2ff); border-radius: 50%; z-index: 10; transform: translate(-50%, -50%); transition: left 0.025s linear, top 0.025s linear; border: 2px solid white; }
.player-avatar { position: absolute; width: 40px; height: 40px; border-radius: 50%; border: 2px solid white; overflow: hidden; transform: translate(-50%, -50%); z-index: 5; }
.case-cardboard { background: linear-gradient(135deg, #8B4513 0%, #D2691E 50%, #8B4513 100%); border: 3px solid #A0522D; }
.case-collector { background: linear-gradient(135deg, #DC143C 0%, #FF1493 50%, #8B008B 100%); border: 3px solid #FFD700; }
</style>
</head>
<body class="bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-600 min-h-screen text-white overflow-x-hidden">
<div id="root"></div>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script type="text/babel">
const { useState, useEffect, useRef } = React;
const firebaseConfig = {
    apiKey: "AIzaSyDZPRiByz69HQa8b7GFMCJeqq56J3Y-bOY",
    authDomain: "step-by-step-279df.firebaseapp.com",
    databaseURL: "https://step-by-step-279df-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "step-by-step-279df",
    storageBucket: "step-by-step-279df.firebasestorage.app",
    messagingSenderId: "302641152597",
    appId: "1:302641152597:web:6479b9ae03104666cd8adc"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const TelegramWebApp = window.Telegram?.WebApp;
const ADMIN_WALLET = 'UQAWqaIPFSg81l9MlgAx0HBE9o3gpJMhk1dnyryKJXhWNHIc';
const TONCENTER_API = 'https://toncenter.com/api/v2';
const BOT_TOKEN = '8325421899:AAHRdmMYdjJMXmAVIynDsQtpUNsSeKkaOis';

const CASE_REWARDS = {
    cardboard: [
        { id: 'stars_0_25', name: '0.25 ‚≠êÔ∏è', displayChance: '80%', realChance: 80, type: 'stars', value: 0.25, emoji: '‚≠êÔ∏è' },
        { id: 'stars_0_75', name: '0.75 ‚≠êÔ∏è', displayChance: '10%', realChance: 10, type: 'stars', value: 0.75, emoji: '‚≠êÔ∏è' },
        { id: 'stars_1_5', name: '1.5 ‚≠êÔ∏è', displayChance: '6%', realChance: 6, type: 'stars', value: 1.5, emoji: '‚≠êÔ∏è' },
        { id: 'stars_5', name: '5 ‚≠êÔ∏è', displayChance: '2%', realChance: 2, type: 'stars', value: 5, emoji: '‚≠êÔ∏è' },
        { id: 'bear', name: 'üß∏', displayChance: '1.5%', realChance: 1.5, type: 'item', sellPrice: 20, emoji: 'üß∏' },
        { id: 'diamond_pro', name: 'üíé PRO', displayChance: '0.5%', realChance: 0.5, type: 'collectible', emoji: 'üíé' }
    ],
    coal: [
        { id: 'stars_2_5', name: '2.5 ‚≠êÔ∏è', displayChance: '60%', realChance: 60, type: 'stars', value: 2.5, emoji: '‚≠êÔ∏è' },
        { id: 'stars_5', name: '5 ‚≠êÔ∏è', displayChance: '18%', realChance: 18, type: 'stars', value: 5, emoji: '‚≠êÔ∏è' },
        { id: 'pickaxe', name: '–ö–∏—Ä–∫–∞ ‚õèÔ∏è', displayChance: '10%', realChance: 10, type: 'item', sellPrice: 10, emoji: '‚õèÔ∏è' },
        { id: 'stars_15', name: '15 ‚≠êÔ∏è', displayChance: '6%', realChance: 6, type: 'stars', value: 15, emoji: '‚≠êÔ∏è' },
        { id: 'material', name: '–ú–∞—Ç–µ—Ä–∏–∞–ª üß±', displayChance: '5%', realChance: 5, type: 'item', sellPrice: 40, emoji: 'üß±' },
        { id: 'brownie_pro', name: 'Happy Brownie PRO üí©', displayChance: '1%', realChance: 1, type: 'collectible', emoji: 'üí©' }
    ],
    platinum: [
        { id: 'stars_35', name: '35 ‚≠êÔ∏è', displayChance: '55%', realChance: 55, type: 'stars', value: 35, emoji: '‚≠êÔ∏è' },
        { id: 'stars_50', name: '50 ‚≠êÔ∏è', displayChance: '35%', realChance: 35, type: 'stars', value: 50, emoji: '‚≠êÔ∏è' },
        { id: 'ring', name: 'üíç', displayChance: '5%', realChance: 5, type: 'collectible', emoji: 'üíç' },
        { id: 'bday', name: 'B-day üóì', displayChance: '4%', realChance: 4, type: 'item', sellPrice: 150, emoji: 'üóì' },
        { id: 'bday_pro', name: 'B-Day PRO üìÖ', displayChance: '1%', realChance: 1, type: 'collectible', emoji: 'üìÖ' }
    ],
    gold: [
        { id: 'stars_50', name: '50 ‚≠êÔ∏è', displayChance: '50%', realChance: 50, type: 'stars', value: 50, emoji: '‚≠êÔ∏è' },
        { id: 'stars_125', name: '125 ‚≠êÔ∏è', displayChance: '35%', realChance: 35, type: 'stars', value: 125, emoji: '‚≠êÔ∏è' },
        { id: 'clover', name: 'üçÄ Clover Pin', displayChance: '10%', realChance: 10, type: 'item', sellPrice: 200, emoji: 'üçÄ' },
        { id: 'icecream', name: 'Ice Cream üç¶', displayChance: '3%', realChance: 3, type: 'collectible', emoji: 'üç¶' },
        { id: 'clover_pro', name: 'üçÄ Clover Pin PRO', displayChance: '2%', realChance: 2, type: 'collectible', emoji: 'üçÄ' }
    ],
    money: [
        { id: 'stars_150', name: '150 ‚≠êÔ∏è', displayChance: '45%', realChance: 45, type: 'stars', value: 150, emoji: '‚≠êÔ∏è' },
        { id: 'stars_75', name: '75 ‚≠êÔ∏è', displayChance: '40%', realChance: 40, type: 'stars', value: 75, emoji: '‚≠êÔ∏è' },
        { id: 'trophy', name: 'üèÜ', displayChance: '5%', realChance: 5, type: 'collectible', emoji: 'üèÜ' },
        { id: 'gem', name: 'üíé', displayChance: '5%', realChance: 5, type: 'collectible', emoji: 'üíé' },
        { id: 'bday_happy', name: 'Happy B-day üíà', displayChance: '4%', realChance: 4, type: 'collectible', emoji: 'üíà' },
        { id: 'cigar', name: 'Snoop Cigar üö¨', displayChance: '1%', realChance: 1, type: 'collectible', emoji: 'üö¨' }
    ],
    elite: [
        { id: 'stars_200', name: '200 ‚≠êÔ∏è', displayChance: '75%', realChance: 75, type: 'stars', value: 200, emoji: '‚≠êÔ∏è' },
        { id: 'stars_275', name: '275 ‚≠êÔ∏è', displayChance: '5%', realChance: 5, type: 'stars', value: 275, emoji: '‚≠êÔ∏è' },
        { id: 'champagne', name: 'üçæ', displayChance: '17%', realChance: 17, type: 'collectible', emoji: 'üçæ' },
        { id: 'socks', name: '–ù–æ—Å–∫–∏ üß¶', displayChance: '2%', realChance: 2, type: 'collectible', emoji: 'üß¶' },
        { id: 'lightsword', name: 'Light Sword ‚öîÔ∏è', displayChance: '1%', realChance: 1, type: 'collectible', emoji: '‚öîÔ∏è' }
    ],
    diamond: [
        { id: 'stars_8', name: '8 ‚≠êÔ∏è', displayChance: '70%', realChance: 70, type: 'stars', value: 8, emoji: '‚≠êÔ∏è' },
        { id: 'bear', name: '–ú–∏—à–∫–∞ üß∏', displayChance: '15%', realChance: 15, type: 'item', sellPrice: 20, emoji: 'üß∏' },
        { id: 'stars_25', name: '25 ‚≠êÔ∏è', displayChance: '9%', realChance: 9, type: 'stars', value: 25, emoji: '‚≠êÔ∏è' },
        { id: 'stars_80', name: '80 ‚≠êÔ∏è', displayChance: '4%', realChance: 4, type: 'stars', value: 80, emoji: '‚≠êÔ∏è' },
        { id: 'diamond_pro', name: '–ê–ª–º–∞–∑ PRO üíé', displayChance: '0.6%', realChance: 0.6, type: 'collectible', emoji: 'üíé' },
        { id: 'snoop_pro', name: 'Snoop Dog PRO üêï', displayChance: '0.4%', realChance: 0.4, type: 'collectible', emoji: 'üêï' }
    ],
    winter: [
        { id: 'stars_20', name: '20 ‚≠êÔ∏è', displayChance: '60%', realChance: 60, type: 'stars', value: 20, emoji: '‚≠êÔ∏è' },
        { id: 'stars_35', name: '35 ‚≠êÔ∏è', displayChance: '35%', realChance: 35, type: 'stars', value: 35, emoji: '‚≠êÔ∏è' },
        { id: 'stars_80', name: '80 ‚≠êÔ∏è', displayChance: '3.5%', realChance: 3.5, type: 'stars', value: 80, emoji: '‚≠êÔ∏è' },
        { id: 'snake', name: 'üéÑ Lunar Snake 2025 üêç', displayChance: '1%', realChance: 1, type: 'collectible', emoji: 'üêç' },
        { id: 'scarf', name: 'üß£ –ó–∏–º–Ω–µ–µ —Å–æ–∫—Ä–æ–≤–∏—â–µ', displayChance: '0.5%', realChance: 0.5, type: 'collectible', emoji: 'üß£' }
    ],
    major: [
        { id: 'stars_500', name: '500 ‚≠êÔ∏è', displayChance: '50%', realChance: 50, type: 'stars', value: 500, emoji: '‚≠êÔ∏è' },
        { id: 'stars_1000', name: '1000 ‚≠êÔ∏è', displayChance: '25%', realChance: 25, type: 'stars', value: 1000, emoji: '‚≠êÔ∏è' },
        { id: 'gold_bar', name: 'ü•á –ó–æ–ª–æ—Ç–æ–π —Å–ª–∏—Ç–æ–∫', displayChance: '25%', realChance: 25, type: 'collectible', emoji: 'ü•á' }
    ],
    collector: [
        { id: 'bear_pro', name: 'üß∏ PRO', displayChance: '55%', realChance: 55, type: 'collectible', emoji: 'üß∏' },
        { id: 'gift_pro', name: 'üéÅ PRO', displayChance: '20%', realChance: 20, type: 'collectible', emoji: 'üéÅ' },
        { id: 'rocket_pro', name: 'üöÄ PRO', displayChance: '15%', realChance: 15, type: 'collectible', emoji: 'üöÄ' },
        { id: 'cup_pro', name: 'üèÜ PRO', displayChance: '5%', realChance: 5, type: 'collectible', emoji: 'üèÜ' },
        { id: 'ramen_pro', name: 'üçú Ramen PRO', displayChance: '1.5%', realChance: 0.5, type: 'collectible', emoji: 'üçú' },
        { id: 'hat_pro', name: 'üé© Top hat', displayChance: '1%', realChance: 0, type: 'collectible', emoji: 'üé©' },
        { id: 'bird_pro', name: 'ü¶Ö Rare bird', displayChance: '0.5%', realChance: 0, type: 'collectible', emoji: 'ü¶Ö' }
    ]
};

const INITIAL_CASES = {
    cardboard: { id: 'cardboard', name: '–ö–∞—Ä—Ç–æ–Ω', emoji: 'üì¶', price: 3, color: 'from-amber-800 to-amber-900', locked: false, isNew: true, freeCount: 0 },
    coal: { id: 'coal', name: '–£–≥–æ–ª—ë–∫', emoji: 'ü™®', price: 22, originalPrice: 22, discountPrice: 20, color: 'from-gray-600 to-gray-800', locked: false, isNew: false, freeCount: 0 },
    platinum: { id: 'platinum', name: '–ü–ª–∞—Ç–∏–Ω–∞', emoji: 'üíé', price: 100, color: 'from-gray-300 to-gray-500', locked: false },
    gold: { id: 'gold', name: '–ó–æ–ª–æ—Ç–æ–π', emoji: 'üëë', price: 250, color: 'from-yellow-400 to-yellow-600', locked: false },
    money: { id: 'money', name: '–î–µ–Ω–µ–∂–Ω—ã–π', emoji: 'üíµ', price: 350, color: 'from-green-400 to-green-600', locked: false },
    elite: { id: 'elite', name: '–≠–ª–∏—Ç–∞', emoji: 'üéñ', price: 500, color: 'from-red-400 to-red-600', locked: false, isNew: false, freeCount: 0 },
    diamond: { id: 'diamond', name: '–ê–ª–º–∞–∑', emoji: 'üíé', price: 50, originalPrice: 50, discountPrice: 35, color: 'from-blue-400 to-blue-600', locked: false, isNew: false, freeCount: 0 },
    winter: { id: 'winter', name: '–ó–∏–º–Ω–∏–π', emoji: '‚òÉÔ∏è', price: 125, originalPrice: 150, discountPrice: 125, color: 'from-cyan-400 to-blue-500', locked: false, isNew: true, freeCount: 0 },
    major: { id: 'major', name: '–ú–∞–∂–æ—Ä', emoji: 'ü§¥', price: 800, color: 'from-purple-500 to-indigo-700', locked: true, isNew: false, freeCount: 0 },
    collector: { id: 'collector', name: '–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–µ—Ä', emoji: 'üé©', price: 650, color: 'from-rose-600 to-pink-800', locked: true, isNew: true, freeCount: 0 }
};
    const TON_RATES = [{ stars: 50, ton: 0.6 }, { stars: 250, ton: 3 }, { stars: 500, ton: 6 }, { stars: 1000, ton: 12 }];
const STARS_PACKAGES = [{ stars: 50, price: 50, name: '50 –∑–≤–µ–∑–¥' }, { stars: 100, price: 100, name: '100 –∑–≤–µ–∑–¥' }, { stars: 250, price: 250, name: '250 –∑–≤–µ–∑–¥' }, { stars: 500, price: 500, name: '500 –∑–≤–µ–∑–¥' }, { stars: 1000, price: 1000, name: '1000 –∑–≤–µ–∑–¥' }];

const ICE_ARENA_PRIZES = [
    { id: 'bear', name: 'üß∏ –ú–∏—à–∫–∞', chance: 40, type: 'item', sellPrice: 20, emoji: 'üß∏' },
    { id: 'gloves', name: 'üß§ –í–∞—Ä–µ–∂–∫–∏', chance: 30, type: 'item', sellPrice: 50, emoji: 'üß§' },
    { id: 'fire', name: 'üî• –û–≥–æ–Ω—å', chance: 10, type: 'special', emoji: 'üî•', message: '–í—ã —Ä–∞—Å—Ç–æ–ø–∏–ª–∏ –ª–µ–¥! –ü–æ–ª—É—á–∞–µ—Ç–µ 40% –æ—Ç —Å—Ç–∞–≤–æ–∫' },
    { id: 'dellko', name: 'üîë Promocode DELLKO', chance: 0.5, type: 'promo', code: 'DELLKO', emoji: 'üîë' }
];

function App() {
    const [currentScreen, setCurrentScreen] = useState('cases');
    const [balance, setBalance] = useState(0);
    const [cases, setCases] = useState(INITIAL_CASES);
    const [inventory, setInventory] = useState([]);
    const [inventorySlots, setInventorySlots] = useState(5);
    const [tasks, setTasks] = useState({ subscribe: { completed: false }, deposit: { completed: false }, depositMajor: { completed: false }, invite: { completed: false, count: 0 } });
    const [user, setUser] = useState(null);
    const [selectedCase, setSelectedCase] = useState(null);
    const [isSpinning, setIsSpinning] = useState(false);
    const [spinResult, setSpinResult] = useState(null);
    const [showTopUp, setShowTopUp] = useState(false);
    const [promoCode, setPromoCode] = useState('');
    const [promoError, setPromoError] = useState('');
    const [promoSuccess, setPromoSuccess] = useState('');
    const [usedPromos, setUsedPromos] = useState([]);
    const [wonPromos, setWonPromos] = useState([]);
    const [adminAttempts, setAdminAttempts] = useState(0);
    const [showAdminLogin, setShowAdminLogin] = useState(false);
    const [isAdmin, setIsAdmin] = useState(false);
    const [adminLogin, setAdminLogin] = useState('');
    const [adminPassword, setAdminPassword] = useState('');
    const [adminScreen, setAdminScreen] = useState('stats');
    const [pendingPayments, setPendingPayments] = useState([]);
    const [checkingPayment, setCheckingPayment] = useState(false);
    const [paymentStatus, setPaymentStatus] = useState('');
    const [allUsers, setAllUsers] = useState([]);
    const [selectedUser, setSelectedUser] = useState(null);
    const [onlineCount, setOnlineCount] = useState(0);
    const [showCollectibleModal, setShowCollectibleModal] = useState(false);
    const [selectedCollectible, setSelectedCollectible] = useState(null);
    const [isLoading, setIsLoading] = useState(true);
    const [currentGame, setCurrentGame] = useState(null);
    const [iceLobby, setIceLobby] = useState(null);
    const [myBet, setMyBet] = useState(25);
    const [hasBet, setHasBet] = useState(false);
    const [isReady, setIsReady] = useState(false);
    const [gameStatus, setGameStatus] = useState('waiting');
    const [ballPos, setBallPos] = useState({ x: 50, y: 50 });
    const [showPrizeChest, setShowPrizeChest] = useState(false);
    const [chestPrizes, setChestPrizes] = useState([]);
    const [openedChestCount, setOpenedChestCount] = useState(0);
    const [showNewGamePrompt, setShowNewGamePrompt] = useState(false);
    const [timerRemaining, setTimerRemaining] = useState(0);
    const [totalDeposits, setTotalDeposits] = useState(0);
    const [freeEliteSpin, setFreeEliteSpin] = useState(0);
    const [rouletteOffset, setRouletteOffset] = useState(0);
    const [fakeItems, setFakeItems] = useState([]);

    useEffect(() => {
        const initApp = async () => {
            let userId = localStorage.getItem('sbs_user_id') || 'guest_' + Date.now();
            let userData = { name: '–ì–æ—Å—Ç—å', id: userId };
            if (TelegramWebApp?.initDataUnsafe?.user) {
                const tg = TelegramWebApp.initDataUnsafe.user;
                userId = tg.id.toString();
                userData = { name: tg.first_name, avatar: tg.photo_url, username: tg.username, id: userId };
            }
            localStorage.setItem('sbs_user_id', userId);
            setUser(userData);
            const snapshot = await db.ref('users/' + userId).once('value');
            const data = snapshot.val();
            if (data) {
                setBalance(data.balance || 0); setCases(data.cases || INITIAL_CASES); setInventory(data.inventory || []); 
                setTasks(data.tasks || tasks); setInventorySlots(data.inventorySlots || 5); setUsedPromos(data.usedPromos || []); setWonPromos(data.wonPromos || []); 
                setTotalDeposits(data.totalDeposits || 0); setFreeEliteSpin(data.freeEliteSpin || 0);
            } else {
                const newCases = { ...INITIAL_CASES, diamond: { ...INITIAL_CASES.diamond, freeCount: 5 } };
                setCases(newCases);
                await db.ref('users/' + userId).set({ balance: 0, cases: newCases, inventory: [], tasks, inventorySlots: 5, usedPromos: [], wonPromos: [], createdAt: Date.now(), totalDeposits: 0, freeEliteSpin: 0 });
            }
            setIsLoading(false);
        };
        initApp();
    }, []);

    useEffect(() => {
        if (user?.id && !isLoading) {
            db.ref('users/' + user.id).update({ balance, cases, inventory, tasks, inventorySlots, usedPromos, wonPromos, totalDeposits, freeEliteSpin });
        }
    }, [balance, cases, inventory, tasks, inventorySlots, usedPromos, wonPromos, totalDeposits, freeEliteSpin]);

    // –ê–í–¢–û-–í–û–ó–í–†–ê–¢ –°–¢–ê–í–ö–ò –ü–†–ò –í–´–•–û–î–ï –ò–ó –õ–û–ë–ë–ò –û–î–ù–ò–ú
    useEffect(() => {
        const handleLeave = async () => {
            if (currentGame?.type === 'ice' && user && hasBet) {
                const snap = await db.ref(`iceLobbies/${currentGame.lobbyId}`).once('value');
                const lobbyData = snap.val();
                if (lobbyData && lobbyData.participants) {
                    const participantsCount = Object.keys(lobbyData.participants).length;
                    if (participantsCount === 1 && lobbyData.players?.[user.id]) {
                        await db.ref(`users/${user.id}/balance`).transaction(c => (c || 0) + myBet);
                        await db.ref(`iceLobbies/${currentGame.lobbyId}/players/${user.id}`).remove();
                    }
                }
                await db.ref(`iceLobbies/${currentGame.lobbyId}/participants/${user.id}`).remove();
            }
        };
        return () => { handleLeave(); };
    }, [currentGame, hasBet, myBet, user]);

    useEffect(() => {
        if (currentGame?.type === 'ice') {
            const lobbyRef = db.ref('iceLobbies/' + currentGame.lobbyId);
            lobbyRef.on('value', snap => {
                const d = snap.val();
                if (d) {
                    setIceLobby(d);
                    setGameStatus(d.status || 'waiting');
                    if (d.players?.[user?.id]) { setHasBet(true); setMyBet(d.players[user?.id].bet); setIsReady(!!d.readyPlayers?.[user?.id]); }
                    else { setHasBet(false); setIsReady(false); }
                    if (d.ballPosition) setBallPos(d.ballPosition);
                    if (d.timerEnd && d.status === 'betting') setTimerRemaining(Math.max(0, Math.ceil((d.timerEnd - Date.now()) / 1000)));
                    if (d.status === 'finished' && d.winner?.id === user?.id && !showPrizeChest) { setChestPrizes(d.prizes || []); setShowPrizeChest(true); }
                }
            });
            return () => lobbyRef.off();
        }
    }, [currentGame, user?.id, showPrizeChest]);

    const handleTitleClick = () => { setAdminAttempts(a => a + 1); if (adminAttempts >= 10) setShowAdminLogin(true); };
    const checkAdminLogin = () => { if (adminLogin === '_*\\^BAGUETTE_642819_6281' && adminPassword === '3628874910ZTWMI_') { setIsAdmin(true); setShowAdminLogin(false); db.ref('users').once('value').then(snap => { const users = []; snap.forEach(c => users.push({ id: c.key, ...c.val() })); setAllUsers(users); }); } else { alert('–û—à–∏–±–∫–∞!'); } };

    const joinIceLobby = async (lobbyId) => {
        const lobbyRef = db.ref('iceLobbies/' + lobbyId);
        await lobbyRef.child('participants/' + user.id).set({ name: user.name, avatar: user.avatar });
        lobbyRef.child('participants/' + user.id).onDisconnect().remove();
        setCurrentGame({ type: 'ice', lobbyId });
    };

    const placeBet = async () => {
        if (balance < myBet) return alert('–ú–∞–ª–æ –∑–≤–µ–∑–¥!');
        const lobbyRef = db.ref('iceLobbies/' + currentGame.lobbyId);
        const newBalance = balance - myBet;
        setBalance(newBalance);
        await lobbyRef.child('players/' + user.id).set({ name: user.name, avatar: user.avatar, bet: myBet, color: `hsl(${Math.random() * 360}, 70%, 50%)`, timestamp: Date.now() });
        setHasBet(true);
    };

    const toggleReady = async () => {
        const ref = db.ref('iceLobbies/' + currentGame.lobbyId);
        const nextReady = !isReady; setIsReady(nextReady);
        await ref.child('readyPlayers/' + user.id).set(nextReady ? true : null);
        const snap = await ref.once('value'); const d = snap.val();
        const pCount = Object.keys(d.players || {}).length;
        const rCount = Object.keys(d.readyPlayers || {}).length;
        if (pCount >= 2 && rCount === pCount && !d.countdownStarted) {
            await ref.update({ status: 'betting', timerEnd: Date.now() + 10000, countdownStarted: true });
            setTimeout(() => startIceGame(ref), 10000);
        }
    };

    const startIceGame = async (ref) => {
        await ref.update({ status: 'playing' });
        let x = 50, y = 50, vx = (Math.random() - 0.5) * 20, vy = (Math.random() - 0.5) * 20;
        const interval = setInterval(async () => {
            x += vx * 0.5; y += vy * 0.5;
            const dist = Math.sqrt(Math.pow(x-50,2) + Math.pow(y-50,2));
            if (dist >= 42) { vx = -vx * 0.95; vy = -vy * 0.95; }
            vx *= 0.998; vy *= 0.998;
            await ref.child('ballPosition').set({ x, y });
            if (Math.abs(vx) < 0.1 && Math.abs(vy) < 0.1) { clearInterval(interval); finishIceGame(ref, x, y); }
        }, 25);
    };

    const finishIceGame = async (ref, fx, fy) => {
        const snap = await ref.once('value'); const d = snap.val();
        const players = Object.entries(d.players); const total = players.reduce((s, [, p]) => s + p.bet, 0);
        const winner = { id: players[0][0], ...players[0][1] };
        await ref.update({ status: 'finished', winner, prizes: [ICE_ARENA_PRIZES[0]], finalBall: { x: fx, y: fy } });
        if (winner.id === user.id) { setBalance(b => b + (total * 0.40)); }
    };

    const getCasePrice = (caseType) => {
        const c = cases[caseType];
        if (c.freeCount > 0) return 0;
        return c.discountPrice || c.price;
    };

    const openCase = async (caseType) => {
        if (caseType === 'collector' && cases.collector?.locked) return alert('–ö–µ–π—Å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!');
        const price = getCasePrice(caseType);
        const isFree = cases[caseType]?.freeCount > 0;
        const isEliteFree = caseType === 'elite' && freeEliteSpin > 0;
        if (!isEliteFree && !isFree && balance < price) return alert('–ú–∞–ª–æ –∑–≤–µ–∑–¥!');

        const balBefore = balance;
        let balAfter = balBefore;
        if (isFree) { setCases(prev => ({...prev, [caseType]: {...prev[caseType], freeCount: prev[caseType].freeCount - 1}})); }
        else if (isEliteFree) { setFreeEliteSpin(s => s - 1); }
        else { balAfter = balBefore - price; setBalance(balAfter); }

        // –°–±—Ä–æ—Å –∏ —Å—Ç–∞—Ä—Ç –∞–Ω–∏–º–∞—Ü–∏–∏
        setRouletteOffset(0);
        setFakeItems([]);
        setIsSpinning(true);
        setSelectedCase({...cases[caseType], id: caseType});
        
        const items = CASE_REWARDS[caseType];
        const rand = Math.random() * 100; let cum = 0, won = items[0];
        for (const it of items) { cum += it.realChance; if (rand <= cum) { won = it; break; } }

        const tape = Array.from({length: 80}, () => items[Math.floor(Math.random()*items.length)]);
        tape[70] = won;
        setFakeItems(tape);

        const itemWidth = 136;
        const targetPos = (70 * itemWidth) + (itemWidth/2) - (window.innerWidth/2) + (Math.random()*60-30);

        setTimeout(() => {
            setRouletteOffset(-targetPos);
        }, 100);

        setTimeout(() => {
            setSpinResult(won); setIsSpinning(false);
            if (won.type === 'stars') setBalance(balAfter + won.value);
            else setInventory(prev => [...prev, {...won, uid: Date.now()}]);
        }, 6600);
    };

    const completeTask = (id) => {
        if (id === 'subscribe') { window.open('https://t.me/stepbystepdelision'); setTasks(t => ({...t, subscribe: {completed: true}})); setFreeEliteSpin(s => s + 1); }
        else setShowTopUp(true);
    };

    if (isLoading) return <div className="h-screen flex items-center justify-center">–ó–∞–≥—Ä—É–∑–∫–∞...</div>;

    const participantsCount = Object.keys(iceLobby?.participants || {}).length;

    return (
        <div className="min-h-screen pb-24">
            <header className="p-4 flex justify-between items-center glass sticky top-0 z-50">
                <h1 onClick={handleTitleClick} className="text-xl font-bold cursor-pointer">Step By Step</h1>
                <div className="bg-yellow-500 px-4 py-1 rounded-full text-black font-bold">{balance.toFixed(2)} ‚≠êÔ∏è</div>
            </header>

            <main className="p-4 max-w-md mx-auto">
                {currentScreen === 'cases' && (
                    <div className="grid grid-cols-2 gap-4">
                        {Object.values(cases).filter(c => !c.locked).map(c => (
                            <div key={c.id} className="glass p-4 rounded-xl text-center relative">
                                <div className="text-4xl mb-2">{c.emoji}</div>
                                <h3 className="font-bold">{c.name}</h3>
                                <p className="text-sm opacity-70">{c.freeCount > 0 ? '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ!' : (c.discountPrice || c.price) + '‚≠êÔ∏è'}</p>
                                <button onClick={() => setSelectedCase(c)} className="w-full mt-2 py-2 bg-indigo-600 rounded-lg">–û—Ç–∫—Ä—ã—Ç—å</button>
                            </div>
                        ))}
                    </div>
                )}
                {currentScreen === 'games' && (
                    <div onClick={() => joinIceLobby(1)} className="glass p-6 rounded-xl text-center border border-cyan-500/30">
                        <h3 className="text-2xl font-bold text-cyan-300">‚òÉÔ∏è –õ–µ–¥—è–Ω–æ–π –ö–∞—Ç–æ–∫</h3>
                        <p className="opacity-70">–ü–æ–±–µ–¥–∞ = 40% –æ—Ç –±–∞–Ω–∫–∞!</p>
                    </div>
                )}
                {currentScreen === 'profile' && (
                    <div className="space-y-4">
                        <div className="glass p-6 rounded-xl text-center">
                            <h2 className="text-xl font-bold">{user?.name}</h2>
                            <button onClick={() => setShowTopUp(true)} className="mt-4 w-full py-3 bg-yellow-500 text-black font-bold rounded-xl">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
                        </div>
                        <div className="glass p-4 rounded-xl">
                            <h3 className="font-bold mb-4">üéÅ –ü—Ä–æ–º–æ–∫–æ–¥</h3>
                            <div className="flex gap-2"><input value={promoCode} onChange={e=>setPromoCode(e.target.value)} className="flex-1 bg-black/20 p-2 rounded" /><button onClick={() => alert('–ü—Ä–æ–º–æ–∫–æ–¥!')} className="bg-indigo-600 px-4 rounded">OK</button></div>
                        </div>
                    </div>
                )}
            </main>

            {selectedCase && (
                <div className="fullscreen-modal flex items-center justify-center p-4">
                    <div className="w-full max-w-lg">
                        <div className="flex justify-between items-center mb-6"><h3 className="text-2xl font-bold">{selectedCase.name}</h3><button onClick={()=>{setSelectedCase(null); setSpinResult(null);}}>&times;</button></div>
                        <div className="roulette-container">
                            <div className="roulette-pointer" />
                            <div className="roulette-inner" style={{ transform: `translateX(${rouletteOffset}px)`, transition: isSpinning ? 'transform 6.5s cubic-bezier(0.1, 0, 0.05, 1)' : 'none' }}>
                                {fakeItems.map((it, i) => (<div key={i} className="roulette-item"><div className="emoji">{it.emoji}</div><div className="name">{it.name}</div></div>))}
                            </div>
                        </div>
                        {spinResult ? (
                            <div className="text-center mt-6 animate-bounce"><p className="text-2xl font-bold">–í—ã–ø–∞–ª–æ: {spinResult.name}</p><button onClick={()=>setSpinResult(null)} className="mt-4 bg-green-600 px-8 py-2 rounded-lg">–ó–∞–±—Ä–∞—Ç—å</button></div>
                        ) : (
                            <button onClick={() => openCase(selectedCase.id)} disabled={isSpinning} className="w-full mt-8 py-4 bg-indigo-600 rounded-xl font-bold">{isSpinning ? '–ö—Ä—É—Ç–∏–º...' : '–û—Ç–∫—Ä—ã—Ç—å'}</button>
                        )}
                    </div>
                </div>
            )}

            {currentGame?.type === 'ice' && (
                <div className="fixed inset-0 bg-blue-900 z-50 p-4">
                    <button onClick={() => setCurrentGame(null)} className="absolute top-4 right-4">‚úï</button>
                    <div className="flex justify-center my-8"><div className="ice-circle" /></div>
                    <div className="max-w-xs mx-auto text-center">
                        {participantsCount < 2 ? (
                            <div className="glass p-6 rounded-xl border-yellow-500 animate-pulse font-bold text-yellow-400">‚è≥ –û–∂–∏–¥–∞–µ–º –µ—â–µ –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...<br/><span className="text-xs opacity-50">–í—ã –≤ –ª–æ–±–±–∏ #{currentGame.lobbyId}</span></div>
                        ) : (
                            <div className="space-y-4">
                                {!hasBet ? (
                                    <button onClick={placeBet} className="w-full py-3 bg-blue-600 rounded-xl font-bold">–°–¥–µ–ª–∞—Ç—å —Å—Ç–∞–≤–∫—É (25‚≠êÔ∏è)</button>
                                ) : (
                                    <button onClick={toggleReady} className={`w-full py-3 rounded-xl font-bold ${isReady ? 'bg-green-600' : 'bg-yellow-600'}`}>{isReady ? '‚úÖ –ì–æ—Ç–æ–≤' : '–ü—Ä–∏–≥–æ—Ç–æ–≤–∏—Ç—å—Å—è'}</button>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            )}

            <nav className="fixed bottom-0 left-0 right-0 glass flex justify-around p-2">
                {['tasks', 'cases', 'games', 'profile'].map(s => (<button key={s} onClick={()=>setCurrentScreen(s)} className={`p-2 ${currentScreen===s?'text-blue-400':''}`}>{s}</button>))}
            </nav>
        </div>
    );
}
ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
