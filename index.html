<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Step By Step Game</title>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script>
tailwind.config = {
  darkMode: 'class',
  theme: {
    extend: { colors: { primary: '#6366f1', secondary: '#8b5cf6', accent: '#f59e0b', ice: '#00d2ff' } }
  }
}
</script>
<style>
@keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
@keyframes pulseGlow { 0%, 100% { box-shadow: 0 0 10px rgba(0,210,255,0.3); } 50% { box-shadow: 0 0 30px rgba(0,210,255,0.8); } }
@keyframes readyPulse { 0%, 100% { box-shadow: 0 0 10px rgba(0,255,100,0.3); } 50% { box-shadow: 0 0 30px rgba(0,255,100,0.8); } }
.pulse-glow { animation: pulseGlow 2s ease-in-out infinite; }
.ready-glow { animation: readyPulse 1.5s ease-in-out infinite; }
.roulette-container { position: relative; width: 100%; height: 160px; overflow: hidden; background: rgba(0,0,0,0.4); border-radius: 16px; border: 2px solid rgba(255,255,255,0.1); margin: 20px 0; }
.roulette-inner { display: flex; position: absolute; left: 0; top: 20px; transition: transform 6.5s cubic-bezier(0.1, 0, 0.1, 1); will-change: transform; }
.roulette-item { width: 120px; height: 120px; flex-shrink: 0; margin: 0 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05)); border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); }
.roulette-item .emoji { font-size: 3.5rem; }
.roulette-item .name { font-size: 11px; opacity: 0.8; text-align: center; margin-top: 4px; }
.roulette-pointer { position: absolute; left: 50%; top: 0; bottom: 0; width: 4px; background: #ff4757; z-index: 20; transform: translateX(-50%); box-shadow: 0 0 20px #ff4757; }
.roulette-pointer::before { content: ''; position: absolute; top: -5px; left: 50%; transform: translateX(-50%); border-left: 10px solid transparent; border-right: 10px solid transparent; border-top: 15px solid #ff4757; }
.roulette-pointer::after { content: ''; position: absolute; bottom: -5px; left: 50%; transform: translateX(-50%); border-left: 10px solid transparent; border-right: 10px solid transparent; border-bottom: 15px solid #ff4757; }
.glass { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
.line-through { text-decoration: line-through; opacity: 0.5; }
.fullscreen-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 100; overflow-y: auto; }
.ice-circle {
  width: 300px; height: 300px; border-radius: 50%;
  border: 4px solid rgba(0,210,255,0.6);
  position: relative; overflow: hidden;
  background: rgba(0, 40, 80, 0.6);
  box-shadow: 0 0 40px rgba(0,210,255,0.4), inset 0 0 60px rgba(0,0,0,0.5);
}
.ice-ball {
  position: absolute; width: 32px; height: 32px;
  background: radial-gradient(circle at 30% 30%, #ffffff, #00d2ff, #0066ff);
  border-radius: 50%;
  box-shadow: 0 0 15px rgba(0,210,255,0.9), 0 0 30px rgba(0,150,255,0.5);
  z-index: 20; transform: translate(-50%, -50%);
  border: 2px solid rgba(255,255,255,0.8);
  transition: left 0.025s linear, top 0.025s linear;
}
.player-avatar { position: absolute; width: 36px; height: 36px; border-radius: 50%; border: 3px solid white; overflow: hidden; transform: translate(-50%, -50%); z-index: 10; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
.case-cardboard { background: linear-gradient(135deg, #8B4513 0%, #D2691E 50%, #8B4513 100%); border: 3px solid #A0522D; }
.case-collector { background: linear-gradient(135deg, #DC143C 0%, #FF1493 50%, #8B008B 100%); border: 3px solid #FFD700; }
.player-row-ready { border-color: rgba(0,255,100,0.5) !important; background: rgba(0,255,100,0.1) !important; }
.player-row-waiting { border-color: rgba(255,200,0,0.4) !important; background: rgba(255,200,0,0.05) !important; }
.player-row-presence { border-color: rgba(150,150,150,0.3) !important; }
</style>
</head>
<body class="bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-600 min-h-screen text-white overflow-x-hidden">
<div id="root"></div>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script type="text/babel">
const { useState, useEffect, useRef, useCallback } = React;

const firebaseConfig = {
  apiKey: "AIzaSyDZPRiByz69HQa8b7GFMCJeqq56J3Y-bOY",
  authDomain: "step-by-step-279df.firebaseapp.com",
  databaseURL: "https://step-by-step-279df-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "step-by-step-279df",
  storageBucket: "step-by-step-279df.firebasestorage.app",
  messagingSenderId: "302641152597",
  appId: "1:302641152597:web:6479b9ae03104666cd8adc"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const TelegramWebApp = window.Telegram?.WebApp;
const ADMIN_WALLET = 'UQAWqaIPFSg81l9MlgAx0HBE9o3gpJMhk1dnyryKJXhWNHIc';
const TONCENTER_API = 'https://toncenter.com/api/v2';
const BOT_TOKEN = '8325421899:AAHRdmMYdjJMXmAVIynDsQtpUNsSeKkaOis';

// –°–ª—É—á–∞–π–Ω—ã–π —Ü–≤–µ—Ç –¥–ª—è –∏–≥—Ä–æ–∫–∞
const PLAYER_COLORS = [
  '#FF6B6B','#FF9F43','#FFEAA7','#55EFC4','#74B9FF',
  '#A29BFE','#FD79A8','#E17055','#00CEC9','#6C5CE7',
  '#FDCB6E','#81ECEC','#FF7675','#DFE6E9','#B2BEC3'
];
function getRandomColor() {
  return PLAYER_COLORS[Math.floor(Math.random() * PLAYER_COLORS.length)];
}

const CASE_REWARDS = {
  cardboard: [
    { id: 'stars_0_25', name: '0.25 ‚≠êÔ∏è', displayChance: '80%', realChance: 80, type: 'stars', value: 0.25, emoji: '‚≠êÔ∏è' },
    { id: 'stars_0_75', name: '0.75 ‚≠êÔ∏è', displayChance: '10%', realChance: 10, type: 'stars', value: 0.75, emoji: '‚≠êÔ∏è' },
    { id: 'stars_1_5', name: '1.5 ‚≠êÔ∏è', displayChance: '6%', realChance: 6, type: 'stars', value: 1.5, emoji: '‚≠êÔ∏è' },
    { id: 'stars_5', name: '5 ‚≠êÔ∏è', displayChance: '2%', realChance: 2, type: 'stars', value: 5, emoji: '‚≠êÔ∏è' },
    { id: 'bear', name: 'üß∏', displayChance: '1.5%', realChance: 1.5, type: 'item', sellPrice: 20, emoji: 'üß∏' },
    { id: 'diamond_pro', name: 'üíé PRO', displayChance: '0.5%', realChance: 0.5, type: 'collectible', emoji: 'üíé' }
  ],
  coal: [
    { id: 'stars_2_5', name: '2.5 ‚≠êÔ∏è', displayChance: '60%', realChance: 60, type: 'stars', value: 2.5, emoji: '‚≠êÔ∏è' },
    { id: 'stars_5', name: '5 ‚≠êÔ∏è', displayChance: '18%', realChance: 18, type: 'stars', value: 5, emoji: '‚≠êÔ∏è' },
    { id: 'pickaxe', name: '–ö–∏—Ä–∫–∞ ‚õèÔ∏è', displayChance: '10%', realChance: 10, type: 'item', sellPrice: 10, emoji: '‚õèÔ∏è' },
    { id: 'stars_15', name: '15 ‚≠êÔ∏è', displayChance: '6%', realChance: 6, type: 'stars', value: 15, emoji: '‚≠êÔ∏è' },
    { id: 'material', name: '–ú–∞—Ç–µ—Ä–∏–∞–ª üß±', displayChance: '5%', realChance: 5, type: 'item', sellPrice: 40, emoji: 'üß±' },
    { id: 'brownie_pro', name: 'Happy Brownie PRO üí©', displayChance: '1%', realChance: 1, type: 'collectible', emoji: 'üí©' }
  ],
  platinum: [
    { id: 'stars_35', name: '35 ‚≠êÔ∏è', displayChance: '55%', realChance: 55, type: 'stars', value: 35, emoji: '‚≠êÔ∏è' },
    { id: 'stars_50', name: '50 ‚≠êÔ∏è', displayChance: '35%', realChance: 35, type: 'stars', value: 50, emoji: '‚≠êÔ∏è' },
    { id: 'ring', name: 'üíç', displayChance: '5%', realChance: 5, type: 'collectible', emoji: 'üíç' },
    { id: 'bday', name: 'B-day üóì', displayChance: '4%', realChance: 4, type: 'item', sellPrice: 150, emoji: 'üóì' },
    { id: 'bday_pro', name: 'B-Day PRO üìÖ', displayChance: '1%', realChance: 1, type: 'collectible', emoji: 'üìÖ' }
  ],
  gold: [
    { id: 'stars_50', name: '50 ‚≠êÔ∏è', displayChance: '50%', realChance: 50, type: 'stars', value: 50, emoji: '‚≠êÔ∏è' },
    { id: 'stars_125', name: '125 ‚≠êÔ∏è', displayChance: '35%', realChance: 35, type: 'stars', value: 125, emoji: '‚≠êÔ∏è' },
    { id: 'clover', name: 'üçÄ Clover Pin', displayChance: '10%', realChance: 10, type: 'item', sellPrice: 200, emoji: 'üçÄ' },
    { id: 'icecream', name: 'Ice Cream üç¶', displayChance: '3%', realChance: 3, type: 'collectible', emoji: 'üç¶' },
    { id: 'clover_pro', name: 'üçÄ Clover Pin PRO', displayChance: '2%', realChance: 2, type: 'collectible', emoji: 'üçÄ' }
  ],
  money: [
    { id: 'stars_150', name: '150 ‚≠êÔ∏è', displayChance: '45%', realChance: 45, type: 'stars', value: 150, emoji: '‚≠êÔ∏è' },
    { id: 'stars_75', name: '75 ‚≠êÔ∏è', displayChance: '40%', realChance: 40, type: 'stars', value: 75, emoji: '‚≠êÔ∏è' },
    { id: 'trophy', name: 'üèÜ', displayChance: '5%', realChance: 5, type: 'collectible', emoji: 'üèÜ' },
    { id: 'gem', name: 'üíé', displayChance: '5%', realChance: 5, type: 'collectible', emoji: 'üíé' },
    { id: 'bday_happy', name: 'Happy B-day üíà', displayChance: '4%', realChance: 4, type: 'collectible', emoji: 'üíà' },
    { id: 'cigar', name: 'Snoop Cigar üö¨', displayChance: '1%', realChance: 1, type: 'collectible', emoji: 'üö¨' }
  ],
  elite: [
    { id: 'stars_200', name: '200 ‚≠êÔ∏è', displayChance: '75%', realChance: 75, type: 'stars', value: 200, emoji: '‚≠êÔ∏è' },
    { id: 'stars_275', name: '275 ‚≠êÔ∏è', displayChance: '5%', realChance: 5, type: 'stars', value: 275, emoji: '‚≠êÔ∏è' },
    { id: 'champagne', name: 'üçæ', displayChance: '17%', realChance: 17, type: 'collectible', emoji: 'üçæ' },
    { id: 'socks', name: '–ù–æ—Å–∫–∏ üß¶', displayChance: '2%', realChance: 2, type: 'collectible', emoji: 'üß¶' },
    { id: 'lightsword', name: 'Light Sword ‚öîÔ∏è', displayChance: '1%', realChance: 1, type: 'collectible', emoji: '‚öîÔ∏è' }
  ],
  diamond: [
    { id: 'stars_8', name: '8 ‚≠êÔ∏è', displayChance: '70%', realChance: 70, type: 'stars', value: 8, emoji: '‚≠êÔ∏è' },
    { id: 'bear', name: '–ú–∏—à–∫–∞ üß∏', displayChance: '15%', realChance: 15, type: 'item', sellPrice: 20, emoji: 'üß∏' },
    { id: 'stars_25', name: '25 ‚≠êÔ∏è', displayChance: '9%', realChance: 9, type: 'stars', value: 25, emoji: '‚≠êÔ∏è' },
    { id: 'stars_80', name: '80 ‚≠êÔ∏è', displayChance: '4%', realChance: 4, type: 'stars', value: 80, emoji: '‚≠êÔ∏è' },
    { id: 'diamond_pro', name: '–ê–ª–º–∞–∑ PRO üíé', displayChance: '0.6%', realChance: 0.6, type: 'collectible', emoji: 'üíé' },
    { id: 'snoop_pro', name: 'Snoop Dog PRO üêï', displayChance: '0.4%', realChance: 0.4, type: 'collectible', emoji: 'üêï' }
  ],
  winter: [
    { id: 'stars_20', name: '20 ‚≠êÔ∏è', displayChance: '60%', realChance: 60, type: 'stars', value: 20, emoji: '‚≠êÔ∏è' },
    { id: 'stars_35', name: '35 ‚≠êÔ∏è', displayChance: '35%', realChance: 35, type: 'stars', value: 35, emoji: '‚≠êÔ∏è' },
    { id: 'stars_80', name: '80 ‚≠êÔ∏è', displayChance: '3.5%', realChance: 3.5, type: 'stars', value: 80, emoji: '‚≠êÔ∏è' },
    { id: 'snake', name: 'üéÑ Lunar Snake 2025 üêç', displayChance: '1%', realChance: 1, type: 'collectible', emoji: 'üêç' },
    { id: 'scarf', name: 'üß£ –ó–∏–º–Ω–µ–µ —Å–æ–∫—Ä–æ–≤–∏—â–µ', displayChance: '0.5%', realChance: 0.5, type: 'collectible', emoji: 'üß£' }
  ],
  major: [
    { id: 'stars_500', name: '500 ‚≠êÔ∏è', displayChance: '50%', realChance: 50, type: 'stars', value: 500, emoji: '‚≠êÔ∏è' },
    { id: 'stars_1000', name: '1000 ‚≠êÔ∏è', displayChance: '25%', realChance: 25, type: 'stars', value: 1000, emoji: '‚≠êÔ∏è' },
    { id: 'stars_2500', name: '2500 ‚≠êÔ∏è', displayChance: '10%', realChance: 10, type: 'stars', value: 2500, emoji: '‚≠êÔ∏è' },
    { id: 'stars_5000', name: '5000 ‚≠êÔ∏è', displayChance: '5%', realChance: 5, type: 'stars', value: 5000, emoji: '‚≠êÔ∏è' },
    { id: 'car', name: 'üöó –ê–≤—Ç–æ–º–æ–±–∏–ª—å', displayChance: '5%', realChance: 5, type: 'collectible', emoji: 'üöó' },
    { id: 'diamond_ring', name: 'üíç –ë—Ä–∏–ª–ª–∏–∞–Ω—Ç–æ–≤–æ–µ –∫–æ–ª—å—Ü–æ', displayChance: '3%', realChance: 3, type: 'collectible', emoji: 'üíç' },
    { id: 'gold_bar', name: 'ü•á –ó–æ–ª–æ—Ç–æ–π —Å–ª–∏—Ç–æ–∫', displayChance: '2%', realChance: 2, type: 'collectible', emoji: 'ü•á' }
  ],
  collector: [
    { id: 'bear_pro', name: 'üß∏ PRO', displayChance: '55%', realChance: 55, type: 'collectible', emoji: 'üß∏' },
    { id: 'gift_pro', name: 'üéÅ PRO', displayChance: '20%', realChance: 20, type: 'collectible', emoji: 'üéÅ' },
    { id: 'rocket_pro', name: 'üöÄ PRO', displayChance: '15%', realChance: 15, type: 'collectible', emoji: 'üöÄ' },
    { id: 'cup_pro', name: 'üèÜ PRO', displayChance: '5%', realChance: 5, type: 'collectible', emoji: 'üèÜ' },
    { id: 'cake_candle', name: 'üç∞ B-day Candle', displayChance: '2%', realChance: 2, type: 'collectible', emoji: 'üç∞' },
    { id: 'ramen_pro', name: 'üçú Ramen PRO', displayChance: '1.5%', realChance: 0.5, type: 'collectible', emoji: 'üçú' },
    { id: 'hat_pro', name: 'üé© Top hat', displayChance: '1%', realChance: 0, type: 'collectible', emoji: 'üé©' },
    { id: 'bird_pro', name: 'ü¶Ö Rare bird', displayChance: '0.5%', realChance: 0, type: 'collectible', emoji: 'ü¶Ö' }
  ]
};

const INITIAL_CASES = {
  cardboard: { id: 'cardboard', name: '–ö–∞—Ä—Ç–æ–Ω', emoji: 'üì¶', price: 3, color: 'from-amber-800 to-amber-900', locked: false, isNew: true, freeCount: 0 },
  coal: { id: 'coal', name: '–£–≥–æ–ª—ë–∫', emoji: 'ü™®', price: 22, originalPrice: 22, discountPrice: 20, color: 'from-gray-600 to-gray-800', locked: false, isNew: false, freeCount: 0 },
  platinum: { id: 'platinum', name: '–ü–ª–∞—Ç–∏–Ω–∞', emoji: 'üíé', price: 100, color: 'from-gray-300 to-gray-500', locked: false },
  gold: { id: 'gold', name: '–ó–æ–ª–æ—Ç–æ–π', emoji: 'üëë', price: 250, color: 'from-yellow-400 to-yellow-600', locked: false },
  money: { id: 'money', name: '–î–µ–Ω–µ–∂–Ω—ã–π', emoji: 'üíµ', price: 350, color: 'from-green-400 to-green-600', locked: false },
  elite: { id: 'elite', name: '–≠–ª–∏—Ç–∞', emoji: 'üéñ', price: 500, color: 'from-red-400 to-red-600', locked: false, isNew: false, freeCount: 0 },
  diamond: { id: 'diamond', name: '–ê–ª–º–∞–∑', emoji: 'üíé', price: 50, originalPrice: 50, discountPrice: 35, color: 'from-blue-400 to-blue-600', locked: false, isNew: false, freeCount: 0 },
  winter: { id: 'winter', name: '–ó–∏–º–Ω–∏–π', emoji: '‚òÉÔ∏è', price: 125, originalPrice: 150, discountPrice: 125, color: 'from-cyan-400 to-blue-500', locked: false, isNew: true, freeCount: 0 },
  major: { id: 'major', name: '–ú–∞–∂–æ—Ä', emoji: 'ü§¥', price: 800, color: 'from-purple-500 to-indigo-700', locked: true, isNew: false, freeCount: 0 },
  collector: { id: 'collector', name: '–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–µ—Ä', emoji: 'üé©', price: 650, color: 'from-rose-600 to-pink-800', locked: true, isNew: true, freeCount: 0 }
};

const ICE_ARENA_PRIZES = [
  { id: 'bear', name: 'üß∏ –ú–∏—à–∫–∞', chance: 40, type: 'item', sellPrice: 20, emoji: 'üß∏' },
  { id: 'gloves', name: 'üß§ –í–∞—Ä–µ–∂–∫–∏', chance: 30, type: 'item', sellPrice: 50, emoji: 'üß§' },
  { id: 'fire', name: 'üî• –û–≥–æ–Ω—å', chance: 10, type: 'special', emoji: 'üî•', message: '–í—ã —Ä–∞—Å—Ç–æ–ø–∏–ª–∏ –ª—ë–¥! –ü–æ–ª—É—á–∞–µ—Ç–µ 40% –æ—Ç —Å—Ç–∞–≤–æ–∫' },
  { id: 'snow', name: '‚ùÑÔ∏è –°–Ω–µ–∂–∏–Ω–∫–∞', chance: 5, type: 'item', sellPrice: 125, emoji: '‚ùÑÔ∏è' },
  { id: 'snoop', name: 'üêï Snoop Dog', chance: 5, type: 'item', sellPrice: 130, emoji: 'üêï' },
  { id: 'winter_case', name: '‚òÉÔ∏è –ö–µ–π—Å –ó–∏–º–Ω–∏–π', chance: 4, type: 'case_free', caseType: 'winter', emoji: '‚òÉÔ∏è' },
  { id: 'elite_case', name: 'üéñ –ö–µ–π—Å –≠–ª–∏—Ç–Ω—ã–π', chance: 3, type: 'case_free', caseType: 'elite', emoji: 'üéñ' },
  { id: 'stars_350', name: '350 ‚≠êÔ∏è', chance: 2, type: 'stars', value: 350, emoji: '‚≠êÔ∏è' },
  { id: 'scarf', name: 'üß£ –ó–∏–º–Ω–µ–µ —Å–æ–∫—Ä–æ–≤–∏—â–µ', chance: 0.5, type: 'collectible', emoji: 'üß£' },
  { id: 'dellko', name: 'üîë Promocode DELLKO', chance: 0.5, type: 'promo', code: 'DELLKO', emoji: 'üîë' }
];

const TON_RATES = [{ stars: 50, ton: 0.6 }, { stars: 250, ton: 3 }, { stars: 500, ton: 6 }, { stars: 1000, ton: 12 }];
const STARS_PACKAGES = [
  { stars: 50, price: 50 }, { stars: 100, price: 100 },
  { stars: 250, price: 250 }, { stars: 500, price: 500 }, { stars: 1000, price: 1000 }
];

// –î–µ—Ñ–æ–ª—Ç–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ª–æ–±–±–∏
const DEFAULT_LOBBY = {
  status: 'waiting',
  players: {},
  presence: {},
  readyPlayers: {},
  winner: null,
  prizes: [],
  wonStars: 0,
  ballPosition: { x: 50, y: 50, vx: 0, vy: 0 },
  countdownEnd: null,
  prizeClaimed: {},
  finalBall: null,
  gameStartedAt: null
};

function App() {
  const [currentScreen, setCurrentScreen] = useState('cases');
  const [balance, setBalance] = useState(0);
  const [cases, setCases] = useState(INITIAL_CASES);
  const [inventory, setInventory] = useState([]);
  const [inventorySlots, setInventorySlots] = useState(5);
  const [tasks, setTasks] = useState({
    subscribe: { completed: false },
    deposit: { completed: false },
    depositMajor: { completed: false },
    inviteThree: { completed: false, count: 0, required: 3, reward: 25 }
  });
  const [user, setUser] = useState(null);
  const [isLoading, setIsLoading] = useState(true);

  // Roulette
  const [selectedCase, setSelectedCase] = useState(null);
  const [isSpinning, setIsSpinning] = useState(false);
  const [spinResult, setSpinResult] = useState(null);
  const [rouletteOffset, setRouletteOffset] = useState(0);
  const [fakeItems, setFakeItems] = useState([]);
  const [rouletteKey, setRouletteKey] = useState(0);
  const rouletteContainerRef = useRef(null);

  // UI modals
  const [showTopUp, setShowTopUp] = useState(false);
  const [promoCode, setPromoCode] = useState('');
  const [promoError, setPromoError] = useState('');
  const [promoSuccess, setPromoSuccess] = useState('');
  const [usedPromos, setUsedPromos] = useState([]);
  const [wonPromos, setWonPromos] = useState([]);
  const [showCollectibleModal, setShowCollectibleModal] = useState(false);
  const [selectedCollectible, setSelectedCollectible] = useState(null);
  const [showIceGiftModal, setShowIceGiftModal] = useState(false);
  const [selectedIceGift, setSelectedIceGift] = useState(null);
  const [showWithdrawModal, setShowWithdrawModal] = useState(false);
  const [withdrawAmount, setWithdrawAmount] = useState('');
  const [showAdminLogin, setShowAdminLogin] = useState(false);
  const [adminLogin, setAdminLogin] = useState('');
  const [adminPassword, setAdminPassword] = useState('');
  const [isAdmin, setIsAdmin] = useState(false);
  const [adminScreen, setAdminScreen] = useState('stats');
  const [allUsers, setAllUsers] = useState([]);
  const [selectedUser, setSelectedUser] = useState(null);
  const [adminAttempts, setAdminAttempts] = useState(0);
  const [onlineCount, setOnlineCount] = useState(Math.floor(Math.random() * 300) + 200);
  const [pendingPayments, setPendingPayments] = useState([]);
  const [checkingPayment, setCheckingPayment] = useState(false);
  const [paymentStatus, setPaymentStatus] = useState('');
  const [totalDeposits, setTotalDeposits] = useState(0);
  const [freeEliteSpin, setFreeEliteSpin] = useState(0);

  // Ice Arena
  const [currentGame, setCurrentGame] = useState(null);
  const [iceLobby, setIceLobby] = useState(null);
  const [gameStatus, setGameStatus] = useState('waiting');
  const [ballPos, setBallPos] = useState({ x: 50, y: 50 });
  const [timerRemaining, setTimerRemaining] = useState(0);

  // –õ–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä–æ–∫–∞
  const [myBet, setMyBet] = useState(25);
  const [myBetInput, setMyBetInput] = useState(25);
  const [hasBet, setHasBet] = useState(false);
  const [isReady, setIsReady] = useState(false);
  const [myColor, setMyColor] = useState('');

  // –°—á—ë—Ç—á–∏–∫–∏
  const [presenceCount, setPresenceCount] = useState(0);
  const [bettingCount, setBettingCount] = useState(0);
  const [readyCount, setReadyCount] = useState(0);

  // –ü–æ–±–µ–¥–Ω—ã–π —ç–∫—Ä–∞–Ω
  const [showVictoryBox, setShowVictoryBox] = useState(false);
  const [victoryStars, setVictoryStars] = useState(0);
  const [victoryPrize, setVictoryPrize] = useState(null);
  const [boxOpened, setBoxOpened] = useState(false);
  const [prizeClaimedLocal, setPrizeClaimedLocal] = useState(false);

  const gameIntervalRef = useRef(null);
  const countdownRef = useRef(null);

  // ===== INIT =====
  useEffect(() => {
    const initApp = async () => {
      let userId = null;
      let userData = { name: '–ì–æ—Å—Ç—å', username: null, avatar: null };
      if (TelegramWebApp) {
        TelegramWebApp.ready();
        TelegramWebApp.expand();
        const tgUser = TelegramWebApp.initDataUnsafe?.user;
        if (tgUser) {
          userId = tgUser.id.toString();
          userData = {
            name: tgUser.first_name + (tgUser.last_name ? ' ' + tgUser.last_name : ''),
            username: tgUser.username ? '@' + tgUser.username : null,
            avatar: tgUser.photo_url || null
          };
        }
      }
      if (!userId) {
        userId = localStorage.getItem('sbs_user_id') || ('guest_' + Date.now());
        localStorage.setItem('sbs_user_id', userId);
      } else {
        localStorage.setItem('sbs_user_id', userId);
      }
      try {
        const snap = await db.ref('users/' + userId).once('value');
        const data = snap.val();
        if (data) {
          setUser({ id: userId, ...userData, ...data });
          setBalance(data.balance || 0);
          setCases(data.cases || INITIAL_CASES);
          setInventory(data.inventory || []);
          setTasks(data.tasks || { subscribe: { completed: false }, deposit: { completed: false }, depositMajor: { completed: false }, inviteThree: { completed: false, count: 0, required: 3, reward: 25 } });
          setInventorySlots(data.inventorySlots || 5);
          setUsedPromos(data.usedPromos || []);
          setWonPromos(data.wonPromos || []);
          setTotalDeposits(data.totalDeposits || 0);
          setFreeEliteSpin(data.freeEliteSpin || 0);
          db.ref('users/' + userId).update({ name: userData.name, username: userData.username || '' });
        } else {
          const newCases = { ...INITIAL_CASES, diamond: { ...INITIAL_CASES.diamond, freeCount: 5 } };
          const newUser = {
            balance: 0, cases: newCases, inventory: [],
            tasks: { subscribe: { completed: false }, deposit: { completed: false }, depositMajor: { completed: false }, inviteThree: { completed: false, count: 0, required: 3, reward: 25 } },
            inventorySlots: 5, usedPromos: [], wonPromos: [],
            createdAt: Date.now(), lastActive: Date.now(),
            totalDeposits: 0, freeEliteSpin: 0,
            name: userData.name, username: userData.username || ''
          };
          setCases(newCases);
          setUser({ id: userId, ...userData });
          await db.ref('users/' + userId).set(newUser);
        }
      } catch (e) { console.error(e); }
      setIsLoading(false);
    };
    initApp();
  }, []);

  // Online presence
  useEffect(() => {
    if (!user?.id) return;
    const ref = db.ref('online/' + user.id);
    ref.set({ name: user.name, timestamp: Date.now() });
    ref.onDisconnect().remove();
    db.ref('online').on('value', snap => {
      setOnlineCount(Math.floor(Math.random() * 300) + 200 + snap.numChildren());
    });
    return () => ref.remove();
  }, [user?.id]);

  // Auto-save
  useEffect(() => {
    if (!user?.id || isLoading) return;
    const iv = setInterval(() => {
      db.ref('users/' + user.id).update({ balance, cases, inventory, tasks, inventorySlots, usedPromos, wonPromos, lastActive: Date.now(), totalDeposits, freeEliteSpin });
    }, 5000);
    return () => clearInterval(iv);
  }, [balance, cases, inventory, tasks, inventorySlots, usedPromos, wonPromos, user?.id, isLoading, totalDeposits, freeEliteSpin]);

  // ===== LOBBY LISTENER =====
  useEffect(() => {
    if (!currentGame?.lobbyId || !user?.id) return;
    const lobbyId = currentGame.lobbyId;
    const lobbyRef = db.ref('iceLobbies/' + lobbyId);

    lobbyRef.on('value', snap => {
      const data = snap.val();
      if (!data) return;
      setIceLobby(data);

      const status = data.status || 'waiting';
      setGameStatus(status);

      // Presence count
      const presCount = data.presence ? Object.keys(data.presence).length : 0;
      setPresenceCount(presCount);

      // Players (with bets)
      const players = data.players || {};
      const bCount = Object.keys(players).length;
      setBettingCount(bCount);

      // Ready count
      const rCount = data.readyPlayers ? Object.keys(data.readyPlayers).length : 0;
      setReadyCount(rCount);

      // Sync my bet state
      if (players[user.id]) {
        setHasBet(true);
        setMyBet(players[user.id].bet);
        setMyBetInput(players[user.id].bet);
        if (players[user.id].color) setMyColor(players[user.id].color);
      } else {
        // If I was in game (playing) and rejoining, check if game is still running
        if (status !== 'playing' && status !== 'countdown') {
          setHasBet(false);
          setIsReady(false);
        }
      }

      // Ready status
      if (data.readyPlayers?.[user.id]) {
        setIsReady(true);
      } else if (status === 'open') {
        setIsReady(false);
      }

      // Ball position
      if (data.ballPosition) setBallPos(data.ballPosition);

      // Countdown timer
      if (data.countdownEnd && status === 'countdown') {
        const rem = Math.max(0, Math.ceil((data.countdownEnd - Date.now()) / 1000));
        setTimerRemaining(rem);
      } else {
        setTimerRemaining(0);
      }

      // Victory screen for winner
      if (status === 'finished' && data.winner?.id === user.id) {
        if (!data.prizeClaimed?.[user.id] && !prizeClaimedLocal) {
          setVictoryStars(data.wonStars || 0);
          setVictoryPrize(data.prizes?.[0] || null);
          setShowVictoryBox(true);
          setBoxOpened(false);
        }
      }

      // If game finished and I'm not winner, show exit option after delay
      if (status === 'finished' && data.winner && data.winner.id !== user.id) {
        // Non-winners see result and can exit
      }
    });

    return () => {
      lobbyRef.off();
      // Remove presence on unmount
      if (user?.id) {
        db.ref('iceLobbies/' + lobbyId + '/presence/' + user.id).remove();
      }
    };
  }, [currentGame?.lobbyId, user?.id]);

  // Countdown tick
  useEffect(() => {
    if (gameStatus !== 'countdown') { setTimerRemaining(0); return; }
    const iv = setInterval(() => {
      setTimerRemaining(prev => {
        if (prev <= 1) { clearInterval(iv); return 0; }
        return prev - 1;
      });
    }, 1000);
    return () => clearInterval(iv);
  }, [gameStatus]);

  // ===== JOIN LOBBY =====
  const joinIceLobby = async (lobbyId) => {
    if (!user?.id) return;
    const lobbyRef = db.ref('iceLobbies/' + lobbyId);
    const snap = await lobbyRef.once('value');
    const data = snap.val() || {};
    const status = data.status || 'waiting';

    // Generate color for this player
    const color = myColor || getRandomColor();
    setMyColor(color);

    // If game is playing or countdown ‚Äî spectator
    if (status === 'playing' || status === 'countdown') {
      // Check if I had a bet (reconnecting player)
      if (data.players?.[user.id]) {
        setCurrentGame({ type: 'ice', lobbyId, spectator: false });
      } else {
        setCurrentGame({ type: 'ice', lobbyId, spectator: true });
      }
      // Still add to presence
      const presRef = db.ref('iceLobbies/' + lobbyId + '/presence/' + user.id);
      await presRef.set({ name: user.name, avatar: user.avatar || null, joinedAt: Date.now(), color, spectator: true });
      presRef.onDisconnect().remove();
      return;
    }

    // Reset victory states
    setShowVictoryBox(false);
    setBoxOpened(false);
    setPrizeClaimedLocal(false);
    setHasBet(false);
    setIsReady(false);

    // Add to presence
    const presRef = db.ref('iceLobbies/' + lobbyId + '/presence/' + user.id);
    await presRef.set({ name: user.name, avatar: user.avatar || null, joinedAt: Date.now(), color });
    presRef.onDisconnect().remove();

    setCurrentGame({ type: 'ice', lobbyId, spectator: false });

    // Check presence count ‚Üí maybe open betting
    const snap2 = await db.ref('iceLobbies/' + lobbyId).once('value');
    const data2 = snap2.val() || {};
    const presCount = data2.presence ? Object.keys(data2.presence).length : 0;
    if (presCount >= 2 && (data2.status === 'waiting' || !data2.status)) {
      await lobbyRef.update({ status: 'open' });
    }
  };

  // ===== LEAVE LOBBY =====
  const leaveIceLobby = async () => {
    if (!currentGame?.lobbyId || !user?.id) { setCurrentGame(null); return; }
    const lobbyId = currentGame.lobbyId;
    const lobbyRef = db.ref('iceLobbies/' + lobbyId);

    // Remove from presence
    await db.ref('iceLobbies/' + lobbyId + '/presence/' + user.id).remove();

    // If had a bet and game not started ‚Äî refund
    if (hasBet) {
      const snap = await lobbyRef.once('value');
      const data = snap.val() || {};
      if ((data.status === 'open' || data.status === 'waiting') && data.players?.[user.id]) {
        const betAmt = data.players[user.id].bet;
        const newBal = balance + betAmt;
        setBalance(newBal);
        await db.ref('users/' + user.id + '/balance').set(newBal);
        await db.ref('iceLobbies/' + lobbyId + '/players/' + user.id).remove();
        await db.ref('iceLobbies/' + lobbyId + '/readyPlayers/' + user.id).remove();
      }
    }

    // Check remaining presence ‚Äî maybe revert to waiting
    const snap2 = await lobbyRef.once('value');
    const data2 = snap2.val() || {};
    const presCount = data2.presence ? Object.keys(data2.presence).length : 0;
    if (presCount < 2 && (data2.status === 'open')) {
      await lobbyRef.update({ status: 'waiting', readyPlayers: {} });
    }

    setCurrentGame(null);
    setHasBet(false);
    setIsReady(false);
    setShowVictoryBox(false);
    setPrizeClaimedLocal(false);
  };

  // ===== PLACE BET =====
  const placeBet = async () => {
    if (gameStatus !== 'open') { alert('–°—Ç–∞–≤–∫–∏ —Å–µ–π—á–∞—Å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã!'); return; }
    if (myBetInput < 25) { alert('–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞ 25‚≠êÔ∏è!'); return; }
    if (balance < myBetInput) { alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–≤—ë–∑–¥!'); return; }

    const lobbyRef = db.ref('iceLobbies/' + currentGame.lobbyId);
    const snap = await lobbyRef.once('value');
    const data = snap.val() || {};
    if (data.status !== 'open') { alert('–°—Ç–∞–≤–∫–∏ –∑–∞–∫—Ä—ã—Ç—ã!'); return; }

    const newBal = balance - myBetInput;
    setBalance(newBal);
    await db.ref('users/' + user.id + '/balance').set(newBal);

    const color = myColor || getRandomColor();
    setMyColor(color);

    await lobbyRef.child('players/' + user.id).set({
      name: user.name,
      avatar: user.avatar || null,
      bet: myBetInput,
      color,
      timestamp: Date.now()
    });

    setMyBet(myBetInput);
    setHasBet(true);
  };

  // ===== CHANGE BET =====
  const changeBet = async () => {
    if (gameStatus !== 'open') { alert('–°–µ–π—á–∞—Å –Ω–µ–ª—å–∑—è –º–µ–Ω—è—Ç—å —Å—Ç–∞–≤–∫—É!'); return; }
    if (myBetInput < 25) { alert('–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞ 25‚≠êÔ∏è!'); return; }

    const lobbyRef = db.ref('iceLobbies/' + currentGame.lobbyId);
    const snap = await lobbyRef.once('value');
    const data = snap.val() || {};

    if (!data.players?.[user.id]) return;

    const oldBet = data.players[user.id].bet;
    // Return old bet, charge new bet
    const balAfterReturn = balance + oldBet;
    if (balAfterReturn < myBetInput) { alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–≤—ë–∑–¥!'); return; }

    const newBal = balAfterReturn - myBetInput;
    setBalance(newBal);
    await db.ref('users/' + user.id + '/balance').set(newBal);

    await lobbyRef.child('players/' + user.id).update({
      bet: myBetInput,
      timestamp: Date.now()
    });

    setMyBet(myBetInput);
    // Reset ready status
    await lobbyRef.child('readyPlayers/' + user.id).remove();
    setIsReady(false);
  };

  // ===== TOGGLE READY =====
  const toggleReady = async () => {
    if (!hasBet) { alert('–°–Ω–∞—á–∞–ª–∞ —Å–¥–µ–ª–∞–π—Ç–µ —Å—Ç–∞–≤–∫—É!'); return; }
    if (gameStatus !== 'open') return;

    const lobbyRef = db.ref('iceLobbies/' + currentGame.lobbyId);

    if (isReady) {
      await lobbyRef.child('readyPlayers/' + user.id).remove();
      setIsReady(false);
      return;
    }

    await lobbyRef.child('readyPlayers/' + user.id).set({ name: user.name, readyAt: Date.now() });
    setIsReady(true);

    // Check if ALL players with bets are ready
    const snap = await lobbyRef.once('value');
    const data = snap.val() || {};
    const players = data.players || {};
    const readyPlayers = data.readyPlayers || {};
    const bCount = Object.keys(players).length;
    // Include current player in ready count
    const newReadySet = { ...readyPlayers, [user.id]: true };
    const rCount = Object.keys(newReadySet).length;

    if (bCount >= 2 && rCount >= bCount) {
      // All ready ‚Äî start countdown
      const countdownEnd = Date.now() + 10000;
      await lobbyRef.update({ status: 'countdown', countdownEnd });
      // Trigger game start after 10s
      setTimeout(() => triggerGameStart(lobbyRef, currentGame.lobbyId), 10000);
    }
  };

  // ===== NEW PLAYER JOINS DURING COUNTDOWN =====
  useEffect(() => {
    if (!currentGame?.lobbyId || !user?.id) return;
    // When a new player joins presence during countdown, reset to open
    // This is handled server-side by checking presence in the listener
  }, []);

  // Watch for new players joining during countdown (handled via lobby listener)
  useEffect(() => {
    if (gameStatus !== 'countdown' || !currentGame?.lobbyId) return;
    // If a new player added to presence during countdown, revert to open
    const presRef = db.ref('iceLobbies/' + currentGame.lobbyId + '/presence');
    presRef.on('child_added', async () => {
      const snap = await db.ref('iceLobbies/' + currentGame.lobbyId).once('value');
      const data = snap.val() || {};
      if (data.status !== 'countdown') return;
      // If new player NOT in players list joined presence ‚Äî cancel countdown
      const presence = data.presence || {};
      const players = data.players || {};
      const newPresKeys = Object.keys(presence).filter(k => !players[k]);
      if (newPresKeys.length > 0) {
        await db.ref('iceLobbies/' + currentGame.lobbyId).update({ status: 'open', countdownEnd: null });
      }
    });
    return () => presRef.off('child_added');
  }, [gameStatus, currentGame?.lobbyId]);

  // ===== TRIGGER GAME START =====
  const triggerGameStart = async (lobbyRef, lobbyId) => {
    const snap = await lobbyRef.once('value');
    const data = snap.val();
    if (!data || data.status !== 'countdown') return;

    const players = data.players || {};
    const readyPlayers = data.readyPlayers || {};
    const bCount = Object.keys(players).length;
    const rCount = Object.keys(readyPlayers).length;

    if (bCount < 2 || rCount < bCount) {
      // Not all ready ‚Äî refund and reset
      for (const [pid, pdata] of Object.entries(players)) {
        await db.ref('users/' + pid + '/balance').transaction(c => (c || 0) + pdata.bet);
      }
      await lobbyRef.update({ status: 'open', countdownEnd: null, players: {}, readyPlayers: {} });
      return;
    }

    await startIceGame(lobbyRef);
  };

  // ===== START GAME =====
  const startIceGame = async (lobbyRef) => {
    await lobbyRef.update({ status: 'playing', gameStartedAt: Date.now() });

    // Random initial direction, moderate speed ‚Äî ONLY decelerates, never accelerates
    let x = 50, y = 50;
    const angle = Math.random() * Math.PI * 2;
    const initialSpeed = 8 + Math.random() * 6; // 8-14 units/tick
    let vx = Math.cos(angle) * initialSpeed;
    let vy = Math.sin(angle) * initialSpeed;

    const FRICTION = 0.994; // slow friction ‚Äî smooth deceleration
    const RADIUS = 44; // boundary radius (% units)
    const CENTER = 50;

    const iv = setInterval(async () => {
      // Move
      x += vx * 0.4;
      y += vy * 0.4;

      // Boundary check ‚Äî reflect off circular wall
      const dx = x - CENTER;
      const dy = y - CENTER;
      const dist = Math.sqrt(dx * dx + dy * dy);

      if (dist >= RADIUS) {
        // Normal vector at collision point
        const nx = dx / dist;
        const ny = dy / dist;
        // Reflect velocity
        const dot = vx * nx + vy * ny;
        vx = vx - 2 * dot * nx;
        vy = vy - 2 * dot * ny;
        // Add small random perturbation for unpredictability
        const perturbAngle = (Math.random() - 0.5) * 0.4;
        const cos = Math.cos(perturbAngle);
        const sin = Math.sin(perturbAngle);
        const nvx = vx * cos - vy * sin;
        const nvy = vx * sin + vy * cos;
        vx = nvx;
        vy = nvy;
        // Push back inside
        const overlap = dist - RADIUS + 1;
        x -= nx * overlap;
        y -= ny * overlap;
      }

      // Apply friction ‚Äî ONLY deceleration
      vx *= FRICTION;
      vy *= FRICTION;

      const speed = Math.sqrt(vx * vx + vy * vy);

      await lobbyRef.child('ballPosition').set({ x, y, vx, vy });

      // Stop when speed is very low
      if (speed < 0.08) {
        clearInterval(iv);
        await finishIceGame(lobbyRef, x, y);
      }
    }, 25);
  };

  // ===== FINISH GAME =====
  const finishIceGame = async (lobbyRef, finalX, finalY) => {
    const snap = await lobbyRef.once('value');
    const data = snap.val();
    if (!data?.players) return;

    const players = Object.entries(data.players);
    const totalBet = players.reduce((s, [, p]) => s + p.bet, 0);

    // Determine which sector the ball is in (angle from center, 0‚Äì360)
    const dx = finalX - 50;
    const dy = finalY - 50;
    let angle = Math.atan2(dy, dx) * 180 / Math.PI;
    if (angle < 0) angle += 360;

    // Match angle to player sector (sorted by timestamp = order of joining)
    // Sectors go around the full 360¬∞ without gaps; if ball is exactly on border, –æ–Ω–æ –∏–¥—ë—Ç –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Å–µ–∫—Ç–æ—Ä—É –ø–æ –∫—Ä—É–≥—É
    let currentAngle = 0;
    let winner = null;
    const sorted = players.sort((a, b) => a[1].timestamp - b[1].timestamp);
    sorted.forEach(([id, p], index) => {
      if (winner) return;
      const sector = (p.bet / totalBet) * 360;
      const start = currentAngle;
      const end = currentAngle + sector;

      // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —É–≥–æ–ª —à–∞—Ä–∞ –≤ –¥–∏–∞–ø–∞–∑–æ–Ω [0, 360)
      let a = angle % 360;
      if (a < 0) a += 360;

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ø–∞–¥–∞–Ω–∏–µ –≤ —Å–µ–∫—Ç–æ—Ä, —É—á–∏—Ç—ã–≤–∞—è –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–µ–∫—Ç–æ—Ä, –∫–æ—Ç–æ—Ä—ã–π "–¥–æ–±–∏–≤–∞–µ—Ç" –¥–æ 360¬∞
      if (index === sorted.length - 1) {
        // –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–µ–∫—Ç–æ—Ä –∑–∞–±–∏—Ä–∞–µ—Ç –≤—Å—ë, —á—Ç–æ –æ—Å—Ç–∞–ª–æ—Å—å
        if (a >= start || a < (end % 360)) {
          winner = { id, ...p };
        }
      } else {
        if (a >= start && a < end) {
          winner = { id, ...p };
        }
      }

      currentAngle = end;
    });

    // –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –ø–æ –∫–∞–∫–æ–π-—Ç–æ –ø—Ä–∏—á–∏–Ω–µ –Ω–µ –Ω–∞—à–ª–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á–∏—Å–ª–æ–≤—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã) ‚Äî –±–µ—Ä—ë–º –ø–µ—Ä–≤–æ–≥–æ
    if (!winner) winner = { id: sorted[0][0], ...sorted[0][1] };

    // Pick bonus prize
    const rand = Math.random() * 100;
    let cum = 0;
    let wonPrize = ICE_ARENA_PRIZES[0];
    for (const prize of ICE_ARENA_PRIZES) {
      cum += prize.chance;
      if (rand <= cum) { wonPrize = prize; break; }
    }

    const winAmount = Math.floor(totalBet * 0.65);

    await lobbyRef.update({
      status: 'finished',
      winner,
      prizes: [wonPrize],
      wonStars: winAmount,
      finalBall: { x: finalX, y: finalY }
    });

    // Credit winner
    if (winner.id === user.id) {
      const newBal = balance + winAmount;
      setBalance(newBal);
      await db.ref('users/' + user.id + '/balance').set(newBal);
    }
  };

  // ===== OPEN VICTORY BOX =====
  const openVictoryBox = async () => {
    if (boxOpened || !victoryPrize) return;
    setBoxOpened(true);
    setPrizeClaimedLocal(true);

    await db.ref('iceLobbies/' + currentGame.lobbyId + '/prizeClaimed/' + user.id).set(true);

    const prize = victoryPrize;
    if (prize.type === 'stars') {
      const nb = balance + prize.value;
      setBalance(nb);
      await db.ref('users/' + user.id + '/balance').set(nb);
    } else if (prize.type === 'item') {
      await addToInventory(prize);
    } else if (prize.type === 'case_free') {
      const nc = { ...cases, [prize.caseType]: { ...cases[prize.caseType], freeCount: (cases[prize.caseType].freeCount || 0) + 1 } };
      setCases(nc);
    } else if (prize.type === 'promo') {
      alert('–ü–æ–ª—É—á–µ–Ω –ø—Ä–æ–º–æ–∫–æ–¥: ' + prize.code);
    }
  };

  // ===== EXIT LOBBY AFTER GAME =====
  const exitLobbyAfterGame = async () => {
    if (!currentGame?.lobbyId) { setCurrentGame(null); return; }
    const lobbyRef = db.ref('iceLobbies/' + currentGame.lobbyId);

    // Clear everything for next game
    await lobbyRef.set(DEFAULT_LOBBY);

    setCurrentGame(null);
    setHasBet(false);
    setIsReady(false);
    setShowVictoryBox(false);
    setBoxOpened(false);
    setPrizeClaimedLocal(false);
    setMyColor('');
    setMyBet(25);
    setMyBetInput(25);
  };

  // Non-winner exit
  const exitLobbyNonWinner = async () => {
    if (!currentGame?.lobbyId) { setCurrentGame(null); return; }
    await db.ref('iceLobbies/' + currentGame.lobbyId + '/presence/' + user.id).remove();
    setCurrentGame(null);
    setHasBet(false);
    setIsReady(false);
    setMyColor('');
    setMyBet(25);
    setMyBetInput(25);
  };

  // ===== ICE ARENA FIELD RENDER =====
  const renderIceField = () => {
    if (!iceLobby?.players) return null;
    const players = Object.entries(iceLobby.players);
    if (players.length === 0) return null;
    const totalBet = players.reduce((s, [, p]) => s + p.bet, 0);
    if (totalBet === 0) return null;

    const sorted = players.sort((a, b) => a[1].timestamp - b[1].timestamp);
    let currentAngle = 0;

    return sorted.map(([id, player]) => {
      const pct = (player.bet / totalBet) * 100;
      const sectorDeg = (player.bet / totalBet) * 360;
      const midAngle = currentAngle + sectorDeg / 2;
      const startAngle = currentAngle;
      currentAngle += sectorDeg;

      // Avatar position
      const avatarDist = 28;
      const avatarX = 50 + avatarDist * Math.cos((midAngle - 90) * Math.PI / 180);
      const avatarY = 50 + avatarDist * Math.sin((midAngle - 90) * Math.PI / 180);

      // Percent label position
      const labelDist = 18;
      const labelX = 50 + labelDist * Math.cos((midAngle - 90) * Math.PI / 180);
      const labelY = 50 + labelDist * Math.sin((midAngle - 90) * Math.PI / 180);

      return (
        <React.Fragment key={id}>
          {/* Sector fill */}
          <div
            className="absolute inset-0"
            style={{
              background: `conic-gradient(from ${startAngle}deg at 50% 50%, ${player.color}bb ${sectorDeg}deg, transparent ${sectorDeg}deg)`,
              clipPath: 'circle(50% at 50% 50%)',
              borderRadius: '50%'
            }}
          />
          {/* Percent label */}
          <div
            className="absolute pointer-events-none font-bold text-white"
            style={{
              left: `${labelX}%`,
              top: `${labelY}%`,
              transform: 'translate(-50%,-50%)',
              fontSize: '11px',
              textShadow: '0 0 6px black, 0 0 3px black'
            }}
          >
            {Math.round(pct)}%
          </div>
          {/* Avatar */}
          <div
            className="player-avatar"
            style={{
              left: `${avatarX}%`,
              top: `${avatarY}%`,
              borderColor: player.color,
              boxShadow: `0 0 12px ${player.color}`
            }}
          >
            {player.avatar
              ? <img src={player.avatar} className="w-full h-full object-cover" alt="" />
              : <div className="w-full h-full flex items-center justify-center text-xs font-bold" style={{ background: player.color }}>{player.name[0]}</div>
            }
          </div>
        </React.Fragment>
      );
    });
  };

  // ===== CASES =====
  const getCasePrice = (ct) => {
    const c = cases[ct];
    if (!c) return 0;
    if (c.freeCount > 0) return 0;
    if (c.discountPrice && c.discountPrice !== c.price) return c.discountPrice;
    return c.price;
  };

  const openCase = async (caseType) => {
    if (caseType === 'collector' && cases.collector?.locked) { alert('–ö–µ–π—Å ¬´–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–µ—Ä¬ª –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!'); return; }
    const price = getCasePrice(caseType);
    const isFree = cases[caseType]?.freeCount > 0;
    const isElite = caseType === 'elite';
    const hasFreeElite = isElite && freeEliteSpin > 0;
    if (!hasFreeElite && !isFree && price > 0 && balance < price) { alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–≤—ë–∑–¥!'); return; }

    let newBal = balance;
    if (isFree) {
      const nf = cases[caseType].freeCount - 1;
      setCases(prev => ({ ...prev, [caseType]: { ...prev[caseType], freeCount: nf } }));
      await db.ref(`users/${user.id}/cases/${caseType}/freeCount`).set(nf);
    } else if (hasFreeElite) {
      const ns = freeEliteSpin - 1;
      setFreeEliteSpin(ns);
      await db.ref(`users/${user.id}/freeEliteSpin`).set(ns);
    } else if (price > 0) {
      newBal = balance - price;
      setBalance(newBal);
      await db.ref('users/' + user.id + '/balance').set(newBal);
    }

    setIsSpinning(true);
    setSelectedCase({ ...cases[caseType], id: caseType });
    setSpinResult(null);
    setRouletteOffset(0);
    setFakeItems([]);
    setRouletteKey(prev => prev + 1);

    const items = CASE_REWARDS[caseType];
    const rand = Math.random() * 100;
    let cum = 0, won = items[0];
    for (const item of items) { cum += item.realChance; if (rand <= cum) { won = item; break; } }

    const tape = [];
    for (let i = 0; i < 80; i++) tape.push(i === 70 ? won : items[Math.floor(Math.random() * items.length)]);

    setTimeout(() => {
      setFakeItems(tape);
      setTimeout(() => {
        const cw = rouletteContainerRef.current ? rouletteContainerRef.current.offsetWidth : window.innerWidth;
        const ifw = 136;
        setRouletteOffset(-(70 * ifw + ifw / 2 - cw / 2));
      }, 100);
    }, 100);

    setTimeout(async () => {
      setSpinResult(won);
      setIsSpinning(false);
      if (won.type === 'stars') {
        const fb = newBal + won.value;
        setBalance(fb);
        await db.ref(`users/${user.id}/balance`).set(fb);
      } else {
        await addToInventory(won);
      }
    }, 6600);
  };

  const addToInventory = async (item) => {
    if (inventory.length >= inventorySlots) { alert('–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø–æ–ª–æ–Ω!'); return; }
    const ni = [...inventory, { ...item, uniqueId: Date.now(), collected: Date.now() }];
    setInventory(ni);
    await db.ref(`users/${user.id}/inventory`).set(ni);
  };

  const sellItem = async (item) => {
    if (item.type === 'ice_gift') { setSelectedIceGift(item); setShowIceGiftModal(true); return; }
    if (item.type === 'collectible') { setSelectedCollectible(item); setShowCollectibleModal(true); return; }
    if (confirm(`–ü—Ä–æ–¥–∞—Ç—å ${item.name} –∑–∞ ${item.sellPrice}‚≠êÔ∏è?`)) {
      const nb = balance + item.sellPrice;
      const ni = inventory.filter(i => i.uniqueId !== item.uniqueId);
      setBalance(nb); setInventory(ni);
      await db.ref(`users/${user.id}`).update({ balance: nb, inventory: ni });
    }
  };

  const sellIceGift = async () => {
    if (!selectedIceGift) return;
    const nb = balance + 25;
    const ni = inventory.filter(i => i.uniqueId !== selectedIceGift.uniqueId);
    setBalance(nb); setInventory(ni);
    await db.ref(`users/${user.id}`).update({ balance: nb, inventory: ni });
    setShowIceGiftModal(false); setSelectedIceGift(null);
    alert('–ü—Ä–æ–¥–∞–Ω–æ –∑–∞ 25‚≠êÔ∏è!');
  };

  const unlockSlot = async () => {
    if (balance < 50) { alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–≤—ë–∑–¥!'); return; }
    if (confirm('–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Å–ª–æ—Ç –∑–∞ 50‚≠êÔ∏è?')) {
      const nb = balance - 50, ns = inventorySlots + 1;
      setBalance(nb); setInventorySlots(ns);
      await db.ref(`users/${user.id}`).update({ balance: nb, inventorySlots: ns });
    }
  };

  const checkPromo = async () => {
    const code = promoCode.toUpperCase().trim();
    setPromoError(''); setPromoSuccess('');
    if (!code) return;
    if (usedPromos.includes(code)) { setPromoError('–£–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω!'); return; }
    if (code === 'DELLKO') {
      if (!wonPromos.includes('DELLKO')) { setPromoError('–¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—ã–∏–≥—Ä–∞–ª–∏ –≤ –õ–µ–¥—è–Ω–æ–º –ö–∞—Ç–∫–µ!'); return; }
      const nc = { ...cases, money: { ...cases.money, freeCount: (cases.money.freeCount || 0) + 3 } };
      setCases(nc);
      await addToInventory({ name: 'üßä –õ—ë–¥ (1/3)', emoji: 'üßä', type: 'ice', part: 1 });
      setPromoSuccess('+3 –¥–µ–Ω–µ–∂–Ω—ã—Ö –∫–µ–π—Å–∞ + üßä!');
      const np = [...usedPromos, code]; setUsedPromos(np); setPromoCode('');
      await db.ref(`users/${user.id}/usedPromos`).set(np);
    } else if (code === 'DIAMOND') {
      const nc = { ...cases, diamond: { ...cases.diamond, freeCount: (cases.diamond.freeCount || 0) + 2 } };
      setCases(nc); setPromoSuccess('+2 –∫–µ–π—Å–∞ –ê–ª–º–∞–∑!');
      const np = [...usedPromos, code]; setUsedPromos(np); setPromoCode('');
      await db.ref(`users/${user.id}/usedPromos`).set(np);
    } else { setPromoError('–ù–µ–≤–µ—Ä–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥'); }
  };

  const topUpBalance = async (stars, ton) => {
    const pid = 'PAY_' + Date.now();
    const memo = `SBS_${user.id}_${stars}_${pid}`;
    const link = `ton://transfer/${ADMIN_WALLET}?amount=${Math.round(ton * 1e9)}&text=${encodeURIComponent(memo)}`;
    window.open(link, '_blank');
    setPaymentStatus(`–û—Ç–ø—Ä–∞–≤—å—Ç–µ ${ton} TON —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–º: ${memo}`);
    setShowTopUp(false);
  };

  const buyStars = async (pkg) => {
    try {
      const r = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/createInvoiceLink`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title: `${pkg.stars} –∑–≤—ë–∑–¥`, description: `–ü–æ–∫—É–ø–∫–∞ ${pkg.stars} –∑–≤—ë–∑–¥`, payload: `stars_${user.id}_${pkg.stars}_${Date.now()}`, currency: 'XTR', prices: [{ label: `${pkg.stars} –∑–≤—ë–∑–¥`, amount: pkg.price }] })
      });
      const data = await r.json();
      if (data.ok && data.result) {
        if (TelegramWebApp) {
          TelegramWebApp.openInvoice(data.result, async (status) => {
            if (status === 'paid') {
              const nb = balance + pkg.stars, nd = totalDeposits + pkg.stars;
              setBalance(nb); setTotalDeposits(nd);
              await db.ref(`users/${user.id}`).update({ balance: nb, totalDeposits: nd });
              checkDepositTasks(nd);
              alert(`‚úÖ –ó–∞—á–∏—Å–ª–µ–Ω–æ ${pkg.stars} –∑–≤—ë–∑–¥!`);
            }
          });
        } else { window.open(data.result, '_blank'); }
      }
    } catch (e) { alert('–û—à–∏–±–∫–∞ –ø–ª–∞—Ç–µ–∂–∞.'); }
  };

  const checkDepositTasks = async (nd) => {
    if (!tasks.deposit?.completed && nd >= 100) {
      const nt = { ...tasks, deposit: { completed: true } };
      const nc = { ...cases, gold: { ...cases.gold, freeCount: (cases.gold.freeCount || 0) + 1 } };
      setTasks(nt); setCases(nc);
      await db.ref(`users/${user.id}`).update({ tasks: nt, cases: nc });
    }
    if (!tasks.depositMajor?.completed && nd >= 350) {
      const nt = { ...tasks, depositMajor: { completed: true } };
      const nc = { ...cases, collector: { ...cases.collector, locked: false, freeCount: (cases.collector.freeCount || 0) + 1 } };
      setTasks(nt); setCases(nc);
      await db.ref(`users/${user.id}`).update({ tasks: nt, cases: nc });
    }
  };

  const completeTask = async (taskId) => {
    if (taskId === 'subscribe') {
      window.open('https://t.me/stepbystepdelision', '_blank');
      setTimeout(async () => {
        if (!tasks.subscribe?.completed) {
          const nt = { ...tasks, subscribe: { completed: true } };
          const nc = { ...cases, elite: { ...cases.elite, freeCount: (cases.elite.freeCount || 0) + 1 } };
          const ns = freeEliteSpin + 1;
          setTasks(nt); setCases(nc); setFreeEliteSpin(ns);
          await db.ref(`users/${user.id}`).update({ tasks: nt, cases: nc, freeEliteSpin: ns });
          alert('üéâ –ü–æ–ª—É—á–µ–Ω 1 –∫–µ–π—Å ¬´–≠–ª–∏—Ç–∞¬ª + 1 –ø—Ä–æ–∫—Ä—É—Ç!');
        }
      }, 2000);
    } else if (taskId === 'inviteThree') {
      window.open('https://t.me/share/url?url=' + encodeURIComponent(`https://t.me/stepbystep_game_bot?start=${user.id}`), '_blank');
    } else if (taskId === 'deposit' || taskId === 'depositMajor') {
      setShowTopUp(true);
    }
  };

  const confirmWithdraw = () => {
    alert('–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞–≥—Ä–∞–¥—ã –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏! https://t.me/stepbystepdelision');
    setShowWithdrawModal(false); setWithdrawAmount('');
  };

  const handleTitleClick = () => {
    const n = adminAttempts + 1; setAdminAttempts(n);
    if (n >= 11) { setShowAdminLogin(true); setAdminAttempts(0); }
  };
  const checkAdminLogin = () => {
    if (adminLogin === '_*\\^BAGUETTE_642819_6281' && adminPassword === '3628874910ZTWMI_') {
      setIsAdmin(true); setShowAdminLogin(false);
      db.ref('users').once('value').then(snap => {
        const u = []; snap.forEach(c => u.push({ id: c.key, ...c.val() })); setAllUsers(u);
      });
    } else { alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å!'); }
  };
  const adminGiveReward = async (tid, reward) => {
    const snap = await db.ref('users/' + tid).once('value');
    const ud = snap.val() || {};
    if (reward.type === 'stars') { const nb = (ud.balance || 0) + reward.amount; await db.ref('users/' + tid + '/balance').set(nb); if (tid === user.id) setBalance(nb); }
    else if (reward.type === 'case') { const cur = ud.cases?.[reward.caseType]?.freeCount || 0; await db.ref(`users/${tid}/cases/${reward.caseType}/freeCount`).set(cur + reward.count); if (tid === user.id) setCases(prev => ({ ...prev, [reward.caseType]: { ...prev[reward.caseType], freeCount: cur + reward.count } })); }
    else if (reward.type === 'unlock_collector') { await db.ref(`users/${tid}/cases/collector/locked`).set(false); if (tid === user.id) setCases(prev => ({ ...prev, collector: { ...prev.collector, locked: false } })); }
    alert('–ù–∞–≥—Ä–∞–¥–∞ –≤—ã–¥–∞–Ω–∞!');
  };

  // ===== ICE LOBBY SCREEN =====
  if (currentGame?.type === 'ice') {
    const isSpectator = currentGame.spectator === true;
    const presence = iceLobby?.presence ? Object.entries(iceLobby.presence) : [];
    const players = iceLobby?.players ? Object.entries(iceLobby.players) : [];
    const readySet = new Set(iceLobby?.readyPlayers ? Object.keys(iceLobby.readyPlayers) : []);
    const bettedSet = new Set(players.map(([id]) => id));
    const totalBank = players.reduce((s, [, p]) => s + p.bet, 0);
    const myPlayerData = iceLobby?.players?.[user?.id];
    const isWinner = gameStatus === 'finished' && iceLobby?.winner?.id === user?.id;
    const isLoser = gameStatus === 'finished' && iceLobby?.winner && iceLobby.winner.id !== user?.id;

    const statusText = () => {
      if (isSpectator) return 'üëÅ –ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å';
      switch (gameStatus) {
        case 'waiting': return `‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤ (${presenceCount}/2+)`;
        case 'open': return presenceCount >= 2 ? '‚úÖ –°—Ç–∞–≤–∫–∏ –æ—Ç–∫—Ä—ã—Ç—ã!' : '‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ...';
        case 'countdown': return `‚è∞ –°—Ç–∞—Ä—Ç —á–µ—Ä–µ–∑ ${timerRemaining} —Å–µ–∫!`;
        case 'playing': return 'üî¥ –ò–≥—Ä–∞ –∏–¥—ë—Ç!';
        case 'finished': return isWinner ? 'üèÜ –í—ã –ø–æ–±–µ–¥–∏–ª–∏!' : `üèÜ –ü–æ–±–µ–¥–∏–ª: ${iceLobby?.winner?.name}`;
        default: return '';
      }
    };

    return (
      <div className="min-h-screen bg-gradient-to-b from-blue-950 via-indigo-950 to-blue-900 pb-4">
        <div className="max-w-lg mx-auto p-3">
          {/* Header */}
          <div className="flex justify-between items-center mb-3">
            <div>
              <h1 className="text-xl font-bold text-white">‚òÉÔ∏è –õ–µ–¥—è–Ω–æ–π –ö–∞—Ç–æ–∫</h1>
              <div className="text-xs text-cyan-400">–õ–æ–±–±–∏ #{currentGame.lobbyId}</div>
            </div>
            <button onClick={leaveIceLobby} className="bg-red-600/40 hover:bg-red-600 border border-red-500/50 px-3 py-1.5 rounded-xl font-bold transition text-sm">‚úï –í—ã–π—Ç–∏</button>
          </div>

          {/* Status bar */}
          <div className={`rounded-xl p-2.5 mb-3 text-center font-bold border text-sm ${
            gameStatus === 'countdown' ? 'bg-yellow-500/20 border-yellow-500/50 animate-pulse' :
            gameStatus === 'open' ? 'bg-cyan-500/20 border-cyan-500/50' :
            gameStatus === 'playing' ? 'bg-red-500/20 border-red-500/50' :
            gameStatus === 'finished' ? 'bg-purple-500/20 border-purple-500/50' :
            'bg-gray-700/50 border-gray-600/50'
          }`}>
            {statusText()}
          </div>

          {/* Countdown */}
          {gameStatus === 'countdown' && timerRemaining > 0 && (
            <div className="text-center mb-3">
              <div className="text-6xl font-bold text-yellow-400 animate-pulse">{timerRemaining}</div>
              <div className="text-gray-400 text-xs">—Å–µ–∫—É–Ω–¥ –¥–æ —Å—Ç–∞—Ä—Ç–∞</div>
            </div>
          )}

          {/* ICE CIRCLE */}
          <div className="flex justify-center mb-4">
            <div className={`ice-circle relative ${gameStatus === 'open' ? 'pulse-glow' : gameStatus === 'countdown' ? 'ready-glow' : ''}`}>
              {/* Center grid lines */}
              <div className="absolute inset-0 opacity-10" style={{
                backgroundImage: 'radial-gradient(circle, #00d2ff 1px, transparent 1px)',
                backgroundSize: '20px 20px'
              }} />

              {/* Sector fills ‚Äî always render when players exist */}
              {(gameStatus === 'open' || gameStatus === 'countdown' || gameStatus === 'playing' || gameStatus === 'finished') && renderIceField()}

              {/* Center puck area when waiting */}
              {(gameStatus === 'waiting') && (
                <div className="absolute inset-0 flex items-center justify-center">
                  <div className="text-5xl opacity-30">‚ùì</div>
                </div>
              )}

              {/* Ball during play */}
              {gameStatus === 'playing' && (
                <div className="ice-ball" style={{ left: ballPos.x + '%', top: ballPos.y + '%' }} />
              )}

              {/* Ball stopped at end */}
              {gameStatus === 'finished' && iceLobby?.finalBall && (
                <div className="ice-ball" style={{
                  left: iceLobby.finalBall.x + '%',
                  top: iceLobby.finalBall.y + '%',
                  background: 'radial-gradient(circle at 30% 30%, #fff, #ffd700)',
                  boxShadow: '0 0 25px #ffd700, 0 0 50px rgba(255,215,0,0.5)'
                }} />
              )}
            </div>
          </div>

          {/* BETTING BLOCK */}
          {!isSpectator && gameStatus === 'open' && (
            <div className="glass rounded-xl p-3 mb-3 border border-cyan-500/30">
              {!hasBet ? (
                <>
                  <p className="text-center text-cyan-300 font-bold mb-2 text-sm">üí∞ –í–∞—à–∞ —Å—Ç–∞–≤–∫–∞</p>
                  <div className="flex gap-2 mb-2">
                    <input
                      type="number" min="25" value={myBetInput}
                      onChange={e => setMyBetInput(Math.max(25, Number(e.target.value)))}
                      className="flex-1 bg-gray-800 border border-cyan-600 rounded-lg p-2.5 text-center text-lg text-white"
                    />
                    <button onClick={() => setMyBetInput(p => p + 25)} className="bg-cyan-700 hover:bg-cyan-600 px-3 rounded-lg font-bold transition text-sm">+25</button>
                    <button onClick={() => setMyBetInput(p => p + 100)} className="bg-cyan-700 hover:bg-cyan-600 px-3 rounded-lg font-bold transition text-sm">+100</button>
                  </div>
                  <button onClick={placeBet} disabled={balance < myBetInput || myBetInput < 25} className="w-full bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 py-2.5 rounded-xl font-bold disabled:opacity-50 transition text-sm">
                    –ü–æ—Å—Ç–∞–≤–∏—Ç—å {myBetInput}‚≠êÔ∏è
                  </button>
                  <p className="text-center text-xs text-gray-500 mt-1">–ë–∞–ª–∞–Ω—Å: {balance.toFixed(0)}‚≠êÔ∏è | –ú–∏–Ω: 25‚≠êÔ∏è</p>
                </>
              ) : (
                <>
                  <div className="text-center mb-2">
                    <div className="text-green-400 font-bold">‚úÖ –°—Ç–∞–≤–∫–∞: {myBet}‚≠êÔ∏è</div>
                  </div>
                  {/* Change bet */}
                  <div className="flex gap-2 mb-2">
                    <input
                      type="number" min="25" value={myBetInput}
                      onChange={e => setMyBetInput(Math.max(25, Number(e.target.value)))}
                      className="flex-1 bg-gray-800 border border-gray-600 rounded-lg p-2 text-center text-sm text-white"
                    />
                    <button onClick={changeBet} disabled={myBetInput === myBet} className="bg-orange-600 hover:bg-orange-500 px-3 rounded-lg font-bold transition text-xs disabled:opacity-40">
                      –ò–∑–º–µ–Ω–∏—Ç—å
                    </button>
                  </div>
                  <button
                    onClick={toggleReady}
                    className={`w-full py-3 rounded-xl font-bold transition ${
                      isReady
                        ? 'bg-gradient-to-r from-green-500 to-emerald-600 ready-glow text-white'
                        : 'bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-500 hover:to-gray-600 border border-gray-500'
                    }`}
                  >
                    {isReady ? '‚úÖ –ì–æ—Ç–æ–≤! (–Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –æ—Ç–º–µ–Ω—ã)' : 'üèÅ –ì–æ—Ç–æ–≤ –∫ –∏–≥—Ä–µ'}
                  </button>
                  {bettingCount > 0 && (
                    <p className="text-center text-xs text-gray-400 mt-1">
                      –ì–æ—Ç–æ–≤—ã: {readyCount}/{bettingCount}
                    </p>
                  )}
                </>
              )}
            </div>
          )}

          {/* Waiting for 2nd player */}
          {!isSpectator && gameStatus === 'waiting' && (
            <div className="glass rounded-xl p-4 mb-3 text-center border border-gray-600/30">
              <div className="text-3xl mb-2 animate-bounce">‚è≥</div>
              <div className="font-bold text-gray-300 text-sm">–û–∂–∏–¥–∞–µ–º –µ—â—ë –∏–≥—Ä–æ–∫–æ–≤...</div>
              <div className="text-gray-500 text-xs mt-1">–°—Ç–∞–≤–∫–∏ –æ—Ç–∫—Ä–æ—é—Ç—Å—è –∫–æ–≥–¥–∞ –∑–∞–π–¥—É—Ç 2+ –∏–≥—Ä–æ–∫–æ–≤</div>
              <div className="flex justify-center gap-2 mt-2">
                {[1, 2].map(i => (
                  <div key={i} className={`w-8 h-8 rounded-full border-2 flex items-center justify-center text-sm ${i <= presenceCount ? 'border-cyan-400 bg-cyan-400/20 text-cyan-300' : 'border-gray-600 bg-gray-800 text-gray-600'}`}>
                    {i <= presenceCount ? 'üë§' : '‚óã'}
                  </div>
                ))}
              </div>
              <div className="text-cyan-400 text-xs mt-1">{presenceCount}/2</div>
            </div>
          )}

          {/* Playing status for betted player */}
          {!isSpectator && gameStatus === 'playing' && hasBet && (
            <div className="glass rounded-xl p-3 mb-3 text-center border border-red-500/30">
              <div className="text-2xl animate-spin mb-1">üåÄ</div>
              <div className="font-bold text-red-300 text-sm">–®–∞–π–±–∞ –∫–∞—Ç–∏—Ç—Å—è...</div>
              <div className="text-gray-400 text-xs">–°—Ç–∞–≤–∫–∞: {myBet}‚≠êÔ∏è | –ë–∞–Ω–∫: {totalBank}‚≠êÔ∏è</div>
            </div>
          )}

          {/* Spectator */}
          {isSpectator && (
            <div className="glass rounded-xl p-3 mb-3 text-center border border-yellow-500/30">
              <div className="text-2xl mb-1">üëÅ</div>
              <div className="text-yellow-400 font-bold text-sm">–í—ã –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å</div>
              <div className="text-gray-500 text-xs">–ò–≥—Ä–∞ —É–∂–µ –Ω–∞—á–∞–ª–∞—Å—å</div>
            </div>
          )}

          {/* FINISHED ‚Äî Non-winner */}
          {isLoser && (
            <div className="glass rounded-xl p-4 mb-3 text-center border border-gray-500/30">
              <div className="text-4xl mb-2">üòî</div>
              <div className="font-bold text-gray-300">–ü–æ–±–µ–¥–∏–ª {iceLobby?.winner?.name}</div>
              <div className="text-gray-400 text-xs mt-1 mb-3">–ë–∞–Ω–∫: {totalBank}‚≠êÔ∏è ‚Üí –ø–æ–±–µ–¥–∏—Ç–µ–ª—å –ø–æ–ª—É—á–∏–ª {Math.floor(totalBank * 0.65)}‚≠êÔ∏è</div>
              <button onClick={exitLobbyNonWinner} className="w-full bg-gray-600 hover:bg-gray-500 py-2.5 rounded-xl font-bold transition text-sm">
                –í—ã–π—Ç–∏ –∏–∑ –ª–æ–±–±–∏
              </button>
            </div>
          )}

          {/* PLAYERS LIST */}
          <div className="glass rounded-xl p-3 mb-3">
            <div className="flex justify-between items-center mb-2">
              <h3 className="font-bold text-cyan-300 text-sm">üë• –í –ª–æ–±–±–∏ ({presenceCount})</h3>
              <span className="text-xs text-gray-400">–ë–∞–Ω–∫: {totalBank}‚≠êÔ∏è</span>
            </div>
            <div className="space-y-1.5 max-h-44 overflow-y-auto">
              {presence.map(([id, p]) => {
                const hasBetted = bettedSet.has(id);
                const isReadyP = readySet.has(id);
                const pData = hasBetted ? iceLobby.players[id] : null;
                const isMe = id === user.id;
                return (
                  <div key={id} className={`flex items-center gap-2 p-2 rounded-lg border text-xs transition ${
                    isReadyP ? 'player-row-ready' :
                    hasBetted ? 'player-row-waiting' :
                    'player-row-presence bg-gray-800/30'
                  }`}>
                    <div className="w-2.5 h-2.5 rounded-full flex-shrink-0" style={{ background: pData?.color || p.color || '#888' }} />
                    <span className={`flex-1 font-medium ${isMe ? 'text-cyan-300' : 'text-white'}`}>
                      {p.name}{isMe && ' (–í—ã)'}
                    </span>
                    <div className="flex items-center gap-1.5">
                      {hasBetted && pData && <span className="text-yellow-400 font-bold">{pData.bet}‚≠êÔ∏è</span>}
                      {isReadyP && <span className="text-green-400 font-bold">‚úÖ</span>}
                      {hasBetted && !isReadyP && <span className="text-yellow-500">‚è≥</span>}
                      {!hasBetted && <span className="text-gray-500 italic">–≤ –ª–æ–±–±–∏</span>}
                    </div>
                  </div>
                );
              })}
              {presence.length === 0 && <div className="text-gray-500 text-center py-3 text-xs">–ù–∏–∫–æ–≥–æ –Ω–µ—Ç...</div>}
            </div>
          </div>

          {/* Prizes info */}
          <div className="glass rounded-xl p-3">
            <h3 className="font-bold text-center text-cyan-300 text-xs mb-2">üéÅ –í–æ–∑–º–æ–∂–Ω—ã–µ –±–æ–Ω—É—Å—ã</h3>
            <div className="flex flex-wrap justify-center gap-1.5 text-xl">
              {['üß∏', 'üß§', '‚ùÑÔ∏è', 'üêï', '‚òÉÔ∏è', 'üéñ', '‚≠êÔ∏è', 'üß£', 'üîë'].map((e, i) => (
                <span key={i} className="bg-gray-800/60 p-1.5 rounded-lg border border-white/10">{e}</span>
              ))}
            </div>
          </div>
        </div>

        {/* VICTORY MODAL */}
        {showVictoryBox && isWinner && (
          <div className="fixed inset-0 bg-black/95 z-50 flex items-center justify-center p-4">
            <div className="glass rounded-2xl p-6 max-w-sm w-full text-center border border-yellow-500/60">
              <h2 className="text-3xl font-bold mb-1 text-yellow-400">üèÜ –ü–æ–±–µ–¥–∞!</h2>
              <p className="text-gray-300 mb-1 text-sm">–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏:</p>
              <p className="text-4xl font-bold text-yellow-400 mb-4">{victoryStars} ‚≠êÔ∏è</p>

              {!boxOpened ? (
                <>
                  <p className="text-gray-400 text-sm mb-3">–û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ—Ä–æ–±–∫—É –¥–ª—è –±–æ–Ω—É—Å–Ω–æ–≥–æ –ø—Ä–∏–∑–∞</p>
                  <div
                    className="text-7xl mb-3 cursor-pointer hover:scale-110 transition-transform active:scale-95 select-none"
                    onClick={openVictoryBox}
                  >
                    üì¶
                  </div>
                  <p className="text-cyan-300 text-xs animate-pulse">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–æ—Ä–æ–±–∫—É!</p>
                </>
              ) : (
                <>
                  <div className="bg-gray-800/60 rounded-xl p-4 mb-4">
                    <p className="text-gray-400 text-xs mb-1">–ë–æ–Ω—É—Å–Ω—ã–π –ø—Ä–∏–∑:</p>
                    <p className="text-3xl">{victoryPrize?.emoji}</p>
                    <p className="text-white font-bold mt-1">{victoryPrize?.name}</p>
                  </div>
                  <button
                    onClick={exitLobbyAfterGame}
                    className="w-full bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 py-3 rounded-xl font-bold transition"
                  >
                    ‚úÖ –í—ã–π—Ç–∏ –∏–∑ –ª–æ–±–±–∏
                  </button>
                </>
              )}
            </div>
          </div>
        )}
      </div>
    );
  }

  // ===== ADMIN =====
  if (isAdmin) {
    return (
      <div className="min-h-screen bg-gray-900 p-4">
        <div className="max-w-4xl mx-auto">
          <div className="flex justify-between items-center mb-6">
            <h1 className="text-2xl font-bold text-white">üîê –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h1>
            <button onClick={() => setIsAdmin(false)} className="text-gray-400 hover:text-white">–í—ã–π—Ç–∏</button>
          </div>
          <div className="flex gap-2 mb-6 overflow-x-auto">
            {['stats', 'users', 'rewards', 'settings'].map(tab => (
              <button key={tab} onClick={() => setAdminScreen(tab)} className={`px-4 py-2 rounded-lg ${adminScreen === tab ? 'bg-indigo-600' : 'bg-gray-700'} text-sm`}>
                {tab === 'stats' ? 'üìä –°—Ç–∞—Ç.' : tab === 'users' ? 'üë• –Æ–∑–µ—Ä—ã' : tab === 'rewards' ? 'üéÄ –ù–∞–≥—Ä–∞–¥—ã' : '‚öôÔ∏è –ù–∞—Å—Ç—Ä.'}
              </button>
            ))}
          </div>
          <div className="glass rounded-xl p-6">
            {adminScreen === 'stats' && (
              <div className="grid grid-cols-2 gap-4">
                <div className="bg-gray-800 p-4 rounded-lg"><div className="text-gray-400 text-sm">–ò–≥—Ä–æ–∫–æ–≤</div><div className="text-3xl font-bold">{allUsers.length}</div></div>
                <div className="bg-gray-800 p-4 rounded-lg"><div className="text-gray-400 text-sm">–û–Ω–ª–∞–π–Ω</div><div className="text-3xl font-bold text-green-400">{onlineCount}</div></div>
                <div className="bg-gray-800 p-4 rounded-lg"><div className="text-gray-400 text-sm">–û–±—â–∏–π –±–∞–ª–∞–Ω—Å</div><div className="text-2xl font-bold">{allUsers.reduce((s, u) => s + (u.balance || 0), 0).toFixed(0)}‚≠êÔ∏è</div></div>
                <div className="bg-gray-800 p-4 rounded-lg"><div className="text-gray-400 text-sm">–ü—Ä–µ–¥–º–µ—Ç–æ–≤</div><div className="text-3xl font-bold">{allUsers.reduce((s, u) => s + (u.inventory?.length || 0), 0)}</div></div>
              </div>
            )}
            {adminScreen === 'users' && !selectedUser && (
              <div className="space-y-2 max-h-96 overflow-y-auto">
                <h3 className="font-bold mb-2">–í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä–æ–∫–∞:</h3>
                {allUsers.map(u => (
                  <div key={u.id} onClick={() => setSelectedUser(u)} className="bg-gray-800 p-3 rounded-lg cursor-pointer hover:bg-gray-700 flex justify-between">
                    <div><div className="font-bold text-sm">{u.name}</div><div className="text-xs text-gray-400">{u.username || u.id.slice(0,12)}</div></div>
                    <div className="text-yellow-400 text-sm">{(u.balance || 0).toFixed(0)}‚≠êÔ∏è</div>
                  </div>
                ))}
              </div>
            )}
            {adminScreen === 'users' && selectedUser && (
              <div>
                <h3 className="font-bold mb-4 text-lg">üë§ {selectedUser.name}</h3>
                <div className="grid grid-cols-3 gap-2 mb-4">
                  <button onClick={() => adminGiveReward(selectedUser.id, { type: 'stars', amount: 100 })} className="bg-green-600 p-2 rounded text-sm">+100‚≠êÔ∏è</button>
                  <button onClick={() => adminGiveReward(selectedUser.id, { type: 'stars', amount: 500 })} className="bg-green-600 p-2 rounded text-sm">+500‚≠êÔ∏è</button>
                  <button onClick={() => adminGiveReward(selectedUser.id, { type: 'stars', amount: 1000 })} className="bg-green-600 p-2 rounded text-sm">+1000‚≠êÔ∏è</button>
                  <button onClick={() => adminGiveReward(selectedUser.id, { type: 'case', caseType: 'diamond', count: 5 })} className="bg-blue-600 p-2 rounded text-sm">+5üíé</button>
                  <button onClick={() => adminGiveReward(selectedUser.id, { type: 'case', caseType: 'elite', count: 2 })} className="bg-red-600 p-2 rounded text-sm">+2üéñ</button>
                  <button onClick={() => adminGiveReward(selectedUser.id, { type: 'unlock_collector' })} className="bg-pink-800 p-2 rounded text-sm">üîì –ö–æ–ª–ª–µ–∫—Ü.</button>
                </div>
                <button onClick={() => setSelectedUser(null)} className="w-full bg-gray-600 p-2 rounded text-sm">‚Üê –ù–∞–∑–∞–¥</button>
              </div>
            )}
            {adminScreen === 'rewards' && (
              <div>
                <h3 className="text-lg mb-4">–í—ã–¥–∞—Ç—å —Å–µ–±–µ:</h3>
                <div className="grid grid-cols-3 gap-2">
                  <button onClick={() => adminGiveReward(user.id, { type: 'stars', amount: 10000 })} className="bg-indigo-600 p-3 rounded text-sm">+10000‚≠êÔ∏è</button>
                  <button onClick={() => adminGiveReward(user.id, { type: 'case', caseType: 'diamond', count: 10 })} className="bg-blue-600 p-3 rounded text-sm">+10üíé</button>
                  <button onClick={() => adminGiveReward(user.id, { type: 'unlock_collector' })} className="bg-pink-800 p-3 rounded text-sm">üîì –ö–æ–ª–ª–µ–∫—Ü.</button>
                </div>
              </div>
            )}
            {adminScreen === 'settings' && (
              <div>
                <h3 className="text-lg mb-4">–°–±—Ä–æ—Å–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</h3>
                <button onClick={async () => { if (confirm('–£–¥–∞–ª–∏—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ?')) { await db.ref('users/' + user.id).remove(); localStorage.removeItem('sbs_user_id'); window.location.reload(); } }} className="bg-red-600 px-4 py-2 rounded-lg text-sm">üóë –°–±—Ä–æ—Å–∏—Ç—å</button>
              </div>
            )}
          </div>
        </div>
      </div>
    );
  }

  // ===== MAIN =====
  return (
    <div className="min-h-screen pb-24">
      <header className="p-4 flex justify-between items-center glass sticky top-0 z-50">
        <h1 onClick={handleTitleClick} className="text-xl font-bold cursor-pointer select-none hover:text-cyan-300 transition">
          Step By Step Game
        </h1>
        <button onClick={() => setShowTopUp(true)} className="bg-gradient-to-r from-yellow-400 to-orange-500 px-4 py-2 rounded-full font-bold text-gray-900 shadow-lg text-sm">
          {balance.toFixed(2)} ‚≠êÔ∏è
        </button>
      </header>

      {paymentStatus && (
        <div className="mx-4 mt-2 p-3 rounded-lg text-center text-xs bg-blue-500/20 border border-blue-500">{paymentStatus}</div>
      )}

      {/* Modals */}
      {showCollectibleModal && (
        <div className="fixed inset-0 bg-black/90 z-[60] flex items-center justify-center p-4">
          <div className="glass rounded-2xl p-6 max-w-sm w-full text-center">
            <div className="text-6xl mb-4 animate-bounce">{selectedCollectible?.emoji}</div>
            <h3 className="text-xl font-bold mb-2">–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω—ã–π –ø—Ä–µ–¥–º–µ—Ç!</h3>
            <p className="mb-4 text-sm">–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ <a href="https://t.me/stepbystepdelision" target="_blank" className="text-blue-400 underline">–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏</a></p>
            <button onClick={() => setShowCollectibleModal(false)} className="w-full bg-indigo-600 hover:bg-indigo-500 py-3 rounded-xl font-bold">–ü–æ–Ω—è—Ç–Ω–æ</button>
          </div>
        </div>
      )}

      {showIceGiftModal && (
        <div className="fixed inset-0 bg-black/90 z-[60] flex items-center justify-center p-4">
          <div className="glass rounded-2xl p-6 max-w-sm w-full text-center border border-cyan-500/50">
            <div className="text-6xl mb-4">üßä</div>
            <h3 className="text-xl font-bold mb-2 text-cyan-300">–õ–µ–¥—è–Ω–æ–π –ü–æ–¥–∞—Ä–æ–∫!</h3>
            <div className="space-y-3">
              <button onClick={sellIceGift} className="w-full bg-orange-600 hover:bg-orange-500 py-3 rounded-xl font-bold transition">üî• –ü—Ä–æ–¥–∞—Ç—å –∑–∞ 25‚≠êÔ∏è</button>
              <button onClick={() => { setShowIceGiftModal(false); setSelectedIceGift(null); }} className="w-full bg-cyan-600 hover:bg-cyan-500 py-3 rounded-xl font-bold transition">üíé –û—Å—Ç–∞–≤–∏—Ç—å</button>
            </div>
          </div>
        </div>
      )}

      {showAdminLogin && (
        <div className="fixed inset-0 bg-black/90 z-[60] flex items-center justify-center p-4">
          <div className="glass rounded-2xl p-6 max-w-sm w-full">
            <h2 className="text-xl font-bold text-center mb-4">üîê –í—Ö–æ–¥ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h2>
            <input type="text" placeholder="–õ–æ–≥–∏–Ω" value={adminLogin} onChange={e => setAdminLogin(e.target.value)} className="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-3 mb-3 text-center text-sm" />
            <input type="password" placeholder="–ü–∞—Ä–æ–ª—å" value={adminPassword} onChange={e => setAdminPassword(e.target.value)} className="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-3 mb-4 text-center text-sm" />
            <button onClick={checkAdminLogin} className="w-full bg-indigo-600 hover:bg-indigo-500 py-3 rounded-xl font-bold mb-2">–í–æ–π—Ç–∏</button>
            <button onClick={() => setShowAdminLogin(false)} className="w-full bg-gray-700 hover:bg-gray-600 py-2 rounded-xl text-sm">–û—Ç–º–µ–Ω–∞</button>
          </div>
        </div>
      )}

      {showWithdrawModal && (
        <div className="fixed inset-0 bg-black/90 z-[60] flex items-center justify-center p-4">
          <div className="glass rounded-2xl p-6 max-w-sm w-full">
            <h2 className="text-xl font-bold text-center mb-4">üìä –í—ã–≤–æ–¥ –ø—Ä–∏–∑–æ–≤</h2>
            <input type="number" placeholder="–ö–æ–ª-–≤–æ –∑–≤—ë–∑–¥" value={withdrawAmount} onChange={e => setWithdrawAmount(e.target.value)} className="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-3 mb-4 text-center" />
            <div className="grid grid-cols-2 gap-3 mb-4">
              <button onClick={confirmWithdraw} className="bg-yellow-600 hover:bg-yellow-500 py-3 rounded-xl font-bold">–í –∑–≤—ë–∑–¥–∞—Ö</button>
              <button onClick={confirmWithdraw} className="bg-purple-600 hover:bg-purple-500 py-3 rounded-xl font-bold">–í –ø–æ–¥–∞—Ä–∫–∞—Ö</button>
            </div>
            <button onClick={() => setShowWithdrawModal(false)} className="w-full bg-gray-700 hover:bg-gray-600 py-2 rounded-xl text-sm">–û—Ç–º–µ–Ω–∞</button>
          </div>
        </div>
      )}

      <main className="p-4 max-w-md mx-auto">
        {/* CASES */}
        {currentScreen === 'cases' && (
          <div>
            <h2 className="text-2xl font-bold mb-4 text-center">üé∞ –ö–µ–π—Å—ã</h2>
            {cases.diamond?.freeCount > 0 && <div className="bg-green-500/20 border border-green-500 rounded-lg p-3 mb-3 text-center text-sm animate-pulse">üéÅ –ë–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –∫–µ–π—Å–æ–≤ –ê–ª–º–∞–∑: {cases.diamond.freeCount}</div>}
            {cases.elite?.freeCount > 0 && <div className="bg-green-500/20 border border-green-500 rounded-lg p-3 mb-3 text-center text-sm animate-pulse">üéÅ –ë–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –∫–µ–π—Å–æ–≤ –≠–ª–∏—Ç–∞: {cases.elite.freeCount}</div>}
            {freeEliteSpin > 0 && <div className="bg-green-500/20 border border-green-500 rounded-lg p-3 mb-3 text-center text-sm animate-pulse">üéÅ –ë–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –ø—Ä–æ–∫—Ä—É—Ç–æ–≤ –≠–ª–∏—Ç–∞: {freeEliteSpin}</div>}
            <div className="grid grid-cols-2 gap-4">
              {Object.values(cases).filter(c => !c.locked).map(c => (
                <div key={c.id} className={`glass rounded-xl p-4 relative hover:scale-105 transition ${c.id === 'cardboard' ? 'case-cardboard' : c.id === 'collector' ? 'case-collector' : ''}`}>
                  {c.isNew && <span className="absolute -top-2 -right-2 bg-red-500 text-xs px-2 py-1 rounded-full animate-pulse">–ù–æ–≤–æ–µ!</span>}
                  {(c.id === 'diamond' || c.id === 'coal' || c.id === 'winter') && !c.freeCount && c.discountPrice && c.discountPrice !== c.price && (
                    <span className="absolute -top-2 -left-2 bg-green-500 text-xs px-2 py-1 rounded-full animate-pulse">–°–∫–∏–¥–∫–∞!</span>
                  )}
                  <div className={`w-16 h-16 mx-auto rounded-lg ${c.id === 'cardboard' || c.id === 'collector' ? 'bg-white/20' : `bg-gradient-to-br ${c.color}`} flex items-center justify-center text-3xl mb-2 shadow-lg`}>{c.emoji}</div>
                  <h3 className="font-bold text-center text-sm">{c.name}</h3>
                  <p className="text-center text-xs opacity-75 mb-2">
                    {c.freeCount > 0 ? <span className="text-green-400 font-bold">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ!</span>
                      : c.discountPrice && c.discountPrice !== c.price
                        ? <span><span className="line-through">{c.originalPrice || c.price}</span> {c.discountPrice}‚≠êÔ∏è</span>
                        : `${c.price}‚≠êÔ∏è`}
                  </p>
                  <button onClick={() => setSelectedCase(c)} className="w-full py-2 rounded-lg font-bold text-sm bg-gradient-to-r from-indigo-500 to-purple-500 hover:from-indigo-600 hover:to-purple-600 transition">–û—Ç–∫—Ä—ã—Ç—å</button>
                </div>
              ))}
              {Object.values(cases).filter(c => c.locked).map(c => (
                <div key={c.id} className="glass rounded-xl p-4 relative opacity-50">
                  <div className="absolute inset-0 bg-black/70 rounded-xl flex items-center justify-center"><span className="text-2xl">üîí</span></div>
                  <div className={`w-16 h-16 mx-auto rounded-lg bg-gradient-to-br ${c.color} flex items-center justify-center text-3xl mb-2`}>{c.emoji}</div>
                  <h3 className="font-bold text-center text-sm">{c.name}</h3>
                  <p className="text-center text-xs mb-2">{c.price}‚≠êÔ∏è</p>
                  <button className="w-full py-2 rounded-lg font-bold text-sm bg-gray-600 cursor-not-allowed">–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ</button>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* GAMES */}
        {currentScreen === 'games' && (
          <div>
            <h2 className="text-2xl font-bold mb-4 text-center">üéÆ –ò–≥—Ä—ã</h2>
            <div className="space-y-4">
              <div className="glass rounded-xl p-5 border border-cyan-500/30">
                <h3 className="text-xl font-bold mb-1 text-center text-cyan-300">‚òÉÔ∏è –õ–µ–¥—è–Ω–æ–π –ö–∞—Ç–æ–∫</h3>
                <p className="text-gray-400 mb-1 text-center text-xs">–î–æ–∂–¥–∏—Ç–µ—Å—å 2+ –∏–≥—Ä–æ–∫–æ–≤ ‚Üí —Å—Ç–∞–≤—å—Ç–µ ‚Üí –∂–º–∏—Ç–µ ¬´–ì–æ—Ç–æ–≤¬ª</p>
                <p className="text-cyan-400 text-center text-xs mb-3">–ü–æ–±–µ–¥–∏—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç 65% –æ—Ç –±–∞–Ω–∫–∞ + –±–æ–Ω—É—Å üì¶</p>
                <div className="grid grid-cols-5 gap-2">
                  {[1,2,3,4,5,6,7,8,9,10].map(i => (
                    <button key={i} onClick={() => joinIceLobby(i)} className="bg-cyan-700 hover:bg-cyan-600 py-2 rounded-lg text-sm font-bold transition">#{i}</button>
                  ))}
                </div>
              </div>
              <div className="glass rounded-xl p-5 opacity-50 text-center">
                <h3 className="text-lg font-bold">–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ... üë≤</h3>
              </div>
            </div>
          </div>
        )}

        {/* TASKS */}
        {currentScreen === 'tasks' && (
          <div>
            <h2 className="text-2xl font-bold mb-4 text-center">üìã –ó–∞–¥–∞–Ω–∏—è</h2>
            <div className="space-y-3">
              {/* Subscribe */}
              <div className={`glass rounded-xl p-4 ${tasks.subscribe?.completed ? 'bg-green-500/20' : ''}`}>
                <div className="flex justify-between items-start mb-2">
                  <div>
                    <h3 className="font-bold text-sm">–ü–æ–¥–ø–∏—à–∏—Å—å –Ω–∞ –∫–∞–Ω–∞–ª</h3>
                    <p className="text-xs opacity-75">–ù–∞–≥—Ä–∞–¥–∞: 1 –∫–µ–π—Å ¬´–≠–ª–∏—Ç–∞¬ª + 1 –ø—Ä–æ–∫—Ä—É—Ç üéñ</p>
                  </div>
                  {tasks.subscribe?.completed && <span className="text-green-400 text-xl">‚úÖ</span>}
                </div>
                <button onClick={() => completeTask('subscribe')} disabled={tasks.subscribe?.completed} className={`w-full py-2 rounded-lg text-sm ${tasks.subscribe?.completed ? 'bg-green-600' : 'bg-blue-600 hover:bg-blue-500'} transition`}>
                  {tasks.subscribe?.completed ? '–í—ã–ø–æ–ª–Ω–µ–Ω–æ' : '–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è'}
                </button>
              </div>

              {/* Invite 3 friends */}
              <div className={`glass rounded-xl p-4 ${tasks.inviteThree?.completed ? 'bg-green-500/20' : ''}`}>
                <div className="flex justify-between items-start mb-2">
                  <div>
                    <h3 className="font-bold text-sm">–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å 3 –¥—Ä—É–∑–µ–π</h3>
                    <p className="text-xs opacity-75">–ù–∞–≥—Ä–∞–¥–∞: 25 ‚≠êÔ∏è</p>
                    {!tasks.inviteThree?.completed && (
                      <p className="text-xs text-cyan-400 mt-0.5">–ü—Ä–æ–≥—Ä–µ—Å—Å: {tasks.inviteThree?.count || 0}/3</p>
                    )}
                  </div>
                  {tasks.inviteThree?.completed && <span className="text-green-400 text-xl">‚úÖ</span>}
                </div>
                <button onClick={() => completeTask('inviteThree')} disabled={tasks.inviteThree?.completed} className={`w-full py-2 rounded-lg text-sm ${tasks.inviteThree?.completed ? 'bg-green-600' : 'bg-blue-600 hover:bg-blue-500'} transition`}>
                  {tasks.inviteThree?.completed ? '–í—ã–ø–æ–ª–Ω–µ–Ω–æ' : '–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å'}
                </button>
              </div>

              {/* Deposit 100 */}
              <div className={`glass rounded-xl p-4 ${tasks.deposit?.completed ? 'bg-green-500/20' : ''}`}>
                <div className="flex justify-between items-start mb-2">
                  <div>
                    <h3 className="font-bold text-sm">–ü–æ–ø–æ–ª–Ω–∏—Ç—å –Ω–∞ 100 ‚≠êÔ∏è</h3>
                    <p className="text-xs opacity-75">–ù–∞–≥—Ä–∞–¥–∞: 1 –∑–æ–ª–æ—Ç–æ–π –∫–µ–π—Å üëë</p>
                  </div>
                  {tasks.deposit?.completed && <span className="text-green-400 text-xl">‚úÖ</span>}
                </div>
                <button onClick={() => completeTask('deposit')} disabled={tasks.deposit?.completed} className={`w-full py-2 rounded-lg text-sm ${tasks.deposit?.completed ? 'bg-green-600' : 'bg-blue-600 hover:bg-blue-500'} transition`}>
                  {tasks.deposit?.completed ? '–í—ã–ø–æ–ª–Ω–µ–Ω–æ' : '–ü–æ–ø–æ–ª–Ω–∏—Ç—å'}
                </button>
              </div>

              {/* Deposit 350 */}
              <div className={`glass rounded-xl p-4 ${tasks.depositMajor?.completed ? 'bg-green-500/20' : ''}`}>
                <div className="flex justify-between items-start mb-2">
                  <div>
                    <h3 className="font-bold text-sm">–ü–æ–ø–æ–ª–Ω–∏—Ç—å –Ω–∞ 350 ‚≠êÔ∏è</h3>
                    <p className="text-xs opacity-75">–ù–∞–≥—Ä–∞–¥–∞: –ö–µ–π—Å ¬´–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–µ—Ä¬ª + 1 –ø—Ä–æ–∫—Ä—É—Ç</p>
                  </div>
                  {tasks.depositMajor?.completed && <span className="text-green-400 text-xl">‚úÖ</span>}
                </div>
                <button onClick={() => completeTask('depositMajor')} disabled={tasks.depositMajor?.completed} className={`w-full py-2 rounded-lg text-sm ${tasks.depositMajor?.completed ? 'bg-green-600' : 'bg-blue-600 hover:bg-blue-500'} transition`}>
                  {tasks.depositMajor?.completed ? '–í—ã–ø–æ–ª–Ω–µ–Ω–æ' : '–ü–æ–ø–æ–ª–Ω–∏—Ç—å'}
                </button>
              </div>
            </div>
          </div>
        )}

        {/* PROFILE */}
        {currentScreen === 'profile' && (
          <div>
            <div className="glass rounded-xl p-3 mb-4 flex justify-between items-center">
              <span className="text-gray-400 text-sm">üü¢ –û–Ω–ª–∞–π–Ω:</span>
              <span className="font-bold text-green-400 text-sm">{onlineCount} –∏–≥—Ä–æ–∫–æ–≤</span>
            </div>
            <h2 className="text-2xl font-bold mb-4 text-center">üë§ –ú–æ–π –ü—Ä–æ—Ñ–∏–ª—å</h2>
            <div className="glass rounded-xl p-5 text-center mb-4">
              <div className="w-20 h-20 mx-auto rounded-full bg-gradient-to-br from-indigo-400 to-purple-500 flex items-center justify-center text-3xl mb-3 overflow-hidden border-2 border-white/20">
                {user?.avatar ? <img src={user.avatar} alt="" className="w-full h-full object-cover" /> : user?.name?.charAt(0).toUpperCase()}
              </div>
              <h3 className="text-lg font-bold">{user?.name}</h3>
              {user?.username && <p className="text-gray-400 text-sm">{user.username}</p>}
            </div>
            <div className="flex gap-2 mb-4">
              <button onClick={() => setShowTopUp(true)} className="flex-1 bg-gradient-to-r from-yellow-400 to-orange-500 text-gray-900 font-bold py-3 rounded-xl shadow-lg transition text-sm">üíé –ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
            </div>
            <div className="mb-4">
              <button onClick={() => setShowWithdrawModal(true)} disabled={!tasks.depositMajor?.completed} className="w-full bg-gradient-to-r from-purple-500 to-indigo-600 text-white font-bold py-3 rounded-xl shadow-lg transition text-sm disabled:opacity-50 disabled:cursor-not-allowed">
                {tasks.depositMajor?.completed ? 'üèÜ –í—ã–≤–µ—Å—Ç–∏ –ø—Ä–∏–∑—ã üèÜ' : 'üîí –í—ã–≤–µ—Å—Ç–∏ –ø—Ä–∏–∑—ã (–Ω—É–∂–Ω–æ 350‚≠êÔ∏è)'}
              </button>
            </div>
            <div className="glass rounded-xl p-4 mb-4">
              <h3 className="font-bold mb-2 text-sm">üéÅ –ü—Ä–æ–º–æ–∫–æ–¥</h3>
              <div className="flex gap-2">
                <input type="text" placeholder="–ü–†–û–ú–û–ö–û–î" value={promoCode} onChange={e => setPromoCode(e.target.value)} className="flex-1 bg-gray-700/50 border border-gray-600 rounded-lg px-3 py-2 text-center uppercase text-sm" />
                <button onClick={checkPromo} className="bg-indigo-600 hover:bg-indigo-500 px-4 py-2 rounded-lg font-bold transition text-sm">OK</button>
              </div>
              {promoError && <p className="text-red-400 text-xs mt-2 text-center">{promoError}</p>}
              {promoSuccess && <p className="text-green-400 text-xs mt-2 text-center">{promoSuccess}</p>}
            </div>
            <div className="glass rounded-xl p-4">
              <div className="flex justify-between items-center mb-3">
                <h3 className="font-bold text-sm">üéí –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</h3>
                <span className="text-xs text-gray-400">{inventory.length}/{inventorySlots}</span>
              </div>
              <div className="grid grid-cols-5 gap-2 mb-3">
                {[...Array(inventorySlots)].map((_, i) => (
                  <div key={i} className="aspect-square bg-gray-700/50 rounded-lg flex items-center justify-center text-2xl hover:bg-gray-600/50 transition cursor-pointer">
                    {inventory[i]
                      ? <span onClick={() => sellItem(inventory[i])} className="hover:scale-110 transition">{inventory[i].emoji}</span>
                      : <span className="text-gray-600 text-xs">‚óã</span>
                    }
                  </div>
                ))}
              </div>
              <button onClick={unlockSlot} disabled={balance < 50} className="w-full bg-gray-700 hover:bg-gray-600 disabled:opacity-50 py-2 rounded-lg text-xs font-bold flex items-center justify-center gap-2 transition">
                üîì –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Å–ª–æ—Ç (50‚≠êÔ∏è)
              </button>
            </div>
          </div>
        )}
      </main>

      {/* ROULETTE MODAL */}
      {selectedCase && (
        <div className="fullscreen-modal flex items-center justify-center p-4">
          <div className="w-full max-w-lg" ref={rouletteContainerRef}>
            <div className="flex justify-between items-center mb-5">
              <h3 className="text-2xl font-bold">{selectedCase.emoji} {selectedCase.name}</h3>
              <button onClick={() => { setSelectedCase(null); setSpinResult(null); setFakeItems([]); }} className="text-3xl hover:text-red-400 transition">√ó</button>
            </div>
            <div key={rouletteKey} className="roulette-container mb-5">
              <div className="roulette-pointer" />
              <div className="roulette-inner" style={{ transform: `translateX(${rouletteOffset}px)` }}>
                {fakeItems.length > 0
                  ? fakeItems.map((item, i) => (
                    <div key={i} className="roulette-item">
                      <div className="emoji">{item.emoji}</div>
                      <div className="name">{item.name}</div>
                    </div>
                  ))
                  : [...Array(80)].map((_, i) => <div key={i} className="roulette-item"><div className="emoji">‚ùì</div></div>)
                }
              </div>
            </div>
            <div className="glass rounded-xl p-4 mb-5 max-h-40 overflow-y-auto">
              <p className="font-bold mb-2 text-center text-sm">–í–æ–∑–º–æ–∂–Ω—ã–µ –Ω–∞–≥—Ä–∞–¥—ã:</p>
              <div className="space-y-1">
                {CASE_REWARDS[selectedCase.id]?.map((r, i) => (
                  <div key={i} className="flex justify-between py-1 border-b border-white/10 last:border-0 text-xs">
                    <span>{r.emoji} {r.name}</span>
                    <span className="text-yellow-400 font-bold">{r.displayChance}</span>
                  </div>
                ))}
              </div>
            </div>
            {spinResult ? (
              <div className="text-center">
                <p className="text-xl font-bold mb-2">üéâ –í—ã–ø–∞–ª–æ: {spinResult.name}!</p>
                {spinResult.type === 'collectible' && <p className="text-yellow-400 text-xs mb-4">‚≠êÔ∏è –ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω—ã–π –ø—Ä–µ–¥–º–µ—Ç!</p>}
                <button onClick={() => setSpinResult(null)} className="w-full bg-green-600 hover:bg-green-500 py-3 rounded-xl font-bold mb-2 transition">–ó–∞–±—Ä–∞—Ç—å –∏ –æ—Ç–∫—Ä—ã—Ç—å –µ—â—ë</button>
                <button onClick={() => { setSelectedCase(null); setSpinResult(null); setFakeItems([]); }} className="w-full bg-gray-600 hover:bg-gray-500 py-2.5 rounded-xl font-bold transition text-sm">–ö –∫–µ–π—Å–∞–º</button>
              </div>
            ) : (
              <button onClick={() => openCase(selectedCase.id)} disabled={isSpinning} className="w-full bg-gradient-to-r from-indigo-500 to-purple-500 hover:from-indigo-600 hover:to-purple-600 py-4 rounded-xl font-bold text-lg disabled:opacity-50 shadow-lg transition">
                {isSpinning ? 'üåÄ –ö—Ä—É—Ç–∏–º...' : `–û—Ç–∫—Ä—ã—Ç—å –∑–∞ ${getCasePrice(selectedCase.id) === 0 ? '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ' : getCasePrice(selectedCase.id) + '‚≠êÔ∏è'}`}
              </button>
            )}
          </div>
        </div>
      )}

      {/* TOP UP MODAL */}
      {showTopUp && (
        <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
          <div className="glass rounded-2xl p-5 max-w-sm w-full">
            <div className="flex justify-between items-center mb-4">
              <h3 className="text-lg font-bold">üí≥ –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</h3>
              <button onClick={() => setShowTopUp(false)} className="text-2xl hover:text-red-400 transition">√ó</button>
            </div>
            <p className="text-xs text-gray-400 text-center mb-3">‚≠êÔ∏è Telegram Stars</p>
            <div className="space-y-2 mb-4">
              {STARS_PACKAGES.map(pkg => (
                <button key={pkg.stars} onClick={() => buyStars(pkg)} className="w-full glass p-3 rounded-xl flex justify-between items-center hover:bg-white/10 transition border border-white/10">
                  <span className="font-bold text-yellow-400 text-sm">+{pkg.stars} ‚≠êÔ∏è</span>
                  <span className="text-gray-300 text-xs">–ö—É–ø–∏—Ç—å</span>
                </button>
              ))}
            </div>
            <div className="border-t border-gray-600 pt-4">
              <p className="text-xs text-gray-400 text-center mb-3">üíé TON</p>
              {TON_RATES.map(rate => (
                <button key={rate.stars} onClick={() => topUpBalance(rate.stars, rate.ton)} className="w-full glass p-3 rounded-xl flex justify-between items-center hover:bg-white/10 transition border border-white/10 mb-2">
                  <span className="font-bold text-sm">+{rate.stars}‚≠êÔ∏è</span>
                  <span className="text-yellow-400 font-bold text-sm">{rate.ton} TON</span>
                </button>
              ))}
            </div>
          </div>
        </div>
      )}

      {/* BOTTOM NAV */}
      <nav className="fixed bottom-0 left-0 right-0 glass border-t border-white/10 p-2">
        <div className="max-w-md mx-auto flex justify-around">
          {[
            { id: 'tasks', emoji: 'üìã', label: '–ó–∞–¥–∞–Ω–∏—è' },
            { id: 'cases', emoji: 'üéÅ', label: '–ö–µ–π—Å—ã' },
            { id: 'games', emoji: 'üéÆ', label: '–ò–≥—Ä—ã' },
            { id: 'profile', emoji: 'üë§', label: '–ü—Ä–æ—Ñ–∏–ª—å' }
          ].map(s => (
            <button key={s.id} onClick={() => setCurrentScreen(s.id)} className={`flex flex-col items-center p-2 rounded-lg transition ${currentScreen === s.id ? 'text-blue-400 scale-110' : 'text-gray-400 hover:text-white'}`}>
              <span className="text-2xl">{s.emoji}</span>
              <span className="text-xs font-bold">{s.label}</span>
            </button>
          ))}
        </div>
      </nav>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
