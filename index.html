<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Step By Step Game</title>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script>
tailwind.config = {
darkMode: 'class',
theme: {
extend: {
colors: { primary: '#6366f1', secondary: '#8b5cf6', accent: '#f59e0b', ice: '#00d2ff', }
}
}
}
</script>
<style>
@keyframes spin-slow { from { transform: translateX(0); } to { transform: translateX(-50%); } }
@keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
.roulette-container { position: relative; width: 100%; height: 160px; overflow: hidden; background: rgba(0,0,0,0.4); border-radius: 16px; border: 2px solid rgba(255,255,255,0.1); margin: 20px 0; }
.roulette-inner { display: flex; position: absolute; left: 0; top: 20px; transition: transform 6.5s cubic-bezier(0.15, 0, 0.15, 1); will-change: transform; }
.roulette-item { width: 120px; height: 120px; flex-shrink: 0; margin: 0 8px; display: flex; align-items: center; justify-content: center; font-size: 3.5rem; background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05)); border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); }
.roulette-item .emoji { font-size: 3.5rem; }
.roulette-item .name { font-size: 12px; opacity: 0.7; text-align: center; margin-top: 5px; }
.roulette-pointer { position: absolute; left: 50%; top: 0; bottom: 0; width: 4px; background: #ff4757; z-index: 20; transform: translateX(-50%); box-shadow: 0 0 20px #ff4757; }
.glass { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
.fullscreen-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 100; overflow-y: auto; }
.ice-circle { width: 320px; height: 320px; border-radius: 50%; border: 4px solid rgba(0,210,255,0.5); position: relative; overflow: hidden; background: radial-gradient(circle, rgba(0,210,255, 0%), rgba(0,128,255,0.2) 160px, rgba(0,128,255,0.4) 100%); box-shadow: 0 0 30px rgba(0,210,255,0.3); }
.ice-ball { position: absolute; width: 40px; height: 40px; background: radial-gradient(circle at 30% 30%, #fff, #00d2ff); border-radius: 50%; box-shadow: 0 0 20px rgba(0,210,255,0.8); z-index: 10; transform: translate(-50%, -50%); border: 2px solid rgba(255,255,255,0.5); transition: left 0.025s linear, top 0.025s linear; }
.player-avatar { position: absolute; width: 40px; height: 40px; border-radius: 50%; border: 2px solid white; overflow: hidden; transform: translate(-50%, -50%); z-index: 5; }
.case-cardboard { background: linear-gradient(135deg, #8B4513 0%, #D2691E 50%, #8B4513 100%); border: 3px solid #A0522D; }
.case-collector { background: linear-gradient(135deg, #DC143C 0%, #FF1493 50%, #8B008B 100%); border: 3px solid #FFD700; }
</style>
</head>
<body class="bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-600 min-h-screen text-white overflow-x-hidden">
<div id="root"></div>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script type="text/babel">
const { useState, useEffect, useRef } = React;
const firebaseConfig = {
apiKey: "AIzaSyDZPRiByz69HQa8b7GFMCJeqq56J3Y-bOY",
authDomain: "step-by-step-279df.firebaseapp.com",
databaseURL: "https://step-by-step-279df-default-rtdb.europe-west1.firebasedatabase.app",
projectId: "step-by-step-279df",
storageBucket: "step-by-step-279df.firebasestorage.app",
messagingSenderId: "302641152597",
appId: "1:302641152597:web:6479b9ae03104666cd8adc"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const TelegramWebApp = window.Telegram?.WebApp;
const ADMIN_WALLET = 'UQAWqaIPFSg81l9MlgAx0HBE9o3gpJMhk1dnyryKJXhWNHIc';
const TONCENTER_API = 'https://toncenter.com/api/v2';
const BOT_TOKEN = '8325421899:AAHRdmMYdjJMXmAVIynDsQtpUNsSeKkaOis';

const CASE_REWARDS = {
cardboard: [
{ id: 'stars_0_25', name: '0.25 ‚≠êÔ∏è', displayChance: '80%', realChance: 80, type: 'stars', value: 0.25, emoji: '‚≠êÔ∏è' },
{ id: 'stars_0_75', name: '0.75 ‚≠êÔ∏è', displayChance: '10%', realChance: 10, type: 'stars', value: 0.75, emoji: '‚≠êÔ∏è' },
{ id: 'stars_1_5', name: '1.5 ‚≠êÔ∏è', displayChance: '6%', realChance: 6, type: 'stars', value: 1.5, emoji: '‚≠êÔ∏è' },
{ id: 'stars_5', name: '5 ‚≠êÔ∏è', displayChance: '2%', realChance: 2, type: 'stars', value: 5, emoji: '‚≠êÔ∏è' },
{ id: 'bear', name: 'üß∏', displayChance: '1.5%', realChance: 1.5, type: 'item', sellPrice: 20, emoji: 'üß∏' },
{ id: 'diamond_pro', name: 'üíé PRO', displayChance: '0.5%', realChance: 0.5, type: 'collectible', emoji: 'üíé' }
],
coal: [
{ id: 'stars_2_5', name: '2.5 ‚≠êÔ∏è', displayChance: '60%', realChance: 60, type: 'stars', value: 2.5, emoji: '‚≠êÔ∏è' },
{ id: 'stars_5', name: '5 ‚≠êÔ∏è', displayChance: '18%', realChance: 18, type: 'stars', value: 5, emoji: '‚≠êÔ∏è' },
{ id: 'pickaxe', name: '–ö–∏—Ä–∫–∞ ‚õèÔ∏è', displayChance: '10%', realChance: 10, type: 'item', sellPrice: 10, emoji: '‚õèÔ∏è' },
{ id: 'stars_15', name: '15 ‚≠êÔ∏è', displayChance: '6%', realChance: 6, type: 'stars', value: 15, emoji: '‚≠êÔ∏è' },
{ id: 'material', name: '–ú–∞—Ç–µ—Ä–∏–∞–ª üß±', displayChance: '5%', realChance: 5, type: 'item', sellPrice: 40, emoji: 'üß±' },
{ id: 'brownie_pro', name: 'Happy Brownie PRO üí©', displayChance: '1%', realChance: 1, type: 'collectible', emoji: 'üí©' }
],
platinum: [
{ id: 'stars_35', name: '35 ‚≠êÔ∏è', displayChance: '55%', realChance: 55, type: 'stars', value: 35, emoji: '‚≠êÔ∏è' },
{ id: 'stars_50', name: '50 ‚≠êÔ∏è', displayChance: '35%', realChance: 35, type: 'stars', value: 50, emoji: '‚≠êÔ∏è' },
{ id: 'ring', name: 'üíç', displayChance: '5%', realChance: 5, type: 'collectible', emoji: 'üíç' },
{ id: 'bday', name: 'B-day üóì', displayChance: '4%', realChance: 4, type: 'item', sellPrice: 150, emoji: 'üóì' },
{ id: 'bday_pro', name: 'B-Day PRO üìÖ', displayChance: '1%', realChance: 1, type: 'collectible', emoji: 'üìÖ' }
],
gold: [
{ id: 'stars_50', name: '50 ‚≠êÔ∏è', displayChance: '50%', realChance: 50, type: 'stars', value: 50, emoji: '‚≠êÔ∏è' },
{ id: 'stars_125', name: '125 ‚≠êÔ∏è', displayChance: '35%', realChance: 35, type: 'stars', value: 125, emoji: '‚≠êÔ∏è' },
{ id: 'clover', name: 'üçÄ Clover Pin', displayChance: '10%', realChance: 10, type: 'item', sellPrice: 200, emoji: 'üçÄ' },
{ id: 'icecream', name: 'Ice Cream üç¶', displayChance: '3%', realChance: 3, type: 'collectible', emoji: 'üç¶' },
{ id: 'clover_pro', name: 'üçÄ Clover Pin PRO', displayChance: '2%', realChance: 2, type: 'collectible', emoji: 'üçÄ' }
],
money: [
{ id: 'stars_150', name: '150 ‚≠êÔ∏è', displayChance: '45%', realChance: 45, type: 'stars', value: 150, emoji: '‚≠êÔ∏è' },
{ id: 'stars_75', name: '75 ‚≠êÔ∏è', displayChance: '40%', realChance: 40, type: 'stars', value: 75, emoji: '‚≠êÔ∏è' },
{ id: 'trophy', name: 'üèÜ', displayChance: '5%', realChance: 5, type: 'collectible', emoji: 'üèÜ' },
{ id: 'gem', name: 'üíé', displayChance: '5%', realChance: 5, type: 'collectible', emoji: 'üíé' },
{ id: 'bday_happy', name: 'Happy B-day üíà', displayChance: '4%', realChance: 4, type: 'collectible', emoji: 'üíà' },
{ id: 'cigar', name: 'Snoop Cigar üö¨', displayChance: '1%', realChance: 1, type: 'collectible', emoji: 'üö¨' }
],
elite: [
{ id: 'stars_200', name: '200 ‚≠êÔ∏è', displayChance: '75%', realChance: 75, type: 'stars', value: 200, emoji: '‚≠êÔ∏è' },
{ id: 'stars_275', name: '275 ‚≠êÔ∏è', displayChance: '5%', realChance: 5, type: 'stars', value: 275, emoji: '‚≠êÔ∏è' },
{ id: 'champagne', name: 'üçæ', displayChance: '17%', realChance: 17, type: 'collectible', emoji: 'üçæ' },
{ id: 'socks', name: '–ù–æ—Å–∫–∏ üß¶', displayChance: '2%', realChance: 2, type: 'collectible', emoji: 'üß¶' },
{ id: 'lightsword', name: 'Light Sword ‚öîÔ∏è', displayChance: '1%', realChance: 1, type: 'collectible', emoji: '‚öîÔ∏è' }
],
diamond: [
{ id: 'stars_8', name: '8 ‚≠êÔ∏è', displayChance: '70%', realChance: 70, type: 'stars', value: 8, emoji: '‚≠êÔ∏è' },
{ id: 'bear', name: '–ú–∏—à–∫–∞ üß∏', displayChance: '15%', realChance: 15, type: 'item', sellPrice: 20, emoji: 'üß∏' },
{ id: 'stars_25', name: '25 ‚≠êÔ∏è', displayChance: '9%', realChance: 9, type: 'stars', value: 25, emoji: '‚≠êÔ∏è' },
{ id: 'stars_80', name: '80 ‚≠êÔ∏è', displayChance: '4%', realChance: 4, type: 'stars', value: 80, emoji: '‚≠êÔ∏è' },
{ id: 'diamond_pro', name: '–ê–ª–º–∞–∑ PRO üíé', displayChance: '0.6%', realChance: 0.6, type: 'collectible', emoji: 'üíé' },
{ id: 'snoop_pro', name: 'Snoop Dog PRO üêï', displayChance: '0.4%', realChance: 0.4, type: 'collectible', emoji: 'üêï' }
],
winter: [
{ id: 'stars_20', name: '20 ‚≠êÔ∏è', displayChance: '60%', realChance: 60, type: 'stars', value: 20, emoji: '‚≠êÔ∏è' },
{ id: 'stars_35', name: '35 ‚≠êÔ∏è', displayChance: '35%', realChance: 35, type: 'stars', value: 35, emoji: '‚≠êÔ∏è' },
{ id: 'stars_80', name: '80 ‚≠êÔ∏è', displayChance: '3.5%', realChance: 3.5, type: 'stars', value: 80, emoji: '‚≠êÔ∏è' },
{ id: 'snake', name: 'üéÑ Lunar Snake 2025 üêç', displayChance: '1%', realChance: 1, type: 'collectible', emoji: 'üêç' },
{ id: 'scarf', name: 'üß£ –ó–∏–º–Ω–µ–µ —Å–æ–∫—Ä–æ–≤–∏—â–µ', displayChance: '0.5%', realChance: 0.5, type: 'collectible', emoji: 'üß£' }
],
major: [
{ id: 'stars_500', name: '500 ‚≠êÔ∏è', displayChance: '50%', realChance: 50, type: 'stars', value: 500, emoji: '‚≠êÔ∏è' },
{ id: 'stars_1000', name: '1000 ‚≠êÔ∏è', displayChance: '25%', realChance: 25, type: 'stars', value: 1000, emoji: '‚≠êÔ∏è' },
{ id: 'stars_2500', name: '2500 ‚≠êÔ∏è', displayChance: '10%', realChance: 10, type: 'stars', value: 2500, emoji: '‚≠êÔ∏è' },
{ id: 'stars_5000', name: '5000 ‚≠êÔ∏è', displayChance: '5%', realChance: 5, type: 'stars', value: 5000, emoji: '‚≠êÔ∏è' },
{ id: 'car', name: 'üöó –ê–≤—Ç–æ–º–æ–±–∏–ª—å', displayChance: '5%', realChance: 5, type: 'collectible', emoji: 'üöó' },
{ id: 'diamond_ring', name: 'üíç –ë—Ä–∏–ª–ª–∏–∞–Ω—Ç–æ–≤–æ–µ –∫–æ–ª—å—Ü–æ', displayChance: '3%', realChance: 3, type: 'collectible', emoji: 'üíç' },
{ id: 'gold_bar', name: 'ü•á –ó–æ–ª–æ—Ç–æ–π —Å–ª–∏—Ç–æ–∫', displayChance: '2%', realChance: 2, type: 'collectible', emoji: 'ü•á' }
],
collector: [
{ id: 'bear_pro', name: 'üß∏ PRO', displayChance: '55%', realChance: 55, type: 'collectible', emoji: 'üß∏' },
{ id: 'gift_pro', name: 'üéÅ PRO', displayChance: '20%', realChance: 20, type: 'collectible', emoji: 'üéÅ' },
{ id: 'rocket_pro', name: 'üöÄ PRO', displayChance: '15%', realChance: 15, type: 'collectible', emoji: 'üöÄ' },
{ id: 'cup_pro', name: 'üèÜ PRO', displayChance: '5%', realChance: 5, type: 'collectible', emoji: 'üèÜ' },
{ id: 'cake_candle', name: 'üç∞B-day Candle', displayChance: '2%', realChance: 2, type: 'collectible', emoji: 'üç∞' },
{ id: 'ramen_pro', name: 'üçúRamen PRO', displayChance: '1.5%', realChance: 0.5, type: 'collectible', emoji: 'üçú' },
{ id: 'hat_pro', name: 'üé© Top hat', displayChance: '1%', realChance: 0, type: 'collectible', emoji: 'üé©' },
{ id: 'bird_pro', name: 'ü¶ÖRare bird', displayChance: '0.5%', realChance: 0, type: 'collectible', emoji: 'ü¶Ö' }
]
};
const INITIAL_CASES = {
cardboard: { id: 'cardboard', name: '–ö–∞—Ä—Ç–æ–Ω', emoji: 'üì¶', price: 3, color: 'from-amber-800 to-amber-900', locked: false, isNew: true, freeCount: 0 },
coal: { id: 'coal', name: '–£–≥–æ–ª—ë–∫', emoji: 'ü™®', price: 22, originalPrice: 22, discountPrice: 20, color: 'from-gray-600 to-gray-800', locked: false, isNew: false, freeCount: 0 },
platinum: { id: 'platinum', name: '–ü–ª–∞—Ç–∏–Ω–∞', emoji: 'üíé', price: 100, color: 'from-gray-300 to-gray-500', locked: false },
gold: { id: 'gold', name: '–ó–æ–ª–æ—Ç–æ–π', emoji: 'üëë', price: 250, color: 'from-yellow-400 to-yellow-600', locked: false },
money: { id: 'money', name: '–î–µ–Ω–µ–∂–Ω—ã–π', emoji: 'üíµ', price: 350, color: 'from-green-400 to-green-600', locked: false },
elite: { id: 'elite', name: '–≠–ª–∏—Ç–∞', emoji: 'üéñ', price: 500, color: 'from-red-400 to-red-600', locked: false, isNew: false, freeCount: 0 },
diamond: { id: 'diamond', name: '–ê–ª–º–∞–∑', emoji: 'üíé', price: 50, originalPrice: 50, discountPrice: 35, color: 'from-blue-400 to-blue-600', locked: false, isNew: false, freeCount: 0 },
winter: { id: 'winter', name: '–ó–∏–º–Ω–∏–π', emoji: '‚òÉÔ∏è', price: 125, originalPrice: 150, discountPrice: 125, color: 'from-cyan-400 to-blue-500', locked: false, isNew: true, freeCount: 0 },
major: { id: 'major', name: '–ú–∞–∂–æ—Ä', emoji: 'ü§¥', price: 800, color: 'from-purple-500 to-indigo-700', locked: true, isNew: false, freeCount: 0 },
collector: { id: 'collector', name: '–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–µ—Ä', emoji: 'üé©', price: 650, color: 'from-rose-600 to-pink-800', locked: true, isNew: true, freeCount: 0 }
};
const ICE_ARENA_PRIZES = [
{ id: 'bear', name: 'üß∏ –ú–∏—à–∫–∞', chance: 40, type: 'item', sellPrice: 20, emoji: 'üß∏' },
{ id: 'gloves', name: 'üß§ –í–∞—Ä–µ–∂–∫–∏', chance: 30, type: 'item', sellPrice: 50, emoji: 'üß§' },
{ id: 'fire', name: 'üî• –û–≥–æ–Ω—å', chance: 10, type: 'special', emoji: 'üî•', message: '–í—ã —Ä–∞—Å—Ç–æ–ø–∏–ª–∏ –ª–µ–¥! –ü–æ–ª—É—á–∞–µ—Ç–µ 40% –æ—Ç —Å—Ç–∞–≤–æ–∫' },
{ id: 'snow', name: '‚ùÑÔ∏è –°–Ω–µ–∂–∏–Ω–∫–∞', chance: 5, type: 'item', sellPrice: 125, emoji: '‚ùÑÔ∏è' },
{ id: 'snoop', name: 'üêï Snoop Dog', chance: 5, type: 'item', sellPrice: 130, emoji: 'üêï' },
{ id: 'winter_case', name: '‚òÉÔ∏è –ö–µ–π—Å –ó–∏–º–Ω–∏–π', chance: 4, type: 'case_free', caseType: 'winter', emoji: '‚òÉÔ∏è' },
{ id: 'elite_case', name: 'üéñ –ö–µ–π—Å –≠–ª–∏—Ç–Ω—ã–π', chance: 3, type: 'case_free', caseType: 'elite', emoji: 'üéñ' },
{ id: 'stars_350', name: '350 ‚≠êÔ∏è', chance: 2, type: 'stars', value: 350, emoji: '350‚≠êÔ∏è' },
{ id: 'scarf', name: 'üß£ –ó–∏–º–Ω–µ–µ —Å–æ–∫—Ä–æ–≤–∏—â–µ', chance: 0.5, type: 'collectible', emoji: 'üß£' },
{ id: 'dellko', name: 'üîë Promocode DELLKO', chance: 0.5, type: 'promo', code: 'DELLKO', emoji: 'üîë' }
];
const TON_RATES = [ { stars: 50, ton: 0.6 }, { stars: 250, ton: 3 }, { stars: 500, ton: 6 }, { stars: 1000, ton: 12 } ];
const STARS_PACKAGES = [ { stars: 50, price: 50, name: '50 –∑–≤–µ–∑–¥' }, { stars: 100, price: 100, name: '100 –∑–≤–µ–∑–¥' }, { stars: 250, price: 250, name: '250 –∑–≤–µ–∑–¥' }, { stars: 500, price: 500, name: '500 –∑–≤–µ–∑–¥' }, { stars: 1000, price: 1000, name: '1000 –∑–≤–µ–∑–¥' } ];
    function App() {
const [currentScreen, setCurrentScreen] = useState('cases');
const [balance, setBalance] = useState(0);
const [cases, setCases] = useState(INITIAL_CASES);
const [inventory, setInventory] = useState([]);
const [inventorySlots, setInventorySlots] = useState(5);
const [tasks, setTasks] = useState({ subscribe: { completed: false, progress: 0 }, deposit: { completed: false, progress: 0 }, depositMajor: { completed: false, progress: 0 }, invite: { completed: false, progress: 0, count: 0, invitedUsers: [] } });
const [user, setUser] = useState(null);
const [selectedCase, setSelectedCase] = useState(null);
const [isSpinning, setIsSpinning] = useState(false);
const [spinResult, setSpinResult] = useState(null);
const [showTopUp, setShowTopUp] = useState(false);
const [promoCode, setPromoCode] = useState('');
const [promoError, setPromoError] = useState('');
const [promoSuccess, setPromoSuccess] = useState('');
const [usedPromos, setUsedPromos] = useState([]);
const [wonPromos, setWonPromos] = useState([]);
const [adminAttempts, setAdminAttempts] = useState(0);
const [showAdminLogin, setShowAdminLogin] = useState(false);
const [isAdmin, setIsAdmin] = useState(false);
const [adminLogin, setAdminLogin] = useState('');
const [adminPassword, setAdminPassword] = useState('');
const [adminScreen, setAdminScreen] = useState('stats');
const [pendingPayments, setPendingPayments] = useState([]);
const [checkingPayment, setCheckingPayment] = useState(false);
const [paymentStatus, setPaymentStatus] = useState('');
const [allUsers, setAllUsers] = useState([]);
const [selectedUser, setSelectedUser] = useState(null);
const [onlineCount, setOnlineCount] = useState(Math.floor(Math.random() * 300) + 200);
const [showCollectibleModal, setShowCollectibleModal] = useState(false);
const [selectedCollectible, setSelectedCollectible] = useState(null);
const [isLoading, setIsLoading] = useState(true);
const [currentGame, setCurrentGame] = useState(null);
const [iceLobby, setIceLobby] = useState(null);
const [myBet, setMyBet] = useState(25);
const [hasBet, setHasBet] = useState(false);
const [isReady, setIsReady] = useState(false);
const [gameStatus, setGameStatus] = useState('waiting');
const [ballPos, setBallPos] = useState({ x: 50, y: 50 });
const [showPrizeChest, setShowPrizeChest] = useState(false);
const [chestPrizes, setChestPrizes] = useState([]);
const [openedChestCount, setOpenedChestCount] = useState(0);
const [showNewGamePrompt, setShowNewGamePrompt] = useState(false);
const [timerRemaining, setTimerRemaining] = useState(0);
const [showIceGiftModal, setShowIceGiftModal] = useState(false);
const [selectedIceGift, setSelectedIceGift] = useState(null);
const [withdrawAmount, setWithdrawAmount] = useState('');
const [showWithdrawModal, setShowWithdrawModal] = useState(false);
const [totalDeposits, setTotalDeposits] = useState(0);
const [freeEliteSpin, setFreeEliteSpin] = useState(0);
const [rouletteOffset, setRouletteOffset] = useState(0);
const [fakeItems, setFakeItems] = useState([]);
const [icePlayerCount, setIcePlayerCount] = useState(0);

useEffect(() => {
const initApp = async () => {
let userId = null;
let userData = null;
if (TelegramWebApp) {
TelegramWebApp.ready();
TelegramWebApp.expand();
const tgUser = TelegramWebApp.initDataUnsafe?.user;
if (tgUser) {
userId = tgUser.id.toString();
userData = { name: tgUser.first_name + (tgUser.last_name ? ' ' + tgUser.last_name : ''), username: tgUser.username ? '@' + tgUser.username : null, avatar: tgUser.photo_url || null, id: userId };
}
}
if (!userId) {
const savedUser = localStorage.getItem('sbs_user_id');
if (savedUser) {
userId = savedUser;
userData = JSON.parse(localStorage.getItem('sbs_user_data') || '{}');
} else {
userId = 'guest_' + Date.now();
userData = { name: '–ì–æ—Å—Ç—å', avatar: null, username: null, id: userId };
localStorage.setItem('sbs_user_id', userId);
localStorage.setItem('sbs_user_data', JSON.stringify(userData));
}
} else {
localStorage.setItem('sbs_user_id', userId);
localStorage.setItem('sbs_user_data', JSON.stringify(userData));
}
setUser(userData);
try {
const snapshot = await db.ref('users/' + userId).once('value');
const data = snapshot.val();
if (data) {
setBalance(data.balance || 0);
setCases(data.cases || INITIAL_CASES);
setInventory(data.inventory || []);
setTasks(data.tasks || { subscribe: { completed: false }, deposit: { completed: false }, depositMajor: { completed: false }, invite: { completed: false, count: 0 } });
setInventorySlots(data.inventorySlots || 5);
setUsedPromos(data.usedPromos || []);
setWonPromos(data.wonPromos || []);
setTotalDeposits(data.totalDeposits || 0);
setFreeEliteSpin(data.freeEliteSpin || 0);
} else {
const newCases = { ...INITIAL_CASES, diamond: { ...INITIAL_CASES.diamond, freeCount: 5 } };
setCases(newCases);
await db.ref('users/' + userId).set({ balance: 0, cases: newCases, inventory: [], tasks: { subscribe: { completed: false }, deposit: { completed: false }, depositMajor: { completed: false }, invite: { completed: false, count: 0 } }, inventorySlots: 5, usedPromos: [], wonPromos: [], createdAt: Date.now(), lastActive: Date.now(), totalDeposits: 0, freeEliteSpin: 0 });
}
} catch (error) { console.error('Error loading ', error); }
setIsLoading(false);
};
initApp();
}, []);

useEffect(() => {
if (user?.id) {
const onlineRef = db.ref('online/' + user.id);
onlineRef.set({ name: user.name, timestamp: Date.now() });
onlineRef.onDisconnect().remove();
db.ref('online').on('value', snap => { const baseOnline = Math.floor(Math.random() * 300) + 200; setOnlineCount(baseOnline + snap.numChildren()); });
return () => { onlineRef.remove(); };
}
}, [user?.id]);

useEffect(() => {
if (user?.id && !isLoading) {
const saveData = async () => {
const dataToSave = { balance, cases, inventory, tasks, inventorySlots, usedPromos, wonPromos, lastActive: Date.now(), totalDeposits, freeEliteSpin };
await db.ref('users/' + user.id).update(dataToSave);
localStorage.setItem('sbs_game_backup', JSON.stringify(dataToSave));
};
saveData();
const interval = setInterval(saveData, 5000);
return () => clearInterval(interval);
}
}, [balance, cases, inventory, tasks, inventorySlots, usedPromos, wonPromos, user?.id, isLoading, totalDeposits, freeEliteSpin]);

useEffect(() => {
return () => {
if (currentGame?.type === 'ice' && user && hasBet) {
const checkAndRefund = async () => {
const snap = await db.ref('iceLobbies/' + currentGame.lobbyId).once('value');
const data = snap.val();
if (data && data.players && Object.keys(data.players).length === 1 && data.players[user.id]) {
await db.ref('users/' + user.id + '/balance').transaction(c => (c || 0) + myBet);
await db.ref('iceLobbies/' + currentGame.lobbyId + '/players/' + user.id).remove();
}
};
checkAndRefund();
}
};
}, [currentGame, user, hasBet, myBet]);

useEffect(() => {
if (currentGame?.type === 'ice' && currentGame.lobbyId) {
const lobbyRef = db.ref('iceLobbies/' + currentGame.lobbyId);
lobbyRef.on('value', snap => {
const data = snap.val();
if (data) {
setIceLobby(data);
setGameStatus(data.status || 'waiting');
const pCount = data.players ? Object.keys(data.players).length : 0;
setIcePlayerCount(pCount);
if (data.players?.[user?.id]) { setHasBet(true); setMyBet(data.players[user?.id].bet); setIsReady(!!data.readyPlayers?.[user?.id]); }
else { setHasBet(false); setIsReady(false); }
if (data.ballPosition) setBallPos(data.ballPosition);
if (data.timerEnd && data.status === 'betting') { const remaining = Math.max(0, Math.ceil((data.timerEnd - Date.now()) / 1000)); setTimerRemaining(remaining); }
else { setTimerRemaining(0); }
if (data.status === 'finished' && data.winner?.id === user?.id) { if (!data.prizeClaimed || !data.prizeClaimed[user.id]) { if (!showPrizeChest) { setChestPrizes(data.prizes || []); setShowPrizeChest(true); } } }
if (data.players && Object.keys(data.players).length === 0 && data.status !== 'waiting') { lobbyRef.update({ status: 'waiting', players: {}, winner: null, prizes: [], ballPosition: { x: 50, y: 50, vx: 0, vy: 0 }, timerEnd: null, lastWinnerId: null, allBetsPlaced: false, prizeClaimed: {}, readyPlayers: {}, countdownStarted: false }); }
}
});
return () => lobbyRef.off();
}
}, [currentGame, user?.id, showPrizeChest]);

const handleTitleClick = () => { const newAttempts = adminAttempts + 1; setAdminAttempts(newAttempts); if (newAttempts >= 11) { setShowAdminLogin(true); setAdminAttempts(0); } };
const checkAdminLogin = () => { if (adminLogin === '_*\\^BAGUETTE_642819_6281' && adminPassword === '3628874910ZTWMI_') { setIsAdmin(true); setShowAdminLogin(false); db.ref('users').once('value').then(snap => { const users = []; snap.forEach(child => users.push({ id: child.key, ...child.val() })); setAllUsers(users); }); } else { alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å!'); } };

const adminGiveReward = async (targetUserId, reward) => {
const snapshot = await db.ref('users/' + targetUserId).once('value');
const userData = snapshot.val() || {};
if (reward.type === 'stars') { const newBalance = (userData.balance || 0) + reward.amount; await db.ref('users/' + targetUserId + '/balance').set(newBalance); if (targetUserId === user.id) setBalance(newBalance); }
else if (reward.type === 'case') { const current = userData.cases?.[reward.caseType]?.freeCount || 0; await db.ref(`users/${targetUserId}/cases/${reward.caseType}/freeCount`).set(current + reward.count); if (targetUserId === user.id) setCases(prev => ({ ...prev, [reward.caseType]: { ...prev[reward.caseType], freeCount: current + reward.count } })); }
else if (reward.type === 'item') { const newItem = { ...reward.item, uniqueId: Date.now() }; const currentInventory = userData.inventory || []; await db.ref(`users/${targetUserId}/inventory`).set([...currentInventory, newItem]); if (targetUserId === user.id) setInventory(prev => [...prev, newItem]); }
else if (reward.type === 'ice_gift') { const newItem = { id: 'ice_gift', name: 'üßä –õ—ë–¥ (–ø–æ–¥–∞—Ä–æ–∫)', emoji: 'üßä', type: 'ice_gift', sellPrice: 25, uniqueId: Date.now() }; const currentInventory = userData.inventory || []; await db.ref(`users/${targetUserId}/inventory`).set([...currentInventory, newItem]); if (targetUserId === user.id) setInventory(prev => [...prev, newItem]); }
else if (reward.type === 'promo_dellko') { const currentWonPromos = userData.wonPromos || []; await db.ref(`users/${targetUserId}/wonPromos`).set([...currentWonPromos, 'DELLKO']); if (targetUserId === user.id) setWonPromos(prev => [...prev, 'DELLKO']); }
else if (reward.type === 'unlock_major') { const updatedCases = { ...userData.cases, major: { ...userData.cases?.major, locked: false } }; await db.ref(`users/${targetUserId}/cases`).update({ major: { ...userData.cases?.major, locked: false } }); if (targetUserId === user.id) setCases(updatedCases); }
else if (reward.type === 'unlock_collector') { const updatedCases = { ...userData.cases, collector: { ...userData.cases?.collector, locked: false } }; await db.ref(`users/${targetUserId}/cases`).update({ collector: { ...userData.cases?.collector, locked: false } }); if (targetUserId === user.id) setCases(updatedCases); }
alert('–ù–∞–≥—Ä–∞–¥–∞ –≤—ã–¥–∞–Ω–∞!');
};

const joinIceLobby = async (lobbyId) => {
const lobbyRef = db.ref('iceLobbies/' + lobbyId);
const snap = await lobbyRef.once('value');
if (snap.exists()) {
const data = snap.val();
if (data.status === 'playing') { alert('–ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å! –í—ã –º–æ–∂–µ—Ç–µ —Ç–æ–ª—å–∫–æ –Ω–∞–±–ª—é–¥–∞—Ç—å.'); setCurrentGame({ type: 'ice', lobbyId, spectator: true }); return; }
if (data.status === 'finished') { await lobbyRef.update({ status: 'waiting', players: {}, winner: null, prizes: [], ballPosition: { x: 50, y: 50, vx: 0, vy: 0 }, timerEnd: null, lastWinnerId: null, allBetsPlaced: false, prizeClaimed: {}, readyPlayers: {}, countdownStarted: false }); }
if (data.status === 'betting') { await lobbyRef.update({ status: 'waiting', players: {}, readyPlayers: {}, timerEnd: null, countdownStarted: false }); alert('–ù–æ–≤—ã–π –∏–≥—Ä–æ–∫ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –≤–æ –≤—Ä–µ–º—è –æ—Ç—Å—á—ë—Ç–∞! –õ–æ–±–±–∏ —Å–±—Ä–æ—à–µ–Ω–æ.'); }
}
setCurrentGame({ type: 'ice', lobbyId, spectator: false });
};

const placeBet = async () => {
if (balance < myBet) { alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–≤–µ–∑–¥!'); return; }
if (myBet < 25) { alert('–ú–∏–Ω–∏–º—É–º 25‚≠êÔ∏è!'); return; }
const lobbyRef = db.ref('iceLobbies/' + currentGame.lobbyId);
const snap = await lobbyRef.once('value');
const data = snap.val() || {};
if (data.status === 'playing') { alert('–ò–≥—Ä–∞ —É–∂–µ –Ω–∞—á–∞–ª–∞—Å—å! –°—Ç–∞–≤–∫–∏ –∑–∞–ø—Ä–µ—â–µ–Ω—ã.'); return; }
if (data.players && Object.keys(data.players).length >= 15 && !data.players[user.id]) { alert('–õ–æ–±–±–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ (15/15)!'); return; }
const isNewPlayer = !data.players || !data.players[user.id];
if (data.status === 'betting' && isNewPlayer) { await lobbyRef.update({ status: 'waiting', players: {}, readyPlayers: {}, timerEnd: null, countdownStarted: false }); alert('–ù–æ–≤—ã–π –∏–≥—Ä–æ–∫ –∑–∞—à–µ–ª –≤–æ –≤—Ä–µ–º—è –æ—Ç—Å—á—ë—Ç–∞! –õ–æ–±–±–∏ —Å–±—Ä–æ—à–µ–Ω–æ.'); return; }
const newBalance = balance - myBet;
setBalance(newBalance);
await lobbyRef.child('players/' + user.id).set({ name: user.name, avatar: user.avatar, bet: myBet, color: `hsl(${Math.random() * 360}, 70%, 50%)`, timestamp: Date.now() });
await lobbyRef.child('readyPlayers/' + user.id).remove();
setIsReady(false);
await db.ref('users/' + user.id + '/balance').set(newBalance);
};

const toggleReady = async () => {
if (!hasBet) return;
const lobbyRef = db.ref('iceLobbies/' + currentGame.lobbyId);
const newReadyState = !isReady;
setIsReady(newReadyState);
if (newReadyState) { await lobbyRef.child('readyPlayers/' + user.id).set(true); }
else { await lobbyRef.child('readyPlayers/' + user.id).remove(); }
const snap = await lobbyRef.once('value');
const data = snap.val() || {};
const playersCount = Object.keys(data.players || {}).length;
const readyPlayersCount = Object.keys(data.readyPlayers || {}).length;
if (playersCount >= 2 && readyPlayersCount >= 2 && !data.countdownStarted) {
const timerEnd = Date.now() + 10000;
await lobbyRef.update({ status: 'betting', timerEnd: timerEnd, countdownStarted: true });
setTimeout(() => startIceGame(lobbyRef), 10000);
}
};

const startIceGame = async (lobbyRef) => {
await lobbyRef.update({ status: 'playing' });
let x = 50, y = 50, vx = (Math.random() - 0.5) * 20, vy = (Math.random() - 0.5) * 20;
const interval = setInterval(async () => {
x += vx * 0.5; y += vy * 0.5;
const dx = x - 50; const dy = y - 50; const distance = Math.sqrt(dx * dx + dy * dy);
if (distance >= 42) { const angle = Math.atan2(dy, dx); const normalX = Math.cos(angle), normalY = Math.sin(angle); const dot = vx * normalX + vy * normalY; vx = vx - 2 * dot * normalX; vy = vy - 2 * dot * normalY; x = 50 + 41 * Math.cos(angle); y = 50 + 41 * Math.sin(angle); vx *= 0.95; vy *= 0.95; }
vx *= 0.998; vy *= 0.998;
await lobbyRef.child('ballPosition').set({ x, y, vx, vy });
if (Math.abs(vx) < 0.1 && Math.abs(vy) < 0.1) { clearInterval(interval); await finishIceGame(lobbyRef, x, y); }
}, 25);
};

const finishIceGame = async (lobbyRef, finalX, finalY) => {
const snap = await lobbyRef.once('value');
const data = snap.val();
if (!data.players) return;
const players = Object.entries(data.players);
const totalBet = players.reduce((sum, [, p]) => sum + p.bet, 0);
const dx = finalX - 50; const dy = finalY - 50;
let angle = Math.atan2(dy, dx) * 180 / Math.PI;
if (angle < 0) angle += 360;
let currentAngle = 0, winner = null;
const sorted = players.sort((a, b) => a[1].timestamp - b[1].timestamp);
for (const [id, p] of sorted) {
const sector = (p.bet / totalBet) * 360;
if (angle >= currentAngle && angle < currentAngle + sector) { winner = { id, ...p }; break; }
currentAngle += sector;
}
if (!winner) winner = { id: sorted[0][0], ...sorted[0][1] };
const rand = Math.random() * 100; let cum = 0, wonPrize = ICE_ARENA_PRIZES[0];
for (const prize of ICE_ARENA_PRIZES) { cum += prize.chance; if (rand <= cum) { wonPrize = prize; break; } }
if (wonPrize.type === 'promo') { const currentWonPromos = data.wonPromos || []; await lobbyRef.child('wonPromos').set([...currentWonPromos, 'DELLKO']); const userSnap = await db.ref('users/' + winner.id).once('value'); const userData = userSnap.val() || {}; await db.ref('users/' + winner.id + '/wonPromos').set([...(userData.wonPromos || []), 'DELLKO']); if (winner.id === user.id) setWonPromos(prev => [...prev, 'DELLKO']); }
await lobbyRef.update({ status: 'finished', winner, prizes: [wonPrize], finalBall: { x: finalX, y: finalY }, allBetsPlaced: false });
if (winner.id === user.id) {
const winAmount = Math.floor(totalBet * 0.40);
const newBalance = balance + winAmount;
setBalance(newBalance);
await db.ref('users/' + user.id + '/balance').set(newBalance);
}
};

const openChest = async () => {
if (openedChestCount < 1) {
const prize = chestPrizes[0];
setOpenedChestCount(1);
await db.ref(`iceLobbies/${currentGame.lobbyId}/prizeClaimed/${user.id}`).set(true);
if (prize.type === 'stars') { const newBalance = balance + prize.value; setBalance(newBalance); await db.ref('users/' + user.id + '/balance').set(newBalance); }
else if (prize.type === 'item') { await addToInventory(prize); }
else if (prize.type === 'case_free') { setCases(prev => ({ ...prev, [prize.caseType]: { ...prev[prize.caseType], freeCount: prev[prize.caseType].freeCount + 1 } })); }
else if (prize.type === 'promo') { alert('–ü–æ–ª—É—á–µ–Ω –ø—Ä–æ–º–æ–∫–æ–¥: ' + prize.code); }
if (prize.id === 'fire') { alert(prize.message); }
setTimeout(() => { setShowPrizeChest(false); setShowNewGamePrompt(true); }, 1500);
}
};

const getCasePrice = (caseType) => {
const c = cases[caseType];
if (c.freeCount > 0) return 0;
if (c.discountPrice && c.discountPrice !== c.price) return c.discountPrice;
return c.price;
};

const openCase = async (caseType) => {
if (caseType === 'collector' && cases.collector?.locked) { alert('–ö–µ–π—Å ¬´–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–µ—Ä¬ª –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω. –ù—É–∂–Ω–æ –ø–æ–ø–æ–ª–Ω–∏—Ç—å –Ω–∞ 350‚≠êÔ∏è'); return; }
const price = getCasePrice(caseType);
const isFreeCase = cases[caseType]?.freeCount > 0;
const isElite = caseType === 'elite';
const hasFreeEliteSpin = isElite && (freeEliteSpin || 0) > 0;
if (!hasFreeEliteSpin && !isFreeCase && price > 0 && balance < price) { alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–≤–µ–∑–¥!'); return; }

const balanceBefore = balance;
let newBalanceAfterPurchase = balanceBefore;

if (isFreeCase) { const newFreeCount = cases[caseType].freeCount - 1; setCases(prev => ({ ...prev, [caseType]: { ...prev[caseType], freeCount: newFreeCount } })); await db.ref(`users/${user.id}/cases/${caseType}/freeCount`).set(newFreeCount); }
else if (hasFreeEliteSpin) { const newSpin = (freeEliteSpin || 0) - 1; setFreeEliteSpin(newSpin); await db.ref(`users/${user.id}/freeEliteSpin`).set(newSpin); }
else if (price > 0) {
newBalanceAfterPurchase = balanceBefore - price;
setBalance(newBalanceAfterPurchase);
await db.ref('users/' + user.id + '/balance').set(newBalanceAfterPurchase);
}

setIsSpinning(true);
setSelectedCase({ ...cases[caseType], id: caseType });
setSpinResult(null);
setRouletteOffset(0);

const items = CASE_REWARDS[caseType];
const rand = Math.random() * 100;
let cum = 0, won = items[0];
for (const item of items) { cum += item.realChance; if (rand <= cum) { won = item; break; } }

const tape = [];
for(let i=0; i<80; i++) tape.push(items[Math.floor(Math.random()*items.length)]);
tape[70] = won;
setFakeItems(tape);

const itemFullWidth = 136;
const jitter = Math.floor(Math.random() * 60) - 30;
const targetPos = (70 * itemFullWidth) + (itemFullWidth/2) - (window.innerWidth/2) + jitter;

setTimeout(() => {
setRouletteOffset(-targetPos);
}, 100);

setTimeout(async () => {
setSpinResult(won);
setIsSpinning(false);
if (won.type === 'stars') {
const finalBalance = newBalanceAfterPurchase + won.value;
setBalance(finalBalance);
await db.ref(`users/${user.id}/balance`).set(finalBalance);
} else {
await addToInventory(won);
}
}, 6500);
};

const addToInventory = async (item) => { if (inventory.length < inventorySlots) { const newItem = { ...item, uniqueId: Date.now(), collected: Date.now() }; const newInventory = [...inventory, newItem]; setInventory(newInventory); await db.ref(`users/${user.id}/inventory`).set(newInventory); } else { alert('–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø–æ–ª–æ–Ω!'); } };

const sellItem = async (item) => { if (item.type === 'ice_gift') { setSelectedIceGift(item); setShowIceGiftModal(true); return; } if (item.type === 'collectible') { if (item.name && item.name.includes('üßä') && item.part === 3) { if (confirm('–û–±–º–µ–Ω—è—Ç—å 3 –ª—å–¥–∞ –Ω–∞ 5 –∑–∏–º–Ω–∏—Ö –∫–µ–π—Å–æ–≤ –∏ 1000‚≠êÔ∏è?')) { const newBalance = balance + 1000; setBalance(newBalance); setCases(prev => ({ ...prev, winter: { ...prev.winter, freeCount: prev.winter.freeCount + 5 } })); const newInventory = inventory.filter(i => !(i.name && i.name.includes('üßä'))); setInventory(newInventory); await db.ref(`users/${user.id}`).update({ balance: newBalance, inventory: newInventory, 'cases/winter/freeCount': cases.winter.freeCount + 5 }); } return; } setSelectedCollectible(item); setShowCollectibleModal(true); return; } if (confirm(`–ü—Ä–æ–¥–∞—Ç—å ${item.name} –∑–∞ ${item.sellPrice}‚≠êÔ∏è?`)) { const newBalance = balance + item.sellPrice; const newInventory = inventory.filter(i => i.uniqueId !== item.uniqueId); setBalance(newBalance); setInventory(newInventory); await db.ref(`users/${user.id}`).update({ balance: newBalance, inventory: newInventory }); } };

const sellIceGift = async () => { if (!selectedIceGift) return; const newBalance = balance + 25; const newInventory = inventory.filter(i => i.uniqueId !== selectedIceGift.uniqueId); setBalance(newBalance); setInventory(newInventory); await db.ref(`users/${user.id}`).update({ balance: newBalance, inventory: newInventory }); setShowIceGiftModal(false); setSelectedIceGift(null); alert('–ü—Ä–æ–¥–∞–Ω–æ –∑–∞ 25‚≠êÔ∏è!'); };
const keepIceGift = () => { setShowIceGiftModal(false); setSelectedIceGift(null); };
const unlockSlot = async () => { if (balance >= 50) { if (confirm('–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Å–ª–æ—Ç –∑–∞ 50 ‚≠êÔ∏è?')) { const newBalance = balance - 50; const newSlots = inventorySlots + 1; setBalance(newBalance); setInventorySlots(newSlots); await db.ref(`users/${user.id}`).update({ balance: newBalance, inventorySlots: newSlots }); } } else { alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–≤–µ–∑–¥!'); } };

const checkPromo = async () => {
const code = promoCode.toUpperCase();
if (usedPromos.includes(code)) { setPromoError('–£–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω!'); return; }
if (code === 'DELLKO') { if (!wonPromos.includes('DELLKO')) { setPromoError('–≠—Ç–æ—Ç –ø—Ä–æ–º–æ–∫–æ–¥ –º–æ–∂–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—ã –≤—ã–∏–≥—Ä–∞–ª–∏ –µ–≥–æ –≤ –õ–µ–¥—è–Ω–æ–º –ö–∞—Ç–∫–µ!'); return; } const newCases = { ...cases, money: { ...cases.money, freeCount: cases.money.freeCount + 3 } }; setCases(newCases); await addToInventory({ name: 'üßä –õ—ë–¥ (1/3)', emoji: 'üßä', type: 'ice', part: 1, uniqueId: Date.now() }); setPromoSuccess('–ü—Ä–æ–º–æ–∫–æ–¥ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω! +3 –¥–µ–Ω–µ–∂–Ω—ã—Ö –∫–µ–π—Å–∞ + üßä'); setPromoCode(''); const newPromos = [...usedPromos, code]; setUsedPromos(newPromos); await db.ref(`users/${user.id}/usedPromos`).set(newPromos); }
else if (code === 'DIAMOND') { const newCases = { ...cases, diamond: { ...cases.diamond, freeCount: cases.diamond.freeCount + 2 } }; setCases(newCases); setPromoSuccess('+2 –∫–µ–π—Å–∞ –ê–ª–º–∞–∑!'); setPromoCode(''); const newPromos = [...usedPromos, code]; setUsedPromos(newPromos); await db.ref(`users/${user.id}/usedPromos`).set(newPromos); }
else { setPromoError('–ù–µ–≤–µ—Ä–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥'); return; }
};

const topUpBalance = async (stars, ton) => {
const paymentId = 'PAY_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
const memo = `SBS_${user.id}_${stars}_${paymentId}`;
const newPayment = { id: paymentId, stars: stars, ton: ton, memo: memo, status: 'pending', createdAt: Date.now(), userId: user.id };
setPendingPayments(prev => [...prev, newPayment]);
const tonLink = `ton://transfer/${ADMIN_WALLET}?amount=${Math.round(ton * 1000000000)}&text=${encodeURIComponent(memo)}`;
window.open(tonLink, '_blank');
setPaymentStatus(`–û—Ç–ø—Ä–∞–≤—å—Ç–µ ${ton} TON —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–º: ${memo}`);
setShowTopUp(false);
setTimeout(() => checkPayment(paymentId), 10000);
};

const checkPayment = async (paymentId) => {
const payment = pendingPayments.find(p => p.id === paymentId);
if (!payment || payment.status === 'completed') return;
setCheckingPayment(true); setPaymentStatus('–ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–ª–∞—Ç–µ–∂...');
try {
const response = await fetch(`${TONCENTER_API}/getTransactions?address=${ADMIN_WALLET}&limit=20`);
const data = await response.json();
if (data.result && Array.isArray(data.result)) {
const foundTx = data.result.find(tx => { const msg = tx.in_msg; if (!msg) return false; const amount = parseInt(msg.value) / 1000000000; const comment = msg.message || ''; return comment.includes(payment.memo) && Math.abs(amount - payment.ton) < 0.01; });
if (foundTx) {
const newBalance = balance + payment.stars;
const newTotalDeposits = totalDeposits + payment.stars;
setBalance(newBalance); setTotalDeposits(newTotalDeposits);
const newPayments = pendingPayments.map(p => p.id === paymentId ? {...p, status: 'completed', txHash: foundTx.transaction_id.hash} : p );
setPendingPayments(newPayments);
setPaymentStatus(`‚úÖ –£—Å–ø–µ—à–Ω–æ! –ó–∞—á–∏—Å–ª–µ–Ω–æ ${payment.stars} –∑–≤–µ–∑–¥`);
await db.ref(`users/${user.id}`).update({ balance: newBalance, totalDeposits: newTotalDeposits });
if (!tasks.deposit.completed && newTotalDeposits >= 100) { const newTasks = { ...tasks, deposit: { completed: true } }; const newCases = { ...cases, gold: { ...cases.gold, freeCount: cases.gold.freeCount + 1 } }; setTasks(newTasks); setCases(newCases); await db.ref(`users/${user.id}`).update({ tasks: newTasks, cases: newCases }); }
if (!tasks.depositMajor.completed && newTotalDeposits >= 350) { const newTasks = { ...tasks, depositMajor: { completed: true } }; const newCases = { ...cases, collector: { ...cases.collector, locked: false, freeCount: cases.collector.freeCount + 1 } }; setTasks(newTasks); setCases(newCases); await db.ref(`users/${user.id}`).update({ tasks: newTasks, cases: newCases }); }
setTimeout(() => setPaymentStatus(''), 3000);
} else { setPaymentStatus('–ü–ª–∞—Ç–µ–∂ –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ –º–∏–Ω—É—Ç—É...'); }
}
} catch (error) { setPaymentStatus('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.'); } finally { setCheckingPayment(false); }
};

const buyStars = async (pkg) => {
try {
const response = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/createInvoiceLink`, {
method: 'POST', headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({ title: `${pkg.stars} –∑–≤–µ–∑–¥`, description: `–ü–æ–∫—É–ø–∫–∞ ${pkg.stars} –∑–≤–µ–∑–¥`, payload: `stars_${user.id}_${pkg.stars}_${Date.now()}`, currency: 'XTR', prices: [{ label: `${pkg.stars} –∑–≤–µ–∑–¥`, amount: pkg.price }] })
});
const data = await response.json();
if (data.ok && data.result) {
if (TelegramWebApp) {
TelegramWebApp.openInvoice(data.result, async (status) => {
if (status === 'paid') {
const newBalance = balance + pkg.stars;
const newTotalDeposits = totalDeposits + pkg.stars;
setBalance(newBalance); setTotalDeposits(newTotalDeposits);
await db.ref(`users/${user.id}`).update({ balance: newBalance, totalDeposits: newTotalDeposits });
if (!tasks.deposit.completed && newTotalDeposits >= 100) { const newTasks = { ...tasks, deposit: { completed: true } }; const newCases = { ...cases, gold: { ...cases.gold, freeCount: cases.gold.freeCount + 1 } }; setTasks(newTasks); setCases(newCases); await db.ref(`users/${user.id}`).update({ tasks: newTasks, cases: newCases }); }
if (!tasks.depositMajor.completed && newTotalDeposits >= 350) { const newTasks = { ...tasks, depositMajor: { completed: true } }; const newCases = { ...cases, collector: { ...cases.collector, locked: false, freeCount: cases.collector.freeCount + 1 } }; setTasks(newTasks); setCases(newCases); await db.ref(`users/${user.id}`).update({ tasks: newTasks, cases: newCases }); }
alert(`‚úÖ –£—Å–ø–µ—à–Ω–æ! –ó–∞—á–∏—Å–ª–µ–Ω–æ ${pkg.stars} –∑–≤–µ–∑–¥!`);
}
});
} else {
window.open(data.result, '_blank'); alert('–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –Ω–∞–∂–º–∏—Ç–µ –û–ö –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏');
const newBalance = balance + pkg.stars; const newTotalDeposits = totalDeposits + pkg.stars; setBalance(newBalance); setTotalDeposits(newTotalDeposits);
await db.ref(`users/${user.id}`).update({ balance: newBalance, totalDeposits: newTotalDeposits });
if (!tasks.deposit.completed && newTotalDeposits >= 100) { const newTasks = { ...tasks, deposit: { completed: true } }; const newCases = { ...cases, gold: { ...cases.gold, freeCount: cases.gold.freeCount + 1 } }; setTasks(newTasks); setCases(newCases); await db.ref(`users/${user.id}`).update({ tasks: newTasks, cases: newCases }); }
if (!tasks.depositMajor.completed && newTotalDeposits >= 350) { const newTasks = { ...tasks, depositMajor: { completed: true } }; const newCases = { ...cases, collector: { ...cases.collector, locked: false, freeCount: cases.collector.freeCount + 1 } }; setTasks(newTasks); setCases(newCases); await db.ref(`users/${user.id}`).update({ tasks: newTasks, cases: newCases }); }
}
} else { alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞: ' + (data.description || 'Unknown error')); }
} catch (error) { console.error('Stars payment error:', error); alert('–û—à–∏–±–∫–∞ –ø–ª–∞—Ç–µ–∂–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.'); }
};

const completeTask = async (taskId) => {
if (taskId === 'subscribe') {
window.open('https://t.me/stepbystepdelision', '_blank');
setTimeout(async () => {
if (!tasks.subscribe?.completed) {
const newTasks = { ...tasks, subscribe: { completed: true } };
const newCases = { ...cases, elite: { ...cases.elite, freeCount: (cases.elite?.freeCount || 0) + 1 } };
const newFreeSpin = (freeEliteSpin || 0) + 1;
setTasks(newTasks); setCases(newCases); setFreeEliteSpin(newFreeSpin);
await db.ref(`users/${user.id}`).update({ tasks: newTasks, cases: newCases, freeEliteSpin: newFreeSpin });
alert('üéâ –ü–æ–ª—É—á–µ–Ω 1 –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫–µ–π—Å –≠–ª–∏—Ç–∞ + 1 –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ø—Ä–æ–∫—Ä—É—Ç!');
}
}, 2000);
} else if (taskId === 'deposit') { setShowTopUp(true); }
else if (taskId === 'depositMajor') { setShowTopUp(true); }
else if (taskId === 'invite') { const link = 'https://t.me/share/url?url=' + encodeURIComponent(`https://t.me/stepbystep_game_bot?start=${user.id}`); window.open(link, '_blank'); }
};

const handleWithdraw = () => { if (totalDeposits < 350) { setShowWithdrawModal(false); setShowTopUp(true); alert('–í—ã–≤–æ–¥ –ø–æ–¥–∞—Ä–∫–æ–≤ –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–∞ –Ω–∞ 350 ‚≠êÔ∏è'); } else { alert('–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤–µ–∑–¥, –∫–æ—Ç–æ—Ä–æ–µ –∂–µ–ª–∞–µ—Ç–µ –≤—ã–≤–µ—Å—Ç–∏'); } };
const confirmWithdraw = (type) => { alert('–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞–≥—Ä–∞–¥—ã –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏! https://t.me/stepbystepdelision'); setShowWithdrawModal(false); setWithdrawAmount(''); };

const renderIceArenaField = () => {
if (!iceLobby?.players) return null;
const players = Object.entries(iceLobby.players);
const totalBet = players.reduce((sum, [, p]) => sum + p.bet, 0);
let currentAngle = 0;
return players.map(([id, player], idx) => {
const percentage = totalBet > 0 ? (player.bet / totalBet) * 100 : 50;
const sectorAngle = (player.bet / totalBet) * 360;
const midAngle = currentAngle + sectorAngle / 2;
const avatarRadius = 35 * (percentage / 100);
const avatarX = 50 + avatarRadius * Math.cos((midAngle - 90) * Math.PI / 180);
const avatarY = 50 + avatarRadius * Math.sin((midAngle - 90) * Math.PI / 180);
currentAngle += sectorAngle;
return (
<React.Fragment key={id}>
<div className="absolute inset-0" style={{ background: `conic-gradient(from ${currentAngle - sectorAngle}deg, ${player.color}${Math.round(percentage) > 50 ? 'cc' : '99'} 0deg, ${player.color}${Math.round(percentage) > 50 ? 'cc' : '99'} ${sectorAngle}deg, transparent ${sectorAngle}deg)`, clipPath: 'circle(50% at 50% 50%)', boxShadow: `inset 0 0 30px ${player.color}40` }} />
<div className="absolute text-2xl font-bold pointer-events-none" style={{ left: `${50 + 25 * Math.cos((midAngle - 90) * Math.PI / 180)}%`, top: `${50 + 25 * Math.sin((midAngle - 90) * Math.PI / 180)}%`, transform: 'translate(-50%, -50%)', color: 'white', textShadow: '0 0 10px black, 0 0 20px black' }} >{Math.round(percentage)}%</div>
<div className="player-avatar" style={{ left: `${avatarX}%`, top: `${avatarY}%`, borderColor: player.color, boxShadow: `0 0 15px ${player.color}` }} >{player.avatar ? (<img src={player.avatar} className="w-full h-full object-cover" />) : (<div className="w-full h-full bg-gray-600 flex items-center justify-center text-sm font-bold"> {player.name[0]} </div>)}</div>
</React.Fragment>
);
});
};

if (isAdmin) {
return (
<div className="min-h-screen bg-gray-900 p-4">
<div className="max-w-4xl mx-auto">
<div className="flex justify-between items-center mb-6"><h1 className="text-2xl font-bold text-white">üîê –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h1><button onClick={() => setIsAdmin(false)} className="text-gray-400 hover:text-white">–í—ã–π—Ç–∏</button></div>
<div className="flex gap-2 mb-6 overflow-x-auto">{['stats', 'users', 'rewards', 'settings'].map(tab => (<button key={tab} onClick={() => setAdminScreen(tab)} className={`px-4 py-2 rounded-lg capitalize ${adminScreen === tab ? 'bg-indigo-600' : 'bg-gray-700'}`}>{tab === 'stats' && 'üìä'} {tab === 'users' && 'üë•'} {tab === 'rewards' && 'üéÄ'} {tab === 'settings' && '‚öôÔ∏è'} {tab}</button>))}</div>
<div className="glass rounded-xl p-6">
{adminScreen === 'stats' && (<div className="grid grid-cols-2 gap-4"><div className="bg-gray-800 p-4 rounded-lg"><div className="text-gray-400">–í—Å–µ–≥–æ –∏–≥—Ä–æ–∫–æ–≤</div><div className="text-3xl font-bold">{allUsers.length}</div></div><div className="bg-gray-800 p-4 rounded-lg"><div className="text-gray-400">–û–Ω–ª–∞–π–Ω</div><div className="text-3xl font-bold text-green-400">{onlineCount}</div></div><div className="bg-gray-800 p-4 rounded-lg"><div className="text-gray-400">–û–±—â–∏–π –±–∞–ª–∞–Ω—Å</div><div className="text-3xl font-bold">{allUsers.reduce((sum, u) => sum + (u.balance || 0), 0).toFixed(2)} ‚≠êÔ∏è</div></div><div className="bg-gray-800 p-4 rounded-lg"><div className="text-gray-400">–ü–æ–¥–∞—Ä–∫–æ–≤</div><div className="text-3xl font-bold">{allUsers.reduce((sum, u) => sum + (u.inventory?.length || 0), 0)}</div></div></div>)}
{adminScreen === 'users' && selectedUser && (<div className="bg-gray-800 p-4 rounded-lg mb-4"><h3 className="font-bold mb-4 text-xl">{selectedUser.name}</h3><div className="grid grid-cols-2 gap-4 mb-4"><div className="bg-gray-700 p-3 rounded"><div className="text-gray-400 text-sm">–ë–∞–ª–∞–Ω—Å</div><div className="text-2xl font-bold text-yellow-400">{selectedUser.balance || 0}‚≠êÔ∏è</div></div><div className="bg-gray-700 p-3 rounded"><div className="text-gray-400 text-sm">–ö–µ–π—Å–æ–≤</div><div className="text-2xl font-bold text-blue-400"> {Object.values(selectedUser.cases || {}).reduce((a,b) => a + (b.freeCount || 0), 0)} </div></div></div><div className="grid grid-cols-4 gap-2"><button onClick={() => adminGiveReward(selectedUser.id, { type: 'stars', amount: 100 })} className="bg-green-600 p-2 rounded">+100‚≠êÔ∏è</button><button onClick={() => adminGiveReward(selectedUser.id, { type: 'case', caseType: 'diamond', count: 5 })} className="bg-blue-600 p-2 rounded">+5üíé</button><button onClick={() => adminGiveReward(selectedUser.id, { type: 'unlock_collector' })} className="bg-pink-600 p-2 rounded">üîì –ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–µ—Ä</button><button onClick={() => setSelectedUser(null)} className="bg-gray-600 p-2 rounded col-span-4">–ù–∞–∑–∞–¥</button></div></div>)}
{adminScreen === 'users' && !selectedUser && (<div className="space-y-2 max-h-96 overflow-y-auto">{allUsers.map(u => (<div key={u.id} onClick={() => setSelectedUser(u)} className="bg-gray-800 p-3 rounded-lg cursor-pointer hover:bg-gray-700 flex justify-between items-center"><div><div className="font-bold">{u.name}</div><div className="text-sm text-gray-400">{u.username || u.id.slice(0, 10)}</div></div><div className="text-right"><div className="text-yellow-400">{(u.balance || 0).toFixed(0)}‚≠êÔ∏è</div></div></div>))}</div>)}
{adminScreen === 'rewards' && (<div><h3 className="text-lg mb-4">–í—ã–¥–∞—Ç—å —Å–µ–±–µ (–∞–¥–º–∏–Ω—É):</h3><div className="grid grid-cols-3 gap-2"><button onClick={() => adminGiveReward(user.id, { type: 'stars', amount: 10000 })} className="bg-indigo-600 p-3 rounded">+10000‚≠êÔ∏è</button><button onClick={() => adminGiveReward(user.id, { type: 'item', item: { name: '–ê–ª–º–∞–∑ PRO üíé', emoji: 'üíé', type: 'collectible', uniqueId: Date.now() } })} className="bg-pink-600 p-3 rounded">üíé –ê–ª–º–∞–∑ PRO</button><button onClick={() => adminGiveReward(user.id, { type: 'unlock_collector' })} className="bg-pink-800 p-3 rounded">üîì –†–∞–∑–±–ª–æ–∫ –ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–µ—Ä</button></div></div>)}
{adminScreen === 'settings' && (<div><h3 className="text-lg mb-4">–û—á–∏—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç</h3><button onClick={async () => { if (confirm('–£–¥–∞–ª–∏—Ç—å –í–°–ï —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ?')) { await db.ref('users/' + user.id).remove(); localStorage.removeItem('sbs_user_id'); localStorage.removeItem('sbs_user_data'); localStorage.removeItem('sbs_game_backup'); window.location.reload(); } }} className="bg-red-600 px-4 py-2 rounded-lg">üóë –°–±—Ä–æ—Å–∏—Ç—å –º–æ–π –∞–∫–∫–∞—É–Ω—Ç</button><p className="text-sm text-gray-400 mt-2">–î—Ä—É–≥–∏–µ –∏–≥—Ä–æ–∫–∏ –Ω–µ –ø–æ—Å—Ç—Ä–∞–¥–∞—é—Ç</p></div>)}
</div>
</div>
</div>
);
}

if (currentGame?.type === 'ice') {
const isSpectator = currentGame?.spectator === true;
const playersCount = icePlayerCount;
return (
<div className="min-h-screen bg-gradient-to-b from-blue-900 to-indigo-900 p-4">
<div className="max-w-2xl mx-auto">
<div className="flex justify-between items-center mb-4"><h1 className="text-2xl font-bold">‚òÉÔ∏è –õ–µ–¥—è–Ω–æ–π –ö–∞—Ç–æ–∫</h1><button onClick={() => setCurrentGame(null)} className="text-white hover:text-red-400">‚úï</button></div>
<div className="text-center mb-4"><div className="text-sm text-cyan-300">–õ–æ–±–±–∏ #{currentGame.lobbyId}</div><div className="text-lg font-bold text-white"> {gameStatus === 'waiting' ? '‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤...' : gameStatus === 'betting' ? '‚è∞ –û—Ç—Å—á—ë—Ç 10 —Å–µ–∫—É–Ω–¥!' : gameStatus === 'playing' ? 'üî¥ –ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å!' : 'üèÜ –ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞'} </div>{isSpectator && gameStatus === 'playing' && (<div className="text-yellow-400 text-sm mt-2">–ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å! –í—ã –º–æ–∂–µ—Ç–µ —Ç–æ–ª—å–∫–æ –Ω–∞–±–ª—é–¥–∞—Ç—å.</div>)}{gameStatus === 'betting' && timerRemaining > 0 && (<div className="text-3xl font-bold text-yellow-400 animate-pulse mt-2"> ‚è∞ {timerRemaining} —Å–µ–∫ </div>)}</div>
<div className="flex justify-center mb-6"><div className="ice-circle relative">{renderIceArenaField()}{(gameStatus === 'waiting' || gameStatus === 'betting') && (<div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-20 h-20 bg-black rounded-full flex items-center justify-center text-4xl mystery-box border-4 border-cyan-400 shadow-lg shadow-cyan-500/50"> ‚ùì </div>)}{gameStatus === 'playing' && (<div className="ice-ball" style={{ left: ballPos.x + '%', top: ballPos.y + '%' }} />)}{gameStatus === 'finished' && iceLobby?.finalBall && (<div className="ice-ball" style={{ left: iceLobby.finalBall.x + '%', top: iceLobby.finalBall.y + '%', background: '#ffd700', boxShadow: '0 0 30px #ffd700' }} />)}</div></div>
{!isSpectator && (gameStatus === 'waiting' || gameStatus === 'betting') && !hasBet ? (
<div className="glass rounded-xl p-4 mb-4 border border-cyan-500/30">
{playersCount < 2 ? (
<div className="text-center text-yellow-400 py-4 font-bold animate-pulse text-lg"> ‚è≥ –û–∂–∏–¥–∞–µ–º –µ—â–µ –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è... (—Å–µ–π—á–∞—Å {playersCount}) </div>
) : (
<>
<div className="flex gap-2 mb-4"><input type="number" min="25" value={myBet} onChange={(e) => setMyBet(Number(e.target.value))} className="flex-1 bg-gray-800 border border-cyan-600 rounded-lg p-3 text-center text-xl text-white" /><button onClick={() => setMyBet(p => p + 25)} className="bg-cyan-700 px-4 rounded-lg font-bold">+25</button><button onClick={() => setMyBet(p => p + 100)} className="bg-cyan-700 px-4 rounded-lg font-bold">+100</button></div>
<button onClick={placeBet} disabled={balance < myBet} className="w-full bg-gradient-to-r from-cyan-600 to-blue-600 py-4 rounded-xl font-bold text-xl disabled:opacity-50 shadow-lg"> –°–¥–µ–ª–∞—Ç—å —Å—Ç–∞–≤–∫—É ({myBet}‚≠êÔ∏è) </button>
<p className="text-center text-sm text-cyan-300 mt-2">–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞: 25‚≠êÔ∏è</p>
</>
)}
</div>
) : !isSpectator && hasBet ? (
<div className="text-center mb-4"><div className="text-green-400 font-bold text-xl mb-2">‚úì –°—Ç–∞–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞: {myBet}‚≠êÔ∏è</div><button onClick={toggleReady} className={`px-6 py-3 rounded-xl font-bold text-lg ${ isReady ? 'bg-green-600 hover:bg-green-500' : 'bg-yellow-600 hover:bg-yellow-500' } transition`} > {isReady ? '‚úÖ –ì–æ—Ç–æ–≤' : '–ü—Ä–∏–≥–æ—Ç–æ–≤–∏—Ç—å—Å—è‚úÖ'} </button><p className="text-sm text-gray-400 mt-2">–ò–≥—Ä–æ–∫–æ–≤ –≤ –ª–æ–±–±–∏: {playersCount}</p></div>
) : null}
{showPrizeChest && iceLobby?.winner?.id === user.id && (<div className="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4"><div className="glass rounded-2xl p-6 max-w-md w-full text-center border border-yellow-500/50"><h2 className="text-3xl font-bold mb-2 text-yellow-400">üèÜ –ü–æ–±–µ–¥–∞!</h2><p className="mb-4 text-gray-300">–û—Ç–∫—Ä–æ–π—Ç–µ —Å—É–Ω–¥—É–∫</p><div className="text-7xl mb-4 cursor-pointer transition-transform active:scale-95" onClick={openChest}> üéÅ </div><p className="text-sm text-gray-400">+ 40% –æ—Ç –æ–±—â–µ–π —Å—Ç–∞–≤–∫–∏</p></div></div>)}
{showNewGamePrompt && (<div className="fixed inset-0 bg-black/80 z-40 flex items-center justify-center p-4"><div className="glass rounded-2xl p-6 text-center max-w-sm w-full"><h3 className="text-xl font-bold mb-4">–ù–∞—á–∞—Ç—å –Ω–æ–≤—É—é –∏–≥—Ä—É?</h3><div className="flex gap-4 justify-center"><button onClick={async () => { setShowNewGamePrompt(false); setOpenedChestCount(0); setHasBet(false); setIsReady(false); await db.ref('iceLobbies/' + currentGame.lobbyId).update({ status: 'waiting', players: {}, winner: null, prizes: [], ballPosition: { x: 50, y: 50, vx: 0, vy: 0 }, timerEnd: null, allBetsPlaced: false, prizeClaimed: {}, readyPlayers: {}, countdownStarted: false }); }} className="bg-green-600 px-6 py-3 rounded-lg font-bold text-lg">‚úÖ –î–∞</button><button onClick={() => setCurrentGame(null)} className="bg-red-600 px-6 py-3 rounded-lg font-bold text-lg">‚ùå –ù–µ—Ç</button></div></div></div>)}
<div className="glass rounded-xl p-4 mb-4"><h3 className="font-bold mb-2 text-cyan-300">–ò–≥—Ä–æ–∫–∏ ({playersCount}/15):</h3><div className="space-y-2 max-h-40 overflow-y-auto">{iceLobby?.players && Object.entries(iceLobby.players).map(([id, p]) => (<div key={id} className="flex justify-between items-center bg-gray-800/50 p-2 rounded border border-white/10"><div className="flex items-center gap-2"><div className="w-3 h-3 rounded-full" style={{background: p.color}}></div><span className={id === user.id ? 'font-bold text-cyan-300' : ''}>{p.name} {id === user.id && '(–í—ã)'}</span>{iceLobby.readyPlayers?.[id] && (<span className="text-green-400 text-xs">‚úÖ</span>)}</div><div className="text-right"><span className="font-bold text-yellow-400">{p.bet}‚≠êÔ∏è</span></div></div>))}{!iceLobby?.players || Object.keys(iceLobby.players).length === 0 && (<p className="text-gray-400 text-center py-4">–ü–æ–∫–∞ –Ω–∏–∫–æ–≥–æ –Ω–µ—Ç. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</p>)}</div><div className="border-t border-gray-600 mt-2 pt-2 flex justify-between font-bold text-lg"><span className="text-gray-300">–û–±—â–∏–π –±–∞–Ω–∫:</span><span className="text-yellow-400"> {iceLobby?.players ? Object.values(iceLobby.players).reduce((s, p) => s + p.bet, 0) : 0}‚≠êÔ∏è </span></div></div>
</div>
</div>
);
}

return (
<div className="min-h-screen pb-24">
<header className="p-4 flex justify-between items-center glass sticky top-0 z-50"><h1 onClick={handleTitleClick} className="text-xl font-bold cursor-pointer select-none hover:text-cyan-300 transition">Step By Step Game</h1><button onClick={() => setShowTopUp(true)} className="bg-gradient-to-r from-yellow-400 to-orange-500 px-4 py-2 rounded-full font-bold text-gray-900 shadow-lg"> {balance.toFixed(2)} ‚≠êÔ∏è </button></header>
{paymentStatus && (<div className={`mx-4 mt-2 p-3 rounded-lg text-center text-sm ${paymentStatus.includes('‚úÖ') ? 'bg-green-500/20 border border-green-500' : 'bg-blue-500/20 border border-blue-500'}`}>{checkingPayment && <span className="animate-pulse">–ü—Ä–æ–≤–µ—Ä–∫–∞...</span>}{paymentStatus}</div>)}
{showIceGiftModal && (<div className="fixed inset-0 bg-black/90 z-[60] flex items-center justify-center p-4"><div className="glass rounded-2xl p-6 max-w-sm w-full text-center border border-cyan-500/50"><div className="text-6xl mb-4">üßä</div><h3 className="text-xl font-bold mb-2 text-cyan-300">–õ–µ–¥—è–Ω–æ–π –ü–æ–¥–∞—Ä–æ–∫!</h3><p className="mb-4 text-gray-300">–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —ç—Ç–æ—Ç –ø–æ–¥–∞—Ä–æ–∫ –¥–æ –æ—Ç—Ç–µ–ø–µ–ª–∏ –∏–ª–∏ –ø—Ä–æ–¥–∞–π—Ç–µ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å!</p><div className="space-y-3"><button onClick={sellIceGift} className="w-full bg-orange-600 hover:bg-orange-500 py-3 rounded-xl font-bold text-lg transition"> üî• –ü—Ä–æ–¥–∞—Ç—å –∑–∞ 25‚≠êÔ∏è </button><button onClick={keepIceGift} className="w-full bg-cyan-600 hover:bg-cyan-500 py-3 rounded-xl font-bold text-lg transition"> üíé –û—Å—Ç–∞–≤–∏—Ç—å —Å–µ–±–µ </button></div></div></div>)}
{showCollectibleModal && (<div className="fixed inset-0 bg-black/90 z-[60] flex items-center justify-center p-4"><div className="glass rounded-2xl p-6 max-w-sm w-full text-center"><div className="text-6xl mb-4 animate-bounce">{selectedCollectible?.emoji}</div><h3 className="text-xl font-bold mb-2">–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω—ã–π –ø—Ä–µ–¥–º–µ—Ç!</h3><p className="mb-4">–î–∞–Ω–Ω—ã–π –ø–æ–¥–∞—Ä–æ–∫ —è–≤–ª—è–µ—Ç—Å—è –∫–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω—ã–º! –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ <a href="https://t.me/stepbystepdelision" target="_blank" className="text-blue-400 underline font-bold hover:text-blue-300">–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏</a> –¥–ª—è –µ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è.</p><button onClick={() => setShowCollectibleModal(false)} className="w-full bg-indigo-600 hover:bg-indigo-500 py-3 rounded-xl font-bold">–ü–æ–Ω—è—Ç–Ω–æ</button></div></div>)}
{showAdminLogin && (<div className="fixed inset-0 bg-black/90 z-[60] flex items-center justify-center p-4"><div className="glass rounded-2xl p-6 max-w-sm w-full"><h2 className="text-xl font-bold text-center mb-4">üîê –í—Ö–æ–¥ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h2><input type="text" placeholder="–õ–æ–≥–∏–Ω" value={adminLogin} onChange={(e) => setAdminLogin(e.target.value)} className="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-3 mb-3 text-center" /><input type="password" placeholder="–ü–∞—Ä–æ–ª—å" value={adminPassword} onChange={(e) => setAdminPassword(e.target.value)} className="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-3 mb-4 text-center" /><button onClick={checkAdminLogin} className="w-full bg-indigo-600 hover:bg-indigo-500 py-3 rounded-xl font-bold mb-2">–í–æ–π—Ç–∏</button><button onClick={() => setShowAdminLogin(false)} className="w-full bg-gray-700 hover:bg-gray-600 py-2 rounded-xl">–û—Ç–º–µ–Ω–∞</button></div></div>)}
{showWithdrawModal && (<div className="fixed inset-0 bg-black/90 z-[60] flex items-center justify-center p-4"><div className="glass rounded-2xl p-6 max-w-sm w-full"><h2 className="text-xl font-bold text-center mb-4">üìä –í—ã–≤–æ–¥ –ø—Ä–∏–∑–æ–≤</h2><input type="number" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤–µ–∑–¥" value={withdrawAmount} onChange={(e) => setWithdrawAmount(e.target.value)} className="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-3 mb-4 text-center" /><div className="grid grid-cols-2 gap-3 mb-4"><button onClick={() => confirmWithdraw('stars')} className="bg-yellow-600 hover:bg-yellow-500 py-3 rounded-xl font-bold" > –í –∑–≤–µ–∑–¥–∞—Ö </button><button onClick={() => confirmWithdraw('gifts')} className="bg-purple-600 hover:bg-purple-500 py-3 rounded-xl font-bold" > –í –ø–æ–¥–∞—Ä–∫–∞—Ö </button></div><button onClick={() => setShowWithdrawModal(false)} className="w-full bg-gray-700 hover:bg-gray-600 py-2 rounded-xl">–û—Ç–º–µ–Ω–∞</button></div></div>)}

<main className="p-4 max-w-md mx-auto">
{currentScreen === 'cases' && (
<div>
<h2 className="text-2xl font-bold mb-4 text-center">üé∞ –ö–µ–π—Å—ã</h2>
{cases.diamond.freeCount > 0 && (<div className="bg-green-500/20 border border-green-500 rounded-lg p-3 mb-4 text-center animate-pulse"> üéÅ –ë–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –∫–µ–π—Å–æ–≤ –ê–ª–º–∞–∑: {cases.diamond.freeCount} </div>)}
{cases.elite.freeCount > 0 && (<div className="bg-green-500/20 border border-green-500 rounded-lg p-3 mb-4 text-center animate-pulse"> üéÅ –ë–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –∫–µ–π—Å–æ–≤ –≠–ª–∏—Ç–∞: {cases.elite.freeCount} </div>)}
{freeEliteSpin > 0 && (<div className="bg-green-500/20 border border-green-500 rounded-lg p-3 mb-4 text-center animate-pulse"> üéÅ –ë–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –ø—Ä–æ–∫—Ä—É—Ç–æ–≤ –≠–ª–∏—Ç–∞: {freeEliteSpin} </div>)}
<div className="grid grid-cols-2 gap-4">
{Object.values(cases).filter(c => !c.locked).map(c => (
<div key={c.id} className={`glass rounded-xl p-4 relative hover:scale-105 transition ${c.id === 'cardboard' ? 'case-cardboard' : c.id === 'collector' ? 'case-collector' : ''}`}>
{c.isNew && <span className="absolute -top-2 -right-2 bg-red-500 text-xs px-2 py-1 rounded-full animate-pulse">–ù–æ–≤–æ–µ!</span>}
{(c.id === 'diamond' || c.id === 'coal' || c.id === 'winter') && c.freeCount === 0 && c.discountPrice && (<span className="absolute -top-2 -left-2 bg-green-500 text-xs px-2 py-1 rounded-full animate-pulse">–°–∫–∏–¥–∫–∞!</span>)}
<div className={`w-16 h-16 mx-auto rounded-lg ${c.id === 'cardboard' || c.id === 'collector' ? 'bg-white/20' : `bg-gradient-to-br ${c.color}`} flex items-center justify-center text-3xl mb-2 shadow-lg`}>{c.emoji}</div>
<h3 className="font-bold text-center">{c.name}</h3>
<p className="text-center text-sm opacity-75"> {c.freeCount > 0 ? <span className="text-green-400 font-bold">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ!</span> : c.discountPrice && c.discountPrice !== c.price ? <span><span className="line-through">{c.originalPrice || c.price}</span> {c.discountPrice} ‚≠êÔ∏è</span> : `${c.price} ‚≠êÔ∏è`} </p>
<button onClick={() => setSelectedCase(c)} className="w-full mt-2 py-2 rounded-lg font-bold bg-gradient-to-r from-indigo-500 to-purple-500 hover:from-indigo-600 hover:to-purple-600 transition">–û—Ç–∫—Ä—ã—Ç—å</button>
</div>
))}
{Object.values(cases).filter(c => c.locked).map(c => (
<div key={c.id} className="glass rounded-xl p-4 relative opacity-50">
<div className="absolute inset-0 bg-black/70 rounded-xl flex items-center justify-center"><span className="text-2xl">üîí</span></div>
<div className={`w-16 h-16 mx-auto rounded-lg bg-gradient-to-br ${c.color} flex items-center justify-center text-3xl mb-2 shadow-lg`}>{c.emoji}</div>
<h3 className="font-bold text-center">{c.name}</h3>
<p className="text-center text-sm opacity-75">{c.price} ‚≠êÔ∏è</p>
<button className="w-full mt-2 py-2 rounded-lg font-bold bg-gray-600 cursor-not-allowed">–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ</button>
</div>
))}
</div>
</div>
)}

{currentScreen === 'games' && (
<div>
<h2 className="text-2xl font-bold mb-4 text-center">üéÆ –ò–≥—Ä—ã</h2>
<div className="space-y-4">
<div className="glass rounded-xl p-6 cursor-pointer hover:bg-white/5 transition border border-cyan-500/30" onClick={() => joinIceLobby(1)}>
<h3 className="text-2xl font-bold mb-2 text-center text-cyan-300">‚òÉÔ∏è –õ–µ–¥—è–Ω–æ–π –ö–∞—Ç–æ–∫</h3>
<p className="text-gray-400 mb-4 text-center">–°–æ—Ä–µ–≤–Ω—É–π—Ç–µ—Å—å —Å –¥—Ä—É–≥–∏–º–∏ –∏–≥—Ä–æ–∫–∞–º–∏! –ú–∏–Ω. —Å—Ç–∞–≤–∫–∞ 25‚≠êÔ∏è<br/>–ü–æ–±–µ–¥–∏—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç 40% –æ—Ç –±–∞–Ω–∫–∞</p>
<div className="grid grid-cols-5 gap-2">
{[1,2,3,4,5,6,7,8,9,10].map(i => (
<button key={i} onClick={(e) => { e.stopPropagation(); joinIceLobby(i); }} className="bg-cyan-700 hover:bg-cyan-600 py-2 rounded-lg text-sm font-bold transition">#{i}</button>
))}
</div>
</div>
<div className="glass rounded-xl p-6 opacity-50 text-center"><h3 className="text-xl font-bold mb-2">–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ... üë≤</h3></div>
</div>
</div>
)}

{currentScreen === 'tasks' && (
<div>
<h2 className="text-2xl font-bold mb-4 text-center">üìã –ú–æ–∏ –ó–∞–¥–∞–Ω–∏—è</h2>
<div className="space-y-4">
<div className={`glass rounded-xl p-4 ${tasks.subscribe?.completed ? 'bg-green-500/20 border-green-500' : ''}`}>
<div className="flex justify-between items-start mb-2"><div><h3 className="font-bold">–ü–æ–¥–ø–∏—à–∏—Å—å –Ω–∞ –∫–∞–Ω–∞–ª</h3><p className="text-sm opacity-75">–ù–∞–≥—Ä–∞–¥–∞: 1 –∫–µ–π—Å ¬´–≠–ª–∏—Ç–∞¬ª + 1 –ø—Ä–æ–∫—Ä—É—Ç üéñ</p></div>{tasks.subscribe?.completed && <span className="text-green-400 text-2xl">‚úÖ</span>}</div>
<button onClick={() => completeTask('subscribe')} disabled={tasks.subscribe?.completed} className={`w-full py-2 rounded-lg ${tasks.subscribe?.completed ? 'bg-green-600' : 'bg-blue-600 hover:bg-blue-500'} transition`}> {tasks.subscribe?.completed ? '–í—ã–ø–æ–ª–Ω–µ–Ω–æ' : '–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è'} </button>
</div>
<div className={`glass rounded-xl p-4 ${tasks.deposit?.completed ? 'bg-green-500/20 border-green-500' : ''}`}>
<div className="flex justify-between items-start mb-2"><div><h3 className="font-bold">–ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å –Ω–∞ 100 ‚≠êÔ∏è</h3><p className="text-sm opacity-75">–ù–∞–≥—Ä–∞–¥–∞: 1 –∑–æ–ª–æ—Ç–æ–π –∫–µ–π—Å üëë</p></div>{tasks.deposit?.completed && <span className="text-green-400 text-2xl">‚úÖ</span>}</div>
<button onClick={() => completeTask('deposit')} className={`w-full py-2 rounded-lg ${tasks.deposit?.completed ? 'bg-green-600' : 'bg-blue-600 hover:bg-blue-500'} transition`}> {tasks.deposit?.completed ? '–í—ã–ø–æ–ª–Ω–µ–Ω–æ' : '–ü–æ–ø–æ–ª–Ω–∏—Ç—å'} </button>
</div>
<div className={`glass rounded-xl p-4 ${tasks.depositMajor?.completed ? 'bg-green-500/20 border-green-500' : ''}`}>
<div className="flex justify-between items-start mb-2"><div><h3 className="font-bold">–ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å –Ω–∞ 350 ‚≠êÔ∏è</h3><p className="text-sm opacity-75">–ù–∞–≥—Ä–∞–¥–∞: –ö–µ–π—Å ¬´–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–µ—Ä¬ª + 1 –ø—Ä–æ–∫—Ä—É—Ç</p></div>{tasks.depositMajor?.completed && <span className="text-green-400 text-2xl">‚úÖ</span>}</div>
<button onClick={() => completeTask('depositMajor')} className={`w-full py-2 rounded-lg ${tasks.depositMajor?.completed ? 'bg-green-600' : 'bg-blue-600 hover:bg-blue-500'} transition`}> {tasks.depositMajor?.completed ? '–í—ã–ø–æ–ª–Ω–µ–Ω–æ' : '–ü–æ–ø–æ–ª–Ω–∏—Ç—å'} </button>
</div>
<div className={`glass rounded-xl p-4 ${tasks.invite?.completed ? 'bg-green-500/20 border-green-500' : ''}`}>
<div className="flex justify-between items-start mb-2"><div><h3 className="font-bold">–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å —Ç—Ä—ë—Ö –¥—Ä—É–∑–µ–π</h3><p className="text-sm opacity-75">–ù–∞–≥—Ä–∞–¥–∞: 25 ‚≠êÔ∏è</p></div>{tasks.invite?.completed && <span className="text-green-400 text-2xl">‚úÖ</span>}</div>
<div className="w-full bg-gray-700 rounded-full h-2 mb-3"><div className="bg-blue-500 h-2 rounded-full transition-all" style={{width: `${Math.min(((tasks.invite?.count || 0) / 3) * 100, 100)}%`}} /></div>
<p className="text-sm text-gray-400 mb-2 text-center">{tasks.invite?.count || 0}/3 –¥—Ä—É–∑–µ–π</p>
<button onClick={() => completeTask('invite')} disabled={tasks.invite?.completed} className={`w-full py-2 rounded-lg ${tasks.invite?.completed ? 'bg-green-600' : 'bg-blue-600 hover:bg-blue-500'} transition`}> {tasks.invite?.completed ? '–í—ã–ø–æ–ª–Ω–µ–Ω–æ' : '–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å'} </button>
</div>
</div>
</div>
)}

{currentScreen === 'profile' && (
<div>
<div className="glass rounded-xl p-4 mb-4 flex justify-between items-center"><span className="text-gray-400">üü¢ –û–Ω–ª–∞–π–Ω:</span><span className="font-bold text-green-400">{onlineCount} –∏–≥—Ä–æ–∫–æ–≤</span></div>
<h2 className="text-2xl font-bold mb-4 text-center">üë§ –ú–æ–π –ü—Ä–æ—Ñ–∏–ª—å</h2>
<div className="glass rounded-xl p-6 text-center mb-4">
<div className="w-24 h-24 mx-auto rounded-full bg-gradient-to-br from-indigo-400 to-purple-500 flex items-center justify-center text-4xl mb-3 overflow-hidden border-2 border-white/20">
{user?.avatar ? <img src={user.avatar} alt="avatar" className="w-full h-full object-cover" /> : user?.name?.charAt(0).toUpperCase()}
</div>
<h3 className="text-xl font-bold">{user?.name}</h3>
{user?.username && <p className="text-gray-400">{user.username}</p>}
</div>
<div className="flex gap-2 mb-4"><button onClick={() => setShowTopUp(true)} className="flex-1 bg-gradient-to-r from-yellow-400 to-orange-500 text-gray-900 font-bold py-3 rounded-xl shadow-lg hover:shadow-xl transition">üíé –ü–æ–ø–æ–ª–Ω–∏—Ç—å TON</button></div>
<div className="mb-4"><button onClick={() => setShowWithdrawModal(true)} disabled={!tasks.depositMajor?.completed} className="w-full bg-gradient-to-r from-purple-500 to-indigo-600 text-white font-bold py-3 rounded-xl shadow-lg hover:shadow-xl transition flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed" >{tasks.depositMajor?.completed ? 'üèÜ –í—ã–≤–µ—Å—Ç–∏ –ø—Ä–∏–∑—ã üèÜ' : 'üîí –í—ã–≤–µ—Å—Ç–∏ –ø—Ä–∏–∑—ã (–Ω—É–∂–Ω–æ 350‚≠êÔ∏è)'}</button></div>
<div className="glass rounded-xl p-4 mb-4"><h3 className="font-bold mb-2">üéÅ –ü—Ä–æ–º–æ–∫–æ–¥</h3><div className="flex gap-2"><input type="text" placeholder="–í–í–ï–î–ò–¢–ï –ü–†–û–ú–û–ö–û–î" value={promoCode} onChange={(e) => setPromoCode(e.target.value)} className="flex-1 bg-gray-700/50 border border-gray-600 rounded-lg px-3 py-2 text-center uppercase" /><button onClick={checkPromo} className="bg-indigo-600 hover:bg-indigo-500 px-4 py-2 rounded-lg font-bold transition">OK</button></div>{promoError && <p className="text-red-400 text-sm mt-2 text-center">{promoError}</p>}{promoSuccess && <p className="text-green-400 text-sm mt-2 text-center">{promoSuccess}</p>}</div>
<div className="glass rounded-xl p-4"><div className="flex justify-between items-center mb-3"><h3 className="font-bold">üéí –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</h3><span className="text-sm text-gray-400">{inventory.length}/{inventorySlots}</span></div><div className="grid grid-cols-5 gap-2 mb-4">{[...Array(inventorySlots)].map((_, i) => (<div key={i} className="aspect-square bg-gray-700/50 rounded-lg flex items-center justify-center text-2xl relative hover:bg-gray-600/50 transition cursor-pointer">{inventory[i] ? (<span onClick={() => sellItem(inventory[i])} className="hover:scale-110 transition" title={inventory[i].type === 'collectible' ? '–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω—ã–π' : inventory[i].type === 'ice_gift' ? '–õ–µ–¥—è–Ω–æ–π –ø–æ–¥–∞—Ä–æ–∫' : '–ü—Ä–æ–¥–∞—Ç—å'}> {inventory[i].emoji} </span>) : <span className="text-gray-600 text-xs">–ü—É—Å—Ç–æ</span>}</div>))}</div><button onClick={unlockSlot} disabled={balance < 50} className="w-full bg-gray-700 hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed py-2 rounded-lg text-sm font-bold flex items-center justify-center gap-2 transition"> <span>üîì</span> –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Å–ª–æ—Ç (50‚≠êÔ∏è) </button></div>
</div>
)}
</main>

{selectedCase && (
<div className="fullscreen-modal flex items-center justify-center p-4">
<div className="w-full max-w-lg">
<div className="flex justify-between items-center mb-6"><h3 className="text-3xl font-bold">{selectedCase.emoji} {selectedCase.name}</h3><button onClick={() => {setSelectedCase(null); setSpinResult(null);}} className="text-3xl hover:text-red-400 transition">&times;</button></div>
<div className="roulette-container mb-8"><div className="roulette-pointer"></div><div className="roulette-inner" style={{ transform: `translateX(${rouletteOffset}px)` }}>{fakeItems.map((item, i) => (<div key={i} className="roulette-item"><div className="emoji">{item.emoji}</div><div className="name">{item.name}</div></div>))}</div></div>
<div className="glass rounded-xl p-4 mb-6 max-h-48 overflow-y-auto"><p className="font-bold mb-2 text-center text-lg">–í–æ–∑–º–æ–∂–Ω—ã–µ –Ω–∞–≥—Ä–∞–¥—ã:</p><div className="space-y-1 text-sm">{CASE_REWARDS[selectedCase.id].map((reward, idx) => (<div key={idx} className="flex justify-between py-1 border-b border-white/10 last:border-0"><span className="flex items-center gap-2">{reward.emoji} {reward.name}</span><span className="text-yellow-400 font-bold">{reward.displayChance}</span></div>))}</div></div>
{spinResult ? (<div className="text-center"><p className="text-2xl font-bold mb-2">–í—ã–ø–∞–ª–æ: {spinResult.name}!</p>{spinResult.type === 'collectible' && <p className="text-sm text-yellow-400 mb-4">‚≠êÔ∏è –ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω—ã–π –ø—Ä–µ–¥–º–µ—Ç!</p>}<button onClick={() => setSpinResult(null)} className="w-full bg-green-600 hover:bg-green-500 py-4 rounded-xl font-bold text-xl mb-2 transition">–ó–∞–±—Ä–∞—Ç—å –∏ –æ—Ç–∫—Ä—ã—Ç—å –µ—â—ë</button><button onClick={() => {setSelectedCase(null); setSpinResult(null);}} className="w-full bg-gray-600 hover:bg-gray-500 py-3 rounded-xl font-bold transition">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∫–µ–π—Å–∞–º</button></div>) : (<button onClick={() => openCase(selectedCase.id)} disabled={isSpinning} className="w-full bg-gradient-to-r from-indigo-500 to-purple-500 hover:from-indigo-600 hover:to-purple-600 py-4 rounded-xl font-bold text-xl disabled:opacity-50 shadow-lg transition">{isSpinning ? '–ö—Ä—É—Ç–∏–º...' : `–û—Ç–∫—Ä—ã—Ç—å –∑–∞ ${getCasePrice(selectedCase.id) === 0 ? '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ' : getCasePrice(selectedCase.id) + ' ‚≠êÔ∏è'}`}</button>)}
</div>
</div>
)}

{showTopUp && (
<div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
<div className="glass rounded-2xl p-6 max-w-sm w-full">
<div className="flex justify-between items-center mb-4"><h3 className="text-xl font-bold">üí≥ –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</h3><button onClick={() => setShowTopUp(false)} className="text-2xl hover:text-red-400 transition">&times;</button></div>
<div className="space-y-3 mb-4"><p className="text-sm text-gray-400 text-center">‚≠êÔ∏è Telegram Stars</p>{STARS_PACKAGES.map((pkg) => (<button key={pkg.stars} onClick={() => buyStars(pkg)} className="w-full glass p-4 rounded-xl flex justify-between items-center hover:bg-white/10 transition border border-white/10"><span className="font-bold text-yellow-400">+{pkg.stars} ‚≠êÔ∏è</span><span className="text-sm text-gray-300">–ö—É–ø–∏—Ç—å</span></button>))}</div>
<div className="border-t border-gray-600 pt-4"><p className="text-sm text-gray-400 text-center mb-3">üíé TON</p>{TON_RATES.map((rate) => (<button key={rate.stars} onClick={() => topUpBalance(rate.stars, rate.ton)} className="w-full glass p-3 rounded-xl flex justify-between items-center hover:bg-white/10 transition border border-white/10 mb-2"><span className="font-bold">+{rate.stars} –∑–≤–µ–∑–¥ ‚≠êÔ∏è</span><span className="text-yellow-400 font-bold">{rate.ton} TON</span></button>))}</div>
</div>
</div>
)}

<nav className="fixed bottom-0 left-0 right-0 glass border-t border-white/10 p-2">
<div className="max-w-md mx-auto flex justify-around">
{['tasks', 'cases', 'games', 'profile'].map(screen => (
<button key={screen} onClick={() => setCurrentScreen(screen)} className={`flex flex-col items-center p-2 rounded-lg transition ${currentScreen === screen ? 'text-blue-400 scale-110' : 'text-gray-400 hover:text-white'}`}>
<span className="text-2xl">{screen === 'cases' ? 'üéÅ' : screen === 'games' ? 'üéÆ' : screen === 'tasks' ? 'üìã' : 'üë§'}</span>
<span className="text-xs font-bold">{screen === 'cases' ? '–ö–µ–π—Å—ã' : screen === 'games' ? '–ò–≥—Ä—ã' : screen === 'tasks' ? '–ó–∞–¥–∞–Ω–∏—è' : '–ü—Ä–æ—Ñ–∏–ª—å'}</span>
</button>
))}
</div>
</nav>
</div>
);
}
ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
