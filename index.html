<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Step By Step Game</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#6366f1',
                        secondary: '#8b5cf6',
                        accent: '#f59e0b',
                        ice: '#00d2ff',
                    }
                }
            }
        }
    </script>
    <style>
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, sans-serif; overscroll-behavior: none; }
        .olympus-font { font-family: 'Cinzel', serif; font-weight: 700; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes pulseGlow { 0%, 100% { box-shadow: 0 0 10px rgba(0,210,255,0.3); } 50% { box-shadow: 0 0 30px rgba(0,210,255,0.8); } }
        @keyframes goldGlow { 0%, 100% { text-shadow: 0 0 5px #facc15, 0 0 10px #facc15; } 50% { text-shadow: 0 0 20px #facc15, 0 0 30px #eab308; } }
        @keyframes purpleGlow { 0%, 100% { text-shadow: 0 0 5px #a855f7, 0 0 10px #a855f7; } 50% { text-shadow: 0 0 20px #a855f7, 0 0 30px #9333ea; } }
        @keyframes greenGlow { 0%, 100% { box-shadow: 0 0 5px #22c55e, 0 0 10px #22c55e; } 50% { box-shadow: 0 0 15px #22c55e, 0 0 25px #16a34a; } }
        @keyframes yellowGlow { 0%, 100% { text-shadow: 0 0 5px #fbbf24, 0 0 10px #fbbf24; } 50% { text-shadow: 0 0 20px #fbbf24, 0 0 30px #f59e0b; } }
        @keyframes neonPulse { 0%, 100% { text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 20px #fbbf24, 0 0 30px #fbbf24, 0 0 40px #f59e0b; } 50% { text-shadow: 0 0 10px #fff, 0 0 20px #fff, 0 0 30px #fbbf24, 0 0 40px #fbbf24, 0 0 60px #f59e0b; } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .neon-text { animation: neonPulse 2s infinite; }
        .pulse-glow { animation: pulseGlow 2s ease-in-out infinite; }
        .special-header { animation: purpleGlow 3s infinite; }
        .ordinary-header { animation: goldGlow 3s infinite; }
        .glass { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
        .line-through { text-decoration: line-through; opacity: 0.6; color: #ef4444; text-decoration-color: #ef4444; text-decoration-thickness: 2px; }
        .fullscreen-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 100; overflow-y: auto; }
        .daily-timer { color: #4ade80; font-family: monospace; font-weight: bold; font-size: 14px; background: rgba(0,0,0,0.6); padding: 2px 8px; border-radius: 6px; border: 1px solid #22c55e; animation: greenGlow 2s infinite; display: inline-block; }
        .cases-timer { color: #fbbf24; font-family: monospace; text-shadow: 0 0 5px #fbbf24; animation: yellowGlow 2s infinite; }
        .case-cardboard { background: linear-gradient(135deg, #8B4513 0%, #D2691E 50%, #8B4513 100%); border: 3px solid #A0522D; }
        .case-collector { background: linear-gradient(135deg, #DC143C 0%, #FF1493 50%, #8B008B 100%); border: 3px solid #FFD700; }
        .events-tab-active { background: linear-gradient(135deg, rgba(251,191,36,0.3), rgba(245,158,11,0.2)); border: 2px solid rgba(251,191,36,0.6); box-shadow: 0 0 20px rgba(251,191,36,0.4); }
        .roulette-container { position: relative; width: 100%; height: 140px; overflow: hidden; background: rgba(0,0,0,0.4); border-radius: 16px; border: 2px solid rgba(255,255,255,0.1); margin: 16px 0; }
        .roulette-inner { display: flex; position: absolute; left: 0; top: 10px; transition: transform 6.5s cubic-bezier(0.1, 0, 0.1, 1); will-change: transform; }
        .roulette-item { width: 110px; height: 110px; flex-shrink: 0; margin: 0 6px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05)); border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); }
        .roulette-item .emoji { font-size: 3rem; }
        .roulette-item .name { font-size: 10px; opacity: 0.8; text-align: center; margin-top: 2px; }
        .roulette-pointer { position: absolute; left: 50%; top: 0; bottom: 0; width: 4px; background: #ff4757; z-index: 20; transform: translateX(-50%); box-shadow: 0 0 20px #ff4757; }
        .roulette-pointer::before { content: ''; position: absolute; top: -5px; left: 50%; transform: translateX(-50%); border-left: 10px solid transparent; border-right: 10px solid transparent; border-top: 15px solid #ff4757; }
        .roulette-pointer::after { content: ''; position: absolute; bottom: -5px; left: 50%; transform: translateX(-50%); border-left: 10px solid transparent; border-right: 10px solid transparent; border-bottom: 15px solid #ff4757; }
        .round-box { width: 28px; height: 28px; border-radius: 6px; border: 2px solid rgba(255,255,255,0.3); display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold; margin: 0 2px; transition: all 0.3s; }
        .round-box.completed { background: linear-gradient(135deg, #22c55e, #16a34a); border-color: #22c55e; box-shadow: 0 0 10px #22c55e; }
        .round-box.current { background: linear-gradient(135deg, #fbbf24, #f59e0b); border-color: #fbbf24; box-shadow: 0 0 10px #fbbf24; animation: pulse 1s infinite; }
        .mobile-btn { min-height: 48px; display: flex; align-items: center; justify-content: center; }
        .progress-step { transition: all 0.3s; }
        .progress-step.done { background: linear-gradient(135deg, #22c55e, #16a34a) !important; border-color: #22c55e !important; box-shadow: 0 0 12px rgba(34,197,94,0.5); }
        .progress-step.active { border-color: #fbbf24 !important; box-shadow: 0 0 12px rgba(251,191,36,0.5); animation: pulse 1.5s infinite; }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-600 min-h-screen text-white overflow-x-hidden">
    <div id="root"></div>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyDZPRiByz69HQa8b7GFMCJeqq56J3Y-bOY",
            authDomain: "step-by-step-279df.firebaseapp.com",
            databaseURL: "https://step-by-step-279df-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "step-by-step-279df",
            storageBucket: "step-by-step-279df.firebasestorage.app",
            messagingSenderId: "302641152597",
            appId: "1:302641152597:web:6479b9ae03104666cd8adc"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const TelegramWebApp = window.Telegram?.WebApp;
        const ADMIN_WALLET = 'UQAWqaIPFSg81l9MlgAx0HBE9o3gpJMhk1dnyryKJXhWNHIc';
        const BOT_TOKEN = '8325421899:AAG9t3yS4WWiwasRoHb-nbr3a94S9tQfHys';

        const INITIAL_CASES = {
            daily: { id: 'daily', name: 'Ð•Ð¶ÐµÐ´Ð½ÐµÐ²Ð½Ñ‹Ð¹', emoji: 'ðŸ—“ï¸', price: 0, color: 'from-cyan-400 to-teal-600', locked: false, isNew: true, freeCount: 1, type: 'special', lastOpened: 0 },
            collector: { id: 'collector', name: 'ÐšÐ¾Ð»Ð»ÐµÐºÑ†Ð¸Ð¾Ð½ÐµÑ€', emoji: 'ðŸŽ©', price: 650, color: 'from-rose-600 to-pink-800', locked: true, isNew: true, freeCount: 0, type: 'special' },
            cardboard: { id: 'cardboard', name: 'ÐšÐ°Ñ€Ñ‚Ð¾Ð½', emoji: 'ðŸ“¦', price: 3, color: 'from-amber-800 to-amber-900', locked: false, isNew: true, freeCount: 0 },
            coal: { id: 'coal', name: 'Ð£Ð³Ð¾Ð»Ñ‘Ðº', emoji: 'ðŸª¨', price: 27, color: 'from-gray-600 to-gray-800', locked: false, isNew: false, freeCount: 0 },
            platinum: { id: 'platinum', name: 'ÐŸÐ»Ð°Ñ‚Ð¸Ð½Ð°', emoji: 'ðŸ’Ž', price: 100, color: 'from-gray-300 to-gray-500', locked: false },
            gold: { id: 'gold', name: 'Ð—Ð¾Ð»Ð¾Ñ‚Ð¾Ð¹', emoji: 'ðŸ‘‘', price: 250, color: 'from-yellow-400 to-yellow-600', locked: false },
            money: { id: 'money', name: 'Ð”ÐµÐ½ÐµÐ¶Ð½Ñ‹Ð¹', emoji: 'ðŸ’µ', price: 350, color: 'from-green-400 to-green-600', locked: false },
            elite: { id: 'elite', name: 'Ð­Ð»Ð¸Ñ‚Ð°', emoji: 'ðŸŽ–', price: 500, color: 'from-red-400 to-red-600', locked: false, isNew: false, freeCount: 0 },
            diamond: { id: 'diamond', name: 'ÐÐ»Ð¼Ð°Ð·', emoji: 'ðŸ’Ž', price: 50, color: 'from-blue-400 to-blue-600', locked: false, isNew: false, freeCount: 0 },
            major: { id: 'major', name: 'ÐœÐ°Ð¶Ð¾Ñ€', emoji: 'ðŸ¤´', price: 800, color: 'from-purple-500 to-indigo-700', locked: true, isNew: false, freeCount: 0 },
            star: { id: 'star', name: 'Ð—Ð²ÐµÐ·Ð´Ð½Ñ‹Ð¹', emoji: 'â­ï¸', price: 30, originalPrice: 30, discountPrice: 23, color: 'from-yellow-400 to-amber-500', locked: false, isNew: true, freeCount: 0 }
        };

        const CASE_REWARDS = {
            daily: [
                { id: 'stars_1', name: '1 â­ï¸', emoji: 'â­ï¸', type: 'stars', value: 1, realChance: 50, displayChance: '50%' },
                { id: 'stars_3', name: '3 â­ï¸', emoji: 'â­ï¸', type: 'stars', value: 3, realChance: 35, displayChance: '35%' },
                { id: 'stars_15', name: '15 â­ï¸', emoji: 'â­ï¸', type: 'stars', value: 15, realChance: 10, displayChance: '10%' },
                { id: 'pickaxe', name: 'ÐšÐ¸Ñ€ÐºÐ° â›ï¸', emoji: 'â›ï¸', type: 'item', sellPrice: 22, realChance: 4, displayChance: '4%' },
                { id: 'random_case_box', name: 'Ð¡Ð»ÑƒÑ‡Ð°Ð¹Ð½Ñ‹Ð¹ ÐºÐµÐ¹Ñ', emoji: 'ðŸ“¦', type: 'random_case_box', realChance: 1, displayChance: '1%' },
            ],
            cardboard: [
                { id: 'stars_0_25', name: '0.25 â­ï¸', displayChance: '80%', realChance: 80, type: 'stars', value: 0.25, emoji: 'â­ï¸' },
                { id: 'stars_0_75', name: '0.75 â­ï¸', displayChance: '10%', realChance: 10, type: 'stars', value: 0.75, emoji: 'â­ï¸' },
                { id: 'stars_1_5', name: '1.5 â­ï¸', displayChance: '6%', realChance: 6, type: 'stars', value: 1.5, emoji: 'â­ï¸' },
                { id: 'stars_5', name: '5 â­ï¸', displayChance: '2%', realChance: 2, type: 'stars', value: 5, emoji: 'â­ï¸' },
                { id: 'bear', name: 'ðŸ§¸', displayChance: '1.5%', realChance: 1.5, type: 'item', sellPrice: 20, emoji: 'ðŸ§¸' },
                { id: 'diamond_pro', name: 'ðŸ’Ž PRO', displayChance: '0.5%', realChance: 0, type: 'collectible', emoji: 'ðŸ’Ž' }
            ],
            coal: [
                { id: 'stars_5', name: '5 â­ï¸', displayChance: '60.5%', realChance: 60.5, type: 'stars', value: 5, emoji: 'â­ï¸' },
                { id: 'stars_12', name: '12 â­ï¸', displayChance: '18%', realChance: 18, type: 'stars', value: 12, emoji: 'â­ï¸' },
                { id: 'pickaxe', name: 'ÐšÐ¸Ñ€ÐºÐ° â›ï¸', displayChance: '10%', realChance: 10, type: 'item', sellPrice: 22, emoji: 'â›ï¸' },
                { id: 'stars_30', name: '30 â­ï¸', displayChance: '6%', realChance: 6, type: 'stars', value: 30, emoji: 'â­ï¸' },
                { id: 'material', name: 'ÐœÐ°Ñ‚ÐµÑ€Ð¸Ð°Ð» ðŸ§±', displayChance: '5%', realChance: 5, type: 'item', sellPrice: 80, emoji: 'ðŸ§±' },
                { id: 'brownie_pro', name: 'Happy Brownie PRO ðŸ’©', displayChance: '0.5%', realChance: 0, type: 'collectible', emoji: 'ðŸ’©' }
            ],
            platinum: [
                { id: 'stars_35', name: '35 â­ï¸', displayChance: '55%', realChance: 55, type: 'stars', value: 35, emoji: 'â­ï¸' },
                { id: 'stars_50', name: '50 â­ï¸', displayChance: '35%', realChance: 35, type: 'stars', value: 50, emoji: 'â­ï¸' },
                { id: 'ring', name: 'ðŸ’', displayChance: '5%', realChance: 0, type: 'collectible', emoji: 'ðŸ’' },
                { id: 'bday', name: 'B-day ðŸ—“', displayChance: '4%', realChance: 4, type: 'item', sellPrice: 150, emoji: 'ðŸ—“' },
                { id: 'bday_pro', name: 'B-Day PRO ðŸ“…', displayChance: '1%', realChance: 0, type: 'collectible', emoji: 'ðŸ“…' }
            ],
            gold: [
                { id: 'stars_50', name: '50 â­ï¸', displayChance: '50%', realChance: 50, type: 'stars', value: 50, emoji: 'â­ï¸' },
                { id: 'stars_125', name: '125 â­ï¸', displayChance: '35%', realChance: 35, type: 'stars', value: 125, emoji: 'â­ï¸' },
                { id: 'clover', name: 'ðŸ€ Clover Pin', displayChance: '10%', realChance: 10, type: 'item', sellPrice: 200, emoji: 'ðŸ€' },
                { id: 'icecream', name: 'Ice Cream ðŸ¦', displayChance: '3%', realChance: 0, type: 'collectible', emoji: 'ðŸ¦' },
                { id: 'clover_pro', name: 'ðŸ€ Clover Pin PRO', displayChance: '2%', realChance: 0, type: 'collectible', emoji: 'ðŸ€' }
            ],
            money: [
                { id: 'stars_150', name: '150 â­ï¸', displayChance: '45%', realChance: 45, type: 'stars', value: 150, emoji: 'â­ï¸' },
                { id: 'stars_75', name: '75 â­ï¸', displayChance: '40%', realChance: 40, type: 'stars', value: 75, emoji: 'â­ï¸' },
                { id: 'trophy', name: 'ðŸ†', displayChance: '5%', realChance: 0, type: 'collectible', emoji: 'ðŸ†' },
                { id: 'gem', name: 'ðŸ’Ž', displayChance: '5%', realChance: 0, type: 'collectible', emoji: 'ðŸ’Ž' },
                { id: 'bday_happy', name: 'Happy B-day ðŸ’ˆ', displayChance: '4%', realChance: 4, type: 'collectible', emoji: 'ðŸ’ˆ' },
                { id: 'cigar', name: 'Snoop Cigar ðŸš¬', displayChance: '1%', realChance: 0, type: 'collectible', emoji: 'ðŸš¬' }
            ],
            elite: [
                { id: 'stars_200', name: '200 â­ï¸', displayChance: '65%', realChance: 65, type: 'stars', value: 200, emoji: 'â­ï¸' },
                { id: 'stars_275', name: '275 â­ï¸', displayChance: '25%', realChance: 25, type: 'stars', value: 275, emoji: 'â­ï¸' },
                { id: 'champagne', name: 'ðŸ¾', displayChance: '8.5%', realChance: 0, type: 'collectible', emoji: 'ðŸ¾' },
                { id: 'socks', name: 'ÐÐ¾ÑÐºÐ¸ ðŸ§¦', displayChance: '1%', realChance: 0, type: 'collectible', emoji: 'ðŸ§¦' },
                { id: 'lightsword', name: 'Light Sword âš”ï¸', displayChance: '0.5%', realChance: 0, type: 'collectible', emoji: 'âš”ï¸' }
            ],
            diamond: [
                { id: 'stars_8', name: '8 â­ï¸', displayChance: '70%', realChance: 70, type: 'stars', value: 8, emoji: 'â­ï¸' },
                { id: 'bear', name: 'ÐœÐ¸ÑˆÐºÐ° ðŸ§¸', displayChance: '15%', realChance: 15, type: 'item', sellPrice: 20, emoji: 'ðŸ§¸' },
                { id: 'stars_25', name: '25 â­ï¸', displayChance: '9%', realChance: 9, type: 'stars', value: 25, emoji: 'â­ï¸' },
                { id: 'stars_80', name: '80 â­ï¸', displayChance: '4%', realChance: 4, type: 'stars', value: 80, emoji: 'â­ï¸' },
                { id: 'diamond_pro', name: 'ÐÐ»Ð¼Ð°Ð· PRO ðŸ’Ž', displayChance: '0.6%', realChance: 0, type: 'collectible', emoji: 'ðŸ’Ž' },
                { id: 'snoop_pro', name: 'Snoop Dog PRO ðŸ•', displayChance: '0.4%', realChance: 0, type: 'collectible', emoji: 'ðŸ•' }
            ],
            major: [
                { id: 'stars_500', name: '500 â­ï¸', displayChance: '50%', realChance: 50, type: 'stars', value: 500, emoji: 'â­ï¸' },
                { id: 'stars_1000', name: '1000 â­ï¸', displayChance: '25%', realChance: 25, type: 'stars', value: 1000, emoji: 'â­ï¸' },
                { id: 'stars_2500', name: '2500 â­ï¸', displayChance: '10%', realChance: 10, type: 'stars', value: 2500, emoji: 'â­ï¸' },
                { id: 'stars_5000', name: '5000 â­ï¸', displayChance: '5%', realChance: 5, type: 'stars', value: 5000, emoji: 'â­ï¸' },
                { id: 'car', name: 'ðŸš— ÐÐ²Ñ‚Ð¾Ð¼Ð¾Ð±Ð¸Ð»ÑŒ', displayChance: '5%', realChance: 0, type: 'collectible', emoji: 'ðŸš—' },
                { id: 'diamond_ring', name: 'ðŸ’ Ð‘Ñ€Ð¸Ð»Ð»Ð¸Ð°Ð½Ñ‚Ð¾Ð²Ð¾Ðµ ÐºÐ¾Ð»ÑŒÑ†Ð¾', displayChance: '3%', realChance: 0, type: 'collectible', emoji: 'ðŸ’' },
                { id: 'gold_bar', name: 'ðŸ¥‡ Ð—Ð¾Ð»Ð¾Ñ‚Ð¾Ð¹ ÑÐ»Ð¸Ñ‚Ð¾Ðº', displayChance: '2%', realChance: 0, type: 'collectible', emoji: 'ðŸ¥‡' }
            ],
            collector: [
                { id: 'bear_pro', name: 'ðŸ§¸ PRO', displayChance: '55%', realChance: 0, type: 'collectible', emoji: 'ðŸ§¸' },
                { id: 'gift_pro', name: 'ðŸŽ PRO', displayChance: '20%', realChance: 0, type: 'collectible', emoji: 'ðŸŽ' },
                { id: 'rocket_pro', name: 'ðŸš€ PRO', displayChance: '15%', realChance: 0, type: 'collectible', emoji: 'ðŸš€' },
                { id: 'cup_pro', name: 'ðŸ† PRO', displayChance: '5%', realChance: 0, type: 'collectible', emoji: 'ðŸ†' },
                { id: 'cake_candle', name: 'ðŸ° B-day Candle', displayChance: '2%', realChance: 0, type: 'collectible', emoji: 'ðŸ°' },
                { id: 'ramen_pro', name: 'ðŸœ Ramen PRO', displayChance: '1.5%', realChance: 0, type: 'collectible', emoji: 'ðŸœ' },
                { id: 'hat_pro', name: 'ðŸŽ© Top hat', displayChance: '1%', realChance: 0, type: 'collectible', emoji: 'ðŸŽ©' },
                { id: 'bird_pro', name: 'ðŸ¦… Rare bird', displayChance: '0.5%', realChance: 0, type: 'collectible', emoji: 'ðŸ¦…' }
            ],
            star: [
                {id:'stars_1',name:'1 â­ï¸',displayChance:'10.50%',realChance:10.50,type:'stars',value:1,emoji:'â­ï¸'},
                {id:'stars_2',name:'2 â­ï¸',displayChance:'8.00%',realChance:8.00,type:'stars',value:2,emoji:'â­ï¸'},
                {id:'stars_3',name:'3 â­ï¸',displayChance:'6.50%',realChance:6.50,type:'stars',value:3,emoji:'â­ï¸'},
                {id:'stars_5',name:'5 â­ï¸',displayChance:'5.20%',realChance:5.20,type:'stars',value:5,emoji:'â­ï¸'},
                {id:'stars_10',name:'10 â­ï¸',displayChance:'4.30%',realChance:4.30,type:'stars',value:10,emoji:'â­ï¸'},
                {id:'stars_15',name:'15 â­ï¸',displayChance:'3.70%',realChance:3.70,type:'stars',value:15,emoji:'â­ï¸'},
                {id:'stars_20',name:'20 â­ï¸',displayChance:'3.20%',realChance:3.20,type:'stars',value:20,emoji:'â­ï¸'},
                {id:'stars_25',name:'25 â­ï¸',displayChance:'2.80%',realChance:2.80,type:'stars',value:25,emoji:'â­ï¸'},
                {id:'stars_30',name:'30 â­ï¸',displayChance:'2.50%',realChance:2.50,type:'stars',value:30,emoji:'â­ï¸'},
                {id:'stars_40',name:'40 â­ï¸',displayChance:'2.00%',realChance:2.00,type:'stars',value:40,emoji:'â­ï¸'},
                {id:'stars_50',name:'50 â­ï¸',displayChance:'1.50%',realChance:1.50,type:'stars',value:50,emoji:'â­ï¸'},
                {id:'stars_60',name:'60 â­ï¸',displayChance:'1.00%',realChance:1.00,type:'stars',value:60,emoji:'â­ï¸'},
                {id:'stars_75',name:'75 â­ï¸',displayChance:'0.50%',realChance:0.50,type:'stars',value:75,emoji:'â­ï¸'},
                {id:'stars_100',name:'100 â­ï¸',displayChance:'0.20%',realChance:0.20,type:'stars',value:100,emoji:'â­ï¸'},
                {id:'stars_125',name:'125 â­ï¸',displayChance:'0.10%',realChance:0.10,type:'stars',value:125,emoji:'â­ï¸'}
            ],
            olympus: [
                { id: 'persephone', name: 'ÐŸÐµÑ€ÑÐµÑ„Ð¾Ð½Ð° ðŸŒº', emoji: 'ðŸŒº', type: 'olympus_item', sellPrice: 20, realChance: 40, displayChance: '40%' },
                { id: 'ares', name: 'ÐÑ€ÐµÑ ðŸ—¡ï¸', emoji: 'ðŸ—¡ï¸', type: 'olympus_item', sellPrice: 28, realChance: 20, displayChance: '20%' },
                { id: 'hermes', name: 'Ð“ÐµÑ€Ð¼ÐµÑ ðŸ“ˆ', emoji: 'ðŸ“ˆ', type: 'olympus_hermes', realChance: 15, displayChance: '15%' },
                { id: 'dionysus', name: 'Ð”Ð¸Ð¾Ð½Ð¸Ñ ðŸ·', emoji: 'ðŸ·', type: 'olympus_dionysus', realChance: 10, displayChance: '10%' },
                { id: 'apollo', name: 'ÐÐ¿Ð¾Ð»Ð»Ð¾Ð½ â˜€ï¸', emoji: 'â˜€ï¸', type: 'olympus_apollo', realChance: 8, displayChance: '8%' },
                { id: 'poseidon', name: 'ÐŸÐ¾ÑÐµÐ¹Ð´Ð¾Ð½ ðŸ”±', emoji: 'ðŸ”±', type: 'olympus_poseidon', realChance: 5, displayChance: '5%' },
                { id: 'hades', name: 'ÐÐ¸Ð´ ðŸ”¥', emoji: 'ðŸ”¥', type: 'olympus_hades', realChance: 1.9, displayChance: '1.9%' },
                { id: 'zeus', name: 'Ð—ÐµÐ²Ñ âš¡ï¸', emoji: 'âš¡', type: 'olympus_zeus', realChance: 0.1, displayChance: '0.1%' }
            ]
        };

        const GERAKL_10_REWARDS = [
            { id: 'bear', name: 'ðŸ§¸ ÐœÐ¸ÑˆÐºÐ°', chance: 35, type: 'item', sellPrice: 20, emoji: 'ðŸ§¸' },
            { id: 'bear_pro', name: 'ðŸ§¸ PRO', chance: 20, type: 'collectible', emoji: 'ðŸ§¸' },
            { id: 'material', name: 'ðŸ§± ÐœÐ°Ñ‚ÐµÑ€Ð¸Ð°Ð»', chance: 15, type: 'item', sellPrice: 80, emoji: 'ðŸ§±' },
            { id: 'champagne', name: 'ðŸ¾ Ð‘ÑƒÑ‚Ñ‹Ð»ÐºÐ°', chance: 10, type: 'collectible', emoji: 'ðŸ¾' },
            { id: 'ring', name: 'ðŸ’ ÐšÐ¾Ð»ÑŒÑ†Ð¾', chance: 8, type: 'collectible', emoji: 'ðŸ’' },
            { id: 'stars_25', name: '25 â­ï¸', chance: 5, type: 'stars', value: 25, emoji: 'â­ï¸' },
            { id: 'stars_200', name: '200 â­ï¸', chance: 3, type: 'stars', value: 200, emoji: 'â­ï¸' },
            { id: 'stars_350', name: '350 â­ï¸', chance: 2, type: 'stars', value: 350, emoji: 'â­ï¸' },
            { id: 'dellko', name: 'ðŸ”‘ DELLKO', chance: 2, type: 'promo', code: 'DELLKO', emoji: 'ðŸ”‘' }
        ];

        const GERAKL_MULTIPLIERS = [1.0, 1.1, 1.4, 1.9, 2.3, 2.6, 3.8, 4.5, 5.5, 6.0, 10.0];
        const GERAKL_ICE_CHANCES = [0.15, 0.18, 0.18, 0.20, 0.30, 0.35, 0.45, 0.45, 0.45, 0.50, 0.53];

        const OLYMPUS_PROGRESS = [
            { required: 3, reward: 'star_3', label: '3 ÐºÐµÐ¹ÑÐ° Ð—Ð²ÐµÐ·Ð´Ð½Ñ‹Ð¹â­ï¸', type: 'case', caseType: 'star', count: 3 },
            { required: 7, reward: 'gold_1', label: '1 ÐºÐµÐ¹Ñ Ð—Ð¾Ð»Ð¾Ñ‚Ð¾Ð¹ðŸ‘‘', type: 'case', caseType: 'gold', count: 1 },
            { required: 15, reward: 'elite_1', label: '1 ÐºÐµÐ¹Ñ Ð­Ð»Ð¸Ñ‚Ð°ðŸŽ–ï¸', type: 'case', caseType: 'elite', count: 1 },
            { required: 20, reward: 'stars_150', label: '150â­ï¸', type: 'stars', value: 150 },
            { required: 25, reward: 'money_3', label: '3 ÐºÐµÐ¹ÑÐ° Ð”ÐµÐ½ÐµÐ¶Ð½Ñ‹Ð¹ðŸ’µ', type: 'case', caseType: 'money', count: 3 },
            { required: 30, reward: 'hades_gift', label: 'ÐŸÐ¾Ð´Ð°Ñ€Ð¾Ðº ÐÐ¸Ð´ðŸ”¥', type: 'item', item: { id: 'hades', name: 'ÐÐ¸Ð´ ðŸ”¥', emoji: 'ðŸ”¥', type: 'olympus_hades' } },
            { required: 50, reward: 'zeus_gift', label: 'ÐŸÐ¾Ð´Ð°Ñ€Ð¾Ðº Ð—ÐµÐ²Ñâš¡ï¸', type: 'item', item: { id: 'zeus', name: 'Ð—ÐµÐ²Ñ âš¡', emoji: 'âš¡', type: 'olympus_zeus' } },
            { required: 150, reward: 'mega', label: '25 Ð—Ð²ÐµÐ·Ð´Ð½Ñ‹Ñ… + 1000â­ï¸', type: 'mega' }
        ];

        const GEFEST_TRADES = [
            { id: 'gold_ball', emoji: 'âš½ï¸', name: 'Ð—Ð¾Ð»Ð¾Ñ‚Ð¾Ð¹ Ð¼ÑÑ‡', itemKey: 'gold_ball', reward: '1 ÐºÐµÐ¹Ñ Ð£Ð³Ð¾Ð»Ñ‘Ðº', rewardType: 'case', caseType: 'coal', count: 1 },
            { id: 'mikhaylov_ball', emoji: 'ðŸ', name: 'ÐœÑÑ‡ Ðœ. ÐœÐ¸Ñ…Ð°Ð¹Ð»Ð¾Ð²Ð°', itemKey: 'mikhaylov_ball', reward: '1 ÐºÐµÐ¹Ñ Ð—Ð²ÐµÐ·Ð´Ð½Ñ‹Ð¹â­ï¸', rewardType: 'case', caseType: 'star', count: 1 },
            { id: 'tyson_gloves', emoji: 'ðŸ¥Š', name: 'ÐŸÐµÑ€Ñ‡Ð°Ñ‚ÐºÐ¸ Ð¢Ð°Ð¹ÑÐ¾Ð½Ð°', itemKey: 'tyson_gloves', reward: '+1 ÑÐ»Ð¾Ñ‚ Ð¸Ð½Ð²ÐµÐ½Ñ‚Ð°Ñ€Ñ', rewardType: 'slot' },
            { id: 'steak', emoji: 'ðŸ¥©', name: 'Ð¡Ñ‚ÐµÐ¹Ðº', itemKey: 'steak', reward: '100â­ï¸', rewardType: 'stars', value: 100 },
            { id: 'simba', emoji: 'ðŸ¦', name: 'Ð¡Ð¸Ð¼Ð±Ð°', itemKey: 'simba', reward: '2 ÐºÐµÐ¹ÑÐ° Ð—Ð¾Ð»Ð¾Ñ‚Ð¾Ð¹ðŸ‘‘', rewardType: 'case', caseType: 'gold', count: 2 },
            { id: 'wolf_wallstreet', emoji: 'ðŸº', name: 'Ð’Ð¾Ð»Ðº Ñ Ð£Ð¾Ð»Ð»-ÑÑ‚Ñ€Ð¸Ñ‚', itemKey: 'wolf_wallstreet', reward: '2 ÐºÐµÐ¹ÑÐ° ÐšÐ¾Ð»Ð»ÐµÐºÑ†Ð¸Ð¾Ð½ÐµÑ€ðŸŽ©', rewardType: 'wolf_special' },
            { id: 'ice', emoji: 'ðŸ§Š', name: 'Ð›Ñ‘Ð´', itemKey: 'ice', reward: '25 Ð—Ð²ÐµÐ·Ð´Ð½Ñ‹Ñ… Ð¸Ð»Ð¸ 500â­ï¸', rewardType: 'ice_choice' },
            { id: 'diamond_pro', emoji: 'ðŸ’Ž', name: 'ÐÐ»Ð¼Ð°Ð· PRO', itemKey: 'diamond_pro', reward: '125â­ï¸', rewardType: 'stars', value: 125 },
            { id: 'material', emoji: 'ðŸ§±', name: 'ÐœÐ°Ñ‚ÐµÑ€Ð¸Ð°Ð»', itemKey: 'material', reward: '130â­ï¸', rewardType: 'stars', value: 130, highlight: true }
        ];

        const TON_RATES = [{ stars: 50, ton: 0.6 }, { stars: 250, ton: 3 }, { stars: 500, ton: 6 }, { stars: 1000, ton: 12 }];
        const STARS_PACKAGES = [{ stars: 50, price: 50 }, { stars: 100, price: 100 }, { stars: 250, price: 250 }, { stars: 500, price: 500 }, { stars: 1000, price: 1000 }];

        function App() {
            const [currentScreen, setCurrentScreen] = useState('cases');
            const [balance, setBalance] = useState(0);
            const [cases, setCases] = useState(INITIAL_CASES);
            const [inventory, setInventory] = useState([]);
            const [inventorySlots, setInventorySlots] = useState(5);
            const [tasks, setTasks] = useState({ subscribe: { completed: false }, deposit: { completed: false }, depositMajor: { completed: false }, deposit50: { completed: false }, cardboard7: { completed: false, count: 0 }, inviteThree: { completed: false, count: 0, required: 3, reward: 25 } });
            const [user, setUser] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const [dailyCaseTimeLeft, setDailyCaseTimeLeft] = useState('');
            const [selectedCase, setSelectedCase] = useState(null);
            const [isSpinning, setIsSpinning] = useState(false);
            const [spinResult, setSpinResult] = useState(null);
            const [rouletteOffset, setRouletteOffset] = useState(0);
            const [fakeItems, setFakeItems] = useState([]);
            const [rouletteKey, setRouletteKey] = useState(0);
            const rouletteContainerRef = useRef(null);
            const [showTopUp, setShowTopUp] = useState(false);
            const [promoCode, setPromoCode] = useState('');
            const [promoError, setPromoError] = useState('');
            const [promoSuccess, setPromoSuccess] = useState('');
            const [usedPromos, setUsedPromos] = useState([]);
            const [wonPromos, setWonPromos] = useState([]);
            const [showCollectibleModal, setShowCollectibleModal] = useState(false);
            const [selectedCollectible, setSelectedCollectible] = useState(null);
            const [showRandomCaseModal, setShowRandomCaseModal] = useState(false);
            const [randomCaseItem, setRandomCaseItem] = useState(null);
            const [showWithdrawModal, setShowWithdrawModal] = useState(false);
            const [showAdminLogin, setShowAdminLogin] = useState(false);
            const [adminLogin, setAdminLogin] = useState('');
            const [adminPassword, setAdminPassword] = useState('');
            const [isAdmin, setIsAdmin] = useState(false);
            const [adminScreen, setAdminScreen] = useState('stats');
            const [allUsers, setAllUsers] = useState([]);
            const [selectedUser, setSelectedUser] = useState(null);
            const [adminUserSearch, setAdminUserSearch] = useState('');
            const [adminAttempts, setAdminAttempts] = useState(0);
            const [onlineCount, setOnlineCount] = useState(Math.floor(Math.random() * 300) + 200);
            const [paymentStatus, setPaymentStatus] = useState('');
            const [totalDeposits, setTotalDeposits] = useState(0);
            const [freeEliteSpin, setFreeEliteSpin] = useState(0);
            const [currentGame, setCurrentGame] = useState(null);
            const [geraklGameActive, setGeraklGameActive] = useState(false);
            const [geraklBetAmount, setGeraklBetAmount] = useState(25);
            const [geraklBetInput, setGeraklBetInput] = useState(25);
            const [geraklRound, setGeraklRound] = useState(0);
            const [geraklMultiplier, setGeraklMultiplier] = useState(1.0);
            const [geraklCurrentWin, setGeraklCurrentWin] = useState(0);
            const [geraklTimer, setGeraklTimer] = useState(25);
            const [geraklResult, setGeraklResult] = useState(null);
            const [geraklBoxOpened, setGeraklBoxOpened] = useState(false);
            const [geraklBoxPrize, setGeraklBoxPrize] = useState(null);
            const [eventSubScreen, setEventSubScreen] = useState('main');
            const [olympusOpens, setOlympusOpens] = useState(0);
            const [olympusRewardsClaimed, setOlympusRewardsClaimed] = useState([]);
            const [olympusTopPlayers, setOlympusTopPlayers] = useState([]);
            const [olympusSpinning, setOlympusSpinning] = useState(false);
            const [olympusSpinResult, setOlympusSpinResult] = useState(null);
            const [olympusFakeItems, setOlympusFakeItems] = useState([]);
            const [olympusRouletteOffset, setOlympusRouletteOffset] = useState(0);
            const [olympusRouletteKey, setOlympusRouletteKey] = useState(0);
            const [olympusFreeCount, setOlympusFreeCount] = useState(2);
            const [showOlympusRewardModal, setShowOlympusRewardModal] = useState(false);
            const [olympusRewardModalData, setOlympusRewardModalData] = useState(null);
            const [gefestLastTrade, setGefestLastTrade] = useState(0);
            const [gefestTradeChoice, setGefestTradeChoice] = useState(null);
            const olympusRouletteRef = useRef(null);

            useEffect(() => {
                const initApp = async () => {
                    let userId = null;
                    let userData = { name: 'Ð“Ð¾ÑÑ‚ÑŒ', username: null, avatar: null };
                    if (TelegramWebApp) {
                        TelegramWebApp.ready();
                        TelegramWebApp.expand();
                        const tgUser = TelegramWebApp.initDataUnsafe?.user;
                        if (tgUser) {
                            userId = tgUser.id.toString();
                            userData = { name: tgUser.first_name + (tgUser.last_name ? ' ' + tgUser.last_name : ''), username: tgUser.username ? '@' + tgUser.username : null, avatar: tgUser.photo_url || null };
                        }
                    }
                    if (!userId) {
                        userId = localStorage.getItem('sbs_user_id') || ('guest_' + Date.now());
                        localStorage.setItem('sbs_user_id', userId);
                    } else {
                        localStorage.setItem('sbs_user_id', userId);
                    }
                    try {
                        const snap = await db.ref('users/' + userId).once('value');
                        const data = snap.val();
                        if (data) {
                            const storedCases = data.cases || {};
                            const newMergedCases = {};
                            for (const caseId in INITIAL_CASES) {
                                newMergedCases[caseId] = { ...INITIAL_CASES[caseId] };
                                if (storedCases[caseId]) {
                                    newMergedCases[caseId].freeCount = storedCases[caseId].freeCount || 0;
                                    if (storedCases[caseId].locked !== undefined) newMergedCases[caseId].locked = storedCases[caseId].locked;
                                    if (caseId === 'daily' && storedCases[caseId].lastOpened) newMergedCases[caseId].lastOpened = storedCases[caseId].lastOpened;
                                }
                            }
                            setUser({ id: userId, ...userData, ...data });
                            setBalance(data.balance || 0);
                            setCases(newMergedCases);
                            setInventory(data.inventory || []);
                            setTasks(data.tasks || tasks);
                            setInventorySlots(data.inventorySlots || 5);
                            setUsedPromos(data.usedPromos || []);
                            setWonPromos(data.wonPromos || []);
                            setTotalDeposits(data.totalDeposits || 0);
                            setFreeEliteSpin(data.freeEliteSpin || 0);
                            setOlympusOpens(data.olympusOpens || 0);
                            setOlympusRewardsClaimed(data.olympusRewardsClaimed || []);
                            setOlympusFreeCount(data.olympusFreeCount !== undefined ? data.olympusFreeCount : 2);
                            setGefestLastTrade(data.gefestLastTrade || 0);
                            await db.ref('users/' + userId).update({ name: userData.name, username: userData.username || '', avatar: userData.avatar || '', cases: newMergedCases });
                        } else {
                            const newCases = { ...INITIAL_CASES, daily: { ...INITIAL_CASES.daily, freeCount: 1, lastOpened: 0 }, diamond: { ...INITIAL_CASES.diamond, freeCount: 5 } };
                            const newUser = { balance: 0, cases: newCases, inventory: [], tasks: tasks, inventorySlots: 5, usedPromos: [], wonPromos: [], createdAt: Date.now(), lastActive: Date.now(), totalDeposits: 0, freeEliteSpin: 0, name: userData.name, username: userData.username || '', avatar: userData.avatar || '', olympusOpens: 0, olympusRewardsClaimed: [], olympusFreeCount: 2, gefestLastTrade: 0 };
                            setCases(newCases);
                            setUser({ id: userId, ...userData });
                            await db.ref('users/' + userId).set(newUser);
                        }
                    } catch (e) { console.error(e); }
                    setIsLoading(false);
                };
                initApp();
            }, []);

            useEffect(() => {
                if (!user?.id) return;
                const ref = db.ref('online/' + user.id);
                ref.set({ name: user.name, timestamp: Date.now() });
                ref.onDisconnect().remove();
                return () => ref.remove();
            }, [user?.id]);

            useEffect(() => {
                if (!user?.id || isLoading) return;
                const iv = setInterval(() => {
                    const dailyData = cases.daily;
                    db.ref('users/' + user.id).update({
                        balance, inventory, tasks, inventorySlots, usedPromos, wonPromos, lastActive: Date.now(), totalDeposits, freeEliteSpin,
                        olympusOpens, olympusRewardsClaimed, olympusFreeCount, gefestLastTrade,
                        'cases/daily/lastOpened': dailyData.lastOpened,
                        'cases/daily/freeCount': dailyData.freeCount
                    });
                }, 5000);
                return () => clearInterval(iv);
            }, [balance, cases, inventory, tasks, inventorySlots, usedPromos, wonPromos, user?.id, isLoading, totalDeposits, freeEliteSpin, olympusOpens, olympusRewardsClaimed, olympusFreeCount, gefestLastTrade]);

            useEffect(() => {
                if (isLoading || !cases.daily) return;
                const DAILY_COOLDOWN = 23 * 60 * 60 * 1000;
                const timer = setInterval(() => {
                    const lastOpened = cases.daily.lastOpened || 0;
                    const now = Date.now();
                    const timePassed = now - lastOpened;
                    if (timePassed >= DAILY_COOLDOWN) {
                        if (cases.daily.freeCount === 0) setCases(prev => ({ ...prev, daily: { ...prev.daily, freeCount: 1 } }));
                        setDailyCaseTimeLeft('Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾!');
                    } else {
                        const remaining = DAILY_COOLDOWN - timePassed;
                        const h = Math.floor(remaining / (1000*60*60));
                        const m = Math.floor((remaining % (1000*60*60)) / (1000*60));
                        const s = Math.floor((remaining % (1000*60)) / 1000);
                        setDailyCaseTimeLeft(`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`);
                    }
                }, 1000);
                return () => clearInterval(timer);
            }, [cases.daily, isLoading]);

            useEffect(() => {
                if (!geraklGameActive || geraklResult) return;
                const iv = setInterval(() => {
                    setGeraklTimer(prev => {
                        if (prev <= 1) { handleGeraklIce(); return 0; }
                        return prev - 1;
                    });
                }, 1000);
                return () => clearInterval(iv);
            }, [geraklGameActive, geraklResult]);

            const loadOlympusTop = async () => {
                try {
                    const snap = await db.ref('users').orderByChild('olympusOpens').limitToLast(5).once('value');
                    const players = [];
                    snap.forEach(child => {
                        const d = child.val();
                        if (d.olympusOpens > 0) {
                            players.push({ id: child.key, name: d.name || 'Ð˜Ð³Ñ€Ð¾Ðº', avatar: d.avatar || '', opens: d.olympusOpens || 0 });
                        }
                    });
                    players.sort((a, b) => b.opens - a.opens);
                    setOlympusTopPlayers(players.slice(0, 5));
                } catch (e) { console.error(e); }
            };

            const checkPromo = async () => {
                const code = promoCode.toUpperCase().trim();
                setPromoError(''); setPromoSuccess('');
                if (!code) return;
                if (usedPromos.includes(code)) { setPromoError('Ð£Ð¶Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½!'); return; }
                if (code === 'DELLKO') {
                    if (!wonPromos.includes('DELLKO')) { setPromoError('Ð¢Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ Ð²Ñ‹Ð¸Ð³Ñ€Ð°Ð»Ð¸ Ð² 13 ÐŸÐ¾Ð´Ð²Ð¸Ð³Ðµ Ð“ÐµÑ€Ð°ÐºÐ»Ð°!'); return; }
                    const nc = { ...cases, money: { ...cases.money, freeCount: (cases.money.freeCount || 0) + 3 } };
                    setCases(nc);
                    setPromoSuccess('+3 Ð´ÐµÐ½ÐµÐ¶Ð½Ñ‹Ñ… ÐºÐµÐ¹ÑÐ°!');
                    const np = [...usedPromos, code]; setUsedPromos(np); setPromoCode('');
                    await db.ref(`users/${user.id}/usedPromos`).set(np);
                } else if (code === 'DIAMOND') {
                    const nc = { ...cases, diamond: { ...cases.diamond, freeCount: (cases.diamond.freeCount || 0) + 2 } };
                    setCases(nc);
                    setPromoSuccess('+2 ÐºÐµÐ¹ÑÐ° ÐÐ»Ð¼Ð°Ð·!');
                    const np = [...usedPromos, code]; setUsedPromos(np); setPromoCode('');
                    await db.ref(`users/${user.id}/usedPromos`).set(np);
                } else if (code === 'OLIMP') {
                    const nb = balance + 130;
                    setBalance(nb);
                    setPromoSuccess('âœ… ÐÐ°Ñ‡Ð¸ÑÐ»ÐµÐ½Ð¾ 130â­ï¸!');
                    const np = [...usedPromos, code]; setUsedPromos(np); setPromoCode('');
                    await db.ref(`users/${user.id}`).update({ balance: nb, usedPromos: np });
                } else {
                    setPromoError('ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ð¿Ñ€Ð¾Ð¼Ð¾ÐºÐ¾Ð´');
                }
            };

            const buyStars = async (pkg) => {
                try {
                    const r = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/createInvoiceLink`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ title: `${pkg.stars} Ð·Ð²Ñ‘Ð·Ð´`, description: `ÐŸÐ¾ÐºÑƒÐ¿ÐºÐ° ${pkg.stars} Ð·Ð²Ñ‘Ð·Ð´`, payload: `stars_${user.id}_${pkg.stars}_${Date.now()}`, currency: 'XTR', prices: [{ label: `${pkg.stars} Ð·Ð²Ñ‘Ð·Ð´`, amount: pkg.price }] })
                    });
                    const data = await r.json();
                    if (data.ok && data.result) {
                        if (TelegramWebApp) {
                            TelegramWebApp.openInvoice(data.result, async (status) => {
                                if (status === 'paid') {
                                    const nb = balance + pkg.stars, nd = totalDeposits + pkg.stars;
                                    setBalance(nb); setTotalDeposits(nd);
                                    await db.ref(`users/${user.id}`).update({ balance: nb, totalDeposits: nd });
                                    checkDepositTasks(nd, pkg.stars);
                                    alert(`âœ… Ð—Ð°Ñ‡Ð¸ÑÐ»ÐµÐ½Ð¾ ${pkg.stars} Ð·Ð²Ñ‘Ð·Ð´!`);
                                }
                            });
                        } else { window.open(data.result, '_blank'); }
                    }
                } catch (e) { alert('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð»Ð°Ñ‚ÐµÐ¶Ð°.'); }
            };

            const topUpBalance = async (stars, ton) => {
                const memo = `SBS_${user.id}_${stars}_PAY_${Date.now()}`;
                window.open(`ton://transfer/${ADMIN_WALLET}?amount=${Math.round(ton*1e9)}&text=${encodeURIComponent(memo)}`, '_blank');
                setPaymentStatus(`ÐžÑ‚Ð¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ ${ton} TON Ñ ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸ÐµÐ¼: ${memo}`);
                setShowTopUp(false);
            };

            const checkDepositTasks = async (nd, singleAmount) => {
                let nt = { ...tasks };
                let nc = { ...cases };
                let nb = balance;
                let changed = false;
                if (!nt.deposit?.completed && nd >= 100) {
                    nt.deposit = { completed: true };
                    nc.gold = { ...nc.gold, freeCount: (nc.gold.freeCount || 0) + 1 };
                    changed = true;
                }
                if (!nt.depositMajor?.completed && nd >= 350) {
                    nt.depositMajor = { completed: true };
                    nc.collector = { ...nc.collector, locked: false, freeCount: (nc.collector.freeCount || 0) + 1 };
                    changed = true;
                }
                if (!nt.deposit50?.completed && singleAmount >= 50) {
                    nt.deposit50 = { completed: true };
                    nb += 50;
                    setBalance(nb);
                    changed = true;
                }
                if (changed) {
                    setTasks(nt); setCases(nc);
                    await db.ref(`users/${user.id}`).update({ tasks: nt, cases: nc, balance: nb });
                }
            };

            const completeTask = async (tid) => {
                if (tid === 'subscribe') {
                    window.open('https://t.me/stepbystepdelision', '_blank');
                    setTimeout(async () => {
                        if (!tasks.subscribe?.completed) {
                            const nt = { ...tasks, subscribe: { completed: true } };
                            const nc = { ...cases, elite: { ...cases.elite, freeCount: (cases.elite.freeCount || 0) + 1 } };
                            setTasks(nt); setCases(nc);
                            await db.ref(`users/${user.id}`).update({ tasks: nt, cases: nc });
                            alert('ðŸŽ‰ ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½ 1 ÐºÐµÐ¹Ñ Â«Ð­Ð»Ð¸Ñ‚Ð°Â»!');
                        }
                    }, 2000);
                } else if (tid === 'inviteThree') {
                    window.open('https://t.me/share/url?url=' + encodeURIComponent(`https://t.me/stepbystep_game_bot?start=${user.id}`), '_blank');
                } else if (tid === 'deposit' || tid === 'depositMajor' || tid === 'deposit50') {
                    setShowTopUp(true);
                }
            };

            const handleTitleClick = () => {
                const newCount = adminAttempts + 1;
                setAdminAttempts(newCount);
                if (newCount >= 12) { setShowAdminLogin(true); setAdminAttempts(0); }
            };

            const checkAdminLogin = () => {
                if (adminLogin === '*^BAGUETTE_642819_6281' && adminPassword === '3628874910ZTWMI') {
                    setIsAdmin(true); setShowAdminLogin(false);
                    db.ref('users').once('value').then(snap => {
                        const u = []; snap.forEach(c => u.push({ id: c.key, ...c.val() })); setAllUsers(u);
                    });
                } else { alert('ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ð»Ð¾Ð³Ð¸Ð½ Ð¸Ð»Ð¸ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ!'); }
            };

            const adminGiveReward = async (uid, r) => {
                const snap = await db.ref('users/' + uid).once('value');
                const ud = snap.val() || {};
                if (r.type === 'stars') {
                    const nb = (ud.balance || 0) + r.amount;
                    await db.ref('users/' + uid + '/balance').set(nb);
                    if (uid === user.id) setBalance(nb);
                } else if (r.type === 'case') {
                    const cur = ud.cases?.[r.caseType]?.freeCount || 0;
                    await db.ref(`users/${uid}/cases/${r.caseType}/freeCount`).set(cur + r.count);
                    if (uid === user.id) setCases(p => ({ ...p, [r.caseType]: { ...p[r.caseType], freeCount: cur + r.count } }));
                } else if (r.type === 'unlock_collector') {
                    await db.ref(`users/${uid}/cases/collector/locked`).set(false);
                    if (uid === user.id) setCases(p => ({ ...p, collector: { ...p.collector, locked: false } }));
                } else if (r.type === 'reset_daily') {
                    await db.ref(`users/${uid}/cases/daily`).update({ freeCount: 1, lastOpened: 0 });
                    if (uid === user.id) setCases(p => ({ ...p, daily: { ...p.daily, freeCount: 1, lastOpened: 0 } }));
                } else if (r.type === 'item' && r.item) {
                    const currentInventory = ud.inventory || [];
                    const newItem = { ...r.item, uniqueId: Date.now(), collected: Date.now() };
                    const newInventory = [...currentInventory, newItem];
                    await db.ref(`users/${uid}/inventory`).set(newInventory);
                    if (uid === user.id) setInventory(newInventory);
                }
                alert('ÐÐ°Ð³Ñ€Ð°Ð´Ð° Ð²Ñ‹Ð´Ð°Ð½Ð°!');
            };

            const getCasePrice = (ct) => {
                const c = cases[ct];
                if (!c) return 0;
                if (c.id === 'daily' && c.freeCount > 0) return 0;
                if (c.freeCount > 0) return 0;
                if (c.discountPrice && c.discountPrice !== c.price) return c.discountPrice;
                return c.price;
            };

            const handleSelectCase = (caseData) => {
                setSpinResult(null); setFakeItems([]); setSelectedCase(caseData);
            };

            const openCase = async (caseType) => {
                const cData = cases[caseType];
                if (cData.id === 'daily' && cData.freeCount === 0) { alert('Ð•Ð¶ÐµÐ´Ð½ÐµÐ²Ð½Ñ‹Ð¹ ÐºÐµÐ¹Ñ Ð½Ðµ Ð³Ð¾Ñ‚Ð¾Ð²!'); return; }
                const price = getCasePrice(caseType);
                const isFree = cData.freeCount > 0;
                if (!isFree && balance < price) { alert('ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð·Ð²ÐµÐ·Ð´!'); return; }
                let nb = balance;
                if (cData.id === 'daily' && isFree) {
                    const now = Date.now();
                    setCases(p => ({ ...p, daily: { ...p.daily, freeCount: 0, lastOpened: now } }));
                    await db.ref(`users/${user.id}/cases/daily`).update({ freeCount: 0, lastOpened: now });
                } else if (isFree) {
                    const nf = cData.freeCount - 1;
                    setCases(p => ({ ...p, [caseType]: { ...p[caseType], freeCount: nf } }));
                    await db.ref(`users/${user.id}/cases/${caseType}/freeCount`).set(nf);
                } else {
                    nb -= price; setBalance(nb);
                    await db.ref(`users/${user.id}/balance`).set(nb);
                }
                if (caseType === 'cardboard') {
                    const newCount = (tasks.cardboard7?.count || 0) + 1;
                    let nt = { ...tasks, cardboard7: { ...tasks.cardboard7, count: newCount } };
                    if (newCount >= 7 && !tasks.cardboard7?.completed) {
                        nt.cardboard7 = { completed: true, count: newCount };
                        const nc2 = { ...cases, diamond: { ...cases.diamond, freeCount: (cases.diamond.freeCount || 0) + 1 } };
                        setCases(nc2);
                        await db.ref(`users/${user.id}/cases/diamond/freeCount`).set((cases.diamond.freeCount || 0) + 1);
                    }
                    setTasks(nt);
                    await db.ref(`users/${user.id}/tasks`).set(nt);
                }
                setIsSpinning(false); setSpinResult(null); setFakeItems([]); setRouletteOffset(0); setRouletteKey(k => k + 1);
                const items = CASE_REWARDS[caseType];
                let won = items[0], r = Math.random() * 100, cum = 0;
                for (let i of items) { cum += i.realChance; if (r <= cum) { won = i; break; } }
                const tape = [];
                for (let i = 0; i < 80; i++) tape.push(i === 70 ? won : items[Math.floor(Math.random() * items.length)]);
                setIsSpinning(true);
                setTimeout(() => {
                    setFakeItems(tape);
                    setTimeout(() => {
                        const cw = rouletteContainerRef.current ? rouletteContainerRef.current.offsetWidth : window.innerWidth;
                        setRouletteOffset(-(70 * 122 + 55 - cw / 2));
                    }, 50);
                }, 50);
                setTimeout(async () => {
                    setSpinResult(won); setIsSpinning(false);
                    if (won.type === 'stars') {
                        const fb = nb + won.value; setBalance(fb);
                        await db.ref(`users/${user.id}/balance`).set(fb);
                    } else {
                        await addToInventory(won);
                    }
                }, 6600);
            };

            const openOlympusCase = async () => {
                const isFree = olympusFreeCount > 0;
                const price = 77;
                if (!isFree && balance < price) { alert('ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð·Ð²ÐµÐ·Ð´!'); return; }
                let nb = balance;
                if (isFree) {
                    const nf = olympusFreeCount - 1;
                    setOlympusFreeCount(nf);
                    await db.ref(`users/${user.id}/olympusFreeCount`).set(nf);
                } else {
                    nb -= price; setBalance(nb);
                    await db.ref(`users/${user.id}/balance`).set(nb);
                }
                const newOpens = olympusOpens + 1;
                setOlympusOpens(newOpens);
                await db.ref(`users/${user.id}/olympusOpens`).set(newOpens);

                setOlympusSpinning(false); setOlympusSpinResult(null); setOlympusFakeItems([]); setOlympusRouletteOffset(0); setOlympusRouletteKey(k => k + 1);
                const items = CASE_REWARDS.olympus;
                let won = items[0], r = Math.random() * 100, cum = 0;
                for (let i of items) { cum += i.realChance; if (r <= cum) { won = i; break; } }
                const tape = [];
                for (let i = 0; i < 80; i++) tape.push(i === 70 ? won : items[Math.floor(Math.random() * items.length)]);
                setOlympusSpinning(true);
                setTimeout(() => {
                    setOlympusFakeItems(tape);
                    setTimeout(() => {
                        const cw = olympusRouletteRef.current ? olympusRouletteRef.current.offsetWidth : window.innerWidth;
                        setOlympusRouletteOffset(-(70 * 122 + 55 - cw / 2));
                    }, 50);
                }, 50);
                setTimeout(async () => {
                    setOlympusSpinResult(won); setOlympusSpinning(false);
                    checkOlympusProgress(newOpens, nb);
                }, 6600);
            };

            const handleOlympusReward = async (won) => {
                let nb = balance;
                if (won.type === 'olympus_item') {
                    await addToInventory(won);
                } else if (won.type === 'olympus_hermes') {
                    setInventorySlots(s => s + 1);
                    await db.ref(`users/${user.id}/inventorySlots`).set(inventorySlots + 1);
                    alert('ðŸ“ˆ +1 ÑÐ»Ð¾Ñ‚ Ð¸Ð½Ð²ÐµÐ½Ñ‚Ð°Ñ€Ñ!');
                } else if (won.type === 'olympus_dionysus') {
                    nb += 80; setBalance(nb);
                    await db.ref(`users/${user.id}/balance`).set(nb);
                    alert('ðŸ· +80â­ï¸!');
                } else if (won.type === 'olympus_apollo') {
                    const nc = { ...cases, star: { ...cases.star, freeCount: (cases.star.freeCount || 0) + 5 } };
                    setCases(nc);
                    await db.ref(`users/${user.id}/cases/star/freeCount`).set((cases.star.freeCount || 0) + 5);
                    alert('â˜€ï¸ +5 ÐºÐµÐ¹ÑÐ¾Ð² Ð—Ð²ÐµÐ·Ð´Ð½Ñ‹Ð¹!');
                } else if (won.type === 'olympus_poseidon') {
                    setOlympusRewardModalData({ type: 'poseidon' });
                    setShowOlympusRewardModal(true);
                    return;
                } else if (won.type === 'olympus_hades') {
                    setOlympusRewardModalData({ type: 'hades' });
                    setShowOlympusRewardModal(true);
                    return;
                } else if (won.type === 'olympus_zeus') {
                    setOlympusRewardModalData({ type: 'zeus' });
                    setShowOlympusRewardModal(true);
                    return;
                }
                setOlympusSpinResult(null);
            };

            const handlePoseidonChoice = async (choice) => {
                if (choice === 'stars') {
                    const nb = balance + 200; setBalance(nb);
                    await db.ref(`users/${user.id}/balance`).set(nb);
                    alert('ðŸ”± +200â­ï¸!');
                } else {
                    const nc = { ...cases, platinum: { ...cases.platinum, freeCount: (cases.platinum.freeCount || 0) + 5 } };
                    setCases(nc);
                    await db.ref(`users/${user.id}/cases/platinum/freeCount`).set((cases.platinum.freeCount || 0) + 5);
                    alert('ðŸ”± +5 ÐºÐµÐ¹ÑÐ¾Ð² ÐŸÐ»Ð°Ñ‚Ð¸Ð½Ð°!');
                }
                setShowOlympusRewardModal(false); setOlympusSpinResult(null);
            };

            const handleHadesChoice = async (choice) => {
                if (choice === 'stars') {
                    const nb = balance + 250; setBalance(nb);
                    await db.ref(`users/${user.id}/balance`).set(nb);
                    alert('ðŸ”¥ +250â­ï¸!');
                } else {
                    const nc = { ...cases, collector: { ...cases.collector, locked: false, freeCount: (cases.collector.freeCount || 0) + 1 } };
                    setCases(nc);
                    await db.ref(`users/${user.id}/cases`).set(nc);
                    alert('ðŸ”¥ ÐšÐ¾Ð»Ð»ÐµÐºÑ†Ð¸Ð¾Ð½ÐµÑ€ Ñ€Ð°Ð·Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½!');
                }
                setShowOlympusRewardModal(false); setOlympusSpinResult(null);
            };

            const handleZeusChoice = async (choice) => {
                if (choice === 'wake') {
                    const nc = { ...cases, collector: { ...cases.collector, locked: false, freeCount: (cases.collector.freeCount || 0) + 2 } };
                    setCases(nc);
                    await db.ref(`users/${user.id}/cases`).set(nc);
                    alert('âš¡ Ð—ÐµÐ²Ñ Ð¿Ñ€Ð¾ÑÐ½ÑƒÐ»ÑÑ! +2 ÐºÐµÐ¹ÑÐ° ÐšÐ¾Ð»Ð»ÐµÐºÑ†Ð¸Ð¾Ð½ÐµÑ€!');
                } else {
                    await addToInventory({ id: 'zeus', name: 'Ð—ÐµÐ²Ñ âš¡', emoji: 'âš¡', type: 'olympus_zeus_kept' });
                    alert('âš¡ Ð—ÐµÐ²Ñ ÑÐ¾Ñ…Ñ€Ð°Ð½Ñ‘Ð½ Ð² Ð¸Ð½Ð²ÐµÐ½Ñ‚Ð°Ñ€Ðµ!');
                }
                setShowOlympusRewardModal(false); setOlympusSpinResult(null);
            };

            const checkOlympusProgress = async (opens, currentBalance) => {
                let nb = currentBalance;
                let nc = { ...cases };
                let claimed = [...olympusRewardsClaimed];
                let changed = false;
                for (const step of OLYMPUS_PROGRESS) {
                    if (opens >= step.required && !claimed.includes(step.reward)) {
                        claimed.push(step.reward);
                        changed = true;
                        if (step.type === 'case') {
                            nc[step.caseType] = { ...nc[step.caseType], freeCount: (nc[step.caseType].freeCount || 0) + step.count };
                        } else if (step.type === 'stars') {
                            nb += step.value;
                        } else if (step.type === 'item') {
                            await addToInventory(step.item);
                        } else if (step.type === 'mega') {
                            nc.star = { ...nc.star, freeCount: (nc.star.freeCount || 0) + 25 };
                            nb += 1000;
                        }
                    }
                }
                if (changed) {
                    setBalance(nb); setCases(nc); setOlympusRewardsClaimed(claimed);
                    await db.ref(`users/${user.id}`).update({ balance: nb, cases: nc, olympusRewardsClaimed: claimed });
                }
            };

            const addToInventory = async (item) => {
                if (inventory.length >= inventorySlots) { alert('Ð˜Ð½Ð²ÐµÐ½Ñ‚Ð°Ñ€ÑŒ Ð¿Ð¾Ð»Ð¾Ð½!'); return; }
                const ni = [...inventory, { ...item, uniqueId: Date.now(), collected: Date.now() }];
                setInventory(ni);
                await db.ref(`users/${user.id}/inventory`).set(ni);
            };

            const sellItem = async (item) => {
                if (item.type === 'random_case_box') { setRandomCaseItem(item); setShowRandomCaseModal(true); return; }
                if (item.type === 'collectible') { setSelectedCollectible(item); setShowCollectibleModal(true); return; }
                if (item.type === 'olympus_item') {
                    if (confirm(`ÐŸÑ€Ð¾Ð´Ð°Ñ‚ÑŒ ${item.name} Ð·Ð° ${item.sellPrice}â­ï¸?`)) {
                        const nb = balance + item.sellPrice;
                        const ni = inventory.filter(i => i.uniqueId !== item.uniqueId);
                        setBalance(nb); setInventory(ni);
                        await db.ref(`users/${user.id}`).update({ balance: nb, inventory: ni });
                    }
                    return;
                }
                if (item.type === 'olympus_hermes' || item.type === 'olympus_dionysus' || item.type === 'olympus_apollo' || item.type === 'olympus_poseidon' || item.type === 'olympus_hades' || item.type === 'olympus_zeus' || item.type === 'olympus_zeus_kept') {
                    setSelectedCollectible(item); setShowCollectibleModal(true); return;
                }
                if (item.sellPrice && confirm(`ÐŸÑ€Ð¾Ð´Ð°Ñ‚ÑŒ ${item.name} Ð·Ð° ${item.sellPrice}â­ï¸?`)) {
                    const nb = balance + item.sellPrice;
                    const ni = inventory.filter(i => i.uniqueId !== item.uniqueId);
                    setBalance(nb); setInventory(ni);
                    await db.ref(`users/${user.id}`).update({ balance: nb, inventory: ni });
                }
            };

            const exchangeRandomCaseBox = async () => {
                const keys = ['cardboard', 'coal', 'platinum', 'diamond', 'money', 'gold', 'elite', 'collector'];
                const rKey = keys[Math.floor(Math.random() * keys.length)];
                const ni = inventory.filter(i => i.uniqueId !== randomCaseItem.uniqueId);
                const nc = { ...cases, [rKey]: { ...cases[rKey], freeCount: (cases[rKey].freeCount || 0) + 1 } };
                if (rKey === 'collector') nc.collector.locked = false;
                setInventory(ni); setCases(nc);
                await db.ref(`users/${user.id}`).update({ inventory: ni, cases: nc });
                setShowRandomCaseModal(false); setRandomCaseItem(null);
                alert(`Ð’Ñ‹Ð¿Ð°Ð» ÐºÐµÐ¹Ñ: ${cases[rKey].name}!`);
            };

            const unlockSlot = async () => {
                if (balance < 50) return;
                const nb = balance - 50;
                setBalance(nb); setInventorySlots(s => s + 1);
                await db.ref(`users/${user.id}`).update({ balance: nb, inventorySlots: inventorySlots + 1 });
            };

            const doGefestTrade = async (trade) => {
                const now = Date.now();
                if (now - gefestLastTrade < 180000) {
                    const remaining = Math.ceil((180000 - (now - gefestLastTrade)) / 1000);
                    alert(`ÐŸÐ¾Ð´Ð¾Ð¶Ð´Ð¸Ñ‚Ðµ ${remaining} ÑÐµÐº. Ð´Ð¾ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÐµÐ³Ð¾ Ð¾Ð±Ð¼ÐµÐ½Ð°!`);
                    return;
                }
                const itemIndex = inventory.findIndex(i => (i.id === trade.itemKey || i.key === trade.itemKey));
                if (itemIndex === -1) { alert('ÐŸÑ€ÐµÐ´Ð¼ÐµÑ‚ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð² Ð¸Ð½Ð²ÐµÐ½Ñ‚Ð°Ñ€Ðµ!'); return; }
                if (trade.rewardType === 'ice_choice') {
                    setGefestTradeChoice(trade);
                    return;
                }
                const ni = [...inventory]; ni.splice(itemIndex, 1); setInventory(ni);
                setGefestLastTrade(now);
                let nb = balance;
                let nc = { ...cases };
                if (trade.rewardType === 'stars') {
                    nb += trade.value; setBalance(nb);
                } else if (trade.rewardType === 'case') {
                    nc[trade.caseType] = { ...nc[trade.caseType], freeCount: (nc[trade.caseType].freeCount || 0) + trade.count };
                    setCases(nc);
                } else if (trade.rewardType === 'slot') {
                    setInventorySlots(s => s + 1);
                    await db.ref(`users/${user.id}/inventorySlots`).set(inventorySlots + 1);
                } else if (trade.rewardType === 'wolf_special') {
                    nc.collector = { ...nc.collector, locked: false, freeCount: (nc.collector.freeCount || 0) + 2 };
                    setCases(nc);
                }
                await db.ref(`users/${user.id}`).update({ balance: nb, inventory: ni, cases: nc, gefestLastTrade: now });
                alert('ÐžÐ±Ð¼ÐµÐ½ ÑÐ¾Ð²ÐµÑ€ÑˆÑ‘Ð½!');
            };

            const doIceChoice = async (choice) => {
                const trade = gefestTradeChoice;
                const itemIndex = inventory.findIndex(i => (i.id === trade.itemKey || i.key === trade.itemKey));
                if (itemIndex === -1) { alert('ÐŸÑ€ÐµÐ´Ð¼ÐµÑ‚ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½!'); return; }
                const ni = [...inventory]; ni.splice(itemIndex, 1); setInventory(ni);
                const now = Date.now(); setGefestLastTrade(now);
                let nb = balance; let nc = { ...cases };
                if (choice === 'stars') {
                    nb += 500; setBalance(nb);
                } else {
                    nc.star = { ...nc.star, freeCount: (nc.star.freeCount || 0) + 25 };
                    setCases(nc);
                }
                await db.ref(`users/${user.id}`).update({ balance: nb, inventory: ni, cases: nc, gefestLastTrade: now });
                setGefestTradeChoice(null);
                alert('ÐžÐ±Ð¼ÐµÐ½ ÑÐ¾Ð²ÐµÑ€ÑˆÑ‘Ð½!');
            };

            const startGeraklGame = async () => {
                if (balance < geraklBetInput || geraklBetInput < 25) { alert('ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð·Ð²ÐµÐ·Ð´ Ð¸Ð»Ð¸ ÑÑ‚Ð°Ð²ÐºÐ° Ð¼ÐµÐ½ÑŒÑˆÐµ 25!'); return; }
                const nb = balance - geraklBetInput;
                setBalance(nb);
                await db.ref(`users/${user.id}/balance`).set(nb);
                setGeraklBetAmount(geraklBetInput); setGeraklRound(0); setGeraklMultiplier(1.0);
                setGeraklCurrentWin(geraklBetInput); setGeraklTimer(25); setGeraklGameActive(true);
                setGeraklResult(null); setGeraklBoxOpened(false); setGeraklBoxPrize(null);
            };

            const handleGeraklFlame = async () => {
                if (geraklRound >= 10) { handleGeraklCashout(); return; }
                if (Math.random() < GERAKL_ICE_CHANCES[geraklRound]) { handleGeraklIce(); }
                else {
                    const nextRound = geraklRound + 1;
                    setGeraklRound(nextRound);
                    setGeraklMultiplier(GERAKL_MULTIPLIERS[nextRound]);
                    setGeraklCurrentWin(Math.floor(geraklBetAmount * GERAKL_MULTIPLIERS[nextRound]));
                    setGeraklTimer(25);
                }
            };

            const handleGeraklCashout = async () => {
                const nb = balance + geraklCurrentWin;
                setBalance(nb);
                await db.ref(`users/${user.id}/balance`).set(nb);
                setGeraklResult({ type: 'cashout', round: geraklRound, win: geraklCurrentWin, profit: geraklCurrentWin - geraklBetAmount });
                setGeraklGameActive(false);
                if (geraklRound >= 10) {
                    let cum2 = 0, r2 = Math.random() * 100, prize = GERAKL_10_REWARDS[0];
                    for (const p of GERAKL_10_REWARDS) { cum2 += p.chance; if (r2 <= cum2) { prize = p; break; } }
                    setGeraklBoxPrize(prize);
                    if (prize.type === 'stars') { const nb2 = nb + prize.value; setBalance(nb2); await db.ref(`users/${user.id}/balance`).set(nb2); }
                    else if (prize.type === 'promo') { const np = [...wonPromos, prize.code]; setWonPromos(np); await db.ref(`users/${user.id}/wonPromos`).set(np); }
                    else { await addToInventory(prize); }
                }
            };

            const handleGeraklIce = () => { setGeraklResult({ type: 'ice', round: geraklRound }); setGeraklGameActive(false); };
            const exitGeraklGame = () => { setGeraklGameActive(false); setGeraklResult(null); setGeraklBoxOpened(false); setGeraklBoxPrize(null); setCurrentGame(null); };

            if (isLoading) return <div className="min-h-screen flex items-center justify-center"><div className="text-2xl animate-pulse">â³ Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ°...</div></div>;

            if (currentGame?.type === 'gerakl') {
                return (
                    <div className="min-h-screen bg-gradient-to-b from-red-900 via-orange-900 to-red-800 pb-4" style={{ backgroundImage: "url('gerakl.jpg')", backgroundSize: 'cover', backgroundPosition: 'center', backgroundBlendMode: 'overlay' }}>
                        <div className="max-w-lg mx-auto p-3">
                            <div className="flex justify-between items-center mb-3">
                                <h1 className="text-xl font-bold">ðŸª¬ 13 ÐŸÐ¾Ð´Ð²Ð¸Ð³ Ð“ÐµÑ€Ð°ÐºÐ»Ð° ðŸŒŠ</h1>
                                <button onClick={exitGeraklGame} className="bg-red-600/40 hover:bg-red-600 border border-red-500/50 px-3 py-1.5 rounded-xl font-bold text-sm">âœ• Ð’Ñ‹Ð¹Ñ‚Ð¸</button>
                            </div>
                            {geraklResult ? (
                                <div className="glass rounded-xl p-4 mb-3 text-center border border-yellow-500/30">
                                    {geraklResult.type === 'ice' ? (
                                        <div><div className="text-5xl mb-2">ðŸ§Š</div><div className="font-bold text-red-400 text-xl mb-2">Ð›ÐÐ”!</div><div className="text-gray-300 text-sm mb-1">ÐŸÑ€Ð¾Ð´ÐµÑ€Ð¶Ð°Ð»Ð¸ÑÑŒ: {geraklResult.round} Ñ€Ð°ÑƒÐ½Ð´Ð¾Ð²</div><div className="text-gray-400 text-sm mb-3">Ð¡Ñ‚Ð°Ð²ÐºÐ°: {geraklBetAmount}â­ï¸ | Ð’Ñ‹Ð¸Ð³Ñ€Ñ‹Ñˆ: 0â­ï¸</div><button onClick={exitGeraklGame} className="w-full bg-gray-600 py-2.5 rounded-xl font-bold text-sm mobile-btn">Ð’Ñ‹Ð¹Ñ‚Ð¸</button></div>
                                    ) : (
                                        <div><div className="text-5xl mb-2">ðŸŽ‰</div><div className="font-bold text-green-400 text-xl mb-2">Ð’Ñ‹ Ð·Ð°Ð±Ñ€Ð°Ð»Ð¸ Ð²Ñ‹Ð¸Ð³Ñ€Ñ‹Ñˆ!</div><div className="text-yellow-400 font-bold text-lg mb-1">Ð’Ñ‹Ð¸Ð³Ñ€Ñ‹Ñˆ: {geraklResult.win}â­ï¸</div><div className="text-green-400 text-sm mb-3">ÐŸÑ€Ð¸Ð±Ñ‹Ð»ÑŒ: +{geraklResult.profit}â­ï¸</div>
                                            {geraklBoxPrize && !geraklBoxOpened && <div className="text-7xl mb-3 cursor-pointer hover:scale-110 transition active:scale-95" onClick={() => setGeraklBoxOpened(true)}>ðŸ“¦</div>}
                                            {geraklBoxPrize && geraklBoxOpened && <div className="bg-gray-800/60 rounded-xl p-3 mb-3"><p className="text-3xl">{geraklBoxPrize.emoji}</p><p className="text-white font-bold mt-1">{geraklBoxPrize.name}</p></div>}
                                            <button onClick={exitGeraklGame} className="w-full bg-green-600 py-2.5 rounded-xl font-bold text-sm mobile-btn">Ð’Ñ‹Ð¹Ñ‚Ð¸</button>
                                        </div>
                                    )}
                                </div>
                            ) : geraklGameActive ? (
                                <div className="glass rounded-xl p-4 mb-3 text-center border border-yellow-500/30">
                                    <div className="text-5xl font-bold text-yellow-400 mb-2">{geraklTimer}</div>
                                    <div className="grid grid-cols-2 gap-4 mb-4">
                                        <div className="bg-gray-800/60 rounded-lg p-3"><div className="text-gray-400 text-xs mb-1">Ð’Ñ‹Ð¸Ð³Ñ€Ñ‹Ñˆ</div><div className="text-2xl font-bold text-yellow-400">{geraklCurrentWin}â­ï¸</div></div>
                                        <div className="bg-gray-800/60 rounded-lg p-3"><div className="text-gray-400 text-xs mb-1">ÐœÐ½Ð¾Ð¶Ð¸Ñ‚ÐµÐ»ÑŒ</div><div className="text-2xl font-bold text-orange-400">{geraklMultiplier}x</div></div>
                                    </div>
                                    <div className="flex gap-2 mb-4">
                                        <button onClick={handleGeraklFlame} className="flex-1 bg-gradient-to-r from-red-600 to-orange-600 py-3 rounded-xl font-bold text-sm mobile-btn">ðŸ”¥ ÐŸÐ»Ð°Ð¼Ñ</button>
                                        <button onClick={handleGeraklCashout} className="flex-1 bg-gradient-to-r from-cyan-600 to-blue-600 py-3 rounded-xl font-bold text-sm mobile-btn">ðŸ§Š Ð—Ð°Ð±Ñ€Ð°Ñ‚ÑŒ</button>
                                    </div>
                                    <div className="flex justify-center flex-wrap">{[...Array(10)].map((_, i) => <div key={i} className={`round-box ${i < geraklRound ? 'completed' : i === geraklRound ? 'current' : ''}`}>{i + 1}</div>)}</div>
                                </div>
                            ) : (
                                <div className="glass rounded-xl p-4 text-center border border-yellow-500/30">
                                    <div className="text-3xl mb-2 animate-bounce">ðŸª¬</div>
                                    <div className="font-bold text-yellow-300 text-lg mb-3">Ð¡Ð¾Ð²ÐµÑ€ÑˆÐ¸ 13 Ð¿Ð¾Ð´Ð²Ð¸Ð³!</div>
                                    <div className="flex gap-2 mb-3">
                                        <input type="number" min="25" value={geraklBetInput} onChange={e => setGeraklBetInput(Math.max(25, Number(e.target.value)))} className="flex-1 bg-gray-800 border border-yellow-600 rounded-lg p-2.5 text-center text-lg text-white" />
                                        <button onClick={() => setGeraklBetInput(p => p + 25)} className="bg-yellow-700 px-3 rounded-lg font-bold text-sm">+25</button>
                                        <button onClick={() => setGeraklBetInput(p => p + 100)} className="bg-yellow-700 px-3 rounded-lg font-bold text-sm">+100</button>
                                    </div>
                                    <button onClick={startGeraklGame} disabled={balance < geraklBetInput} className="w-full bg-gradient-to-r from-yellow-600 to-orange-600 py-2.5 rounded-xl font-bold disabled:opacity-50 text-sm mobile-btn">ÐÐ°Ñ‡Ð°Ñ‚ÑŒ ({geraklBetInput}â­ï¸)</button>
                                    <p className="text-xs text-gray-500 mt-1">Ð‘Ð°Ð»Ð°Ð½Ñ: {balance.toFixed(0)}â­ï¸</p>
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            if (isAdmin) {
                const filteredUsers = allUsers.filter(u => !adminUserSearch || (u.name && u.name.toLowerCase().includes(adminUserSearch.toLowerCase())) || (u.id && u.id.includes(adminUserSearch)));
                return (
                    <div className="min-h-screen bg-gray-900 p-4">
                        <div className="max-w-lg mx-auto">
                            <div className="flex justify-between items-center mb-4">
                                <h1 className="text-xl font-bold">ðŸ” ÐÐ´Ð¼Ð¸Ð½</h1>
                                <button onClick={() => setIsAdmin(false)} className="text-gray-400">Ð’Ñ‹Ð¹Ñ‚Ð¸</button>
                            </div>
                            <div className="flex gap-2 mb-4 overflow-x-auto">
                                {['stats', 'users', 'rewards', 'settings'].map(tab => <button key={tab} onClick={() => setAdminScreen(tab)} className={`px-3 py-2 rounded-lg text-sm ${adminScreen === tab ? 'bg-indigo-600' : 'bg-gray-700'}`}>{tab === 'stats' ? 'ðŸ“Š' : tab === 'users' ? 'ðŸ‘¥' : tab === 'rewards' ? 'ðŸŽ€' : 'âš™ï¸'} {tab}</button>)}
                            </div>
                            <div className="glass rounded-xl p-4">
                                {adminScreen === 'stats' && (
                                    <div className="grid grid-cols-2 gap-3">
                                        <div className="bg-gray-800 p-3 rounded-lg"><div className="text-gray-400 text-xs">Ð˜Ð³Ñ€Ð¾ÐºÐ¾Ð²</div><div className="text-2xl font-bold">{allUsers.length}</div></div>
                                        <div className="bg-gray-800 p-3 rounded-lg"><div className="text-gray-400 text-xs">ÐžÐ±Ñ‰Ð¸Ð¹ Ð±Ð°Ð»Ð°Ð½Ñ</div><div className="text-xl font-bold">{allUsers.reduce((s, u) => s + (u.balance || 0), 0).toFixed(0)}â­ï¸</div></div>
                                    </div>
                                )}
                                {adminScreen === 'users' && !selectedUser && (
                                    <div>
                                        <input type="text" placeholder="ðŸ” ÐŸÐ¾Ð¸ÑÐº..." value={adminUserSearch} onChange={e => setAdminUserSearch(e.target.value)} className="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-sm mb-3" />
                                        <div className="space-y-2 max-h-80 overflow-y-auto">
                                            {filteredUsers.map(u => <div key={u.id} onClick={() => setSelectedUser(u)} className="bg-gray-800 p-3 rounded-lg cursor-pointer hover:bg-gray-700 flex justify-between"><div><div className="font-bold text-sm">{u.name}</div><div className="text-xs text-gray-400">{u.id.slice(0, 12)}</div></div><div className="text-yellow-400 text-sm">{(u.balance || 0).toFixed(0)}â­ï¸</div></div>)}
                                        </div>
                                    </div>
                                )}
                                {adminScreen === 'users' && selectedUser && (
                                    <div>
                                        <h3 className="font-bold mb-3">ðŸ‘¤ {selectedUser.name}</h3>
                                        <div className="grid grid-cols-3 gap-2 mb-3">
                                            <button onClick={() => adminGiveReward(selectedUser.id, { type: 'stars', amount: 100 })} className="bg-green-600 p-2 rounded text-xs">+100â­ï¸</button>
                                            <button onClick={() => adminGiveReward(selectedUser.id, { type: 'stars', amount: 500 })} className="bg-green-600 p-2 rounded text-xs">+500â­ï¸</button>
                                            <button onClick={() => adminGiveReward(selectedUser.id, { type: 'stars', amount: 1000 })} className="bg-green-600 p-2 rounded text-xs">+1000â­ï¸</button>
                                            <button onClick={() => adminGiveReward(selectedUser.id, { type: 'case', caseType: 'diamond', count: 5 })} className="bg-blue-600 p-2 rounded text-xs">+5ðŸ’Ž</button>
                                            <button onClick={() => adminGiveReward(selectedUser.id, { type: 'case', caseType: 'elite', count: 2 })} className="bg-red-600 p-2 rounded text-xs">+2ðŸŽ–</button>
                                            <button onClick={() => adminGiveReward(selectedUser.id, { type: 'unlock_collector' })} className="bg-pink-600 p-2 rounded text-xs">ðŸ”“ÐšÐ¾Ð»Ð»ÐµÐºÑ†.</button>
                                            <button onClick={() => adminGiveReward(selectedUser.id, { type: 'reset_daily' })} className="bg-cyan-600 p-2 rounded text-xs">ðŸ—“ï¸Ð¡Ð±Ñ€Ð¾Ñ</button>
                                            <button onClick={() => adminGiveReward(selectedUser.id, { type: 'item', item: { id: 'random_case_box', name: 'Ð¡Ð»ÑƒÑ‡Ð°Ð¹Ð½Ñ‹Ð¹ ÐºÐµÐ¹Ñ', emoji: 'ðŸ“¦', type: 'random_case_box' } })} className="bg-amber-600 p-2 rounded text-xs">ðŸ“¦Ð¯Ñ‰Ð¸Ðº</button>
                                        </div>
                                        <button onClick={() => setSelectedUser(null)} className="w-full bg-gray-600 p-2 rounded text-sm">â† ÐÐ°Ð·Ð°Ð´</button>
                                    </div>
                                )}
                                {adminScreen === 'rewards' && (
                                    <div className="grid grid-cols-2 gap-2">
                                        <button onClick={() => adminGiveReward(user.id, { type: 'stars', amount: 10000 })} className="bg-indigo-600 p-3 rounded text-sm">+10000â­ï¸</button>
                                        <button onClick={() => adminGiveReward(user.id, { type: 'case', caseType: 'diamond', count: 10 })} className="bg-blue-600 p-3 rounded text-sm">+10ðŸ’Ž</button>
                                        <button onClick={() => adminGiveReward(user.id, { type: 'unlock_collector' })} className="bg-pink-600 p-3 rounded text-sm">ðŸ”“ÐšÐ¾Ð»Ð»ÐµÐºÑ†.</button>
                                        <button onClick={() => adminGiveReward(user.id, { type: 'reset_daily' })} className="bg-cyan-600 p-3 rounded text-sm">ðŸ—“ï¸Ð¡Ð±Ñ€Ð¾Ñ</button>
                                    </div>
                                )}
                                {adminScreen === 'settings' && (
                                    <button onClick={async () => { if (confirm('Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð’Ð¡Ð• Ð´Ð°Ð½Ð½Ñ‹Ðµ?')) { await db.ref('users/' + user.id).remove(); localStorage.removeItem('sbs_user_id'); window.location.reload(); } }} className="bg-red-600 px-4 py-2 rounded-lg text-sm">ðŸ—‘ Ð¡Ð±Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ Ð°ÐºÐºÐ°ÑƒÐ½Ñ‚</button>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            const renderEventMain = () => (
                <div className="min-h-[70vh] rounded-xl p-4 relative" style={{ backgroundImage: "url('event.jpg')", backgroundSize: 'cover', backgroundPosition: 'center' }}>
                    <div className="absolute inset-0 bg-black/50 rounded-xl"></div>
                    <div className="relative z-10">
                        <h2 className="text-3xl font-bold text-center olympus-font neon-text mb-6" style={{ color: '#fbbf24' }}>âš¡ ÐžÐ›Ð˜ÐœÐŸ âš¡</h2>
                        <div className="flex flex-col gap-4 max-w-xs mx-auto">
                            <button onClick={() => { loadOlympusTop(); setEventSubScreen('heroes'); }} className="w-full py-4 rounded-xl font-bold text-lg olympus-font mobile-btn" style={{ background: 'linear-gradient(135deg, rgba(251,191,36,0.4), rgba(245,158,11,0.3))', border: '2px solid #fbbf24', textShadow: '0 0 10px #fbbf24' }}>ðŸ† Ð“ÐµÑ€Ð¾Ð¸ ÐžÐ»Ð¸Ð¼Ð¿Ð°</button>
                            <button onClick={() => setEventSubScreen('treasure')} className="w-full py-4 rounded-xl font-bold text-lg olympus-font mobile-btn" style={{ background: 'linear-gradient(135deg, rgba(139,92,246,0.4), rgba(109,40,217,0.3))', border: '2px solid #a78bfa', textShadow: '0 0 10px #a78bfa' }}>âš¡ Ð¡Ð¾ÐºÑ€Ð¾Ð²Ð¸Ñ‰Ðµ ÐžÐ»Ð¸Ð¼Ð¿Ð°</button>
                            <button onClick={() => setEventSubScreen('gefest')} className="w-full py-4 rounded-xl font-bold text-lg olympus-font mobile-btn" style={{ background: 'linear-gradient(135deg, rgba(239,68,68,0.4), rgba(185,28,28,0.3))', border: '2px solid #f87171', textShadow: '0 0 10px #f87171' }}>ðŸµï¸ Ð›Ð°Ð²ÐºÐ° Ð“ÐµÑ„ÐµÑÑ‚Ð°</button>
                        </div>
                    </div>
                </div>
            );

            const renderTreasure = () => (
                <div className="rounded-xl p-3 relative" style={{ backgroundImage: "url('case.jpg')", backgroundSize: 'cover', backgroundPosition: 'center', minHeight: '80vh' }}>
                    <div className="absolute inset-0 bg-black/60 rounded-xl"></div>
                    <div className="relative z-10">
                        <button onClick={() => { setEventSubScreen('main'); setOlympusSpinResult(null); setOlympusFakeItems([]); }} className="mb-3 bg-gray-700/80 px-3 py-1.5 rounded-lg text-sm font-bold">â† ÐÐ°Ð·Ð°Ð´</button>
                        <h2 className="text-2xl font-bold text-center olympus-font neon-text mb-4" style={{ color: '#fbbf24' }}>âš¡ Ð¡Ð¾ÐºÑ€Ð¾Ð²Ð¸Ñ‰Ðµ ÐžÐ»Ð¸Ð¼Ð¿Ð° âš¡</h2>

                        <div ref={olympusRouletteRef} className="roulette-container mb-4">
                            <div className="roulette-pointer" />
                            <div key={olympusRouletteKey} className="roulette-inner" style={{ transform: `translateX(${olympusRouletteOffset}px)` }}>
                                {olympusFakeItems.length > 0 ? olympusFakeItems.map((item, i) => (
                                    <div key={i} className="roulette-item"><div className="emoji">{item.emoji}</div><div className="name">{item.name}</div></div>
                                )) : [...Array(80)].map((_, i) => <div key={i} className="roulette-item"><div className="emoji">â“</div></div>)}
                            </div>
                        </div>

                        {olympusSpinResult ? (
                            <div className="text-center mb-4">
                                <p className="text-xl font-bold mb-2 olympus-font">ðŸŽ‰ {olympusSpinResult.name}!</p>
                                <div className="flex gap-2">
                                    <button onClick={() => { handleOlympusReward(olympusSpinResult); if (!['olympus_poseidon', 'olympus_hades', 'olympus_zeus'].includes(olympusSpinResult.type)) setOlympusSpinResult(null); }} className="flex-1 bg-green-600 py-3 rounded-xl font-bold text-sm mobile-btn">Ð—Ð°Ð±Ñ€Ð°Ñ‚ÑŒ</button>
                                    <button onClick={() => { handleOlympusReward(olympusSpinResult); if (!['olympus_poseidon', 'olympus_hades', 'olympus_zeus'].includes(olympusSpinResult.type)) { setOlympusSpinResult(null); openOlympusCase(); } }} className="flex-1 bg-indigo-600 py-3 rounded-xl font-bold text-sm mobile-btn">Ð•Ñ‰Ñ‘ Ñ€Ð°Ð·</button>
                                </div>
                            </div>
                        ) : (
                            <button onClick={openOlympusCase} disabled={olympusSpinning} className="w-full bg-gradient-to-r from-yellow-500 to-amber-600 py-4 rounded-xl font-bold text-lg disabled:opacity-50 olympus-font mobile-btn mb-4">
                                {olympusSpinning ? 'ðŸŒ€ ÐšÑ€ÑƒÑ‚Ð¸Ð¼...' : (olympusFreeCount > 0 ? `ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð‘Ð•Ð¡ÐŸÐ›ÐÐ¢ÐÐž (${olympusFreeCount})` : 'ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð·Ð° 77â­ï¸')}
                            </button>
                        )}

                        <div className="glass rounded-xl p-3 mb-4">
                            <h3 className="font-bold text-center text-sm olympus-font mb-2" style={{ color: '#fbbf24', textShadow: '0 0 8px #fbbf24' }}>ÐÐ°Ð³Ñ€Ð°Ð´Ñ‹ ÐºÐµÐ¹ÑÐ°</h3>
                            <div className="space-y-1">
                                {CASE_REWARDS.olympus.map((r, i) => (
                                    <div key={i} className="flex justify-between py-1 border-b border-white/10 last:border-0 text-xs">
                                        <span>{r.emoji} {r.name}</span>
                                        <span className="text-yellow-400 font-bold">{r.displayChance}</span>
                                    </div>
                                ))}
                            </div>
                        </div>

                        <div className="glass rounded-xl p-3">
                            <h3 className="font-bold text-center text-sm olympus-font mb-3" style={{ color: '#fbbf24', textShadow: '0 0 8px #fbbf24' }}>ðŸ“Š ÐŸÑ€Ð¾Ð³Ñ€ÐµÑÑ ({olympusOpens} Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ð¸Ð¹)</h3>
                            <div className="space-y-2">
                                {OLYMPUS_PROGRESS.map((step, i) => {
                                    const done = olympusRewardsClaimed.includes(step.reward);
                                    const progress = Math.min(100, (olympusOpens / step.required) * 100);
                                    return (
                                        <div key={i} className={`progress-step rounded-lg p-2.5 border ${done ? 'done border-green-500' : 'border-white/20'}`} style={!done ? { background: 'rgba(0,0,0,0.4)' } : {}}>
                                            <div className="flex justify-between items-center mb-1">
                                                <span className="text-xs font-bold">{step.label}</span>
                                                <span className="text-xs">{done ? 'âœ…' : `${olympusOpens}/${step.required}`}</span>
                                            </div>
                                            {!done && <div className="w-full bg-gray-700 rounded-full h-1.5"><div className="bg-yellow-400 h-1.5 rounded-full transition-all" style={{ width: progress + '%' }}></div></div>}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                </div>
            );

            const renderHeroes = () => (
                <div className="rounded-xl p-4 relative" style={{ backgroundImage: "url('hero.jpg')", backgroundSize: 'cover', backgroundPosition: 'center', minHeight: '60vh' }}>
                    <div className="absolute inset-0 bg-black/70 rounded-xl"></div>
                    <div className="relative z-10">
                        <button onClick={() => setEventSubScreen('main')} className="mb-3 bg-gray-700/80 px-3 py-1.5 rounded-lg text-sm font-bold">â† ÐÐ°Ð·Ð°Ð´</button>
                        <h2 className="text-2xl font-bold text-center olympus-font neon-text mb-4" style={{ color: '#fbbf24' }}>ðŸ† Ð“ÐµÑ€Ð¾Ð¸ ÐžÐ»Ð¸Ð¼Ð¿Ð° ðŸ†</h2>
                        <div className="space-y-3">
                            {olympusTopPlayers.length === 0 && <p className="text-center text-gray-400">ÐŸÐ¾ÐºÐ° Ð½ÐµÑ‚ Ð¸Ð³Ñ€Ð¾ÐºÐ¾Ð²</p>}
                            {olympusTopPlayers.map((p, i) => {
                                const medals = ['ðŸ¥‡', 'ðŸ¥ˆ', 'ðŸ¥‰'];
                                return (
                                    <div key={p.id} className="glass rounded-xl p-3 flex items-center gap-3" style={i < 3 ? { border: '1px solid #fbbf24', boxShadow: '0 0 10px rgba(251,191,36,0.3)' } : {}}>
                                        <span className="text-2xl">{medals[i] || `#${i + 1}`}</span>
                                        <div className="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-400 to-purple-500 flex items-center justify-center text-lg overflow-hidden flex-shrink-0">
                                            {p.avatar ? <img src={p.avatar} alt="" className="w-full h-full object-cover" /> : p.name?.charAt(0)?.toUpperCase()}
                                        </div>
                                        <div className="flex-1 min-w-0">
                                            <div className="font-bold text-sm truncate">{p.name}</div>
                                        </div>
                                        <div className="text-yellow-400 font-bold text-sm whitespace-nowrap">{p.opens} ðŸŽ</div>
                                    </div>
                                );
                            })}
                        </div>
                        <p className="text-center text-xs text-yellow-300 mt-4 olympus-font" style={{ textShadow: '0 0 5px #fbbf24' }}>Ð¢Ð¾Ð¿ 3 Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð½Ð°Ð³Ñ€Ð°Ð´Ñ‹ Ð² ÐºÐ¾Ð½Ñ†Ðµ Ð¸Ð²ÐµÐ½Ñ‚Ð°!</p>
                    </div>
                </div>
            );

            const renderGefest = () => (
                <div className="rounded-xl p-3 relative" style={{ backgroundImage: "url('gefest.jpg')", backgroundSize: 'cover', backgroundPosition: 'center', minHeight: '70vh' }}>
                    <div className="absolute inset-0 bg-black/70 rounded-xl"></div>
                    <div className="relative z-10">
                        <button onClick={() => setEventSubScreen('main')} className="mb-3 bg-gray-700/80 px-3 py-1.5 rounded-lg text-sm font-bold">â† ÐÐ°Ð·Ð°Ð´</button>
                        <h2 className="text-2xl font-bold text-center olympus-font mb-2" style={{ color: '#fbbf24', textShadow: '0 0 15px #fbbf24, 0 0 30px #f59e0b' }}>ðŸµï¸ Ð›Ð°Ð²ÐºÐ° Ð“ÐµÑ„ÐµÑÑ‚Ð° ðŸµï¸</h2>
                        <p className="text-center text-sm mb-4 olympus-font" style={{ color: '#e2e8f0', textShadow: '0 0 10px rgba(255,255,255,0.5)' }}>ÐžÐ±Ð¼ÐµÐ½ÑÐ¹ ÑÐ²Ð¾Ð¸ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ñ‹ Ð½Ð° Ñ‡Ñ‚Ð¾-Ð½Ð¸Ð±ÑƒÐ´ÑŒ Ñ†ÐµÐ½Ð½Ð¾ÐµðŸ’Ž</p>
                        <div className="space-y-2">
                            {GEFEST_TRADES.map(trade => {
                                const hasItem = inventory.some(i => i.id === trade.itemKey || i.key === trade.itemKey);
                                return (
                                    <div key={trade.id} className="glass rounded-xl p-3 flex items-center gap-3" style={trade.highlight ? { border: '2px solid #ef4444', boxShadow: '0 0 15px rgba(239,68,68,0.4)' } : {}}>
                                        <span className="text-3xl">{trade.emoji}</span>
                                        <div className="flex-1 min-w-0">
                                            <div className="font-bold text-sm" style={{ textShadow: '0 0 5px rgba(255,255,255,0.3)' }}>{trade.name}</div>
                                            <div className="text-xs text-yellow-300 font-bold" style={{ textShadow: '0 0 5px #fbbf24' }}>â†’ {trade.reward}</div>
                                            {trade.highlight && <span className="text-xs text-red-400 font-bold animate-pulse" style={{ textShadow: '0 0 10px #ef4444' }}>ðŸ”¥ Ð’Ð«Ð“ÐžÐ”ÐÐž!</span>}
                                        </div>
                                        <button onClick={() => doGefestTrade(trade)} disabled={!hasItem} className={`px-3 py-2 rounded-lg text-xs font-bold ${hasItem ? 'bg-yellow-600 hover:bg-yellow-500' : 'bg-gray-600 opacity-50'}`}>{hasItem ? 'ÐžÐ±Ð¼ÐµÐ½ÑÑ‚ÑŒ' : 'ÐÐµÑ‚'}</button>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen pb-24">
                    <header className="p-3 flex justify-between items-center glass sticky top-0 z-50">
                        <h1 onClick={handleTitleClick} className="text-lg font-bold cursor-pointer select-none hover:text-cyan-300 transition">Step By Step Game</h1>
                        <button onClick={() => setShowTopUp(true)} className="bg-gradient-to-r from-yellow-400 to-orange-500 px-3 py-2 rounded-full font-bold text-gray-900 shadow-lg text-sm">{balance.toFixed(2)} â­ï¸</button>
                    </header>

                    {paymentStatus && <div className="mx-3 mt-2 p-2 rounded-lg text-center text-xs bg-blue-500/20 border border-blue-500">{paymentStatus}</div>}

                    {showOlympusRewardModal && olympusRewardModalData && (
                        <div className="fixed inset-0 bg-black/90 z-[60] flex items-center justify-center p-4">
                            <div className="glass rounded-2xl p-5 max-w-sm w-full text-center">
                                {olympusRewardModalData.type === 'poseidon' && (
                                    <div>
                                        <div className="text-6xl mb-3">ðŸ”±</div>
                                        <h3 className="text-xl font-bold mb-3 olympus-font" style={{ color: '#fbbf24' }}>ÐŸÐ¾ÑÐµÐ¹Ð´Ð¾Ð½!</h3>
                                        <p className="text-sm text-gray-300 mb-4">Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð½Ð°Ð³Ñ€Ð°Ð´Ñƒ:</p>
                                        <div className="space-y-2">
                                            <button onClick={() => handlePoseidonChoice('stars')} className="w-full bg-yellow-600 py-3 rounded-xl font-bold text-sm mobile-btn">200â­ï¸</button>
                                            <button onClick={() => handlePoseidonChoice('cases')} className="w-full bg-purple-600 py-3 rounded-xl font-bold text-sm mobile-btn">5 ÐºÐµÐ¹ÑÐ¾Ð² ÐŸÐ»Ð°Ñ‚Ð¸Ð½Ð°ðŸ’Ž</button>
                                        </div>
                                    </div>
                                )}
                                {olympusRewardModalData.type === 'hades' && (
                                    <div>
                                        <div className="text-6xl mb-3">ðŸ”¥</div>
                                        <h3 className="text-xl font-bold mb-3 olympus-font" style={{ color: '#fbbf24' }}>ÐÐ¸Ð´!</h3>
                                        <p className="text-sm text-gray-300 mb-4">Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð½Ð°Ð³Ñ€Ð°Ð´Ñƒ:</p>
                                        <div className="space-y-2">
                                            <button onClick={() => handleHadesChoice('stars')} className="w-full bg-yellow-600 py-3 rounded-xl font-bold text-sm mobile-btn">250â­ï¸</button>
                                            <button onClick={() => handleHadesChoice('collector')} className="w-full bg-pink-600 py-3 rounded-xl font-bold text-sm mobile-btn">Ð Ð°Ð·Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²ÐºÐ° ÐšÐ¾Ð»Ð»ÐµÐºÑ†Ð¸Ð¾Ð½ÐµÑ€Ð°ðŸŽ©</button>
                                        </div>
                                    </div>
                                )}
                                {olympusRewardModalData.type === 'zeus' && (
                                    <div>
                                        <div className="text-6xl mb-3">âš¡</div>
                                        <h3 className="text-xl font-bold mb-3 olympus-font" style={{ color: '#fbbf24' }}>Ð—ÐµÐ²Ñ!</h3>
                                        <p className="text-sm text-gray-300 mb-4">Ð Ð°Ð·Ð±ÑƒÐ´Ð¸Ñ‚Ðµ Ð—ÐµÐ²ÑÐ°âš¡ ÑÐµÐ¹Ñ‡Ð°Ñ Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚Ðµ 2 ÐšÐµÐ¹ÑÐ° Â«ÐšÐ¾Ð»Ð»ÐµÐºÑ†Ð¸Ð¾Ð½ÐµÑ€Â» (+Ñ€Ð°Ð·Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²ÐºÐ°) Ð¸Ð»Ð¸ Ð¾ÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ ÐµÐ³Ð¾ Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚Ðµ Ð½Ð°Ð³Ñ€Ð°Ð´Ñƒ Ð»ÑƒÑ‡ÑˆÐµ Ð¿Ð¾Ð·Ð¶Ðµ!</p>
                                        <div className="space-y-2">
                                            <button onClick={() => handleZeusChoice('wake')} className="w-full bg-yellow-600 py-3 rounded-xl font-bold text-sm mobile-btn">âš¡ Ð Ð°Ð·Ð±ÑƒÐ´Ð¸Ñ‚ÑŒ</button>
                                            <button onClick={() => handleZeusChoice('keep')} className="w-full bg-gray-600 py-3 rounded-xl font-bold text-sm mobile-btn">ðŸ’¤ ÐžÑÑ‚Ð°Ð²Ð¸Ñ‚ÑŒ</button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {gefestTradeChoice && (
                        <div className="fixed inset-0 bg-black/90 z-[60] flex items-center justify-center p-4">
                            <div className="glass rounded-2xl p-5 max-w-sm w-full text-center">
                                <div className="text-6xl mb-3">ðŸ§Š</div>
                                <h3 className="text-xl font-bold mb-3">Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð½Ð°Ð³Ñ€Ð°Ð´Ñƒ</h3>
                                <div className="space-y-2">
                                    <button onClick={() => doIceChoice('cases')} className="w-full bg-blue-600 py-3 rounded-xl font-bold text-sm mobile-btn">25 ÐºÐµÐ¹ÑÐ¾Ð² Ð—Ð²ÐµÐ·Ð´Ð½Ñ‹Ð¹â­ï¸</button>
                                    <button onClick={() => doIceChoice('stars')} className="w-full bg-yellow-600 py-3 rounded-xl font-bold text-sm mobile-btn">500â­ï¸</button>
                                    <button onClick={() => setGefestTradeChoice(null)} className="w-full bg-gray-600 py-2 rounded-xl text-sm">ÐžÑ‚Ð¼ÐµÐ½Ð°</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showRandomCaseModal && (
                        <div className="fixed inset-0 bg-black/90 z-[60] flex items-center justify-center p-4">
                            <div className="glass rounded-2xl p-5 max-w-sm w-full text-center">
                                <div className="text-6xl mb-3 animate-bounce">ðŸ“¦</div>
                                <h3 className="text-xl font-bold mb-3">Ð¡Ð»ÑƒÑ‡Ð°Ð¹Ð½Ñ‹Ð¹ ÐšÐµÐ¹Ñ</h3>
                                <button onClick={exchangeRandomCaseBox} className="w-full bg-green-600 py-3 rounded-xl font-bold mb-2 mobile-btn">ÐžÐ±Ð¼ÐµÐ½ÑÑ‚ÑŒ</button>
                                <button onClick={() => setShowRandomCaseModal(false)} className="w-full bg-gray-600 py-2 rounded-xl text-sm">ÐžÑ‚Ð¼ÐµÐ½Ð°</button>
                            </div>
                        </div>
                    )}

                    {showCollectibleModal && (
                        <div className="fixed inset-0 bg-black/90 z-[60] flex items-center justify-center p-4">
                            <div className="glass rounded-2xl p-5 max-w-sm w-full text-center">
                                <div className="text-6xl mb-3">{selectedCollectible?.emoji}</div>
                                <h3 className="text-xl font-bold mb-3">ÐšÐ¾Ð»Ð»ÐµÐºÑ†Ð¸Ð¾Ð½Ð½Ñ‹Ð¹ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚!</h3>
                                <p className="mb-4 text-sm">ÐžÐ±Ñ€Ð°Ñ‚Ð¸Ñ‚ÐµÑÑŒ Ðº <a href="https://t.me/stepbystepdelision" target="_blank" className="text-blue-400 underline">Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ð¸</a></p>
                                <button onClick={() => setShowCollectibleModal(false)} className="w-full bg-indigo-600 py-3 rounded-xl font-bold mobile-btn">ÐŸÐ¾Ð½ÑÑ‚Ð½Ð¾</button>
                            </div>
                        </div>
                    )}

                    {showAdminLogin && (
                        <div className="fixed inset-0 bg-black/90 z-[60] flex items-center justify-center p-4">
                            <div className="glass rounded-2xl p-5 max-w-sm w-full">
                                <h2 className="text-xl font-bold text-center mb-4">ðŸ” ÐÐ´Ð¼Ð¸Ð½-Ð¿Ð°Ð½ÐµÐ»ÑŒ</h2>
                                <input type="text" placeholder="Ð›Ð¾Ð³Ð¸Ð½" value={adminLogin} onChange={e => setAdminLogin(e.target.value)} className="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-3 mb-3 text-center text-sm" />
                                <input type="password" placeholder="ÐŸÐ°Ñ€Ð¾Ð»ÑŒ" value={adminPassword} onChange={e => setAdminPassword(e.target.value)} className="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-3 mb-4 text-center text-sm" />
                                <button onClick={checkAdminLogin} className="w-full bg-indigo-600 py-3 rounded-xl font-bold mb-2 mobile-btn">Ð’Ð¾Ð¹Ñ‚Ð¸</button>
                                <button onClick={() => setShowAdminLogin(false)} className="w-full bg-gray-700 py-2 rounded-xl text-sm">ÐžÑ‚Ð¼ÐµÐ½Ð°</button>
                            </div>
                        </div>
                    )}

                    {showWithdrawModal && (
                        <div className="fixed inset-0 bg-black/90 z-[60] flex items-center justify-center p-4">
                            <div className="glass rounded-2xl p-5 max-w-sm w-full text-center">
                                <h2 className="text-xl font-bold mb-4">ðŸ“Š Ð’Ñ‹Ð²Ð¾Ð´ Ð¿Ñ€Ð¸Ð·Ð¾Ð²</h2>
                                {tasks.depositMajor?.completed
                                    ? <p className="text-sm mb-4">ÐžÐ±Ñ€Ð°Ñ‚Ð¸Ñ‚ÐµÑÑŒ Ðº Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ð¸ Ð´Ð»Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð° Ð¿Ñ€Ð¸Ð·Ð¾Ð²!</p>
                                    : <p className="text-sm mb-4 text-red-400">Ð§Ñ‚Ð¾Ð±Ñ‹ Ð²Ñ‹Ð²ÐµÑÑ‚Ð¸ NFT Ð¿Ñ€Ð¸Ð·Ñ‹, Ð·Ð²ÐµÐ·Ð´Ñ‹ Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ Ð·Ð°Ð´Ð°Ð½Ð¸Ðµ Â«ÐŸÐ¾Ð¿Ð¾Ð»Ð½Ð¸ Ð½Ð° 350â­ï¸Â»</p>
                                }
                                <button onClick={() => setShowWithdrawModal(false)} className="w-full bg-gray-600 py-2 rounded-xl text-sm">Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ</button>
                            </div>
                        </div>
                    )}

                    <main className="p-3 max-w-md mx-auto">
                        {currentScreen === 'cases' && (
                            <div>
                                <h2 className="text-2xl font-bold mb-4 text-center">ðŸŽ° ÐšÐµÐ¹ÑÑ‹</h2>
                                {Object.values(cases).filter(c => c.freeCount > 0 && c.id !== 'daily').map(c => (
                                    <div key={c.id + '_free'} className="bg-green-500/20 border border-green-500 rounded-lg p-2 mb-2 text-center text-sm animate-pulse">ðŸŽ Ð‘ÐµÑÐ¿Ð»Ð°Ñ‚Ð½Ñ‹Ñ… ÐºÐµÐ¹ÑÐ¾Ð² {c.name}: {c.freeCount}</div>
                                ))}

                                <div className="mb-5">
                                    <h3 className="text-lg font-bold text-center mb-3 text-purple-300 special-header">ðŸ”® ÐžÑÐ¾Ð±Ñ‹Ðµ ðŸ”®</h3>
                                    <div className="grid grid-cols-2 gap-3">
                                        {Object.values(cases).filter(c => c.type === 'special').map(c => {
                                            const isDaily = c.id === 'daily';
                                            const isDailyWait = isDaily && c.freeCount === 0;
                                            if (c.id === 'collector' && c.locked) {
                                                return (
                                                    <div key={c.id} className="rounded-xl p-3 relative case-collector opacity-80 overflow-hidden">
                                                        <div className="absolute inset-0 bg-black/50 z-20 flex items-center justify-center"><span className="text-4xl">ðŸ”’</span></div>
                                                        <div className="w-14 h-14 mx-auto rounded-lg bg-white/20 flex items-center justify-center text-2xl mb-2">{c.emoji}</div>
                                                        <h3 className="font-bold text-center text-sm">{c.name}</h3>
                                                        <p className="text-center text-xs opacity-75 mb-2">{c.price}â­ï¸</p>
                                                        <button disabled className="w-full py-2 rounded-lg font-bold text-xs bg-gray-800/80 cursor-not-allowed mobile-btn">ÐÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾</button>
                                                    </div>
                                                );
                                            }
                                            return (
                                                <div key={c.id} className={`glass rounded-xl p-3 relative overflow-hidden hover:scale-105 transition ${c.id === 'collector' ? 'case-collector' : ''}`}>
                                                    <div className={`w-14 h-14 mx-auto rounded-lg ${c.id === 'collector' ? 'bg-white/20' : `bg-gradient-to-br ${c.color}`} flex items-center justify-center text-2xl mb-2`}>{c.emoji}</div>
                                                    <h3 className="font-bold text-center text-sm">{c.name}</h3>
                                                    <p className="text-center text-xs opacity-75 mb-2">
                                                        {isDaily ? (c.freeCount > 0 ? <span className="text-green-400 font-bold">Ð‘ÐµÑÐ¿Ð»Ð°Ñ‚Ð½Ð¾!</span> : <span className="daily-timer">{dailyCaseTimeLeft}</span>) : (c.price > 0 ? c.price + 'â­ï¸' : '')}
                                                    </p>
                                                    <button onClick={() => handleSelectCase(c)} disabled={c.locked} className="w-full py-2 rounded-lg font-bold text-xs bg-gradient-to-r from-indigo-500 to-purple-500 transition mobile-btn">
                                                        {c.locked ? 'ðŸ”’' : (isDailyWait ? 'ðŸ‘ Ð¡Ð¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ' : 'ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ')}
                                                    </button>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>

                                <div className="mb-5">
                                    <h3 className="text-lg font-bold text-center mb-3 text-yellow-300 ordinary-header">ðŸŽ ÐžÐ±Ñ‹Ñ‡Ð½Ñ‹Ðµ ðŸŽ</h3>
                                    <div className="grid grid-cols-2 gap-3">
                                        {Object.values(cases).filter(c => !c.type && !c.locked).map(c => (
                                            <div key={c.id} className={`glass rounded-xl p-3 relative overflow-hidden hover:scale-105 transition ${c.id === 'cardboard' ? 'case-cardboard' : ''}`}>
                                                {c.isNew && <span className="absolute -top-1 -right-1 bg-red-500 text-xs px-1.5 py-0.5 rounded-full animate-pulse">New!</span>}
                                                <div className={`w-14 h-14 mx-auto rounded-lg ${c.id === 'cardboard' ? 'bg-white/20' : `bg-gradient-to-br ${c.color}`} flex items-center justify-center text-2xl mb-2`}>{c.emoji}</div>
                                                <h3 className="font-bold text-center text-sm">{c.name}</h3>
                                                <p className="text-center text-xs opacity-75 mb-2">
                                                    {c.freeCount > 0 ? <span className="text-green-400 font-bold">Ð‘ÐµÑÐ¿Ð»Ð°Ñ‚Ð½Ð¾!</span> :
                                                        (c.discountPrice && c.discountPrice !== c.price ? <span><span className="line-through">{c.price}â­ï¸</span> {c.discountPrice}â­ï¸</span> : c.price + 'â­ï¸')}
                                                </p>
                                                <button onClick={() => handleSelectCase(c)} className="w-full py-2 rounded-lg font-bold text-xs bg-gradient-to-r from-indigo-500 to-purple-500 transition mobile-btn">ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ</button>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                {Object.values(cases).filter(c => c.locked && !c.type).length > 0 && (
                                    <div className="grid grid-cols-2 gap-3">
                                        {Object.values(cases).filter(c => c.locked && !c.type).map(c => (
                                            <div key={c.id} className="glass rounded-xl p-3 relative opacity-50">
                                                <div className="absolute inset-0 bg-black/70 rounded-xl flex items-center justify-center"><span className="text-2xl">ðŸ”’</span></div>
                                                <div className={`w-14 h-14 mx-auto rounded-lg bg-gradient-to-br ${c.color} flex items-center justify-center text-2xl mb-2`}>{c.emoji}</div>
                                                <h3 className="font-bold text-center text-sm">{c.name}</h3>
                                                <p className="text-center text-xs mb-2">{c.price}â­ï¸</p>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}

                        {currentScreen === 'games' && (
                            <div>
                                <h2 className="text-2xl font-bold mb-4 text-center">ðŸŽ® Ð˜Ð³Ñ€Ñ‹</h2>
                                <div className="glass rounded-xl p-4 border border-yellow-500/30 mb-3" style={{ backgroundImage: "url('gerakl.jpg')", backgroundSize: 'cover', backgroundPosition: 'center', backgroundBlendMode: 'overlay' }}>
                                    <h3 className="text-xl font-bold mb-1 text-center text-yellow-300">ðŸª¬ 13 ÐŸÐ¾Ð´Ð²Ð¸Ð³ Ð“ÐµÑ€Ð°ÐºÐ»Ð° ðŸŒŠ</h3>
                                    <p className="text-yellow-400 text-center text-xs mb-3">ÐŸÑ€Ð¾Ð¹Ð´Ð¸ 10 Ñ€Ð°ÑƒÐ½Ð´Ð¾Ð² Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸ ÑÑƒÐ½Ð´ÑƒÐº ðŸ“¦</p>
                                    <button onClick={() => setCurrentGame({ type: 'gerakl' })} className="w-full bg-gradient-to-r from-yellow-600 to-orange-600 py-3 rounded-xl font-bold text-sm mobile-btn">Ð’Ð¾Ð¹Ñ‚Ð¸</button>
                                </div>
                            </div>
                        )}

                        {currentScreen === 'events' && (
                            <div>
                                {eventSubScreen === 'main' && renderEventMain()}
                                {eventSubScreen === 'treasure' && renderTreasure()}
                                {eventSubScreen === 'heroes' && renderHeroes()}
                                {eventSubScreen === 'gefest' && renderGefest()}
                            </div>
                        )}

                        {currentScreen === 'tasks' && (
                            <div>
                                <h2 className="text-2xl font-bold mb-4 text-center">ðŸ“‹ Ð—Ð°Ð´Ð°Ð½Ð¸Ñ</h2>
                                <div className="space-y-3">
                                    {[
                                        { id: 'subscribe', title: 'ÐŸÐ¾Ð´Ð¿Ð¸ÑˆÐ¸ÑÑŒ Ð½Ð° ÐºÐ°Ð½Ð°Ð»', reward: '1 ÐºÐµÐ¹Ñ Â«Ð­Ð»Ð¸Ñ‚Ð°Â» ðŸŽ–', task: tasks.subscribe },
                                        { id: 'cardboard7', title: 'ÐŸÑ€Ð¾ÐºÑ€ÑƒÑ‚Ð¸ ÐºÐµÐ¹Ñ Â«ÐšÐ°Ñ€Ñ‚Ð¾Ð½ðŸ“¦Â» 7 Ñ€Ð°Ð·', reward: '1 ÐºÐµÐ¹Ñ Â«ÐÐ»Ð¼Ð°Ð·ðŸ’ŽÂ»', task: tasks.cardboard7, progress: `${tasks.cardboard7?.count || 0}/7` },
                                        { id: 'deposit50', title: 'ÐŸÐ¾Ð¿Ð¾Ð»Ð½Ð¸ Ð±Ð°Ð»Ð°Ð½Ñ Ð½Ð° 50â­ï¸', reward: '50â­ï¸', task: tasks.deposit50 },
                                        { id: 'inviteThree', title: 'ÐŸÑ€Ð¸Ð³Ð»Ð°ÑÐ¸Ñ‚ÑŒ 3 Ð´Ñ€ÑƒÐ·ÐµÐ¹', reward: '25â­ï¸', task: tasks.inviteThree, progress: `${tasks.inviteThree?.count || 0}/3` },
                                        { id: 'deposit', title: 'ÐŸÐ¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÑŒ Ð½Ð° 100â­ï¸', reward: '1 Ð·Ð¾Ð»Ð¾Ñ‚Ð¾Ð¹ ÐºÐµÐ¹Ñ ðŸ‘‘', task: tasks.deposit },
                                        { id: 'depositMajor', title: 'ÐŸÐ¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÑŒ Ð½Ð° 350â­ï¸', reward: 'ÐšÐµÐ¹Ñ Â«ÐšÐ¾Ð»Ð»ÐµÐºÑ†Ð¸Ð¾Ð½ÐµÑ€Â» + Ð¿Ñ€Ð¾ÐºÑ€ÑƒÑ‚', task: tasks.depositMajor },
                                    ].map(t => (
                                        <div key={t.id} className={`glass rounded-xl p-3 ${t.task?.completed ? 'bg-green-500/20' : ''}`}>
                                            <div className="flex justify-between items-start mb-2">
                                                <div>
                                                    <h3 className="font-bold text-sm">{t.title}</h3>
                                                    <p className="text-xs opacity-75">ÐÐ°Ð³Ñ€Ð°Ð´Ð°: {t.reward}</p>
                                                    {t.progress && !t.task?.completed && <p className="text-xs text-cyan-400 mt-0.5">ÐŸÑ€Ð¾Ð³Ñ€ÐµÑÑ: {t.progress}</p>}
                                                </div>
                                                {t.task?.completed && <span className="text-green-400 text-xl">âœ…</span>}
                                            </div>
                                            {t.id !== 'cardboard7' && (
                                                <button onClick={() => completeTask(t.id)} disabled={t.task?.completed} className={`w-full py-2 rounded-lg text-sm mobile-btn ${t.task?.completed ? 'bg-green-600' : 'bg-blue-600'}`}>
                                                    {t.task?.completed ? 'Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¾' : (t.id === 'subscribe' ? 'ÐŸÐ¾Ð´Ð¿Ð¸ÑÐ°Ñ‚ÑŒÑÑ' : t.id === 'inviteThree' ? 'ÐŸÑ€Ð¸Ð³Ð»Ð°ÑÐ¸Ñ‚ÑŒ' : 'ÐŸÐ¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÑŒ')}
                                                </button>
                                            )}
                                            {t.id === 'cardboard7' && (
                                                <button disabled className={`w-full py-2 rounded-lg text-sm mobile-btn ${t.task?.completed ? 'bg-green-600' : 'bg-gray-600'}`}>
                                                    {t.task?.completed ? 'Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¾ âœ…' : 'ÐžÑ‚ÐºÑ€Ñ‹Ð²Ð°Ð¹Ñ‚Ðµ ÐºÐµÐ¹Ñ ÐšÐ°Ñ€Ñ‚Ð¾Ð½'}
                                                </button>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {currentScreen === 'profile' && (
                            <div>
                                <div className="glass rounded-xl p-2.5 mb-3 flex justify-between items-center">
                                    <span className="text-gray-400 text-sm">ðŸŸ¢ ÐžÐ½Ð»Ð°Ð¹Ð½:</span>
                                    <span className="font-bold text-green-400 text-sm">{onlineCount}</span>
                                </div>
                                <h2 className="text-2xl font-bold mb-4 text-center">ðŸ‘¤ ÐŸÑ€Ð¾Ñ„Ð¸Ð»ÑŒ</h2>
                                <div className="glass rounded-xl p-4 text-center mb-4">
                                    <div className="w-16 h-16 mx-auto rounded-full bg-gradient-to-br from-indigo-400 to-purple-500 flex items-center justify-center text-2xl mb-2 overflow-hidden border-2 border-white/20">
                                        {user?.avatar ? <img src={user.avatar} alt="" className="w-full h-full object-cover" /> : user?.name?.charAt(0).toUpperCase()}
                                    </div>
                                    <h3 className="text-lg font-bold">{user?.name}</h3>
                                    {user?.username && <p className="text-gray-400 text-sm">{user.username}</p>}
                                </div>
                                <div className="flex gap-2 mb-3">
                                    <button onClick={() => setShowTopUp(true)} className="flex-1 bg-gradient-to-r from-yellow-400 to-orange-500 text-gray-900 font-bold py-3 rounded-xl text-sm mobile-btn">ðŸ’Ž ÐŸÐ¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÑŒ</button>
                                </div>
                                <button onClick={() => setShowWithdrawModal(true)} className="w-full bg-gradient-to-r from-purple-500 to-indigo-600 font-bold py-3 rounded-xl text-sm mb-3 mobile-btn">ðŸ† Ð’Ñ‹Ð²ÐµÑÑ‚Ð¸ Ð¿Ñ€Ð¸Ð·Ñ‹</button>

                                <div className="glass rounded-xl p-3 mb-3">
                                    <h3 className="font-bold mb-2 text-sm">ðŸŽ ÐŸÑ€Ð¾Ð¼Ð¾ÐºÐ¾Ð´</h3>
                                    <div className="flex gap-2">
                                        <input type="text" placeholder="ÐŸÐ ÐžÐœÐžÐšÐžÐ”" value={promoCode} onChange={e => setPromoCode(e.target.value)} className="flex-1 bg-gray-700/50 border border-gray-600 rounded-lg px-3 py-2 text-center uppercase text-sm" />
                                        <button onClick={checkPromo} className="bg-indigo-600 px-4 py-2 rounded-lg font-bold text-sm">OK</button>
                                    </div>
                                    {promoError && <p className="text-red-400 text-xs mt-2 text-center">{promoError}</p>}
                                    {promoSuccess && <p className="text-green-400 text-xs mt-2 text-center">{promoSuccess}</p>}
                                </div>

                                <div className="glass rounded-xl p-3">
                                    <div className="flex justify-between items-center mb-2">
                                        <h3 className="font-bold text-sm">ðŸŽ’ Ð˜Ð½Ð²ÐµÐ½Ñ‚Ð°Ñ€ÑŒ</h3>
                                        <span className="text-xs text-gray-400">{inventory.length}/{inventorySlots}</span>
                                    </div>
                                    <div className="grid grid-cols-5 gap-2 mb-2">
                                        {[...Array(inventorySlots)].map((_, i) => (
                                            <div key={i} className="aspect-square bg-gray-700/50 rounded-lg flex items-center justify-center text-xl cursor-pointer hover:bg-gray-600/50 transition">
                                                {inventory[i] ? <span onClick={() => sellItem(inventory[i])} className="hover:scale-110 transition">{inventory[i].emoji}</span> : <span className="text-gray-600 text-xs">â—‹</span>}
                                            </div>
                                        ))}
                                    </div>
                                    <button onClick={unlockSlot} disabled={balance < 50} className="w-full bg-gray-700 disabled:opacity-50 py-2 rounded-lg text-xs font-bold mobile-btn">ðŸ”“ Ð¡Ð»Ð¾Ñ‚ (50â­ï¸)</button>
                                </div>
                            </div>
                        )}
                    </main>

                    {selectedCase && (
                        <div className="fullscreen-modal flex items-center justify-center p-3">
                            <div className="w-full max-w-lg" ref={rouletteContainerRef}>
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-xl font-bold">{selectedCase.emoji} {selectedCase.name}</h3>
                                    <button onClick={() => { setSelectedCase(null); setSpinResult(null); setFakeItems([]); }} className="text-3xl hover:text-red-400">Ã—</button>
                                </div>
                                <div className="roulette-container mb-4">
                                    <div className="roulette-pointer" />
                                    <div key={rouletteKey} className="roulette-inner" style={{ transform: `translateX(${rouletteOffset}px)` }}>
                                        {fakeItems.length > 0 ? fakeItems.map((item, i) => (
                                            <div key={i} className="roulette-item"><div className="emoji">{item.emoji}</div><div className="name">{item.name}</div></div>
                                        )) : [...Array(80)].map((_, i) => <div key={i} className="roulette-item"><div className="emoji">â“</div></div>)}
                                    </div>
                                </div>
                                <div className="glass rounded-xl p-3 mb-4 max-h-36 overflow-y-auto">
                                    <p className="font-bold mb-1 text-center text-sm">Ð’Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ñ‹Ðµ Ð½Ð°Ð³Ñ€Ð°Ð´Ñ‹:</p>
                                    <div className="space-y-1">{CASE_REWARDS[selectedCase.id]?.map((r, i) => (
                                        <div key={i} className="flex justify-between py-0.5 border-b border-white/10 last:border-0 text-xs">
                                            <span>{r.emoji} {r.name}</span><span className="text-yellow-400 font-bold">{r.displayChance}</span>
                                        </div>
                                    ))}</div>
                                </div>
                                {spinResult ? (
                                    <div className="text-center">
                                        <p className="text-xl font-bold mb-2">ðŸŽ‰ {spinResult.name}!</p>
                                        <button onClick={() => { setSpinResult(null); openCase(selectedCase.id); }} className="w-full bg-green-600 py-3 rounded-xl font-bold mb-2 mobile-btn">Ð•Ñ‰Ñ‘ Ñ€Ð°Ð·</button>
                                        <button onClick={() => { setSelectedCase(null); setSpinResult(null); setFakeItems([]); }} className="w-full bg-gray-600 py-2.5 rounded-xl font-bold text-sm mobile-btn">Ðš ÐºÐµÐ¹ÑÐ°Ð¼</button>
                                    </div>
                                ) : (
                                    <button onClick={() => openCase(selectedCase.id)} disabled={isSpinning || (selectedCase.id === 'daily' && selectedCase.freeCount === 0)} className="w-full bg-gradient-to-r from-indigo-500 to-purple-500 py-4 rounded-xl font-bold text-lg disabled:opacity-50 mobile-btn">
                                        {isSpinning ? 'ðŸŒ€ ÐšÑ€ÑƒÑ‚Ð¸Ð¼...' : (selectedCase.id === 'daily' && selectedCase.freeCount === 0 ? dailyCaseTimeLeft : `ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð·Ð° ${getCasePrice(selectedCase.id) === 0 ? 'Ð‘ÐµÑÐ¿Ð»Ð°Ñ‚Ð½Ð¾' : getCasePrice(selectedCase.id) + 'â­ï¸'}`)}
                                    </button>
                                )}
                            </div>
                        </div>
                    )}

                    {showTopUp && (
                        <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-3">
                            <div className="glass rounded-2xl p-4 max-w-sm w-full max-h-[90vh] overflow-y-auto">
                                <div className="flex justify-between items-center mb-3">
                                    <h3 className="text-lg font-bold">ðŸ’³ ÐŸÐ¾Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ</h3>
                                    <button onClick={() => setShowTopUp(false)} className="text-2xl hover:text-red-400">Ã—</button>
                                </div>
                                <p className="text-xs text-gray-400 text-center mb-2">â­ï¸ Telegram Stars</p>
                                <div className="space-y-2 mb-3">
                                    {STARS_PACKAGES.map(pkg => (
                                        <button key={pkg.stars} onClick={() => buyStars(pkg)} className="w-full glass p-3 rounded-xl flex justify-between items-center hover:bg-white/10 border border-white/10">
                                            <span className="font-bold text-yellow-400 text-sm">+{pkg.stars} â­ï¸</span>
                                            <span className="text-gray-300 text-xs">ÐšÑƒÐ¿Ð¸Ñ‚ÑŒ</span>
                                        </button>
                                    ))}
                                </div>
                                <div className="border-t border-gray-600 pt-3">
                                    <p className="text-xs text-gray-400 text-center mb-2">ðŸ’Ž TON</p>
                                    {TON_RATES.map(rate => (
                                        <button key={rate.stars} onClick={() => topUpBalance(rate.stars, rate.ton)} className="w-full glass p-3 rounded-xl flex justify-between items-center hover:bg-white/10 border border-white/10 mb-2">
                                            <span className="font-bold text-sm">+{rate.stars}â­ï¸</span>
                                            <span className="text-yellow-400 font-bold text-sm">{rate.ton} TON</span>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    <nav className="fixed bottom-0 left-0 right-0 glass border-t border-white/10 p-1.5 z-40">
                        <div className="max-w-md mx-auto flex justify-around">
                            {[
                                { id: 'tasks', emoji: 'ðŸ“‹', label: 'Ð—Ð°Ð´Ð°Ð½Ð¸Ñ' },
                                { id: 'cases', emoji: 'ðŸŽ', label: 'ÐšÐµÐ¹ÑÑ‹' },
                                { id: 'events', emoji: 'ðŸ›ï¸', label: 'Ð˜Ð²ÐµÐ½Ñ‚Ñ‹' },
                                { id: 'games', emoji: 'ðŸŽ®', label: 'Ð˜Ð³Ñ€Ñ‹' },
                                { id: 'profile', emoji: 'ðŸ‘¤', label: 'ÐŸÑ€Ð¾Ñ„Ð¸Ð»ÑŒ' }
                            ].map(s => (
                                <button key={s.id} onClick={() => { setCurrentScreen(s.id); if (s.id === 'events') setEventSubScreen('main'); }} className={`flex flex-col items-center p-1.5 rounded-lg transition ${currentScreen === s.id ? 'events-tab-active text-yellow-400 scale-110' : 'text-gray-400 hover:text-white'}`}>
                                    <span className="text-xl">{s.emoji}</span>
                                    <span className="text-[10px] font-bold">{s.label}</span>
                                </button>
                            ))}
                        </div>
                    </nav>
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
